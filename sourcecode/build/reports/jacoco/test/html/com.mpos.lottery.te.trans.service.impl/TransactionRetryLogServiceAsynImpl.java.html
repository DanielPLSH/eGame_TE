<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TransactionRetryLogServiceAsynImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.trans.service.impl</a> &gt; <span class="el_source">TransactionRetryLogServiceAsynImpl.java</span></div><h1>TransactionRetryLogServiceAsynImpl.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.trans.service.impl;

import com.mpos.lottery.te.common.dao.BaseJpaDao;
import com.mpos.lottery.te.common.util.SimpleToolkit;
import com.mpos.lottery.te.config.dao.OperationParameterDao;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.instantgame.domain.IgOperationParameter;
import com.mpos.lottery.te.gamespec.game.Game;
import com.mpos.lottery.te.merchant.domain.Device;
import com.mpos.lottery.te.sequence.service.UUIDService;
import com.mpos.lottery.te.trans.dao.TransactionRetryLogDao;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.trans.domain.TransactionRetryLog;
import com.mpos.lottery.te.trans.domain.TransactionType;
import com.mpos.lottery.te.trans.service.TransactionRetryLogServiceAsyn;

import java.util.Date;

<span class="fc" id="L20">public class TransactionRetryLogServiceAsynImpl implements TransactionRetryLogServiceAsyn {</span>
    private TransactionRetryLogDao transactionRetryLogDao;
    private OperationParameterDao operationParameterDao;
    private BaseJpaDao baseJpaDao;
    private UUIDService uuidManager;

    public TransactionRetryLog add(String ticketSerialNo, int transType, long deviceId) throws ApplicationException {
<span class="fc" id="L27">        TransactionRetryLog retryLog = new TransactionRetryLog();</span>
<span class="fc" id="L28">        retryLog.setVersion(TransactionRetryLog.VERSION_VALID);</span>
<span class="fc" id="L29">        retryLog.setId(this.getUuidManager().getGeneralID());</span>
<span class="fc" id="L30">        retryLog.setCreateTime(new Date());</span>
<span class="fc" id="L31">        retryLog.setTicketSerialNo(ticketSerialNo);</span>
<span class="fc" id="L32">        retryLog.setTransType(TransactionType.VALIDATE_INSTANT_TICKET.getRequestType());</span>
<span class="fc" id="L33">        retryLog.setTotalRetry(1);</span>
<span class="fc" id="L34">        retryLog.setDeviceId(deviceId);</span>
<span class="fc" id="L35">        this.getTransactionRetryLogDao().insert(retryLog);</span>
<span class="fc" id="L36">        return retryLog;</span>
    }

    public TransactionRetryLog getBySerialNoAndTransTypeAndDevice(String ticketSerialNo, int transType, long deviceId)
            throws ApplicationException {
<span class="fc" id="L41">        return this.getTransactionRetryLogDao().getByTicketAndTransTypeAndDevice(ticketSerialNo, transType, deviceId);</span>
    }

    public void update(TransactionRetryLog retryLog) throws ApplicationException {
<span class="fc" id="L45">        this.getTransactionRetryLogDao().update(retryLog);</span>
<span class="fc" id="L46">    }</span>

    public TransactionRetryLog checkMaxValidationTimes(Transaction trans, String ticketSerialNo, int transType,
            Game game) throws ApplicationException {
<span class="fc" id="L50">        int timeRange = 1; // hour</span>

<span class="fc" id="L52">        IgOperationParameter param = (IgOperationParameter) this.getOperationParameterDao().findById(</span>
                IgOperationParameter.class, game.getOperatorParameterId());
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        if (param == null) {</span>
<span class="nc" id="L55">            throw new SystemException(&quot;can NOT find IG operation parameter by id(&quot; + game.getOperatorParameterId()</span>
                    + &quot;).&quot;);
        }
        // retrieve exist log
<span class="fc" id="L59">        TransactionRetryLog retryLog = this.getBySerialNoAndTransTypeAndDevice(ticketSerialNo, transType,</span>
                trans.getDeviceId());
<span class="fc bfc" id="L61" title="All 2 branches covered.">        if (retryLog == null) {</span>
<span class="fc" id="L62">            retryLog = this.add(ticketSerialNo, transType, trans.getDeviceId());</span>
        } else {
<span class="fc" id="L64">            int maxValidationTimes = param.getMaxValidateTimes();</span>
            // check current time, if (current-createtime) is greater than 1
            // hour
<span class="fc" id="L67">            Date current = new Date();</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">            if (SimpleToolkit.compare(current, retryLog.getCreateTime()) &gt; (timeRange * 3600 * 1000)) {</span>
                // exceed timeRange hour, reset transaction retry log.
<span class="nc" id="L70">                retryLog.setCreateTime(current);</span>
<span class="nc" id="L71">                retryLog.setUpdateTime(current);</span>
<span class="nc" id="L72">                retryLog.setTotalRetry(1);</span>
<span class="nc" id="L73">                this.update(retryLog);</span>
            } else {
                // if exceed max allowed times per hour, the request will be
                // denied.
                // It means you can try validation many time as long as they
                // don't occur in 1 hour.
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">                if (retryLog.getTotalRetry() &gt;= maxValidationTimes) {</span>
<span class="nc" id="L80">                    retryLog.setTotalRetry(retryLog.getTotalRetry() + 1);</span>
                    // use 'version' column to represent a invalid(soft removed)
                    // log.
<span class="nc" id="L83">                    retryLog.setVersion(TransactionRetryLog.VERSION_INVALID);</span>
<span class="nc" id="L84">                    this.update(retryLog);</span>

                    // lock the device, it can be unlocked from M.lottery
                    // admin.
<span class="nc" id="L88">                    Device device = this.getBaseJpaDao().findById(Device.class, trans.getDeviceId());</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                    if (device == null) {</span>
<span class="nc" id="L90">                        throw new ApplicationException(SystemException.CODE_NO_DEVICE, &quot;can NOT find device with id=&quot;</span>
                                + trans.getDeviceId());
                    }
<span class="nc" id="L93">                    device.setStatus(Device.STATUS_BLOCKED);</span>
<span class="nc" id="L94">                    this.getBaseJpaDao().update(device);</span>
<span class="nc" id="L95">                } else {</span>
<span class="fc" id="L96">                    retryLog.setTotalRetry(retryLog.getTotalRetry() + 1);</span>
<span class="fc" id="L97">                    retryLog.setUpdateTime(current);</span>
<span class="fc" id="L98">                    this.update(retryLog);</span>
                }
            }
        }
<span class="fc" id="L102">        retryLog.setAllowedRetry(param.getMaxValidateTimes());</span>
<span class="fc" id="L103">        return retryLog;</span>
    }

    // ----------------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // ----------------------------------------------------------

    public TransactionRetryLogDao getTransactionRetryLogDao() {
<span class="fc" id="L111">        return transactionRetryLogDao;</span>
    }

    public void setTransactionRetryLogDao(TransactionRetryLogDao transactionRetryLogDao) {
<span class="fc" id="L115">        this.transactionRetryLogDao = transactionRetryLogDao;</span>
<span class="fc" id="L116">    }</span>

    public UUIDService getUuidManager() {
<span class="fc" id="L119">        return uuidManager;</span>
    }

    public void setUuidManager(UUIDService uuidManager) {
<span class="fc" id="L123">        this.uuidManager = uuidManager;</span>
<span class="fc" id="L124">    }</span>

    public OperationParameterDao getOperationParameterDao() {
<span class="fc" id="L127">        return operationParameterDao;</span>
    }

    public void setOperationParameterDao(OperationParameterDao operationParameterDao) {
<span class="fc" id="L131">        this.operationParameterDao = operationParameterDao;</span>
<span class="fc" id="L132">    }</span>

    public BaseJpaDao getBaseJpaDao() {
<span class="nc" id="L135">        return baseJpaDao;</span>
    }

    public void setBaseJpaDao(BaseJpaDao baseJpaDao) {
<span class="fc" id="L139">        this.baseJpaDao = baseJpaDao;</span>
<span class="fc" id="L140">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>