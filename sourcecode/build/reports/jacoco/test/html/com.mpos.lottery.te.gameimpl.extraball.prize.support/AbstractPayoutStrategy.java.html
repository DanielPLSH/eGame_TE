<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractPayoutStrategy.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.extraball.prize.support</a> &gt; <span class="el_source">AbstractPayoutStrategy.java</span></div><h1>AbstractPayoutStrategy.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.extraball.prize.support;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.gameimpl.extraball.prize.web.Prize;
import com.mpos.lottery.te.gameimpl.extraball.prize.web.PrizeItem;
import com.mpos.lottery.te.gamespec.prize.Payout;
import com.mpos.lottery.te.gamespec.prize.dao.PayoutDao;
import com.mpos.lottery.te.gamespec.prize.dao.PayoutDetailDao;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.gamespec.sale.dao.BaseTicketDao;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.sequence.service.UUIDService;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.beans.factory.InitializingBean;

import java.math.BigDecimal;
import java.util.Date;
import java.util.Iterator;

<span class="fc" id="L22">public abstract class AbstractPayoutStrategy implements PayoutStrategy, InitializingBean {</span>
<span class="fc" id="L23">    protected Log logger = LogFactory.getLog(AbstractPayoutStrategy.class);</span>
    // Spring dependencies
    private PayoutStrategyFactory payoutStrategyFactory;
    private BaseTicketDao baseTicketDao;
    protected PayoutDao payoutDao;
    protected PayoutDetailDao payoutDetailDao;
    protected UUIDService uuidService;

    @Override
    public final void afterPropertiesSet() throws Exception {
<span class="fc" id="L33">        this.getPayoutStrategyFactory().register(this.key(), this);</span>
<span class="fc" id="L34">    }</span>

    @Override
    public void payout(Context&lt;?&gt; respCtx, Prize prize) throws ApplicationException {
        // update ticket status
<span class="nc" id="L39">        this.updateTicket(prize);</span>
        // gerneate new tickets if needed.
<span class="nc" id="L41">        this.generateTicket(respCtx, prize);</span>
        // genrate payout entities
<span class="nc" id="L43">        this.generatePayout(respCtx, prize);</span>
<span class="nc" id="L44">    }</span>

    // --------------------------------------------------
    // HELPER METHODS
    // --------------------------------------------------

    /**
     * Generate payout entities.
     */
    private void generatePayout(Context&lt;?&gt; respCtx, Prize prize) throws ApplicationException {
<span class="nc" id="L54">        Iterator&lt;PrizeItem&gt; iterator = prize.iterator();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L56">            PrizeItem prizeItem = iterator.next();</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">            if (prizeItem.getPrizeAmount().compareTo(new BigDecimal(&quot;0&quot;)) &lt;= 0) {</span>
<span class="nc" id="L58">                continue;</span>
            }

<span class="nc" id="L61">            Payout payout = new Payout();</span>
<span class="nc" id="L62">            payout.setGameInstanceId(prizeItem.getGameInstance().getId());</span>
<span class="nc" id="L63">            payout.setId(this.getUuidService().getGeneralID());</span>
<span class="nc" id="L64">            payout.setCreateTime(new Date());</span>
<span class="nc" id="L65">            payout.setUpdateTime(payout.getCreateTime());</span>
<span class="nc" id="L66">            payout.setTransaction(respCtx.getTransaction());</span>
<span class="nc" id="L67">            payout.setTicketSerialNo(prize.getWinningTicket().getSerialNo());</span>
<span class="nc" id="L68">            payout.setTotalAmount(prizeItem.getActualAmount());</span>
<span class="nc" id="L69">            payout.setBeforeTaxTotalAmount(prizeItem.getPrizeAmount());</span>
<span class="nc" id="L70">            payout.setType(Payout.TYPE_WINNING);</span>
<span class="nc" id="L71">            payout.setValid(true);</span>
<span class="nc" id="L72">            payout.setStatus(Payout.STATUS_PAID);</span>
<span class="nc" id="L73">            payout.setOperatorId(respCtx.getTransaction().getOperatorId());</span>
<span class="nc" id="L74">            payout.setDevId((int) respCtx.getTransaction().getDeviceId());</span>
<span class="nc" id="L75">            payout.setMerchantId((int) respCtx.getTransaction().getMerchantId());</span>
<span class="nc" id="L76">            payout.setGameId(prizeItem.getGameInstance().getGame().getId());</span>
            // assemble payout entity in customized way
<span class="nc" id="L78">            this.assemblePayout(respCtx, prize, prizeItem, payout);</span>
            // generate payout details
<span class="nc" id="L80">            this.doGeneratePayoutDetails(respCtx, prize, prizeItem, payout);</span>

<span class="nc" id="L82">            this.getPayoutDao().insert(payout);</span>
<span class="nc" id="L83">        }</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (prize.getFutureTickets().size() &gt; 0) {</span>
<span class="nc" id="L85">            this.handleFutureTickets(respCtx, prize);</span>
        }
<span class="nc" id="L87">    }</span>

    /**
     * Handle the future tickets.
     */
    protected void handleFutureTickets(Context&lt;?&gt; respCtx, Prize prize) throws ApplicationException {
        // Template method for subclass
<span class="nc" id="L94">    }</span>

    /**
     * Subimplementation can override this method to assemble &lt;code&gt;Payout&lt;/code&gt; entity in its own requirement.
     * 
     * @param respCtx
     *            The context of transaction.
     * @param prize
     *            The prize information.
     * @param prizeItem
     *            The prize item of given game instance.
     * @param payout
     *            The generated payout base on current prize item.
     */
    protected void assemblePayout(Context&lt;?&gt; respCtx, Prize prize, PrizeItem prizeItem, Payout payout)
            throws ApplicationException {
        // Template method for subclass
<span class="nc" id="L111">    }</span>

    /**
     * Subimplementation can override this method to generate payout details.
     * 
     * @param respCtx
     *            The context of transaction.
     * @param prize
     *            The prize information.
     * @param prizeItem
     *            The prize item of given game instance.
     * @param payout
     *            The generated payout base on current prize item.
     */
    protected void doGeneratePayoutDetails(Context&lt;?&gt; respCtx, Prize prize, PrizeItem prizeItem, Payout payout)
            throws ApplicationException {
        // Template method for subclass
<span class="nc" id="L128">    }</span>

    /**
     * Generate new tickets for future if needed.
     */
    protected void generateTicket(Context&lt;?&gt; respCtx, Prize prize) throws ApplicationException {
        // Template method for sub-implementation
<span class="nc" id="L135">    }</span>

    /**
     * Update the ticket status.
     */
    protected final void updateTicket(Prize prize) throws ApplicationException {
<span class="nc" id="L141">        Date now = new Date();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        for (BaseTicket ticket : prize.getPaidTickets()) {</span>
<span class="nc" id="L143">            ticket.setStatus(BaseTicket.STATUS_PAID);</span>
<span class="nc" id="L144">            ticket.setUpdateTime(now);</span>
<span class="nc" id="L145">            this.getBaseTicketDao().update(ticket);</span>
<span class="nc" id="L146">        }</span>
<span class="nc" id="L147">        this.doUpdateTicket(prize);</span>
<span class="nc" id="L148">    }</span>

    protected void doUpdateTicket(Prize prize) throws ApplicationException {
        // Template method for sub-implementation
<span class="nc" id="L152">    }</span>

    // --------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // --------------------------------------------------

    public PayoutDao getPayoutDao() {
<span class="nc" id="L159">        return payoutDao;</span>
    }

    public void setPayoutDao(PayoutDao payoutDao) {
<span class="fc" id="L163">        this.payoutDao = payoutDao;</span>
<span class="fc" id="L164">    }</span>

    public UUIDService getUuidService() {
<span class="nc" id="L167">        return uuidService;</span>
    }

    public void setUuidService(UUIDService uuidService) {
<span class="fc" id="L171">        this.uuidService = uuidService;</span>
<span class="fc" id="L172">    }</span>

    public PayoutDetailDao getPayoutDetailDao() {
<span class="nc" id="L175">        return payoutDetailDao;</span>
    }

    public void setPayoutDetailDao(PayoutDetailDao payoutDetailDao) {
<span class="fc" id="L179">        this.payoutDetailDao = payoutDetailDao;</span>
<span class="fc" id="L180">    }</span>

    public PayoutStrategyFactory getPayoutStrategyFactory() {
<span class="fc" id="L183">        return payoutStrategyFactory;</span>
    }

    public void setPayoutStrategyFactory(PayoutStrategyFactory payoutStrategyFactory) {
<span class="fc" id="L187">        this.payoutStrategyFactory = payoutStrategyFactory;</span>
<span class="fc" id="L188">    }</span>

    public BaseTicketDao getBaseTicketDao() {
<span class="nc" id="L191">        return baseTicketDao;</span>
    }

    public void setBaseTicketDao(BaseTicketDao baseTicketDao) {
<span class="fc" id="L195">        this.baseTicketDao = baseTicketDao;</span>
<span class="fc" id="L196">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>