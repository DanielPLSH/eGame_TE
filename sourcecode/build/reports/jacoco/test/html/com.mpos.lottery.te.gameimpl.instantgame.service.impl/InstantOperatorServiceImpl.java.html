<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>InstantOperatorServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.instantgame.service.impl</a> &gt; <span class="el_source">InstantOperatorServiceImpl.java</span></div><h1>InstantOperatorServiceImpl.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.instantgame.service.impl;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.gameimpl.instantgame.dao.IGBatchReportDao;
import com.mpos.lottery.te.gameimpl.instantgame.dao.IGFailedTicketsReportDao;
import com.mpos.lottery.te.gameimpl.instantgame.dao.IGOperatorBatchDao;
import com.mpos.lottery.te.gameimpl.instantgame.dao.IGPayoutDetailTempDao;
import com.mpos.lottery.te.gameimpl.instantgame.dao.IGPayoutTempDao;
import com.mpos.lottery.te.gameimpl.instantgame.domain.IGBatchReport;
import com.mpos.lottery.te.gameimpl.instantgame.domain.IGOperatorBatch;
import com.mpos.lottery.te.gameimpl.instantgame.domain.InstantTicket;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.InstantBatchReportDto;
import com.mpos.lottery.te.gameimpl.instantgame.service.InstantOperatorService;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.sequence.service.UUIDService;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

<span class="fc" id="L20">public class InstantOperatorServiceImpl implements InstantOperatorService {</span>
<span class="fc" id="L21">    private Log logger = LogFactory.getLog(InstantOperatorServiceImpl.class);</span>

    private IGOperatorBatchDao igOperatorBatchDao;
    // clear
    private IGPayoutTempDao iGPayoutTempDao;
    private IGBatchReportDao iGBatchReportDao;
    private IGFailedTicketsReportDao iGFailedTicketsReportDao;
    private IGPayoutDetailTempDao iGPayoutDetailTempDao;

    private UUIDService uuidManager;

    @Override
    public InstantBatchReportDto getConfirmBatchNumber(Context ctx) throws ApplicationException {
        // should write business logic here
<span class="fc" id="L35">        InstantBatchReportDto instantBatchReportDto = new InstantBatchReportDto();</span>
<span class="fc" id="L36">        IGOperatorBatch igOperatorBatch = igOperatorBatchDao.getIGOperatorBatch(ctx.getOperatorId());</span>
<span class="pc bpc" id="L37" title="1 of 2 branches missed.">        if (igOperatorBatch == null) {</span>
<span class="nc" id="L38">            igOperatorBatch = new IGOperatorBatch();</span>
<span class="nc" id="L39">            igOperatorBatch.setId(this.getUuidManager().getGeneralID());</span>
<span class="nc" id="L40">            igOperatorBatch.setBatchNumber(1);</span>
<span class="nc" id="L41">            igOperatorBatch.setOperatorId(ctx.getOperatorId());</span>
<span class="nc" id="L42">            igOperatorBatch.setCreateBy(ctx.getOperatorId());</span>
<span class="nc" id="L43">            igOperatorBatch.setUpdateBy(ctx.getOperatorId());</span>

<span class="nc" id="L45">            this.getIgOperatorBatchDao().insert(igOperatorBatch);</span>
        } else {
            // response batch number =batch number +1

<span class="fc" id="L49">            long batchNumber = igOperatorBatch.getBatchNumber();</span>
<span class="fc" id="L50">            igOperatorBatch.setBatchNumber(batchNumber + 1);</span>
<span class="fc" id="L51">            this.getIgOperatorBatchDao().update(igOperatorBatch);</span>
            // delete temporary payout records
            // 1,delete payout records
            // 2,delete payout detail records

        }

        // delete before batch number
<span class="fc" id="L59">        long previousBatchNumber = igOperatorBatch.getBatchNumber() - 1;</span>

        // IF ig_batch_report has no data then delete other tables data
        // Get batch report data with previousBatchNumber
<span class="fc" id="L63">        IGBatchReport batchReport = this.getIGBatchReportDao().getByBatchId(ctx.getOperatorId(), previousBatchNumber);</span>
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (batchReport == null) {</span>
            // 3,update status of all IG tickets from 'processing'to 'active'

<span class="fc" id="L67">            this.getiGPayoutTempDao().changeStatusOfAllIGTickets(InstantTicket.STATUS_ACTIVE, previousBatchNumber,</span>
                    ctx.getOperatorId());
            // delete IG_PAYOUT_TEMP data only users themselves
<span class="fc" id="L70">            this.getiGPayoutTempDao().deleteDataByOperatorId(previousBatchNumber, ctx.getOperatorId());</span>

            // delete ig_batch_report data(no need to delete the table)
            // this.getIGBatchReportDao().deleteDataByOperatorId(previousBatchNumber,ctx.getOperatorId());

            // delete IG_FAILED_TICKETS_REPORT data
<span class="fc" id="L76">            this.getIGFailedTicketsReportDao().deleteDataByOperatorId(previousBatchNumber, ctx.getOperatorId());</span>

            // delete IG_PAYOUT_DETAIL_TEMP data
<span class="fc" id="L79">            this.getIGPayoutDetailTempDao().deleteDataByOperatorId(previousBatchNumber, ctx.getOperatorId());</span>

        } else {

        }

<span class="fc" id="L85">        instantBatchReportDto.setBatchNumber(igOperatorBatch.getBatchNumber());</span>
<span class="fc" id="L86">        return instantBatchReportDto;</span>
    }

    public IGPayoutTempDao getiGPayoutTempDao() {
<span class="fc" id="L90">        return iGPayoutTempDao;</span>
    }

    public void setiGPayoutTempDao(IGPayoutTempDao iGPayoutTempDao) {
<span class="fc" id="L94">        this.iGPayoutTempDao = iGPayoutTempDao;</span>
<span class="fc" id="L95">    }</span>

    public IGOperatorBatchDao getIgOperatorBatchDao() {
<span class="fc" id="L98">        return igOperatorBatchDao;</span>
    }

    public void setIgOperatorBatchDao(IGOperatorBatchDao igOperatorBatchDao) {
<span class="fc" id="L102">        this.igOperatorBatchDao = igOperatorBatchDao;</span>
<span class="fc" id="L103">    }</span>

    public UUIDService getUuidManager() {
<span class="nc" id="L106">        return uuidManager;</span>
    }

    public void setUuidManager(UUIDService uuidManager) {
<span class="fc" id="L110">        this.uuidManager = uuidManager;</span>
<span class="fc" id="L111">    }</span>

    public IGPayoutTempDao getIGPayoutTempDao() {
<span class="nc" id="L114">        return iGPayoutTempDao;</span>
    }

    public void setIGPayoutTempDao(IGPayoutTempDao payoutTempDao) {
<span class="nc" id="L118">        iGPayoutTempDao = payoutTempDao;</span>
<span class="nc" id="L119">    }</span>

    public IGBatchReportDao getIGBatchReportDao() {
<span class="fc" id="L122">        return iGBatchReportDao;</span>
    }

    public void setIGBatchReportDao(IGBatchReportDao batchReportDao) {
<span class="fc" id="L126">        iGBatchReportDao = batchReportDao;</span>
<span class="fc" id="L127">    }</span>

    public IGFailedTicketsReportDao getIGFailedTicketsReportDao() {
<span class="fc" id="L130">        return iGFailedTicketsReportDao;</span>
    }

    public void setIGFailedTicketsReportDao(IGFailedTicketsReportDao failedTicketsReportDao) {
<span class="fc" id="L134">        iGFailedTicketsReportDao = failedTicketsReportDao;</span>
<span class="fc" id="L135">    }</span>

    public IGPayoutDetailTempDao getIGPayoutDetailTempDao() {
<span class="fc" id="L138">        return iGPayoutDetailTempDao;</span>
    }

    public void setIGPayoutDetailTempDao(IGPayoutDetailTempDao payoutDetailTempDao) {
<span class="fc" id="L142">        iGPayoutDetailTempDao = payoutDetailTempDao;</span>
<span class="fc" id="L143">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>