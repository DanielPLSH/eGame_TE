<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>InstantGameController.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.instantgame</a> &gt; <span class="el_source">InstantGameController.java</span></div><h1>InstantGameController.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.instantgame;

import com.mpos.lottery.common.router.RequestMap;
import com.mpos.lottery.te.common.util.JSONHelper;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.instantgame.domain.InstantTicket;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.ActiveCriteria;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.ActiveResult;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.ConfirmBatchPayoutDto;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.InstantBatchPayoutDto;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.InstantBatchReportDto;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.InstantOfflineTicketResult;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.InstantOfflineTickets;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.Packet;
import com.mpos.lottery.te.gameimpl.instantgame.domain.dto.PrizeLevelDto;
import com.mpos.lottery.te.gameimpl.instantgame.service.InstantOperatorService;
import com.mpos.lottery.te.gameimpl.instantgame.service.InstantTicketService;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.trans.domain.TransactionMessage;

import org.springframework.stereotype.Controller;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

@Controller
<span class="fc" id="L31">public class InstantGameController {</span>
    @Resource(name = &quot;igTicketService&quot;)
    private InstantTicketService ticketService;

    @Resource(name = &quot;igOperatorService&quot;)
    private InstantOperatorService igOperatorService;

    @RequestMap(&quot;{transType:401}&quot;)
    public void activeByCriteria(Context request, Context response) throws ApplicationException {
<span class="nc" id="L40">        ActiveCriteria criteria = (ActiveCriteria) request.getModel();</span>
<span class="nc" id="L41">        criteria.setTrans(request.getTransaction());</span>
<span class="nc" id="L42">        ActiveResult result = this.getTicketService().active(criteria);</span>
<span class="nc bnc" id="L43" title="All 4 branches missed.">        if (result.getCount() == 0 &amp;&amp; !result.isBatchSuccessful()) {</span>
            // only fail to active all tickets, this response code should be
            // returned
<span class="nc" id="L46">            response.setResponseCode(SystemException.CODE_FAIL_ACTIVEBYCRITERIA);</span>
        } else {
<span class="nc" id="L48">            response.setResponseCode(SystemException.CODE_OK);</span>
        }

        // save criteria to transMessage
<span class="nc" id="L52">        TransactionMessage transMessage = new TransactionMessage();</span>
<span class="nc" id="L53">        transMessage.setTransactionId(request.getTransaction().getId());</span>
<span class="nc" id="L54">        transMessage.setRequestMsg(result.getActiveResult());</span>
<span class="nc" id="L55">        request.getTransaction().setTransMessage(transMessage);</span>
<span class="nc" id="L56">        response.setModel(result);</span>
<span class="nc" id="L57">    }</span>

    @RequestMap(&quot;{transType:402}&quot;)
    public void validateInstantTicket(Context request, Context response) throws ApplicationException {
<span class="fc" id="L61">        PrizeLevelDto payout = (PrizeLevelDto) request.getModel();</span>
<span class="fc" id="L62">        payout.getTicket().setTransaction(request.getTransaction());</span>
<span class="fc" id="L63">        PrizeLevelDto dto = this.getTicketService().validate(response, payout);</span>
<span class="fc" id="L64">        response.setModel(dto);</span>
        // response.setResponseCode(dto.getErrorCode());

<span class="fc" id="L67">        request.getTransaction().setTicketSerialNo(payout.getTicket().getSerialNo());</span>
        // tran.setVirn(payout.getTicket().getTicketXOR2());
<span class="fc" id="L69">        request.getTransaction().setTotalAmount(dto.getCashActualAmount());</span>
<span class="fc" id="L70">    }</span>

    @RequestMap(&quot;{transType:403}&quot;)
    public void offlineInfoUpload(Context request, Context response) throws ApplicationException {
<span class="nc" id="L74">        InstantOfflineTickets ticket = (InstantOfflineTickets) request.getModel();</span>
<span class="nc" id="L75">        InstantOfflineTicketResult result = this.getTicketService().offlineInfoUpload(ticket);</span>
<span class="nc" id="L76">        response.setModel(result);</span>
<span class="nc" id="L77">    }</span>

    @RequestMap(&quot;{transType:404}&quot;)
    public void sellInstantTicket(Context request, Context response) throws ApplicationException {
<span class="nc" id="L81">        InstantTicket ticket = (InstantTicket) request.getModel();</span>
<span class="nc" id="L82">        ticket.setTransaction(request.getTransaction());</span>
<span class="nc" id="L83">        InstantTicket result = this.getTicketService().sell(ticket);</span>
<span class="nc" id="L84">        request.getTransaction().setTicketSerialNo(ticket.getSerialNo());</span>
<span class="nc" id="L85">        request.getTransaction().setTotalAmount(result.getTotalAmount());</span>
<span class="nc" id="L86">        response.setModel(result);</span>
<span class="nc" id="L87">    }</span>

    @RequestMap(&quot;{transType:405}&quot;)
    public void receivePacket(Context request, Context response) throws ApplicationException {
<span class="nc" id="L91">        Packet packet = (Packet) request.getModel();</span>
<span class="nc" id="L92">        this.getTicketService().receive(packet);</span>
<span class="nc" id="L93">    }</span>

    @RequestMap(&quot;{transType:406}&quot;)
    public void activeTicket(Context request, Context response) throws ApplicationException {
<span class="fc" id="L97">        InstantTicket ticket = (InstantTicket) request.getModel();</span>
<span class="fc" id="L98">        ticket.setTransaction(request.getTransaction());</span>
<span class="fc" id="L99">        InstantTicket result = this.getTicketService().active(ticket);</span>
<span class="fc" id="L100">        request.getTransaction().setTicketSerialNo(ticket.getSerialNo());</span>
<span class="fc" id="L101">        response.setModel(result);</span>
<span class="fc" id="L102">    }</span>

    @RequestMap(&quot;{transType:407}&quot;)
    public void batchValidate(Context request, Context response) throws ApplicationException {
<span class="nc" id="L106">        InstantBatchPayoutDto batchPayout = (InstantBatchPayoutDto) request.getModel();</span>
<span class="nc" id="L107">        List&lt;PrizeLevelDto&gt; payoutReq = batchPayout.getPayouts();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        for (PrizeLevelDto dto : payoutReq) {</span>
            // set transaction to InstantTicket
<span class="nc" id="L110">            dto.getTicket().setTransaction(request.getTransaction());</span>
<span class="nc" id="L111">        }</span>

<span class="nc" id="L113">        InstantBatchPayoutDto result = this.getTicketService().batchValidate(response, batchPayout);</span>
<span class="nc" id="L114">        response.setModel(result);</span>
        // fail to validate any ticket
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (result.getTotalFail() == result.getPayouts().size()) {</span>
<span class="nc" id="L117">            response.setResponseCode(SystemException.CODE_FAIL_BATCHVALIDATION);</span>
        }
<span class="nc" id="L119">        request.getTransaction().setTotalAmount(result.getActualAmount());</span>

        // write all instant tickets to transaction_message for reversal
<span class="nc" id="L122">        Map ticketResultMap = new HashMap();</span>
<span class="nc" id="L123">        List&lt;PrizeLevelDto&gt; payouts = batchPayout.getPayouts();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        for (PrizeLevelDto dto : payouts) {</span>
<span class="nc" id="L125">            ticketResultMap.put(dto.getTicket().getSerialNo(), dto.getErrorCode());</span>
<span class="nc" id="L126">        }</span>
<span class="nc" id="L127">        TransactionMessage transMsg = new TransactionMessage();</span>
<span class="nc" id="L128">        transMsg.setTransactionId(request.getTransaction().getId());</span>
<span class="nc" id="L129">        transMsg.setRequestMsg(JSONHelper.encode(ticketResultMap));</span>
<span class="nc" id="L130">        request.getTransaction().setTransMessage(transMsg);</span>
<span class="nc" id="L131">    }</span>

    /**
     * need to handle confirmation batch validation transaction.
     * */
    @RequestMap(&quot;{transType:410}&quot;)
    public void patialPackage(Context request, Context response) throws ApplicationException {
<span class="fc" id="L138">        ConfirmBatchPayoutDto confirmBatchPayout = (ConfirmBatchPayoutDto) request.getModel();</span>
<span class="fc" id="L139">        List&lt;PrizeLevelDto&gt; payoutReq = confirmBatchPayout.getPayouts();</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">        for (PrizeLevelDto dto : payoutReq) {</span>
            // set transaction to InstantTicket
<span class="fc" id="L142">            dto.getTicket().setTransaction(request.getTransaction());</span>
<span class="fc" id="L143">        }</span>

<span class="fc" id="L145">        ConfirmBatchPayoutDto result = this.getTicketService().partialPackage(response, confirmBatchPayout);</span>

        // fail to validate any ticket
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (result.getTotalFail() == result.getPayouts().size()) {</span>
            // response.setResponseCode(SystemException.CODE_FAIL_BATCHVALIDATION);
        }
<span class="fc" id="L151">        response.setModel(null);</span>
<span class="fc" id="L152">    }</span>

    /**
     * need to handle confirmation batch validation transaction.
     * */
    @RequestMap(&quot;{transType:411}&quot;)
    public void ConfirmBatchValidation(Context request, Context response) throws ApplicationException {
<span class="fc" id="L159">        InstantBatchReportDto dto = (InstantBatchReportDto) request.getModel();</span>

<span class="fc" id="L161">        InstantBatchReportDto result = this.getTicketService().ConfirmBatchValidation(response, dto);</span>

        // fail to validate any ticket
<span class="pc bpc" id="L164" title="2 of 4 branches missed.">        if (result == null || result.getBatchNumber() == 0) {</span>
            // response.setResponseCode(SystemException.CODE_FAIL_BATCHVALIDATION);
        }
<span class="fc" id="L167">        response.setModel(result);</span>
<span class="fc" id="L168">    }</span>

    @RequestMap(&quot;{transType:408}&quot;)
    public void enquiryPrize(Context request, Context response) throws ApplicationException {
<span class="fc" id="L172">        InstantTicket dto = (InstantTicket) request.getModel();</span>
<span class="fc" id="L173">        PrizeLevelDto prize = this.getTicketService().enquiryPrize(response, dto, false);</span>
<span class="fc" id="L174">        response.setModel(prize);</span>
<span class="fc" id="L175">    }</span>

    @RequestMap(&quot;{transType:409}&quot;)
    public void GetConfirmBatchNumber(Context request, Context response) throws ApplicationException {
<span class="fc" id="L179">        InstantBatchReportDto instantBatchReportDto = this.getIgOperatorService().getConfirmBatchNumber(request);</span>
<span class="fc" id="L180">        response.setModel(instantBatchReportDto);</span>
<span class="fc" id="L181">    }</span>

    @RequestMap(&quot;{transType:312}&quot;)
    public void offlineBatchValidate(Context request, Context response) throws ApplicationException {
<span class="nc" id="L185">        InstantBatchPayoutDto dto = (InstantBatchPayoutDto) request.getModel();</span>
<span class="nc" id="L186">        request.setTransaction(request.getTransaction());</span>
<span class="nc" id="L187">        InstantBatchPayoutDto resp = this.getTicketService().offlineBatchValidate(response, dto);</span>
<span class="nc" id="L188">        response.setModel(resp);</span>
<span class="nc" id="L189">    }</span>

    @RequestMap(&quot;{transType:412}&quot;)
    public void getReportOfConfirmBatchValidation(Context request, Context response) throws ApplicationException {

<span class="fc" id="L194">        InstantBatchReportDto dto = (InstantBatchReportDto) request.getModel();</span>
<span class="fc" id="L195">        InstantBatchReportDto resp = this.getTicketService().getReportOfConfirmBatchValidation(request, dto);</span>
<span class="fc" id="L196">        response.setModel(resp);</span>
<span class="fc" id="L197">    }</span>

    // -----------------------------------------------------------------
    // HELPER METHODS
    // -----------------------------------------------------------------

    // -----------------------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // -----------------------------------------------------------------

    public InstantTicketService getTicketService() {
<span class="fc" id="L208">        return ticketService;</span>
    }

    public void setTicketService(InstantTicketService ticketService) {
<span class="nc" id="L212">        this.ticketService = ticketService;</span>
<span class="nc" id="L213">    }</span>

    public InstantOperatorService getIgOperatorService() {
<span class="fc" id="L216">        return igOperatorService;</span>
    }

    public void setIgOperatorService(InstantOperatorService igOperatorService) {
<span class="nc" id="L220">        this.igOperatorService = igOperatorService;</span>
<span class="nc" id="L221">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>