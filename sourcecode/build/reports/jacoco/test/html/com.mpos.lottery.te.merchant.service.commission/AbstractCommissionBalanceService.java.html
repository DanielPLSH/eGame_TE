<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractCommissionBalanceService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.merchant.service.commission</a> &gt; <span class="el_source">AbstractCommissionBalanceService.java</span></div><h1>AbstractCommissionBalanceService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.merchant.service.commission;

import com.mpos.lottery.te.common.util.SimpleToolkit;
import com.mpos.lottery.te.config.MLotteryContext;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.merchant.dao.BalanceTransactionsDao;
import com.mpos.lottery.te.merchant.domain.BalanceTransactions;
import com.mpos.lottery.te.merchant.domain.Merchant;
import com.mpos.lottery.te.merchant.domain.Operator;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.trans.domain.Transaction;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.math.BigDecimal;
import java.sql.Timestamp;
import java.util.Date;
import java.util.List;

import javax.annotation.Resource;

<span class="fc" id="L23">public abstract class AbstractCommissionBalanceService implements CommissionBalanceService {</span>
<span class="fc" id="L24">    private Log logger = LogFactory.getLog(AbstractCommissionBalanceService.class);</span>
    // spring dependencies
    @Resource(name = &quot;balanceTransactionsDao&quot;)
    private BalanceTransactionsDao balanceTransactionDao;

    /**
     * Calculate the commission of transaction. Below will give a sample to explain the logic, and before that we assume
     * there is a 4-level operator/merchant hierarchy.
     * &lt;p/&gt;
     * &lt;table border=&quot;1&quot;&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Level&lt;/td&gt;
     * &lt;td&gt;Name&lt;/td&gt;
     * &lt;td&gt;CreditType&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;#1&lt;/td&gt;
     * &lt;td&gt;Distributor#1&lt;/td&gt;
     * &lt;td&gt;Definite Value&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;#2&lt;/td&gt;
     * &lt;td&gt;Merchant#2&lt;/td&gt;
     * &lt;td&gt;Definite Value&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;#3&lt;/td&gt;
     * &lt;td&gt;Merchant#2A&lt;/td&gt;
     * &lt;td&gt;Definite Value&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;#4&lt;/td&gt;
     * &lt;td&gt;Operator#2A1&lt;/td&gt;
     * &lt;td&gt;Definite Value&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;/table&gt;
     * &lt;p/&gt;
     * Now if operator#2A1 sold a ticket with amount $100 and the commission rate is 1%,
     * &lt;h1&gt;Definite Operator&lt;/h1&gt;
     * If the credit type of operator#2A1 is 'definite value', TE will generate only a single balance log as below,
     * &lt;table border=&quot;1&quot;&gt;
     * &lt;tr&gt;
     * &lt;td&gt;TE_Trans_ID&lt;/td&gt;
     * &lt;td&gt;Owner_ID&lt;/td&gt;
     * &lt;td&gt;Trans_Amount&lt;/td&gt;
     * &lt;td&gt;Commission_Amount&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Sale_Trans_ID&lt;/td&gt;
     * &lt;td&gt;Operator#2A1&lt;/td&gt;
     * &lt;td&gt;100&lt;/td&gt;
     * &lt;td&gt;1&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;/table&gt;
     * &lt;b&gt;Be noted that the Owner_ID is the node who get the commission.&lt;/b&gt;
     * &lt;p/&gt;
     * Besides TE will deduct the sale balance of 'operator#2A1' by $100 as well and topup commission balance of
     * 'operator#2A1' by $1. DataConsumer will care the commission of all parent nodes of 'operator#2A1'.
     * 
     * &lt;h1&gt;Operator Use Parent&lt;/h1&gt;
     * If the credit type of both 'operator#2A1' and 'merchant#2A' is 'use parent', that says the sale will only affect
     * the sale balance of 'merchant#2'. In this case TE will generate 2 balance logs for 'operator#2A1' and
     * 'merchant#2', and it will only calculate commission for 'operator#2A1', DataConsumer will care the commission of
     * all parent nodes of 'operator#2A1'.
     * &lt;table border=&quot;1&quot;&gt;
     * &lt;tr&gt;
     * &lt;td&gt;TE_Trans_ID&lt;/td&gt;
     * &lt;td&gt;Owner_ID&lt;/td&gt;
     * &lt;td&gt;Trans_Amount&lt;/td&gt;
     * &lt;td&gt;Commission_Amount&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Sale_Trans_ID&lt;/td&gt;
     * &lt;td&gt;Operator#2A1&lt;/td&gt;
     * &lt;td&gt;100&lt;/td&gt;
     * &lt;td&gt;1&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Sale_Trans_ID&lt;/td&gt;
     * &lt;td&gt;Merchant#2&lt;/td&gt;
     * &lt;td&gt;100&lt;/td&gt;
     * &lt;td&gt;null(dataConsumer will calculate it)&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;/table&gt;
     * &lt;p/&gt;
     * TE will deduct the sale balance of 'merchant#2' by $100 as well, and doesn't need to maintain the commission
     * balance of 'operator#2A1', as it is 'use parent'.
     */
    @Override
    public void calCommission(Context&lt;?&gt; respCtx, Object operatorOrMerchant) throws ApplicationException {
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        if (!MLotteryContext.getInstance().getSysConfiguration().isSupportCommissionCalculation()) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L116">                logger.debug(&quot;System has disable the commission supports, no need to calculate commission&quot;);</span>
<span class="nc" id="L117">                return;</span>
            }
        }
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (operatorOrMerchant == null) {</span>
<span class="nc" id="L121">            return;</span>
        }
<span class="fc" id="L123">        List&lt;CommissionUnit&gt; commissionUnits = this.determineCommUnits(respCtx.getTransaction());</span>
<span class="fc" id="L124">        BigDecimal totalComm = new BigDecimal(&quot;0&quot;);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">        for (CommissionUnit commUnit : commissionUnits) {</span>
<span class="fc" id="L126">            BigDecimal totalAmount = commUnit.getTransAmount();</span>
<span class="fc" id="L127">            BigDecimal commission = SimpleToolkit.mathMultiple(commUnit.getTransAmount(), commUnit.getCommissonRate(),</span>
                    MLotteryContext.getInstance().getInt(MLotteryContext.COMMISSION_BALANCE_PRECISION));
<span class="fc" id="L129">            totalComm = totalComm.add(commission);</span>

<span class="fc" id="L131">            BalanceTransactions operatorLog = this.generateOperatorBalanceLog(respCtx.getTransaction(), respCtx</span>
                    .getTransaction().getType(), totalAmount, commUnit.getCommissonRate(), commission, commUnit
                    .getGameId(), commUnit.getPaymentType(), false);
<span class="fc" id="L134">            this.getBalanceTransactionDao().insert(operatorLog);</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">            if (operatorOrMerchant instanceof Merchant) {</span>
                // the credit type of operator is 'use parent', TE has to
                // generate a balance log of target merchant, however no need to
                // calculate commission of merchant.
<span class="fc" id="L139">                BalanceTransactions merchantLog = this.generateMerchantBalanceLog(respCtx.getTransaction(), respCtx</span>
                        .getTransaction().getType(), ((Merchant) operatorOrMerchant).getId(), totalAmount, commUnit
                        .getGameId(), commUnit.getPaymentType(), false);
<span class="fc" id="L142">                this.getBalanceTransactionDao().insert(merchantLog);</span>
            }
<span class="fc" id="L144">        }</span>
        // that says the credit type of operator is 'definite value'.
<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (operatorOrMerchant instanceof Operator) {</span>
            // update operator's commission balance.. TE only need to care
            // commission of operator, DataConsumer will be responsible of
            // commission of parent merchants.
<span class="fc" id="L150">            Operator operator = this.getBalanceTransactionDao().findById(Operator.class,</span>
                    respCtx.getTransaction().getOperatorId());
<span class="fc" id="L152">            operator.setCommisionBalance(operator.getCommisionBalance().add(totalComm));</span>
<span class="fc" id="L153">            this.getBalanceTransactionDao().update(operator);</span>
        }
<span class="fc" id="L155">    }</span>

    /**
     * Reverse the commission calculation. This service will
     * &lt;ol&gt;
     * &lt;li&gt;Mark all balance logs of original transaction(such as sale, payout etc) as 'invalid'.&lt;/li&gt;
     * &lt;li&gt;Restore the commission balance of operator if its credit type is 'definite value'.&lt;/li&gt;
     * &lt;li&gt;Generate cancellation balance log for operator and parent if operator's credit-type is 'use parent'(follow
     * the same rule as {@link #calCommission(Context, Object)}.&lt;/li&gt;
     * &lt;/ol&gt;
     */
    @Override
    public void cancelCommission(Context&lt;?&gt; respCtx, Transaction targetTrans, Object operatorOrMerchant)
            throws ApplicationException {
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        if (!MLotteryContext.getInstance().getSysConfiguration().isSupportCommissionCalculation()) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L171">                logger.debug(&quot;System has disable the commission supports, no need to calculate commission&quot;);</span>
            }
<span class="nc" id="L173">            return;</span>
        }
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (operatorOrMerchant == null) {</span>
<span class="nc" id="L176">            return;</span>
        }
        // mark all balance logs of target transaction as invalid
<span class="fc" id="L179">        this.getBalanceTransactionDao().updateBalanceTransactionsStatusByteTransactionId(targetTrans.getId());</span>

        // lookup operator balance log of target transactions
<span class="fc" id="L182">        BigDecimal totalComm = new BigDecimal(&quot;0&quot;);</span>
<span class="fc" id="L183">        List&lt;BalanceTransactions&gt; targetOperatorLogs = this.getBalanceTransactionDao().findByOwnerAndTransaction(</span>
                targetTrans.getId(), targetTrans.getOperatorId());
<span class="fc bfc" id="L185" title="All 2 branches covered.">        for (BalanceTransactions targetOperatorLog : targetOperatorLogs) {</span>
<span class="fc" id="L186">            int paymentType = BalanceTransactions.PAYMENT_TYPE_PLUSING_MONEY;</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">            if (targetOperatorLog.getPaymentType() == BalanceTransactions.PAYMENT_TYPE_PLUSING_MONEY) {</span>
<span class="fc" id="L188">                paymentType = BalanceTransactions.PAYMENT_TYPE_DEDUCTING_MONEY;</span>
            }
<span class="fc" id="L190">            BalanceTransactions operatorCancelLog = this.generateOperatorBalanceLog(respCtx.getTransaction(),</span>
                    targetOperatorLog.getTransactionType(), targetOperatorLog.getTransactionAmount(),
                    targetOperatorLog.getCommissionRate(), targetOperatorLog.getCommissionAmount(),
                    targetOperatorLog.getGameId(), paymentType, true);
<span class="fc" id="L194">            this.getBalanceTransactionDao().insert(operatorCancelLog);</span>

<span class="fc" id="L196">            totalComm = totalComm.add(targetOperatorLog.getCommissionAmount());</span>
<span class="fc" id="L197">        }</span>

<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (operatorOrMerchant instanceof Merchant) {</span>
            // the credit type of operator is 'use parent'
<span class="fc" id="L201">            List&lt;BalanceTransactions&gt; targetMerchantLogs = this.getBalanceTransactionDao().findByOwnerAndTransaction(</span>
                    targetTrans.getId(), ((Merchant) operatorOrMerchant).getId() + &quot;&quot;);
<span class="fc bfc" id="L203" title="All 2 branches covered.">            for (BalanceTransactions targetMerchantLog : targetMerchantLogs) {</span>
<span class="fc" id="L204">                int paymentType = BalanceTransactions.PAYMENT_TYPE_PLUSING_MONEY;</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">                if (targetMerchantLog.getPaymentType() == BalanceTransactions.PAYMENT_TYPE_PLUSING_MONEY) {</span>
<span class="fc" id="L206">                    paymentType = BalanceTransactions.PAYMENT_TYPE_DEDUCTING_MONEY;</span>
                }
<span class="fc" id="L208">                BalanceTransactions merchantCancelLog = this.generateMerchantBalanceLog(respCtx.getTransaction(),</span>
                        targetMerchantLog.getTransactionType(), ((Merchant) operatorOrMerchant).getId(),
                        targetMerchantLog.getTransactionAmount(), targetMerchantLog.getGameId(), paymentType, true);
<span class="fc" id="L211">                this.getBalanceTransactionDao().insert(merchantCancelLog);</span>
<span class="fc" id="L212">            }</span>
<span class="fc" id="L213">        } else {</span>
            // restore the commission balance of operator
            // update operator's commission balance
<span class="fc" id="L216">            Operator operator = this.getBalanceTransactionDao().findById(Operator.class,</span>
                    respCtx.getTransaction().getOperatorId());
<span class="fc" id="L218">            operator.setCommisionBalance(operator.getCommisionBalance().subtract(totalComm));</span>
<span class="fc" id="L219">            this.getBalanceTransactionDao().update(operator);</span>
        }
<span class="fc" id="L221">    }</span>

    // ----------------------------------------------------------
    // HELPER METHODS
    // ----------------------------------------------------------

    /**
     * Sub-implementation class should implement this method to determine the &lt;code&gt;CommissionUnit&lt;/code&gt;s. For some
     * transaction, such as 'IG batch validation', multiple &lt;code&gt;CommissionUnit&lt;/code&gt; should be returned, as it may
     * involve multiple games, and each game will be assigned different commission rate.
     */
    protected abstract List&lt;CommissionUnit&gt; determineCommUnits(Transaction transaction) throws ApplicationException;

    private final BalanceTransactions generateOperatorBalanceLog(Transaction trans, int origTransType,
            BigDecimal transAmount, BigDecimal commissionRate, BigDecimal commission, String gameId, int paymentType,
            boolean isCancel) {
<span class="fc" id="L237">        return this.generateBalanceLog(trans, origTransType, trans.getOperatorId(),</span>
                BalanceTransactions.OWNER_TYPE_OPERATOR, transAmount, commissionRate, commission, gameId, paymentType,
                isCancel);
    }

    private final BalanceTransactions generateMerchantBalanceLog(Transaction trans, int origTransType, long merchantId,
            BigDecimal transAmount, String gameId, int paymentType, boolean isCancel) {
<span class="fc" id="L244">        return this.generateBalanceLog(trans, origTransType, merchantId + &quot;&quot;, BalanceTransactions.OWNER_TYPE_MERCHANT,</span>
                transAmount, new BigDecimal(&quot;0&quot;), new BigDecimal(&quot;0&quot;), gameId, paymentType, isCancel);
    }

    private final BalanceTransactions generateBalanceLog(Transaction trans, int origTransType, String ownerId,
            int ownerType, BigDecimal transAmount, BigDecimal commissionRate, BigDecimal commission, String gameId,
            int paymentType, boolean isCancel) {
        // id of CommissonLog will be generated by underlying database
        // automatically.
<span class="fc" id="L253">        BalanceTransactions log = new BalanceTransactions();</span>
<span class="fc" id="L254">        log.setTeTransactionId(trans.getId());</span>
<span class="fc" id="L255">        log.setMerchantId(trans.getMerchantId());</span>
<span class="fc" id="L256">        log.setOperatorId(trans.getOperatorId());</span>
<span class="fc" id="L257">        log.setDeviceId(trans.getDeviceId());</span>
<span class="fc" id="L258">        log.setOwnerId(ownerId);</span>
<span class="fc" id="L259">        log.setOwnerType(ownerType);</span>
<span class="fc" id="L260">        log.setPaymentType(paymentType);</span>
<span class="fc" id="L261">        log.setTransactionType(trans.getType());</span>
<span class="fc" id="L262">        log.setOriginalTransType(origTransType);</span>
        // if (paymentType == BalanceTransactions.PAYMENT_TYPE_DEDUCTING_MONEY
        // &amp;&amp; transAmount.compareTo(new BigDecimal(&quot;0&quot;)) &gt; 0) {
        // transAmount = SimpleToolkit.mathMultiple(transAmount, new BigDecimal(&quot;-1&quot;));
        // }
        // if (paymentType == BalanceTransactions.PAYMENT_TYPE_PLUSING_MONEY
        // &amp;&amp; transAmount.compareTo(new BigDecimal(&quot;0&quot;)) &lt; 0) {
        // transAmount = SimpleToolkit.mathMultiple(transAmount, new BigDecimal(&quot;-1&quot;));
        // }
<span class="fc" id="L271">        log.setTransactionAmount(transAmount);</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">        log.setCommissionAmount(isCancel ? SimpleToolkit.mathMultiple(commission, new BigDecimal(&quot;-1&quot;), MLotteryContext</span>
                .getInstance().getInt(MLotteryContext.COMMISSION_BALANCE_PRECISION)) : commission);
<span class="fc" id="L274">        log.setCommissionRate(commissionRate);</span>
<span class="fc" id="L275">        log.setStatus(BalanceTransactions.STATUS_VALID);</span>
<span class="fc" id="L276">        log.setCreateTime(new Timestamp(new Date().getTime()));</span>
<span class="fc" id="L277">        log.setUpdateTime(log.getCreateTime());</span>
<span class="fc" id="L278">        log.setGameId(gameId);</span>
<span class="fc" id="L279">        return log;</span>
    }

    // ----------------------------------------------------------
    // SPRING DEPENDENCIES
    // ----------------------------------------------------------

    public BalanceTransactionsDao getBalanceTransactionDao() {
<span class="fc" id="L287">        return balanceTransactionDao;</span>
    }

    public void setBalanceTransactionDao(BalanceTransactionsDao balanceTransactionDao) {
<span class="nc" id="L291">        this.balanceTransactionDao = balanceTransactionDao;</span>
<span class="nc" id="L292">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>