<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UUIDServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.sequence.service.impl</a> &gt; <span class="el_source">UUIDServiceImpl.java</span></div><h1>UUIDServiceImpl.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.sequence.service.impl;

import com.mpos.lottery.te.common.util.SimpleToolkit;
import com.mpos.lottery.te.config.MLotteryContext;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.sequence.domain.Sequence;
import com.mpos.lottery.te.sequence.domain.SequenceUnique;
import com.mpos.lottery.te.sequence.domain.TicketSerialSpec;
import com.mpos.lottery.te.sequence.service.SequenceManager;
import com.mpos.lottery.te.sequence.service.UUIDService;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.math.BigInteger;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

<span class="fc" id="L22">public class UUIDServiceImpl implements UUIDService {</span>
<span class="fc" id="L23">    private Log logger = LogFactory.getLog(UUIDServiceImpl.class);</span>
<span class="fc" id="L24">    private Map&lt;String, Sequence&gt; sequenceMap = new HashMap&lt;String, Sequence&gt;(0);</span>
<span class="fc" id="L25">    private String dateFormat = &quot;yyMMdd&quot;;</span>
    private SequenceManager sequenceService;

    /**
     * Generate generatel transaction id.
     */
    public synchronized String getGeneralID() throws ApplicationException {
<span class="fc" id="L32">        String timestamp = SimpleToolkit.formatDate(new Date(), dateFormat);</span>
<span class="fc" id="L33">        BigInteger sequence = this.retrieveCurrentSeq(Sequence.NAME_GENERAL);</span>
<span class="fc" id="L34">        String maxAllowedSeq = MLotteryContext.getInstance().get(Sequence.NAME_GENERAL.toLowerCase() + &quot;.max&quot;);</span>
<span class="fc" id="L35">        String seqPrefix = MLotteryContext.getInstance().get(&quot;seq.prefix&quot;);</span>
<span class="fc" id="L36">        StringBuffer buffer = new StringBuffer().append(fillZero(2, seqPrefix)).append(timestamp)</span>
                .append(this.fillZero(maxAllowedSeq.length(), sequence.toString()));
<span class="fc" id="L38">        return buffer.toString();</span>
    }

    /**
     * Generate ticket serial No.
     */
    public synchronized String getTicketSerialNo(int saleMode, int gameType) throws ApplicationException {
<span class="fc" id="L45">        String serialNo = this.doGenerateSerialNo(saleMode, gameType, new Date(), Sequence.NAME_TICKETSERIALNO);</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L47">            logger.debug(&quot;Assemble a new ticket serial number:&quot; + serialNo);</span>
        }
<span class="fc" id="L49">        return serialNo;</span>
    }

    public synchronized String getTicketSerialNo(int gameType) throws ApplicationException {
<span class="fc" id="L53">        return this.getTicketSerialNo(TicketSerialSpec.ONLINE_MODE, gameType);</span>
    }

    /**
     * Generate reference No.
     */
    public synchronized String getReferenceNo(int saleMode) throws ApplicationException {
<span class="fc" id="L60">        Date timestamp = new Date();</span>
<span class="fc" id="L61">        Calendar calendar = Calendar.getInstance();</span>
<span class="fc" id="L62">        calendar.setTime(timestamp);</span>
<span class="fc" id="L63">        int secondOfMinute = calendar.get(Calendar.SECOND);</span>
<span class="fc" id="L64">        String referenceNo = this.doGenerateSerialNo(saleMode, secondOfMinute, new Date(), Sequence.NAME_REFERENCE_NO);</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L66">            logger.debug(&quot;Assemble a new reference No.:&quot; + referenceNo);</span>
        }
<span class="fc" id="L68">        return referenceNo;</span>
    }

    @Override
    public void reset(String sequenceName) throws ApplicationException {
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (sequenceName == null) {</span>
            // reset all sequences
<span class="nc" id="L75">            this.sequenceMap.clear();</span>
        } else {
<span class="nc" id="L77">            this.sequenceMap.remove(sequenceName);</span>
        }
<span class="nc" id="L79">    }</span>

    @Override
    public BigInteger retrieveCurrentSeq(String name) throws ApplicationException {
<span class="fc" id="L83">        BigInteger currentValue = null;</span>
<span class="fc" id="L84">        Sequence seq = sequenceMap.get(name);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (seq != null) {</span>
<span class="fc" id="L86">            currentValue = seq.getCurrentValue();</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">            if (currentValue != null) {</span>
<span class="fc" id="L88">                return currentValue;</span>
            }
        }
        // retrieve new sequence from database
<span class="fc" id="L92">        seq = this.getSequenceService().fetchNewSequence(name);</span>
        try {
<span class="fc" id="L94">            this.verifySequence(seq, MLotteryContext.getInstance().get(name.toLowerCase() + &quot;.max&quot;));</span>
<span class="nc" id="L95">        } catch (SystemException e) {</span>
<span class="nc" id="L96">            logger.warn(e.getMessage());</span>
            // retrieve the sequence again...as the system will adjust illegal
            // setting automatically
<span class="nc" id="L99">            seq = this.getSequenceService().fetchNewSequence(name);</span>
<span class="fc" id="L100">        }</span>
        // check whether the sequence is duplicated
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">        for (int i = 0; SequenceUnique.getIntance().isDulplicate(seq); i++) {</span>
            // retrieve new sequence again
<span class="nc" id="L104">            seq = this.getSequenceService().fetchNewSequence(name);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (i &gt;= 5) {</span>
<span class="nc" id="L106">                throw new SystemException(&quot;Tried the fifth time, can NOT find valid Sequence!&quot;);</span>
            }
        }

<span class="fc" id="L110">        sequenceMap.put(name, seq);</span>
<span class="fc" id="L111">        currentValue = seq.getCurrentValue();</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        if (logger.isTraceEnabled()) {</span>
<span class="nc" id="L113">            logger.trace(&quot;Get current sequence:&quot; + currentValue.intValue());</span>
        }
<span class="fc" id="L115">        return currentValue;</span>
    }

    // --------------------------------------------------
    // HELPER METHODS
    // --------------------------------------------------

    protected String doGenerateSerialNo(int saleMode, int gameType, Date timestamp, String sequenceName)
            throws ApplicationException {
<span class="fc" id="L124">        BigInteger sequence = this.retrieveCurrentSeq(sequenceName);</span>
<span class="fc" id="L125">        TicketSerialSpec serialSpec = new TicketSerialSpec(saleMode, timestamp, gameType, sequence);</span>
<span class="fc" id="L126">        return serialSpec.toSerialNo();</span>
    }

    protected void verifySequence(Sequence seq, String strMaxSequence) {
<span class="fc" id="L130">        BigInteger maxSequence = new BigInteger(strMaxSequence);</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (maxSequence.compareTo(seq.getMinValue()) &lt; 0) {</span>
<span class="nc" id="L132">            throw new SystemException(&quot;The minValue of sequence[&quot; + seq.getName() + &quot;] is greater than &quot;</span>
                    + strMaxSequence + &quot;!!!&quot;);
        }
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if (maxSequence.compareTo(seq.getMaxValue()) &lt; 0) {</span>
<span class="nc" id="L136">            throw new SystemException(&quot;The maxValue of sequence[&quot; + seq.getName() + &quot;] is greater than &quot;</span>
                    + strMaxSequence + &quot;!!!&quot;);
        }
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        if (maxSequence.compareTo(seq.getNextMin()) &lt; 0) {</span>
<span class="nc" id="L140">            throw new SystemException(&quot;The nextMin of sequence[&quot; + seq.getName() + &quot;] is greater than &quot;</span>
                    + strMaxSequence + &quot;!!!&quot;);
        }
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (maxSequence.compareTo(seq.getNextMax()) &lt; 0) {</span>
<span class="nc" id="L144">            throw new SystemException(&quot;The nextMax of sequence[&quot; + seq.getName() + &quot;] is greater than &quot;</span>
                    + strMaxSequence + &quot;!!!&quot;);
        }
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">        if (seq.getMinValue().compareTo(seq.getMaxValue()) &gt;= 0) {</span>
<span class="nc" id="L148">            throw new SystemException(&quot;The minValue(&quot; + seq.getMinValue() + &quot;) of sequence[&quot; + seq.getName()</span>
                    + &quot;] must be less than maxValue(&quot; + seq.getMaxValue() + &quot;)!!!&quot;);
        }
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (seq.getNextMin().compareTo(seq.getNextMax()) &gt; 0) {</span>
<span class="nc" id="L152">            throw new SystemException(&quot;The nextMin(&quot; + seq.getNextMin() + &quot;) of sequence[&quot; + seq.getName()</span>
                    + &quot;] must be less than or equal with nextMax(&quot; + seq.getNextMax() + &quot;)!!!&quot;);
        }
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (seq.getNextMin().compareTo(seq.getMinValue()) &lt; 0) {</span>
<span class="nc" id="L156">            throw new SystemException(&quot;The nextMin(&quot; + seq.getNextMin() + &quot;) of sequence[&quot; + seq.getName()</span>
                    + &quot;] must be greater than or equal with minValue(&quot; + seq.getMinValue() + &quot;)!!!&quot;);
        }
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">        if (seq.getNextMax().compareTo(seq.getMaxValue()) &gt; 0) {</span>
<span class="nc" id="L160">            throw new SystemException(&quot;The nextMax(&quot; + seq.getNextMax() + &quot;) of sequence[&quot; + seq.getName()</span>
                    + &quot;] must be less than or equal with maxValue(&quot; + seq.getMaxValue() + &quot;)!!!&quot;);
        }
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        if (seq.getInterval().compareTo(BigInteger.ONE) &lt; 0) {</span>
<span class="nc" id="L164">            throw new SystemException(&quot;The interval of sequence[&quot; + seq.getName()</span>
                    + &quot;] must be greater than or equals with 1 !!!&quot;);
        }
<span class="fc" id="L167">    }</span>

    /**
     * Get a zero-filled string representation of current value.
     * 
     * @param size
     *            The length of string.
     */
    public String fillZero(int size, String input) {
<span class="fc" id="L176">        StringBuffer buffer = new StringBuffer();</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">        for (int i = 0; i &lt; size; i++) {</span>
<span class="fc" id="L178">            buffer.append(&quot;0&quot;);</span>
        }
<span class="fc" id="L180">        String tmp = buffer.toString() + input;</span>
<span class="fc" id="L181">        return tmp.substring(tmp.length() - size);</span>
    }

    // --------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // --------------------------------------------------
    public SequenceManager getSequenceService() {
<span class="fc" id="L188">        return sequenceService;</span>
    }

    public void setSequenceService(SequenceManager sequenceService) {
<span class="fc" id="L192">        this.sequenceService = sequenceService;</span>
<span class="fc" id="L193">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>