<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BaseActivityReportJpaDao.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.merchant.dao</a> &gt; <span class="el_source">BaseActivityReportJpaDao.java</span></div><h1>BaseActivityReportJpaDao.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.merchant.dao;

import com.mpos.lottery.te.common.dao.BaseJpaDao;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.merchant.web.ActivityReport;
import com.mpos.lottery.te.merchant.web.ActivityReportItem;
import com.mpos.lottery.te.merchant.web.DailyActivityReport;
import com.mpos.lottery.te.trans.domain.TransactionType;

import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.persistence.Query;

<span class="fc" id="L19">public class BaseActivityReportJpaDao extends BaseJpaDao implements ActivityReportDao {</span>
    private String ticketTableName;
<span class="fc" id="L21">    private String columnMultiDrawName = &quot;MUTLI_DRAW&quot;;</span>

    @Override
    public List&lt;DailyActivityReport&gt; findActivityReport(String operatorId, Date startTime, Date endTime) {
<span class="fc" id="L25">        String strStartTime = new SimpleDateFormat(&quot;yyyyMMddHHmmss&quot;).format(startTime);</span>
<span class="fc" id="L26">        String strEndTime = new SimpleDateFormat(&quot;yyyyMMddHHmmss&quot;).format(endTime);</span>

<span class="fc" id="L28">        String sql = &quot;SELECT a.update_date,&quot; + &quot;  a.trans_type,&quot; + &quot;  a.status,&quot;</span>
                + &quot;  SUM(a.total_amount) AS total_amount,&quot; + &quot;  COUNT(a.serial_no)  AS sale_count&quot; + &quot; FROM (&quot;
                /**
                 * When a ticket is paid, its update time will be updated to payout time as well. If a ticket is sold
                 * yesterday, and claim payout today, it is definitely the sale should be counted to yesterday, so we
                 * must filter this sale by its create time here, otherwise it will be counted to today.
                 * &lt;p&gt;
                 * Use create_time as filter criteria
                 */
                + &quot;  (SELECT TO_CHAR(t.CREATE_TIME,'YYYYMMDD') AS update_date,&quot; + &quot;  t.TOTAL_AMOUNT*t.&quot;
                + this.getColumnMultiDrawName()
                + &quot; AS total_amount,&quot;
                + &quot;    t.TRANS_TYPE AS trans_type,&quot;
                + &quot;    t.SERIAL_NO AS serial_no,&quot;
                + &quot;    t.STATUS AS status&quot;
                + &quot;  FROM &quot;
                + this.getTicketTableName()
                + &quot; t&quot;
                + &quot;  WHERE t.OPERATOR_ID=:operatorId&quot;
                + &quot;  AND (t.CREATE_TIME BETWEEN to_date('&quot;
                + strStartTime
                + &quot;','YYYYMMDDHH24MISS') AND to_date('&quot;
                + strEndTime
                + &quot;','YYYYMMDDHH24MISS'))&quot;
                + &quot;  AND t.TRANS_TYPE =200&quot;
                + &quot;  AND t.TICKET_TYPE=:ticketType&quot;
                + &quot;  AND t.&quot;
                + this.getColumnMultiDrawName()
                + &quot; &gt;0&quot;
                + &quot;  )&quot;
                + &quot;UNION ALL&quot;
                /**
                 * Statistics of cancellation, use update_time as filter criteria.
                 */
                + &quot;  (SELECT TO_CHAR(t.UPDATE_TIME,'YYYYMMDD') AS update_date,&quot;
                + &quot;    t.TOTAL_AMOUNT*t.&quot;
                + this.getColumnMultiDrawName()
                + &quot; AS total_amount,&quot;
                + &quot;    t.TRANS_TYPE AS trans_type,&quot;
                + &quot;    t.SERIAL_NO AS serial_no,&quot;
                + &quot;    t.STATUS AS status&quot;
                + &quot;  FROM &quot;
                + this.getTicketTableName()
                + &quot; t&quot;
                + &quot;  WHERE t.OPERATOR_ID=:operatorId&quot;
                + &quot;  AND (t.UPDATE_TIME BETWEEN to_date('&quot;
                + strStartTime
                + &quot;','YYYYMMDDHH24MISS') AND to_date('&quot;
                + strEndTime
                + &quot;','YYYYMMDDHH24MISS'))&quot;
                + &quot;  AND t.TRANS_TYPE IN (201, 206, 210)&quot;
                + &quot;  AND t.TICKET_TYPE =:ticketType&quot;
                + &quot;  AND t.&quot;
                + this.getColumnMultiDrawName()
                + &quot; &gt;0&quot;
                + &quot;  ) ) a &quot;
                + &quot;GROUP BY a.UPDATE_DATE,&quot;
                + &quot;  a.TRANS_TYPE,&quot;
                + &quot;  a.STATUS&quot;;

<span class="fc" id="L88">        Map&lt;String, Object&gt; params = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L89">        params.put(&quot;operatorId&quot;, operatorId);</span>
<span class="fc" id="L90">        params.put(&quot;ticketType&quot;, BaseTicket.TICKET_TYPE_NORMAL);</span>

<span class="fc" id="L92">        return this.assembleGameActivityReport(sql, params);</span>
    }

    /**
     * Assemble a list of &lt;code&gt;DailyReportItem&lt;/code&gt; from the provided &lt;code&gt;sql&lt;/code&gt;, and the returned result of
     * &lt;code&gt;sql&lt;/code&gt; must be below columns and in the same order:
     * &lt;p&gt;
     * 
     * &lt;pre&gt;
     * SELECT a.update_date,
     *   a.trans_type,
     *   a.status,
     *   SUM(a.total_amount),
     *   count(a.serial_no)  
     * FROM
     *   (SELECT TO_CHAR(t.update_time,'YYYYMMDD') AS update_date,
     *     t.TOTAL_AMOUNT*t.MUTLI_DRAW             AS total_amount,
     *     t.TRANS_TYPE                            AS trans_type,
     *     t.SERIAL_NO as serial_no,
     *     t.STATUS AS status
     *   FROM TE_TICKET t
     *   WHERE t.OPERATOR_ID='OPERATOR-111'
     *   AND t.UPDATE_TIME BETWEEN to_date('20131212000000','YYYYMMDDHH24MISS') AND to_date('20131214000000','YYYYMMDDHH24MISS')
     *   AND t.TICKET_TYPE=1
     *   AND t.MUTLI_DRAW &gt;0
     *   ) a
     * GROUP BY a.update_time,
     *   a.trans_type,
     *   a.status
     * &lt;/pre&gt;
     * 
     * !! Above SQL has been proven that is incorrect, forget it.
     * 
     * @param sql
     *            The sql to query daily summary of a given game.
     * @param params
     *            the parameter for sql.
     * @return the list of daily summary report.
     */
    @SuppressWarnings(&quot;deprecation&quot;)
    protected List&lt;DailyActivityReport&gt; assembleGameActivityReport(final String sql, final Map&lt;String, Object&gt; params) {
        // execute query
<span class="fc" id="L134">        Query query = this.getEntityManager().createNativeQuery(sql);</span>
        // set parameters
<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (Map.Entry&lt;String, Object&gt; entry : params.entrySet()) {</span>
<span class="fc" id="L137">            query.setParameter(entry.getKey(), entry.getValue());</span>
<span class="fc" id="L138">        }</span>

<span class="fc" id="L140">        List rows = query.getResultList();</span>
<span class="fc" id="L141">        ActivityReport activityReport = new ActivityReport();</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">        for (Object row : rows) {</span>
<span class="fc" id="L143">            Object[] columns = (Object[]) row;</span>
            // assemble activity report.
<span class="fc" id="L145">            String date = (String) columns[0];</span>
<span class="fc" id="L146">            DailyActivityReport dailyReport = activityReport.getReportByDate(date, true);</span>
<span class="fc" id="L147">            int transType = ((BigDecimal) columns[1]).intValue();</span>
<span class="fc" id="L148">            int status = ((BigDecimal) columns[2]).intValue();</span>
            /**
             * If a multi-draw ticket has been paid, and a new ticket is generated, the status of new generated ticket
             * will be 1(accepted) and trans type will be 'payout', this ticket record must be ignored, otherwise will
             * be counted into payout statistics.
             */
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">            if (transType == TransactionType.PAYOUT.getRequestType()) {</span>
<span class="nc" id="L155">                continue;</span>
            }
<span class="fc bfc" id="L157" title="All 2 branches covered.">            if (status == BaseTicket.STATUS_CANCEL_DECLINED) {</span>
                // for cancellation, there may be two rows with
                // same trans_type 201, however the one is
                // 'canceled' and other is cancel declined,
                // these 2 rows must be recorded in 2 activity
                // report item.
<span class="fc" id="L163">                transType = TransactionType.CANCEL_DECLINED.getRequestType();</span>
            }
            /*
             * If a multi-draw ticket has been paid, the status of payout-started draw will be 5(paid), however the
             * status of tickets associating with active game instances will be 0(invalid)
             */
<span class="fc" id="L169">            ActivityReportItem reportItem = dailyReport.getReportItemByTransType(transType, true);</span>
<span class="fc" id="L170">            reportItem.setAmount(reportItem.getAmount().add((BigDecimal) columns[3]));</span>
<span class="fc" id="L171">            reportItem.setNumberOfTrans(reportItem.getNumberOfTrans() + ((BigDecimal) columns[4]).intValue());</span>
<span class="fc" id="L172">        }</span>

<span class="fc" id="L174">        return activityReport.getDailyActivityReports();</span>
    }

    public String getTicketTableName() {
<span class="fc" id="L178">        return ticketTableName;</span>
    }

    public void setTicketTableName(String ticketTableName) {
<span class="fc" id="L182">        this.ticketTableName = ticketTableName;</span>
<span class="fc" id="L183">    }</span>

    public String getColumnMultiDrawName() {
<span class="fc" id="L186">        return columnMultiDrawName;</span>
    }

    public void setColumnMultiDrawName(String columnMultiDrawName) {
<span class="fc" id="L190">        this.columnMultiDrawName = columnMultiDrawName;</span>
<span class="fc" id="L191">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>