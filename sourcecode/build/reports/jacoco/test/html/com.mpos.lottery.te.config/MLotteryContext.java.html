<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MLotteryContext.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.config</a> &gt; <span class="el_source">MLotteryContext.java</span></div><h1>MLotteryContext.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.config;

import com.mpos.lottery.te.config.dao.SysConfigurationDao;
import com.mpos.lottery.te.config.exception.SystemException;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.beans.factory.BeanFactory;

import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.util.Arrays;
import java.util.Properties;
import java.util.Set;

/**
 * Load properties from a customized properties file. This class follows the singleton design pattern.
 */
public class MLotteryContext {
<span class="fc" id="L21">    private Log logger = LogFactory.getLog(MLotteryContext.class);</span>

    public static final String ENTRY_BEAN_WORKINGKEYDAO = &quot;spring.workingkeydao.id&quot;;
    public static final String ENTRY_BEAN_SERVICEFACADE = &quot;spring.servicefacade.id&quot;;
    public static final String ENTRY_BEAN_DATASOURCE = &quot;spring.datasource.id&quot;;
    public static final String ENTRY_BEAN_TRANSACTION_RETRY_LOG = &quot;spring.transactionretrylogdao.id&quot;;
    public static final String ENTRY_BEAN_SYSCONFDAO = &quot;spring.sysconfigurationdao.id&quot;;
    public static final String ENTRY_BEAN_LOTTOOPDAO = &quot;spring.lottooperatorparameter.id&quot;;
    public static final String ENTRY_BEAN_GAMEDAO = &quot;spring.gamedao.id&quot;;
    public static final String ENTRY_BEAN_MERCHANTDAO = &quot;spring.merchantdao.id&quot;;
    public static final String ENTRY_BEAN_OPERATORDAO = &quot;spring.operatordao.id&quot;;
    public static final String ENTRY_BEAN_BASEDAO = &quot;spring.basejpadao&quot;;
    public static final String ENTRY_BEAN_OPERATORCOMMISSIONDAO = &quot;spring.operatorcommissiondao.id&quot;;
    public static final String ENTRY_BEAN_BINGOGAMEDRAWDAO = &quot;spring.bingogameDrawDao.id&quot;;
    public static final String ENTRY_BEAN_JOB_SCHEDULER = &quot;spring.jobscheduler.id&quot;;

    public static final String ENTRY_PROTOCAL_VERSION = &quot;protocal.version&quot;;
    public static final String ENTRY_DATAFORMAT_TIMESTAMP = &quot;dataformat.timestamp&quot;;
    public static final String ENTRY_ERRORCODE = &quot;errorcode.&quot;;
    public static final String ENTRY_SQLLOG_ENABLE = &quot;sqllog.enable&quot;;
    public static final String COMMISSION_BALANCE_PRECISION = &quot;commission.balance.precision&quot;;

    // load resource from classpath
    private static final String RESOURCE_CLASSPATH = &quot;classpath&quot;;
    // load resource from file path.
    private static final String RESOURCE_FILE = &quot;file&quot;;
    private static final String RESOURCE_DELIM = &quot;:&quot;;
    private static final String GLOBAL_KEY_PREFIX = &quot;app.config.&quot;;

    private static MLotteryContext instance;
<span class="fc" id="L51">    private String defaultPropertiesFile = &quot;classpath:mlottery_te.properties&quot;;</span>
    // private String xmlmappingFile = &quot;classpath:mlottery_xmlmapping.properties&quot;;
    private Properties appProp;
    // private Properties xmlmappingProp;
    private BeanFactory beanFactory;

    /**
     * Return a singleton instance.
     */
    public static synchronized MLotteryContext getInstance() {
        try {
<span class="fc bfc" id="L62" title="All 2 branches covered.">            if (instance == null) {</span>
<span class="fc" id="L63">                instance = new MLotteryContext();</span>
            }
<span class="fc" id="L65">            return instance;</span>
<span class="nc" id="L66">        } catch (Exception e) {</span>
<span class="nc" id="L67">            throw new RuntimeException(e);</span>
        }
    }

    /**
     * Get a int-type value.
     * 
     * @throws IllegalArgumentException
     *             if no key defined or the value isn't int type.
     */
    public int getInt(String key) {
<span class="fc" id="L78">        String tmp = this.get(key);</span>
        try {
<span class="fc" id="L80">            return Integer.parseInt(tmp);</span>
<span class="fc" id="L81">        } catch (Exception e) {</span>
<span class="fc" id="L82">            throw new IllegalArgumentException(&quot;The entry(key=&quot; + key + &quot;,value=&quot; + tmp + &quot;) is not INT type.&quot;);</span>
        }
    }

    /**
     * Get a int-type value. If no key defined, the default value will be returned.
     * 
     * @throws IllegalArgumentException
     *             if the value isn't int type.
     */
    public int getInt(String key, int defaultValue) {
<span class="fc" id="L93">        String tmp = this.getWithNull(key);</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        if (tmp == null) {</span>
<span class="fc" id="L95">            return defaultValue;</span>
        }
        try {
<span class="fc" id="L98">            return Integer.parseInt(tmp);</span>
<span class="nc" id="L99">        } catch (Exception e) {</span>
<span class="nc" id="L100">            throw new IllegalArgumentException(&quot;The entry(key=&quot; + key + &quot;,value=&quot; + tmp + &quot;) is not INT type.&quot;);</span>
        }
    }

    /**
     * Get a boolean-type value.
     * 
     * @throws IllegalArgumentException
     *             if no key defined or the value isn't boolean type.
     */
    public boolean getBoolean(String key) {
<span class="nc" id="L111">        String value = this.get(key);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (value != null) {</span>
<span class="nc" id="L113">            value = value.trim();</span>
        }
<span class="nc bnc" id="L115" title="All 4 branches missed.">        if (value != null &amp;&amp; value.equalsIgnoreCase(&quot;true&quot;)) {</span>
<span class="nc" id="L116">            return true;</span>
        }
<span class="nc" id="L118">        return false;</span>
    }

    /**
     * Get a boolean-type value. If no key defined, the default value will be returned.
     * 
     * @throws IllegalArgumentException
     *             if the value isn't boolean type.
     */
    public boolean getBoolean(String key, boolean defaultValue) {
<span class="fc" id="L128">        String value = appProp.getProperty(key);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        if (value != null) {</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">            if (value.trim().equalsIgnoreCase(&quot;true&quot;)) {</span>
<span class="fc" id="L131">                return true;</span>
            } else {
<span class="nc" id="L133">                return false;</span>
            }
        } else {
<span class="nc" id="L136">            return defaultValue;</span>
        }
    }

    /**
     * Get a double-type value.
     * 
     * @throws IllegalArgumentException
     *             if no key defined or the value isn't double type.
     */
    public double getDouble(String key) {
<span class="nc" id="L147">        String tmp = this.get(key);</span>
        try {
<span class="nc" id="L149">            return Double.parseDouble(tmp);</span>
<span class="nc" id="L150">        } catch (Exception e) {</span>
<span class="nc" id="L151">            throw new IllegalArgumentException(&quot;The entry(key=&quot; + key + &quot;,value=&quot; + tmp + &quot;) is not DOUBLE type.&quot;);</span>
        }
    }

    /**
     * Get a string-type value.
     * 
     * @throws IllegalArgumentException
     *             if the key doesn't exist.
     */
    public String get(String key) {
<span class="fc" id="L162">        String value = appProp.getProperty(key);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L164">            throw new IllegalArgumentException(&quot;can NOT find entry(&quot; + key + &quot;) in properties file:&quot;</span>
                    + this.defaultPropertiesFile);
        }
<span class="fc" id="L167">        return value;</span>
    }

    /**
     * Get a string-type value. If no key exist, the default value will be returned.
     */
    public String get(String key, String defaultValue) {
<span class="nc" id="L174">        String value = this.getWithNull(key);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        return (value == null) ? defaultValue : value;</span>
    }

    public String getWithNull(String key) {
<span class="fc" id="L179">        return this.appProp.getProperty(key);</span>
    }

    public BeanFactory getBeanFactory() {
<span class="fc" id="L183">        return beanFactory;</span>
    }

    public void setBeanFactory(BeanFactory beanFactory) {
<span class="fc" id="L187">        this.beanFactory = beanFactory;</span>
<span class="fc" id="L188">    }</span>

    // -----------------------------------------------------
    // BUSINESS METHODS WRAPPER
    // -----------------------------------------------------

    public String getTimestampFormat() {
<span class="fc" id="L195">        return this.get(ENTRY_DATAFORMAT_TIMESTAMP);</span>
    }

    public String getTriperDesIV() {
<span class="fc" id="L199">        return this.get(&quot;triperdes.iv&quot;);</span>
    }

    public String getInstantTicketSerialNoFormat() {
<span class="fc" id="L203">        return this.get(&quot;dataformat.instantticket.serialno&quot;);</span>
    }

    public String getDefaultEncoding() {
<span class="fc" id="L207">        return this.get(&quot;default.encoding&quot;);</span>
    }

    public String getMappingFile(int transType) {
<span class="nc" id="L211">        return this.getMappingFile(transType, null, null);</span>
    }

    /**
     * Lookup xml mapping file of a java class. The lookup order will be as below:
     * &lt;ol&gt;
     * &lt;li&gt;gameType+transType+protocolVersion&lt;/li&gt;
     * &lt;li&gt;transType+protocolVersion&lt;/li&gt;
     * &lt;li&gt;gameType+transType&lt;/li&gt;
     * &lt;li&gt;transType&lt;/li&gt;
     * &lt;/ol&gt;
     */
    public String getMappingFile(int transType, String protocolVersion, String gameType) {
<span class="fc" id="L224">        String key = gameType + &quot;.transtype.&quot; + transType + &quot;.&quot; + protocolVersion;</span>
<span class="fc" id="L225">        String value = this.getWithNull(key);</span>
<span class="pc bpc" id="L226" title="1 of 4 branches missed.">        if (value != null &amp;&amp; logger.isDebugEnabled()) {</span>
<span class="fc" id="L227">            logger.debug(&quot;find mapping file definition(&quot; + value + &quot;) by key(&quot; + key + &quot;).&quot;);</span>
        }
<span class="fc bfc" id="L229" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L230">            key = &quot;transtype.&quot; + transType + &quot;.&quot; + protocolVersion;</span>
<span class="fc" id="L231">            value = this.getWithNull(key);</span>
<span class="pc bpc" id="L232" title="3 of 4 branches missed.">            if (value != null &amp;&amp; logger.isDebugEnabled()) {</span>
<span class="nc" id="L233">                logger.debug(&quot;find mapping file definition(&quot; + value + &quot;) by key(&quot; + key + &quot;).&quot;);</span>
            }
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">            if (value == null) {</span>
<span class="fc" id="L236">                key = gameType + &quot;.transtype.&quot; + transType;</span>
<span class="fc" id="L237">                value = this.getWithNull(key);</span>
<span class="pc bpc" id="L238" title="1 of 4 branches missed.">                if (value != null &amp;&amp; logger.isDebugEnabled()) {</span>
<span class="fc" id="L239">                    logger.debug(&quot;find mapping file definition(&quot; + value + &quot;) by key(&quot; + key + &quot;).&quot;);</span>
                }
<span class="fc bfc" id="L241" title="All 2 branches covered.">                if (value == null) {</span>
<span class="fc" id="L242">                    key = &quot;transtype.&quot; + transType;</span>
<span class="fc" id="L243">                    value = this.appProp.getProperty(key);</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">                    if (value == null) {</span>
                        // refer to bug#4746
<span class="nc" id="L246">                        throw new SystemException(SystemException.CODE_UNSUPPORTED_TRANSTYPE,</span>
                                &quot;Unsupported transaction type(transType:&quot; + transType + &quot;, protocolVerion:&quot;
                                        + protocolVersion + &quot;, gameType:&quot; + gameType
                                        + &quot;) - NO mapping file found by key(&quot; + key + &quot;)&quot;);
                    } else {
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">                        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L252">                            logger.debug(&quot;find mapping file definition(&quot; + value + &quot;) by key(&quot; + key + &quot;).&quot;);</span>
                        }
                    }
                }
            }
        }
<span class="fc" id="L258">        return value;</span>
    }

    /**
     * Get the port of protocol(http/https), which is defined by Tomcat(server.xml)
     */
    public int getProtocolPort(String protocol) {
<span class="nc" id="L265">        protocol = protocol.toLowerCase();</span>
<span class="nc" id="L266">        return this.getInt(&quot;port.&quot; + protocol);</span>
    }

    public String getSelectedNumberFormat(int gameType, int betOption) {
<span class="fc" id="L270">        return this.get(gameType + &quot;.selectednumber.&quot; + betOption);</span>
    }

    // add by jason for bingo
    public String getbingoNumberFormat() {
<span class="nc" id="L275">        return this.get(&quot;bingo.selectednumber&quot;);</span>
    }

    public int getWaitLockTime() {
<span class="fc" id="L279">        return this.getInt(&quot;database.waitforlock&quot;);</span>
    }

    public String getIgnoredPIN() {
<span class="fc" id="L283">        return this.get(&quot;ticket.pin.ignored&quot;);</span>
    }

    public SysConfiguration getSysConfiguration() {
        // set SysConfiguration
<span class="fc" id="L288">        SysConfigurationDao sysConfDao = (SysConfigurationDao) this.beanFactory.getBean(this</span>
                .get(MLotteryContext.ENTRY_BEAN_SYSCONFDAO));
<span class="fc" id="L290">        SysConfiguration sysConf = sysConfDao.getSysConfiguration();</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        if (sysConf == null) {</span>
<span class="nc" id="L292">            throw new SystemException(&quot;can NOT find System-Configuration!&quot;);</span>
        }
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">        if (logger.isTraceEnabled()) {</span>
<span class="nc" id="L295">            logger.trace(&quot;Found system configuration: &quot; + sysConf);</span>
        }
<span class="fc" id="L297">        return sysConf;</span>
    }

    // -----------------------------------------------------
    // PRIVATE METHODS
    // -----------------------------------------------------

<span class="fc" id="L304">    private MLotteryContext() throws Exception {</span>
        // load global configuration property file
<span class="fc" id="L306">        Properties propFiles = new Properties();</span>
<span class="fc" id="L307">        InputStream propInputStream = openInputStream(defaultPropertiesFile);</span>
<span class="fc" id="L308">        propFiles.load(propInputStream);</span>
<span class="fc" id="L309">        propInputStream.close();</span>

<span class="fc" id="L311">        this.appProp = new Properties();</span>
<span class="fc" id="L312">        Set&lt;Object&gt; keyset = propFiles.keySet();</span>
        // sort the key to make sure the module configuration files will be loaded as pre-defined order.
<span class="fc" id="L314">        String[] keys = new String[keyset.size()];</span>
<span class="fc" id="L315">        keyset.toArray(keys);</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">        for (String key : keys) {</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">            if (!key.startsWith(GLOBAL_KEY_PREFIX)) {</span>
<span class="nc" id="L318">                throw new RuntimeException(&quot;Illegal entry key:&quot; + key);</span>
            }
        }

<span class="fc" id="L322">        int[] orders = new int[keys.length];</span>
<span class="fc bfc" id="L323" title="All 2 branches covered.">        for (int i = 0; i &lt; keys.length; i++) {</span>
<span class="fc" id="L324">            orders[i] = Integer.parseInt(keys[i].substring(GLOBAL_KEY_PREFIX.length()));</span>
        }
<span class="fc" id="L326">        Arrays.sort(orders);</span>

<span class="fc bfc" id="L328" title="All 2 branches covered.">        for (int order : orders) {</span>
<span class="fc" id="L329">            String propFile = propFiles.getProperty(GLOBAL_KEY_PREFIX + order);</span>
<span class="fc" id="L330">            logger.debug(&quot;Load module property file[&quot; + order + &quot;]:&quot; + propFile);</span>
<span class="fc" id="L331">            appProp.load(Thread.currentThread().getContextClassLoader().getResourceAsStream(propFile));</span>
        }
<span class="fc" id="L333">    }</span>

    /**
     * Open a input stream from classpath or filepath.
     */
    private InputStream openInputStream(String propFile) throws Exception {
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">        if (propFile.startsWith(RESOURCE_CLASSPATH)) {</span>
<span class="fc" id="L340">            ClassLoader cl = Thread.currentThread().getContextClassLoader();</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">            if (cl == null) {</span>
                // support for jre1.3 or below
<span class="nc" id="L343">                cl = this.getClass().getClassLoader();</span>
            }
<span class="fc" id="L345">            return cl.getResourceAsStream(extract(propFile));</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">        } else if (propFile.startsWith(RESOURCE_FILE)) {</span>
<span class="nc" id="L347">            File file = new File(extract(propFile));</span>
<span class="nc" id="L348">            return new FileInputStream(file);</span>
        } else {
<span class="nc" id="L350">            throw new IllegalStateException(&quot;Unsupport resource type: &quot; + propFile);</span>
        }
    }

    private String extract(String propFile) {
<span class="fc" id="L355">        int index = propFile.indexOf(RESOURCE_DELIM);</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">        if (index == -1) {</span>
<span class="nc" id="L357">            throw new IllegalStateException(&quot;Wrong format of properties file path:&quot; + propFile);</span>
        }
<span class="fc" id="L359">        return propFile.substring(index + 1);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>