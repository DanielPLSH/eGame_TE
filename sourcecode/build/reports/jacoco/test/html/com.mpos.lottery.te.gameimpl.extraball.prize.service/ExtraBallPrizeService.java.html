<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ExtraBallPrizeService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.extraball.prize.service</a> &gt; <span class="el_source">ExtraBallPrizeService.java</span></div><h1>ExtraBallPrizeService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.extraball.prize.service;

import com.mpos.lottery.te.common.dao.BaseJpaDao;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.extraball.prize.ExtraBallWinningItem;
import com.mpos.lottery.te.gameimpl.extraball.prize.support.PayoutStrategy;
import com.mpos.lottery.te.gameimpl.extraball.prize.support.PayoutStrategyFactory;
import com.mpos.lottery.te.gameimpl.extraball.prize.web.Prize;
import com.mpos.lottery.te.gameimpl.extraball.prize.web.PrizeItem;
import com.mpos.lottery.te.gameimpl.extraball.sale.ExtraBallGameInstance;
import com.mpos.lottery.te.gameimpl.extraball.sale.ExtraBallOperationParameter;
import com.mpos.lottery.te.gameimpl.extraball.sale.ExtraBallTicket;
import com.mpos.lottery.te.gameimpl.lotto.draw.LottoOperationParameter;
import com.mpos.lottery.te.gameimpl.lotto.draw.domain.LottoGameInstance;
import com.mpos.lottery.te.gameimpl.lotto.sale.domain.LottoTicket;
import com.mpos.lottery.te.gamespec.game.BaseGameInstance;
import com.mpos.lottery.te.gamespec.game.BaseOperationParameter;
import com.mpos.lottery.te.gamespec.game.Game;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.gamespec.game.dao.BaseGameInstanceDao;
import com.mpos.lottery.te.gamespec.prize.NewPrintTicket;
import com.mpos.lottery.te.gamespec.prize.Payout;
import com.mpos.lottery.te.gamespec.prize.dao.BaseWinningItemDao;
import com.mpos.lottery.te.gamespec.prize.dao.NewPrintTicketDao;
import com.mpos.lottery.te.gamespec.prize.dao.PayoutDao;
import com.mpos.lottery.te.gamespec.prize.service.TaxService;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.gamespec.sale.dao.BaseEntryDao;
import com.mpos.lottery.te.gamespec.sale.dao.BaseTicketDao;
import com.mpos.lottery.te.merchant.service.CreditService;
import com.mpos.lottery.te.merchant.service.MerchantService;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.port.domain.router.RoutineKey;
import com.mpos.lottery.te.sequence.service.UUIDService;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.trans.domain.TransactionType;
import com.mpos.lottery.te.trans.domain.logic.AbstractReversalOrCancelStrategy;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

<span class="fc" id="L47">public class ExtraBallPrizeService extends AbstractReversalOrCancelStrategy implements PrizeService {</span>
<span class="fc" id="L48">    protected Log logger = LogFactory.getLog(ExtraBallPrizeService.class);</span>
    // SPRINT DEPENDENCIES
    private BaseTicketDao baseTicketDao;
    private BaseEntryDao baseEntryDao;
    private BaseGameInstanceDao baseGameInstanceDao;
    private BaseWinningItemDao baseWinningItemDao;
    private BaseJpaDao baseJpaDao;
    private PayoutDao payoutDao;
    private UUIDService uuidService;
    private PayoutStrategyFactory payoutStrategyFactory;
    private CreditService creditService;
    private MerchantService merchantService;
    // private PrizeGroupItemDao prizeGroupItemDao;
    // private PrizeLevelDao prizeLevelDao;
    private TaxService taxService;
    private NewPrintTicketDao newPrintTicketDao;

    @Override
    public boolean cancelOrReverse(Context&lt;?&gt; respCtx, Transaction targetTrans) throws ApplicationException {
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (TransactionType.PAYOUT.getRequestType() != targetTrans.getType()) {</span>
<span class="nc" id="L68">            throw new SystemException(&quot;can't reverse a transaction of type:&quot; + targetTrans.getType());</span>
        }

<span class="nc" id="L71">        List&lt;Payout&gt; payouts = this.getPayoutDao().getByTransactionAndStatus(targetTrans.getId(), Payout.STATUS_PAID);</span>
        // calculate credit amount
<span class="nc" id="L73">        BigDecimal credit = new BigDecimal(&quot;0&quot;);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        for (Payout payout : payouts) {</span>
            // only care about amount after tax.
<span class="nc" id="L76">            credit = credit.add(payout.getTotalAmount());</span>
<span class="nc" id="L77">            payout.setStatus(Payout.STATUS_REVERSED);</span>
<span class="nc" id="L78">            this.getPayoutDao().update(payout);</span>
<span class="nc" id="L79">        }</span>
        // restore the status of multiple-draw ticket, or the winning analysis
        // process
        // will ignore these tickets.
<span class="nc" id="L83">        String ticketSerialNo = targetTrans.getTicketSerialNo();</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (ticketSerialNo == null) {</span>
<span class="nc" id="L85">            throw new SystemException(&quot;transacion(payout).ticketserialNo can NOT be null&quot;);</span>
        }
<span class="nc" id="L87">        List&lt;ExtraBallTicket&gt; tickets = this.getBaseTicketDao().findBySerialNo(ExtraBallTicket.class, ticketSerialNo,</span>
                true);
<span class="nc bnc" id="L89" title="All 2 branches missed.">        for (ExtraBallTicket ticket : tickets) {</span>
            // only 'paid' ticket will be restored
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if (BaseTicket.STATUS_PAID == ticket.getStatus()) {</span>
<span class="nc" id="L92">                ticket.setStatus(LottoTicket.STATUS_ACCEPTED);</span>
<span class="nc" id="L93">                this.getBaseTicketDao().update(ticket);</span>
            }
<span class="nc" id="L95">        }</span>
<span class="nc" id="L96">        this.reverseNewPrintTicket(ticketSerialNo);</span>
        // if
        // (MLotteryContext.getInstance().getSysConfiguration().isRestoreCreditLevelWhenPayout())
        // {
        // restore credit amount
<span class="nc" id="L101">        this.getCreditService().credit(respCtx.getTransaction().getOperatorId(),</span>
                respCtx.getTransaction().getMerchantId(), credit, respCtx.getTransaction().getGameId(), false, false,
                false);

<span class="nc" id="L105">        return false;</span>
    }

    /**
     * Customize the routine key for &lt;code&gt;ReversalOrCancelStrategy&lt;/code&gt;.
     */
    @Override
    public RoutineKey supportedReversalRoutineKey() {
<span class="fc" id="L113">        return new RoutineKey(Game.TYPE_EXTRABALL, TransactionType.PAYOUT.getRequestType(), null);</span>
    }

    @Override
    public Prize enquiry(Context&lt;?&gt; respCtx, BaseTicket clientTicket) throws ApplicationException {
<span class="nc" id="L118">        ExtraBallTicket ticket = (ExtraBallTicket) clientTicket;</span>
<span class="nc" id="L119">        List&lt;ExtraBallTicket&gt; dbTickets = this.assemblePhysicalTicket(respCtx, ticket);</span>
        // assemble the prize information
<span class="nc" id="L121">        return this.assemblePrize(dbTickets, ticket, true);</span>
    }

    @Override
    public Prize payout(Context&lt;?&gt; respCtx, BaseTicket clientTicket) throws ApplicationException {
<span class="nc" id="L126">        ExtraBallTicket ticket = (ExtraBallTicket) clientTicket;</span>
<span class="nc" id="L127">        List&lt;ExtraBallTicket&gt; dbTickets = this.assemblePhysicalTicket(respCtx, ticket);</span>

<span class="nc" id="L129">        this.beforeCalculatePrize(dbTickets, ticket);</span>
        // assemble the prize information
<span class="nc" id="L131">        Prize prize = this.assemblePrize(dbTickets, ticket, true);</span>
<span class="nc" id="L132">        this.beforePayout(respCtx, dbTickets.get(0), prize);</span>

        // retrieve lotto operator parameter
<span class="nc" id="L135">        PayoutStrategy strategy = this.getPayoutStrategyFactory().lookupPayoutStrategy(</span>
                ticket.getGameInstance().getGame().getType(), prize.getPayoutMode());
<span class="nc" id="L137">        strategy.payout(respCtx, prize);</span>

        // update credit level of merchant
<span class="nc" id="L140">        BigDecimal creditAmount = prize.getPrizeAmount().subtract(prize.getTaxAmount());</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (prize.getReturnAmount() != null) {</span>
<span class="nc" id="L142">            creditAmount = creditAmount.add(prize.getReturnAmount());</span>
        }
        // retrieve game identifier
<span class="nc" id="L145">        String gameId = prize.getWinningTicket().getGameInstance().getGame().getId();</span>
<span class="nc" id="L146">        this.getCreditService().credit(respCtx.getTransaction().getOperatorId(),</span>
                respCtx.getTransaction().getMerchantId(), creditAmount, gameId, true, false, false);
<span class="nc" id="L148">        return prize;</span>
    }

    @Override
    public void confirmPayout(Context&lt;?&gt; respCtx, BaseTicket clientTicket) throws ApplicationException {
<span class="nc" id="L153">        List&lt;ExtraBallTicket&gt; dbTickets = this.assemblePhysicalTicket(respCtx, clientTicket);</span>
<span class="nc" id="L154">        BaseTicket boughtTicket = dbTickets.get(0);</span>
<span class="nc" id="L155">        boughtTicket.setGameInstance(this.getBaseGameInstanceDao().findById(ExtraBallGameInstance.class,</span>
                boughtTicket.getGameInstance().getId(), false));
<span class="nc" id="L157">        BaseOperationParameter operationParam = this.getBaseJpaDao().findById(ExtraBallOperationParameter.class,</span>
                boughtTicket.getGameInstance().getGame().getOperatorParameterId());

        /**
         * check if the ticket has been payed. Anyway if a ticket has been payed, the first ticket record of
         * multiple-draw should be 'payed' status.
         */
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (LottoTicket.STATUS_PAID == boughtTicket.getStatus()) {</span>
            // BigDecimal refundAmount = new BigDecimal(&quot;0&quot;);
<span class="nc bnc" id="L166" title="All 2 branches missed.">            for (ExtraBallTicket ticket : dbTickets) {</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">                if (LottoTicket.STATUS_ACCEPTED == ticket.getStatus()) {</span>
                    // if the status of game instance is 'in progress of winning
                    // analysis' or 'payout started',
<span class="nc" id="L170">                    int drawState = ticket.getGameInstance().getState();</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">                    if (LottoGameInstance.STATE_WINANALYSIS_STARTED == drawState</span>
                            || LottoGameInstance.STATE_PAYOUT_STARTED == drawState) {
                        // tickets have joined winning analysis...absorption
                    } else {
<span class="nc bnc" id="L175" title="All 2 branches missed.">                        ticket.setStatus((operationParam.getPayoutMode() == LottoOperationParameter.PAYOUTMODE_REFUND)</span>
                                ? LottoTicket.STATUS_RETURNED
                                : LottoTicket.STATUS_INVALID);
<span class="nc" id="L178">                        ticket.setCountInPool(false);</span>
<span class="nc" id="L179">                        ticket.setUpdateTime(new Date());</span>
<span class="nc" id="L180">                        this.getBaseTicketDao().update(ticket);</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">                        if (operationParam.getPayoutMode() == LottoOperationParameter.PAYOUTMODE_PRINTNEWTICKET) {</span>
                            // update NewPrintTicket
<span class="nc" id="L184">                            NewPrintTicket newTicket = this.getNewPrintTicketDao().getByOldTicket(ticket.getSerialNo());</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">                            if (newTicket != null) {</span>
<span class="nc" id="L186">                                newTicket.setStatus(NewPrintTicket.STATUS_CONFIRMED);</span>
<span class="nc" id="L187">                                this.getNewPrintTicketDao().update(newTicket);</span>
                            }
                        }
                    }
                }
<span class="nc" id="L192">            }</span>
        } else {
<span class="nc" id="L194">            throw new ApplicationException(SystemException.CODE_CONFIRM_NONPAYEDTIKCET, &quot;LottoTicket(serialNo=&quot;</span>
                    + clientTicket.getSerialNo() + &quot;) hasn't been paid, can NOT confim refund.&quot;);
        }
<span class="nc" id="L197">    }</span>

    // -------------------------------------------------------------
    // HELPER METHODS
    // -------------------------------------------------------------

    /**
     * Verify pre-conditions before real payout.
     */
    protected void beforePayout(Context&lt;?&gt; respCtx, ExtraBallTicket hostTicket, Prize prize)
            throws ApplicationException {
        // - check max payout amount of merchant
<span class="nc" id="L209">        this.getMerchantService().allowPayout(respCtx, hostTicket.getGameInstance().getGame(), null,</span>
                prize.getActualAmount());

        // TODO - check whether the merchant has priviledge to pay this prize
        // level
        // int gameType = physicalTicket.getGameInstance().getGame().getType();
        // if (new BigDecimal(&quot;0&quot;).compareTo(prize.getPrizeAmount()) != 0) {
        // // win normal prize
        // this.getMerchantService().allowPayout(respCtx.getTransaction().getMerchantId(),
        // prize.getWinnedPrizeLevels(), gameType,
        // PrizeGroupItem.GROUP_TYPE_LOTTO);
        // }
<span class="nc" id="L221">    }</span>

    protected void reverseNewPrintTicket(String ticketSerialNo) throws ApplicationException {
        // set new printed ticket to false
<span class="nc" id="L225">        NewPrintTicket newTicket = this.getNewPrintTicketDao().getByOldTicket(ticketSerialNo);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (newTicket != null) {</span>
<span class="nc" id="L227">            List&lt;ExtraBallTicket&gt; newTickets = this.getBaseTicketDao().findBySerialNo(ExtraBallTicket.class,</span>
                    newTicket.getNewTicketSerialNo(), true);
<span class="nc bnc" id="L229" title="All 2 branches missed.">            if (newTickets.size() &gt; 0) {</span>
<span class="nc" id="L230">                BaseGameInstance gameInstance = this.getBaseGameInstanceDao().findById(ExtraBallGameInstance.class,</span>
                        newTickets.get(0).getGameInstance().getId());
<span class="nc" id="L232">                int firstState = gameInstance.getState();</span>
<span class="nc bnc" id="L233" title="All 4 branches missed.">                if (firstState == LottoGameInstance.STATE_NEW || firstState == LottoGameInstance.STATE_ACTIVE) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                    for (ExtraBallTicket ticket : newTickets) {</span>
<span class="nc" id="L235">                        ticket.setStatus(LottoTicket.STATUS_INVALID);</span>
<span class="nc" id="L236">                        ticket.setCountInPool(false);</span>
<span class="nc" id="L237">                        this.getBaseTicketDao().update(ticket);</span>
<span class="nc" id="L238">                    }</span>
                }
                // or the ticket has joined winning analysis, can NOT reverse
                // it.
            }
            // mark the NewPrintTicket as invalid
<span class="nc" id="L244">            newTicket.setStatus(NewPrintTicket.STATUS_REVERSED);</span>
<span class="nc" id="L245">            this.getNewPrintTicketDao().update(newTicket);</span>
        }
<span class="nc" id="L247">    }</span>

    /**
     * Verify the pre-condition before calculating prize.
     */
    protected void beforeCalculatePrize(List&lt;ExtraBallTicket&gt; dbTickets, ExtraBallTicket physicalTicket)
            throws ApplicationException {
<span class="nc" id="L254">        ExtraBallTicket boughtTicket = dbTickets.get(0);</span>
        // - check if this ticket has been paid
<span class="nc bnc" id="L256" title="All 2 branches missed.">        if (BaseTicket.STATUS_PAID == boughtTicket.getStatus()) {</span>
<span class="nc" id="L257">            throw new ApplicationException(SystemException.CODE_INVALID_PAYOUT, &quot;LottoTicket(serialNo=&quot;</span>
                    + physicalTicket.getSerialNo() + &quot;) has been payed.&quot;);
        }

        // - check the last payout time(it should be counted from the final
        // game draw)
<span class="nc" id="L263">        ExtraBallGameInstance lastGameInstance = this.getBaseGameInstanceDao().findById(ExtraBallGameInstance.class,</span>
                dbTickets.get(dbTickets.size() - 1).getGameInstance().getId(), false);
<span class="nc" id="L265">        lastGameInstance.isPastLastClaimDay();</span>
<span class="nc" id="L266">    }</span>

    /**
     * Assemble a physical ticket information based on serial number.
     * 
     * @return The host ticket entities.
     */
    protected List&lt;ExtraBallTicket&gt; assemblePhysicalTicket(Context&lt;?&gt; respCtx, BaseTicket ticket)
            throws ApplicationException {
<span class="nc" id="L275">        List&lt;ExtraBallTicket&gt; tickets = this.getBaseTicketDao().findBySerialNo(ExtraBallTicket.class,</span>
                ticket.getSerialNo(), true);
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (tickets.size() == 0) {</span>
<span class="nc" id="L278">            throw new ApplicationException(SystemException.CODE_NO_TICKET, &quot;can NOT find ticket with serialNO=&quot;</span>
                    + ticket.getSerialNo());
        }
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L282">            logger.debug(&quot;Start to enquiry prize for ticket(serialNo=&quot; + ticket.getSerialNo() + &quot;,multipleDraw=&quot;</span>
                    + tickets.size() + &quot;).&quot;);
        }
        /**
         * the returned ticket list is ordered by game-draw.number, so the game draw associates with the 1st ticket is
         * the game draw in which customer bought the ticket.
         */
<span class="nc" id="L289">        ExtraBallTicket boughtTicket = tickets.get(0);</span>
<span class="nc" id="L290">        ExtraBallGameInstance boughtGameInstance = this.getBaseGameInstanceDao().findById(ExtraBallGameInstance.class,</span>
                boughtTicket.getGameInstance().getId(), false);
<span class="nc" id="L292">        ticket.setGameInstance(boughtGameInstance);</span>
<span class="nc" id="L293">        ticket.setMultipleDraws(tickets.size());</span>
<span class="nc" id="L294">        ticket.setTotalAmount(boughtTicket.getTotalAmount().multiply(new BigDecimal(ticket.getMultipleDraws())));</span>

        // assemble transaction
<span class="nc" id="L297">        respCtx.getTransaction().setGameId(boughtGameInstance.getGame().getId());</span>
<span class="nc" id="L298">        respCtx.getTransaction().setTicketSerialNo(boughtTicket.getSerialNo());</span>

<span class="nc" id="L300">        return tickets;</span>
    }

    /**
     * Assemble PrizeDto instance from ticket.serialNo. Below precondition must be satisfied:
     * &lt;ol&gt;
     * &lt;li&gt;The ticket exists&lt;/li&gt;
     * &lt;li&gt;At least the buying gamedraw is 'payout started', customer can go to claim prize at any time. To
     * multiple-draw ticket, some later gamedraws maybe not 'payout started'&lt;/li&gt;
     * &lt;/ol&gt;
     * The prize will be assembled from WinningItems.
     */
    protected Prize assemblePrize(List&lt;ExtraBallTicket&gt; dbTickets, ExtraBallTicket physicalTicket, boolean isPayout)
            throws ApplicationException {
<span class="nc" id="L314">        BaseGameInstance boughtDraw = physicalTicket.getGameInstance();</span>
        // - only 'payout started' game draw can do enquiry or payout. To
        // multiple-draw ticket, at least
        // one game draw should be 'payout started'.
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if (BaseGameInstance.STATE_PAYOUT_STARTED != boughtDraw.getState()) {</span>
<span class="nc" id="L319">            throw new ApplicationException(SystemException.CODE_DRAW_NOTPAYOUTSTARTED, &quot;The game draw(drawNo=&quot;</span>
                    + boughtDraw.getNumber() + &quot;) of buying ticket(serialNo=&quot; + physicalTicket.getSerialNo()
                    + &quot;) is not 'payout started':&quot; + boughtDraw.getState());
        }

        // - check all game draws, whether some game draws are in progress of
        // winning analysis or payout blocked.
<span class="nc bnc" id="L326" title="All 2 branches missed.">        for (int i = 0; i &lt; dbTickets.size(); i++) {</span>
<span class="nc" id="L327">            ExtraBallGameInstance gameInstance = this.getBaseGameInstanceDao().findById(ExtraBallGameInstance.class,</span>
                    dbTickets.get(i).getGameInstance().getId(), false);
<span class="nc" id="L329">            dbTickets.get(i).setGameInstance(gameInstance);</span>
<span class="nc bnc" id="L330" title="All 4 branches missed.">            if ((new Date().after(gameInstance.getEndTime()) &amp;&amp; BaseGameInstance.STATE_PAYOUT_STARTED != gameInstance</span>
                    .getState())) {
<span class="nc" id="L332">                throw new ApplicationException(SystemException.CODE_INPROGRESSOF_WINNINGANALYSIS, &quot;game draw(id=&quot;</span>
                        + gameInstance.getId() + &quot;,number=&quot; + gameInstance.getNumber()
                        + &quot;) is in progress of winning analysis, please try later.&quot;);
            }
            // check below condition only when real payout
<span class="nc bnc" id="L337" title="All 2 branches missed.">            if (isPayout) {</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (gameInstance.isPayoutBlocked()) {</span>
<span class="nc" id="L339">                    throw new ApplicationException(SystemException.CODE_SUSPEND_PAYOUT, &quot;game instance(id=&quot;</span>
                            + gameInstance.getId() + &quot;,number=&quot; + gameInstance.getNumber()
                            + &quot;) has been payout suspended, please try later.&quot;);
                }
<span class="nc bnc" id="L343" title="All 2 branches missed.">                if (dbTickets.get(i).isPayoutBlocked()) {</span>
<span class="nc" id="L344">                    throw new ApplicationException(SystemException.CODE_TICKET_BLOCKPAYOUT, &quot;LottoTicket(serialNo=&quot;</span>
                            + physicalTicket.getSerialNo() + &quot;) has been blocked for payout.&quot;);
                }
            }
        }

        // calculate prize amount
<span class="nc" id="L351">        Prize prize = calculatePrizeAmount(dbTickets, physicalTicket);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (prize.getActualAmount().compareTo(new BigDecimal(&quot;0&quot;)) == 0) {</span>
<span class="nc" id="L353">            throw new ApplicationException(SystemException.CODE_NOTWINNINGTICKET, &quot;LottoTicket(serialNo=&quot;</span>
                    + physicalTicket.getSerialNo() + &quot;) isn't a winning ticket.&quot;);
        }
        // assemble game information
<span class="nc" id="L357">        prize.setGame(physicalTicket.getGameInstance().getGame());</span>

        // assemble isVerifyPIN
        // if
        // (!boughtTicket.getPIN().equals(MLotteryContext.getInstance().getIgnoredPIN()))
        // {
        // prize.setVerifyPIN(true);
        // }

<span class="nc" id="L366">        return prize;</span>
    }

    /**
     * Calculate prize amount of the given ticket.
     */
    protected Prize calculatePrizeAmount(List&lt;ExtraBallTicket&gt; dbTickets, ExtraBallTicket physicalTicket)
            throws ApplicationException {
<span class="nc" id="L374">        ExtraBallTicket boughtTicket = dbTickets.get(0);</span>
<span class="nc" id="L375">        BaseGameInstance boughtDraw = physicalTicket.getGameInstance();</span>
        // initialize prize
<span class="nc" id="L377">        Prize prize = new Prize();</span>
<span class="nc" id="L378">        prize.setWinningTicket(physicalTicket);</span>

<span class="nc" id="L380">        BaseOperationParameter operationParam = this.getBaseJpaDao().findById(ExtraBallOperationParameter.class,</span>
                boughtTicket.getGameInstance().getGame().getOperatorParameterId());
<span class="nc" id="L382">        prize.setPayoutMode(operationParam.getPayoutMode());</span>
<span class="nc" id="L383">        BigDecimal returnAmount = new BigDecimal(&quot;0&quot;);</span>
        /**
         * handle ticket one by one...each game instance will has its own valid version
         */
<span class="nc bnc" id="L387" title="All 2 branches missed.">        for (ExtraBallTicket t : dbTickets) {</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            if (BaseGameInstance.STATE_PAYOUT_STARTED == t.getGameInstance().getState()) {</span>
<span class="nc" id="L389">                long lastSuccessfulVersion = t.getGameInstance().getVersion();</span>
                // get all winning items
<span class="nc" id="L391">                List&lt;ExtraBallWinningItem&gt; winItems = this.getBaseWinningItemDao()</span>
                        .findByGameInstanceAndSerialNoAndVersion(ExtraBallWinningItem.class,
                                t.getGameInstance().getId(), physicalTicket.getSerialNo(), lastSuccessfulVersion);
<span class="nc" id="L394">                PrizeItem prizeItem = this.handleWinItemsOfSingleGameInstance(winItems, prize, t.getGameInstance());</span>

                // stat prize amount of the winning ticket
<span class="nc" id="L397">                prize.setPrizeAmount(prize.getPrizeAmount().add(prizeItem.getPrizeAmount()));</span>
<span class="nc" id="L398">                prize.setTaxAmount(prize.getTaxAmount().add(prizeItem.getTaxAmount()));</span>
<span class="nc" id="L399">                prize.setActualAmount(prize.getActualAmount().add(prizeItem.getActualAmount()));</span>

<span class="nc" id="L401">                prize.getPaidTickets().add(t);</span>
<span class="nc" id="L402">            } else {</span>
<span class="nc" id="L403">                prize.getFutureTickets().add(t);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                if (BaseOperationParameter.PAYOUTMODE_REFUND == operationParam.getPayoutMode()) {</span>
<span class="nc" id="L405">                    returnAmount = returnAmount.add(t.getTotalAmount());</span>
                }
            }
<span class="nc" id="L408">        }</span>
<span class="nc" id="L409">        prize.setReturnAmount(returnAmount);</span>
        // actualAmount := prizeAmount + returnAmount - taxAmount
<span class="nc" id="L411">        prize.setActualAmount(prize.getActualAmount().add(returnAmount));</span>
<span class="nc" id="L412">        return prize;</span>
    }

    /**
     * Handle each winning item, and calculate tax if needed.
     * 
     * @return the prize item of a single game instance.
     */
    protected PrizeItem handleWinItemsOfSingleGameInstance(List&lt;ExtraBallWinningItem&gt; winningItems, Prize prize,
            BaseGameInstance gameInstance) throws ApplicationException {
        // lookup prizeItem
<span class="nc" id="L423">        PrizeItem prizeItem = prize.lookupPrizeItem(gameInstance.getKey());</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">        if (prizeItem == null) {</span>
<span class="nc" id="L425">            prizeItem = new PrizeItem();</span>
<span class="nc" id="L426">            prizeItem.setGameInstance(gameInstance);</span>
<span class="nc" id="L427">            prize.addPrizeItem(prizeItem);</span>
        }

        // handle winning item
<span class="nc bnc" id="L431" title="All 2 branches missed.">        for (ExtraBallWinningItem winningItem : winningItems) {</span>
            // check if the winning item is valid
<span class="nc bnc" id="L433" title="All 2 branches missed.">            if (!winningItem.isValid()) {</span>
<span class="nc" id="L434">                throw new ApplicationException(SystemException.CODE_CANCELED_WINNING_TICKET,</span>
                        &quot;can not payout a invalid winning ticket(serialNo=&quot; + prize.getWinningTicket().getSerialNo()
                                + &quot;).&quot;);
            }
            // stat prize amount of a single game instance
            // if the tax-method of Game is TAXMETHOD_PAYOUT, then we need
            // to calculate the tax
<span class="nc" id="L441">            prizeItem.setPrizeAmount(prizeItem.getPrizeAmount().add(winningItem.getPrizeAmount()));</span>
<span class="nc" id="L442">            Game game = gameInstance.getGame();</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">            if (Game.TAXMETHOD_PAYOUT == game.getTaxMethod()) {</span>
<span class="nc" id="L444">                BigDecimal tax = this.getTaxService().tax(winningItem.getPrizeAmount(), game.getId());</span>
<span class="nc" id="L445">                prizeItem.setTaxAmount(prizeItem.getTaxAmount().add(tax));</span>
<span class="nc" id="L446">                prizeItem.setActualAmount(prizeItem.getActualAmount().add(winningItem.getPrizeAmount().subtract(tax)));</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">            } else if (Game.TAXMETHOD_ANALYSIS == game.getTaxMethod()) {</span>
<span class="nc" id="L448">                prizeItem.setTaxAmount(prizeItem.getTaxAmount().add(winningItem.getTaxAmount()));</span>
<span class="nc" id="L449">                prizeItem.setActualAmount(prizeItem.getActualAmount().add(winningItem.getActualAmount()));</span>
            } else {
<span class="nc" id="L451">                throw new RuntimeException(&quot;Unsupported tax method:&quot; + game.getTaxMethod() + &quot; of game(id=&quot;</span>
                        + game.getId() + &quot;)&quot;);
            }
<span class="nc" id="L454">        }</span>
<span class="nc" id="L455">        return prizeItem;</span>
    }

    // -------------------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // -------------------------------------------------------------

    public BaseTicketDao getBaseTicketDao() {
<span class="nc" id="L463">        return baseTicketDao;</span>
    }

    public void setBaseTicketDao(BaseTicketDao baseTicketDao) {
<span class="fc" id="L467">        this.baseTicketDao = baseTicketDao;</span>
<span class="fc" id="L468">    }</span>

    public PayoutDao getPayoutDao() {
<span class="nc" id="L471">        return payoutDao;</span>
    }

    public void setPayoutDao(PayoutDao payoutDao) {
<span class="fc" id="L475">        this.payoutDao = payoutDao;</span>
<span class="fc" id="L476">    }</span>

    public UUIDService getUuidService() {
<span class="nc" id="L479">        return uuidService;</span>
    }

    public void setUuidService(UUIDService uuidService) {
<span class="fc" id="L483">        this.uuidService = uuidService;</span>
<span class="fc" id="L484">    }</span>

    public MerchantService getMerchantService() {
<span class="nc" id="L487">        return merchantService;</span>
    }

    public void setMerchantService(MerchantService merchantService) {
<span class="fc" id="L491">        this.merchantService = merchantService;</span>
<span class="fc" id="L492">    }</span>

    public BaseWinningItemDao getBaseWinningItemDao() {
<span class="nc" id="L495">        return baseWinningItemDao;</span>
    }

    public void setBaseWinningItemDao(BaseWinningItemDao baseWinningItemDao) {
<span class="fc" id="L499">        this.baseWinningItemDao = baseWinningItemDao;</span>
<span class="fc" id="L500">    }</span>

    public BaseGameInstanceDao getBaseGameInstanceDao() {
<span class="nc" id="L503">        return baseGameInstanceDao;</span>
    }

    public void setBaseGameInstanceDao(BaseGameInstanceDao baseGameInstanceDao) {
<span class="fc" id="L507">        this.baseGameInstanceDao = baseGameInstanceDao;</span>
<span class="fc" id="L508">    }</span>

    public TaxService getTaxService() {
<span class="nc" id="L511">        return taxService;</span>
    }

    public void setTaxService(TaxService taxService) {
<span class="fc" id="L515">        this.taxService = taxService;</span>
<span class="fc" id="L516">    }</span>

    public BaseJpaDao getBaseJpaDao() {
<span class="nc" id="L519">        return baseJpaDao;</span>
    }

    public void setBaseJpaDao(BaseJpaDao baseJpaDao) {
<span class="fc" id="L523">        this.baseJpaDao = baseJpaDao;</span>
<span class="fc" id="L524">    }</span>

    public BaseEntryDao getBaseEntryDao() {
<span class="nc" id="L527">        return baseEntryDao;</span>
    }

    public void setBaseEntryDao(BaseEntryDao baseEntryDao) {
<span class="fc" id="L531">        this.baseEntryDao = baseEntryDao;</span>
<span class="fc" id="L532">    }</span>

    public PayoutStrategyFactory getPayoutStrategyFactory() {
<span class="nc" id="L535">        return payoutStrategyFactory;</span>
    }

    public void setPayoutStrategyFactory(PayoutStrategyFactory payoutStrategyFactory) {
<span class="fc" id="L539">        this.payoutStrategyFactory = payoutStrategyFactory;</span>
<span class="fc" id="L540">    }</span>

    public NewPrintTicketDao getNewPrintTicketDao() {
<span class="nc" id="L543">        return newPrintTicketDao;</span>
    }

    public void setNewPrintTicketDao(NewPrintTicketDao newPrintTicketDao) {
<span class="fc" id="L547">        this.newPrintTicketDao = newPrintTicketDao;</span>
<span class="fc" id="L548">    }</span>

    public CreditService getCreditService() {
<span class="nc" id="L551">        return creditService;</span>
    }

    public void setCreditService(CreditService creditService) {
<span class="fc" id="L555">        this.creditService = creditService;</span>
<span class="fc" id="L556">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>