<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DefaultCashoutService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.thirdpartyservice.playeraccount.service</a> &gt; <span class="el_source">DefaultCashoutService.java</span></div><h1>DefaultCashoutService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.thirdpartyservice.playeraccount.service;

import com.mpos.lottery.te.common.http.DefaultReversalHandler;
import com.mpos.lottery.te.common.http.HttpClientProtoBuffChannel;
import com.mpos.lottery.te.common.http.HttpMethod;
import com.mpos.lottery.te.common.http.MessageResponse;
import com.mpos.lottery.te.common.http.RemoteServiceException;
import com.mpos.lottery.te.common.http.ReversalMessageBuilder;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.merchant.dao.OperatorDao;
import com.mpos.lottery.te.merchant.domain.Merchant;
import com.mpos.lottery.te.merchant.domain.Operator;
import com.mpos.lottery.te.merchant.service.CreditService;
import com.mpos.lottery.te.merchant.service.MerchantService;
import com.mpos.lottery.te.merchant.service.balance.BalanceService;
import com.mpos.lottery.te.merchant.service.commission.CommissionBalanceService;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.port.domain.router.RoutineKey;
import com.mpos.lottery.te.thirdpartyservice.PaymentResponseCode;
import com.mpos.lottery.te.thirdpartyservice.PaymentTransactionType;
import com.mpos.lottery.te.thirdpartyservice.playeraccount.web.CashoutRequest;
import com.mpos.lottery.te.thirdpartyservice.playeraccount.web.CashoutResponse;
import com.mpos.lottery.te.thirdpartyservice.playeraccount.web.PlayerAccountHttpHeader;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.trans.domain.TransactionType;
import com.mpos.lottery.te.trans.domain.logic.AbstractReversalOrCancelStrategy;
import com.mpos.lottery.te.workingkey.domain.Gpe;

import net.mpos.apc.entry.Cashout.ReqCashout;
import net.mpos.apc.entry.Cashout.ResCashout;
import net.mpos.apc.entry.GetAccountInfo.ResGetAccountInfo;
import net.mpos.apc.entry.Reversal.ReqReversal;
import net.mpos.apc.entry.Reversal.ResReversal;
import net.mpos.fk.util.StringUtils;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.perf4j.StopWatch;
import org.perf4j.commonslog.CommonsLogStopWatch;

import java.io.IOException;
import java.math.BigDecimal;
import java.util.Date;

import javax.annotation.Resource;

<span class="fc" id="L48">public class DefaultCashoutService extends AbstractReversalOrCancelStrategy implements CashoutService {</span>
<span class="fc" id="L49">    private Log logger = LogFactory.getLog(DefaultCashoutService.class);</span>
    // SPRING DEPENDENCIES
    private AccountInfoService accountInfoService;
    private CreditService creditService;
    private MerchantService merchantService;
    private HttpClientProtoBuffChannel accountSystemChannel;
    private OperatorDao operatorDao;
    
    @Resource(name = &quot;defaultBalanceService&quot;)
    private BalanceService balanceService;
    @Resource(name = &quot;cashoutMobileCommissionBalanceService&quot;)
    private CommissionBalanceService commissionService;
    

    @Override
    public CashoutResponse cashout(Context&lt;?&gt; responseCtx, CashoutRequest request) throws ApplicationException {
<span class="pc bpc" id="L65" title="2 of 4 branches missed.">        if (request.getReferenceNum() == null &amp;&amp; request.getCashoutAmount() == null) {</span>
<span class="nc" id="L66">            throw new ApplicationException(SystemException.CODE_WRONG_MESSAGEBODY,</span>
                    &quot;Either 'referenceNo or amount must be provided.&quot;);
        }

        // perform local checking
<span class="fc" id="L71">        Merchant leafMerchant = this.getMerchantService().getMerchant(responseCtx.getMerchant().getId());</span>
<span class="pc bpc" id="L72" title="2 of 4 branches missed.">        if (request.getCashoutAmount() == null || request.getCashoutAmount().compareTo(new BigDecimal(&quot;0&quot;)) == 0) {</span>
<span class="nc" id="L73">            logger.info(&quot;No need to check cashout limit operation is by reference number.&quot;);</span>
        } else {
<span class="fc" id="L75">            this.getMerchantService().allowCashout(responseCtx, request.getCashoutAmount());</span>
        }

        // lookup user info first
<span class="fc" id="L79">        ResGetAccountInfo accountInfo = this.getAccountInfoService().enquiry(responseCtx, request.getMobile());</span>
        // call remote service
        try {
            // build cashout request
<span class="fc" id="L83">            ReqCashout.Builder builder = ReqCashout.newBuilder();</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">            if (request.getReferenceNum() != null) {</span>
                // SHIT, if setReferenceNo(null), you will get a
                // NullPointerException even this field is optional in protocbuf
                // def file.
<span class="nc" id="L88">                builder.setReferenceNo(request.getReferenceNum());</span>
<span class="nc" id="L89">                builder.setCashoutType(1);</span>
            } else {
<span class="fc" id="L91">                builder.setCashoutAmount(request.getCashoutAmount().toString());</span>
<span class="fc" id="L92">                builder.setCashoutType(0);</span>
            }
            // only SGPE will affect Free_SMS
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">            if (Gpe.TYPE_SGPE == responseCtx.getGpe().getType()) {</span>
<span class="nc" id="L96">                builder.setFreeRequest(1);</span>
            } else {
<span class="fc" id="L98">                builder.setFreeRequest(0);</span>
            }

<span class="fc" id="L101">            ReqCashout reqCashout = builder.setPin(request.getUserPIN()).setMerchantId(leafMerchant.getId() + &quot;&quot;)</span>
                    .setMerchantCode(leafMerchant.getCode()).setMerchantName(leafMerchant.getName())
                    .setTransactionId(responseCtx.getTransaction().getId()).build();

<span class="fc" id="L105">            StopWatch cashoutStopWach = new CommonsLogStopWatch(&quot;Remote Cashout&quot;);</span>
<span class="fc" id="L106">            MessageResponse response = this.getAccountSystemChannel().send(</span>
                    PaymentTransactionType.CASHOUT,
                    HttpMethod.POST,
                    new PlayerAccountHttpHeader(PaymentTransactionType.CASHOUT.getTransType(), StringUtils
                            .getGeneralID().toPlainString(), accountInfo.getUserId(), responseCtx.getTransaction()
                            .getUpdateTime()),
                    reqCashout,
                    new HttpClientProtoBuffChannel.MessageResponseHandler(ResCashout.getDefaultInstance()),
                    // set reversal handler
                    new DefaultReversalHandler(new PlayerAccountHttpHeader(PaymentTransactionType.REVERSAL
                            .getTransType(), StringUtils.getGeneralID().toPlainString(), accountInfo.getUserId(),
                            new Date()), this.accountSystemChannel, new CashoutReversalMessageBuilder()));

<span class="fc" id="L119">            int responseCode = response.getRespHeader().getResponseCode();</span>
<span class="fc" id="L120">            cashoutStopWach.stop();</span>

<span class="pc bpc" id="L122" title="1 of 2 branches missed.">            if (responseCode != PaymentResponseCode.OK.getCode()) {</span>
<span class="nc" id="L123">                logger.warn(&quot;Get response of transaction(devid=&quot; + responseCtx.getTerminalId() + &quot;,traceMsgId=&quot;</span>
                        + responseCtx.getTraceMessageId() + &quot;): responseCode:&quot; + responseCode + &quot;,desc:&quot;
                        + response.getRespHeader().getResponseDesc());
                // can't throw out ApplicationException here, as this exception
                // will mark current transaction as rollback-only, and then the
                // 'cancel by transaction' can't find this transaction.

                // throw new ApplicationException(responseCode,
                // resCashout.getResponseDesc());
<span class="nc" id="L132">                responseCtx.setResponseCode(responseCode);</span>
                // in such case we should'n publish AMQP message
<span class="nc" id="L134">                responseCtx.setProperty(Context.KEY_PUBLISH_AMQP_MESSAGE, false);</span>
            } else {
                // whether the remote service has handled request successfully
<span class="fc" id="L137">                ResCashout resCashout = (ResCashout) response.getMessageBody();</span>
                // update daily cashout-level if get successful response
<span class="fc" id="L139">                this.updateDailyCashoutLevel(responseCtx.getOperator(), new BigDecimal(resCashout.getCashoutAmount()),</span>
                        true);
//                this.getCreditService().credit(responseCtx.getOperatorId(), responseCtx.getMerchant().getId(),
//                        new BigDecimal(resCashout.getCashoutAmount()), true, false);

                // NOTE: update total amount of transaction, reversal request
                // will need this information.
<span class="fc" id="L146">                responseCtx.getTransaction().setTotalAmount(new BigDecimal(resCashout.getCashoutAmount()));</span>
                // save userId for later reversal
<span class="fc" id="L148">                responseCtx.getTransaction().setBatchNumber(accountInfo.getUserId());</span>
                
                // Add Operator cashout balance &amp; commission balance
                // --------------------------------
                // Maintain cashout balance and commission
                // --------------------------------
                // update cash out balance
<span class="fc" id="L155">                Object operatorMerchant = this.getBalanceService().balance(responseCtx, BalanceService.BALANCE_TYPE_CASHOUT,</span>
                       responseCtx.getTransaction().getOperatorId(), true);
<span class="fc" id="L157">                this.getCommissionService().calCommission(responseCtx, operatorMerchant);</span>
                
<span class="fc" id="L159">                return new CashoutResponse(request, resCashout);</span>
            }
<span class="nc" id="L161">        } catch (IOException e) {</span>
<span class="nc" id="L162">            logger.warn(e.getMessage(), e);</span>
            // can't throw out exception here.
<span class="nc" id="L164">            responseCtx.setResponseCode(SystemException.CODE_INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L165">        }</span>
<span class="nc" id="L166">        return null;</span>
    }

    /**
     * Reverse the cashout transaction.
     */
    @Override
    public boolean cancelOrReverse(Context respCtx, Transaction originalTrans) throws ApplicationException {
        try {
            // build reversal request
<span class="nc" id="L176">            ReqReversal reqReversal = ReqReversal.newBuilder().setTransactionId(originalTrans.getId())</span>
                    .setTransType(PaymentTransactionType.CASHOUT.getTransType() + &quot;&quot;).build();

<span class="nc" id="L179">            MessageResponse response = this.getAccountSystemChannel().send(</span>
                    PaymentTransactionType.REVERSAL,
                    HttpMethod.POST,
                    // user batchNo. to store userId
                    new PlayerAccountHttpHeader(PaymentTransactionType.REVERSAL.getTransType(), StringUtils
                            .getGeneralID().toPlainString(), originalTrans.getBatchNumber(), new Date()), reqReversal,
                    new HttpClientProtoBuffChannel.MessageResponseHandler(ResReversal.getDefaultInstance()), null);

<span class="nc" id="L187">            StopWatch reversalStopWatch = new CommonsLogStopWatch(&quot;Remote Cashout Reversal&quot;);</span>
<span class="nc" id="L188">            ResReversal resReversal = (ResReversal) response.getMessageBody();</span>
<span class="nc" id="L189">            int responseCode = response.getRespHeader().getResponseCode();</span>
<span class="nc" id="L190">            reversalStopWatch.stop();</span>

<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (responseCode != PaymentResponseCode.OK.getCode()) {</span>
<span class="nc" id="L193">                logger.warn(&quot;Get response of reversal transaction: responseCode:&quot; + responseCode);</span>
<span class="nc" id="L194">                throw new ApplicationException(responseCode, &quot;Fail to reverse cashout transaction(id=&quot;</span>
                        + originalTrans.getId() + &quot;)&quot;);
            } else {
                // perform local reversal
                // restore daily cash out level.
<span class="nc" id="L199">                this.updateDailyCashoutLevel(</span>
                        this.getOperatorDao().findById(Operator.class, originalTrans.getOperatorId()),
                        originalTrans.getTotalAmount(), false);
                // update credit level
//                this.getCreditService().credit(originalTrans.getOperatorId(), originalTrans.getMerchantId(),
//                        originalTrans.getTotalAmount(), false, false);
                // --------------------------------
                // Maintain cash out balance and commission
                // --------------------------------
                // update cash out balance
<span class="nc" id="L209">                Object operatorMerchant = this.getBalanceService().balance(respCtx, BalanceService.BALANCE_TYPE_CASHOUT,</span>
                        originalTrans.getOperatorId(), false);
<span class="nc" id="L211">                this.getCommissionService().cancelCommission(respCtx, originalTrans, operatorMerchant);</span>
            }
<span class="nc" id="L213">        } catch (IOException e) {</span>
<span class="nc" id="L214">            throw new RemoteServiceException(e);</span>
<span class="nc" id="L215">        }</span>

<span class="nc" id="L217">        return false;</span>
    }

    @Override
    public RoutineKey supportedReversalRoutineKey() {
<span class="fc" id="L222">        return new RoutineKey(TransactionType.PLAYER_CASH_OUT.getRequestType());</span>
    }

<span class="fc" id="L225">    public static class CashoutReversalMessageBuilder implements ReversalMessageBuilder&lt;ReqCashout&gt; {</span>

        @Override
        public ReqReversal build(ReqCashout reqCashout) {
<span class="nc" id="L229">            return ReqReversal.newBuilder().setTransactionId(reqCashout.getTransactionId())</span>
                    .setTransType(PaymentTransactionType.CASHOUT.getTransType() + &quot;&quot;).build();
        }

    }

    protected void updateDailyCashoutLevel(Operator operator, BigDecimal cashoutAmount, boolean isRestore)
            throws ApplicationException {
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">        if (operator == null) {</span>
<span class="nc" id="L238">            throw new ApplicationException(SystemException.CODE_NO_OPERATOR, &quot;No operator found.&quot;);</span>
        }
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">        if (isRestore) {</span>
<span class="fc" id="L241">            operator.setDailyCashoutLevel(cashoutAmount.add(operator.getDailyCashoutLevel()));</span>
        } else {
<span class="nc" id="L243">            operator.setDailyCashoutLevel(operator.getDailyCashoutLevel().subtract(cashoutAmount));</span>
        }
<span class="fc" id="L245">        this.getOperatorDao().update(operator);</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L247">            logger.debug(&quot;After cash out[dailyCashoutLevel: &quot; + operator.getDailyCashoutLevel() + &quot;].&quot;);</span>
        }
<span class="fc" id="L249">    }</span>

    // -------------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // -------------------------------------------------------

    public MerchantService getMerchantService() {
<span class="fc" id="L256">        return merchantService;</span>
    }

    public void setMerchantService(MerchantService merchantService) {
<span class="fc" id="L260">        this.merchantService = merchantService;</span>
<span class="fc" id="L261">    }</span>

    public HttpClientProtoBuffChannel getAccountSystemChannel() {
<span class="fc" id="L264">        return accountSystemChannel;</span>
    }

    public void setAccountSystemChannel(HttpClientProtoBuffChannel accountSystemChannel) {
<span class="fc" id="L268">        this.accountSystemChannel = accountSystemChannel;</span>
<span class="fc" id="L269">    }</span>

    public OperatorDao getOperatorDao() {
<span class="fc" id="L272">        return operatorDao;</span>
    }

    public void setOperatorDao(OperatorDao operatorDao) {
<span class="fc" id="L276">        this.operatorDao = operatorDao;</span>
<span class="fc" id="L277">    }</span>

    public CreditService getCreditService() {
<span class="nc" id="L280">        return creditService;</span>
    }

    public void setCreditService(CreditService creditService) {
<span class="fc" id="L284">        this.creditService = creditService;</span>
<span class="fc" id="L285">    }</span>

    public AccountInfoService getAccountInfoService() {
<span class="fc" id="L288">        return accountInfoService;</span>
    }

    public void setAccountInfoService(AccountInfoService accountInfoService) {
<span class="fc" id="L292">        this.accountInfoService = accountInfoService;</span>
<span class="fc" id="L293">    }</span>

    public BalanceService getBalanceService() {
<span class="fc" id="L296">        return balanceService;</span>
    }

    public void setBalanceService(BalanceService balanceService) {
<span class="nc" id="L300">        this.balanceService = balanceService;</span>
<span class="nc" id="L301">    }</span>

    public CommissionBalanceService getCommissionService() {
<span class="fc" id="L304">        return commissionService;</span>
    }

    public void setCommissionService(CommissionBalanceService commissionService) {
<span class="nc" id="L308">        this.commissionService = commissionService;</span>
<span class="nc" id="L309">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>