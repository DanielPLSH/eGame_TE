<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DefaultLuckyNumberService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.magic100.sale.service</a> &gt; <span class="el_source">DefaultLuckyNumberService.java</span></div><h1>DefaultLuckyNumberService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.magic100.sale.service;

import com.mpos.lottery.te.common.dao.BaseJpaDao;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.magic100.game.Magic100GameInstance;
import com.mpos.lottery.te.gameimpl.magic100.sale.LuckyNumber;
import com.mpos.lottery.te.gameimpl.magic100.sale.LuckyNumberSequence;
import com.mpos.lottery.te.gameimpl.magic100.sale.Magic100Entry;
import com.mpos.lottery.te.gameimpl.magic100.sale.Magic100Ticket;
import com.mpos.lottery.te.gameimpl.magic100.sale.RequeuedNumbers;
import com.mpos.lottery.te.gameimpl.magic100.sale.RequeuedNumbersItem;
import com.mpos.lottery.te.gameimpl.magic100.sale.dao.LuckyNumberDao;
import com.mpos.lottery.te.gameimpl.magic100.sale.dao.LuckyNumberSequenceDao;
import com.mpos.lottery.te.gameimpl.magic100.sale.dao.RequeuedNumbersDao;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.sequence.service.UUIDService;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;

<span class="fc" id="L26">public class DefaultLuckyNumberService implements LuckyNumberService {</span>
<span class="fc" id="L27">    private Log logger = LogFactory.getLog(DefaultLuckyNumberService.class);</span>
    private LuckyNumberDao luckyNumberDao;
    private RequeuedNumbersDao requeuedNumbersDao;
    private LuckyNumberSequenceDao luckyNumberSequenceDao;
    private BaseJpaDao baseJpaDao;
    private UUIDService uuidService;

    /**
     * Determine which range of lucky numbers should be sold. &lt;code&gt;LuckyNumberSequence&lt;/code&gt; will be used to record
     * the next sequence number of main cycle. At the initial status, &lt;code&gt;LuckyNumberSequence.nextSequence&lt;/code&gt; will
     * be 1, and once sold a range, for example 1~3, the LuckyNumberSequence.nextSequence will be updated to 4, even
     * this sale is cancelled later, the next sequence will stay as 4.
     * &lt;p/&gt;
     * If a sale is cancelled, the corresponding range will be saved as &lt;code&gt;RequeueNumbers&lt;/code&gt;, and will be sold at
     * next cycle(aims to make sure all numbers should be sold, and their prize amount should be paid as well, it is a
     * fair game).
     * &lt;p/&gt;
     * Below rules must be followed:
     * &lt;ol&gt;
     * &lt;li&gt;Sold requeued ranges as much as possible first, if no matched range numbers, get numbers from main cycle&lt;/li&gt;
     * &lt;li&gt;The numbers sold in a single request must be sequential.&lt;/li&gt;
     * &lt;/ol&gt;
     * &lt;p/&gt;
     * Below gives a user scenario:
     * &lt;h2&gt;Case #1(LuckyNumberSequence.nextSequence=1)&lt;/h2&gt;
     * &lt;ol&gt;
     * &lt;li&gt;Player A requests to buy a range(countOfNumber=3).&lt;/li&gt;
     * &lt;li&gt;System lookup all requeued ranges by (coungOfValidNumber&gt;=3) first, if found, use the requeued range, and
     * mark them as invalid. If numbers are retrieved from requeued ranges, no LuckyNumberSequence.nextSequence will be
     * updated.&lt;/li&gt;
     * &lt;li&gt;If no matched requeued ranges found, then lookup main cycle(beginNumber=LuckyNumberSequence.nextSequence,
     * countOfNumber=3), and update LuckyNumberSequence.nextSequence to 4&lt;/li&gt;
     * &lt;/ol&gt;
     * At a give time point, only one thread can enter this method, other threads will be blocked, otherwise different
     * player may get same numbers in a same cycle.
     * 
     * @param respCtx
     *            The context of transaction.
     * @param clientTicket
     *            THe client sale request.
     * @return the list of lucky numbers which will be sold to current player.
     */
    public List&lt;LuckyNumber&gt; determine(Context respCtx, Magic100Ticket clientTicket) throws ApplicationException {
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        if (clientTicket.getEntries().size() == 0) {</span>
<span class="nc" id="L71">            throw new ApplicationException(SystemException.CODE_WRONG_MESSAGEBODY,</span>
                    &quot;There is no any entry in ticket(serialNo=&quot; + clientTicket.getSerialNo() + &quot;).&quot;);
        }
        // there should be only one entry in raffle ticket...
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">        if (clientTicket.getEntries().size() &gt; 1) {</span>
<span class="nc" id="L76">            logger.warn(&quot;There should be only one entry in ticket, however total &quot; + clientTicket.getEntries().size()</span>
                    + &quot; entries found of ticket(serialNo=&quot; + clientTicket.getSerialNo() + &quot;).&quot;);
        }
<span class="fc" id="L79">        Magic100Entry mEntry = (Magic100Entry) clientTicket.getEntries().get(0);</span>
        // lookup current sequence first, and lock it to prevent
        // multi-access...this is a global lock
<span class="fc" id="L82">        LuckyNumberSequence luckyNumberSequence = this.lookupSequence((Magic100GameInstance) clientTicket</span>
                .getGameInstance());

<span class="fc" id="L85">        List&lt;LuckyNumber&gt; luckyNumbers = new LinkedList&lt;LuckyNumber&gt;();</span>
        // lookup requeued ranges first, the rule is sold requeued range first
<span class="fc" id="L87">        List&lt;RequeuedNumbers&gt; ranges = this.getRequeuedNumbersDao().findByGameInstanceAndCountOfValidNumber(</span>
                clientTicket.getGameInstance().getId(), (int) mEntry.getTotalBets());
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (ranges.size() &gt; 0) {</span>
            // use a requeued range if found
<span class="fc" id="L91">            RequeuedNumbers range = ranges.get(0);</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L93">                logger.debug(&quot;Use lucky number from REQUEUED RANGE(id=&quot; + range.getId() + &quot;) instead of main cycle.&quot;);</span>
            }
<span class="fc" id="L95">            List&lt;RequeuedNumbersItem&gt; validItems = range.lookupValidItems((int) mEntry.getTotalBets());</span>

            // update requeued range to prevent repeated usage.
<span class="fc" id="L98">            range.setCountOfValidNumbers(range.getCountOfValidNumbers() - (int) mEntry.getTotalBets());</span>
<span class="fc" id="L99">            range.setUpdateTime(respCtx.getTransaction().getUpdateTime());</span>
<span class="fc" id="L100">            this.getBaseJpaDao().update(range);</span>

<span class="fc bfc" id="L102" title="All 2 branches covered.">            for (RequeuedNumbersItem item : validItems) {</span>
<span class="fc" id="L103">                luckyNumbers.add(new LuckyNumber(item));</span>
<span class="fc" id="L104">                item.setState(RequeuedNumbersItem.STATE_INVALID);</span>
<span class="fc" id="L105">                item.setUpdateTime(respCtx.getTransaction().getUpdateTime());</span>
<span class="fc" id="L106">            }</span>
<span class="fc" id="L107">            this.getBaseJpaDao().update(validItems);</span>
<span class="fc" id="L108">        } else {</span>
            // lookup numbers from main cycle
<span class="fc" id="L110">            luckyNumbers = this.getLuckyNumberDao().findBySeuqnce(luckyNumberSequence.getNextSequence(),</span>
                    clientTicket.getGameInstance().getId(), (int) mEntry.getTotalBets());

            // update the sequence log
<span class="fc" id="L114">            luckyNumberSequence.setNextSequence(this.determineNextSequence(luckyNumbers.get(luckyNumbers.size() - 1),</span>
                    (Magic100GameInstance) clientTicket.getGameInstance()));
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">            luckyNumberSequence.setLastestPlayer(clientTicket.getUser() != null</span>
                    ? clientTicket.getUser().getMobile()
                    : null);
<span class="fc" id="L119">            this.getLuckyNumberSequenceDao().update(luckyNumberSequence);</span>
        }
<span class="fc" id="L121">        return luckyNumbers;</span>
    }

    @Override
    public void cancel(Context respCtx, Magic100Ticket ticket) throws ApplicationException {
<span class="fc" id="L126">        Long[] sequences = new Long[ticket.getEntries().size()];</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">        for (int i = 0; i &lt; ticket.getEntries().size(); i++) {</span>
<span class="fc" id="L128">            Magic100Entry entry = (Magic100Entry) ticket.getEntries().get(i);</span>
<span class="fc" id="L129">            sequences[i] = entry.getSequenceOfNumber();</span>
        }
        // fix bug#6244
<span class="fc" id="L132">        List&lt;LuckyNumber&gt; cancelNumbers = this.getLuckyNumberDao().findBySeuqnces(ticket.getGameInstance().getId(),</span>
                sequences);

<span class="fc" id="L135">        RequeuedNumbers cancelRequeueNum = new RequeuedNumbers();</span>
<span class="fc" id="L136">        cancelRequeueNum.setId(this.getUuidService().getGeneralID());</span>
<span class="fc" id="L137">        cancelRequeueNum.setCreateTime(respCtx.getTransaction().getCreateTime());</span>
<span class="fc" id="L138">        cancelRequeueNum.setUpdateTime(cancelRequeueNum.getCreateTime());</span>
<span class="fc" id="L139">        cancelRequeueNum.setTransactionId(respCtx.getTransaction().getId());</span>
        // cancelRequeueNum.setBeginOfValidNumbers(beginOfValidNumbers)
<span class="fc" id="L141">        cancelRequeueNum.setCountOfNumbers(cancelNumbers.size());</span>
<span class="fc" id="L142">        cancelRequeueNum.setCountOfValidNumbers(cancelNumbers.size());</span>
<span class="fc" id="L143">        cancelRequeueNum.setGameInstanceId(ticket.getGameInstance().getId());</span>

<span class="fc" id="L145">        this.getRequeuedNumbersDao().insert(cancelRequeueNum);</span>

<span class="fc" id="L147">        List&lt;RequeuedNumbersItem&gt; requeuedItems = new ArrayList&lt;RequeuedNumbersItem&gt;();</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">        for (LuckyNumber luckyNumber : cancelNumbers) {</span>
<span class="fc" id="L149">            RequeuedNumbersItem requeueItem = new RequeuedNumbersItem(luckyNumber);</span>
<span class="fc" id="L150">            requeueItem.setId(this.getUuidService().getGeneralID());</span>
<span class="fc" id="L151">            requeueItem.setCreateTime(respCtx.getTransaction().getCreateTime());</span>
<span class="fc" id="L152">            requeueItem.setUpdateTime(requeueItem.getCreateTime());</span>
<span class="fc" id="L153">            requeueItem.setRequeuedNumbers(cancelRequeueNum);</span>
<span class="fc" id="L154">            requeueItem.setState(RequeuedNumbersItem.STATE_VALID);</span>
<span class="fc" id="L155">            requeuedItems.add(requeueItem);</span>
<span class="fc" id="L156">        }</span>
<span class="fc" id="L157">        this.getBaseJpaDao().insert(requeuedItems);</span>
<span class="fc" id="L158">    }</span>

    // -------------------------------------------------------------
    // HELPER METHODS
    // -------------------------------------------------------------

    protected LuckyNumberSequence lookupSequence(Magic100GameInstance gameInstance) throws ApplicationException {
<span class="fc" id="L165">        return this.getLuckyNumberSequenceDao().lookup(gameInstance.getGameId());</span>
    }

    /**
     * Determine what is the next sequence? The sequence must be in range of &lt;code&gt;gameInstance.startOfSequence&lt;/code&gt;
     * and &lt;code&gt;gameInstance.endOfSequence&lt;/code&gt;
     */
    protected long determineNextSequence(LuckyNumber lastLuckyNumber, Magic100GameInstance gameInstance) {
<span class="fc" id="L173">        long nextSeq = lastLuckyNumber.getSequenceOfNumber() + 1;</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (nextSeq &gt; gameInstance.getEndOfSequence()) {</span>
<span class="fc" id="L175">            nextSeq = gameInstance.getStartOfSequence();</span>
        }
<span class="fc" id="L177">        return nextSeq;</span>
    }

    // -------------------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // -------------------------------------------------------------
    public LuckyNumberDao getLuckyNumberDao() {
<span class="fc" id="L184">        return luckyNumberDao;</span>
    }

    public void setLuckyNumberDao(LuckyNumberDao luckyNumberDao) {
<span class="fc" id="L188">        this.luckyNumberDao = luckyNumberDao;</span>
<span class="fc" id="L189">    }</span>

    public LuckyNumberSequenceDao getLuckyNumberSequenceDao() {
<span class="fc" id="L192">        return luckyNumberSequenceDao;</span>
    }

    public void setLuckyNumberSequenceDao(LuckyNumberSequenceDao luckyNumberSequenceDao) {
<span class="fc" id="L196">        this.luckyNumberSequenceDao = luckyNumberSequenceDao;</span>
<span class="fc" id="L197">    }</span>

    public RequeuedNumbersDao getRequeuedNumbersDao() {
<span class="fc" id="L200">        return requeuedNumbersDao;</span>
    }

    public void setRequeuedNumbersDao(RequeuedNumbersDao requeuedNumbersDao) {
<span class="fc" id="L204">        this.requeuedNumbersDao = requeuedNumbersDao;</span>
<span class="fc" id="L205">    }</span>

    public BaseJpaDao getBaseJpaDao() {
<span class="fc" id="L208">        return baseJpaDao;</span>
    }

    public void setBaseJpaDao(BaseJpaDao baseJpaDao) {
<span class="fc" id="L212">        this.baseJpaDao = baseJpaDao;</span>
<span class="fc" id="L213">    }</span>

    public UUIDService getUuidService() {
<span class="fc" id="L216">        return uuidService;</span>
    }

    public void setUuidService(UUIDService uuidService) {
<span class="fc" id="L220">        this.uuidService = uuidService;</span>
<span class="fc" id="L221">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>