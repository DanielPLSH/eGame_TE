<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Magic100SaleService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.magic100.sale.service</a> &gt; <span class="el_source">Magic100SaleService.java</span></div><h1>Magic100SaleService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.magic100.sale.service;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.gameimpl.magic100.sale.LuckyNumber;
import com.mpos.lottery.te.gameimpl.magic100.sale.Magic100Entry;
import com.mpos.lottery.te.gameimpl.magic100.sale.Magic100Ticket;
import com.mpos.lottery.te.gamespec.game.BaseGameInstance;
import com.mpos.lottery.te.gamespec.game.Game;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.gamespec.prize.Payout;
import com.mpos.lottery.te.gamespec.prize.dao.PayoutDao;
import com.mpos.lottery.te.gamespec.prize.service.TaxService;
import com.mpos.lottery.te.gamespec.sale.BaseEntry;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.gamespec.sale.dao.BaseEntryDao;
import com.mpos.lottery.te.gamespec.sale.service.AbstractTicketService;
import com.mpos.lottery.te.merchant.service.balance.BalanceService;
import com.mpos.lottery.te.merchant.service.commission.CommissionBalanceService;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.trans.domain.TransactionType;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

import javax.annotation.Resource;

/**
 * Make a sale of magic100 game. For magic100, only single-draw sale option is supported, and only single entry can be
 * carried in sale request. For example, below is a sale request:
 * 
 * &lt;pre&gt;
 * {@code
 * &lt;Ticket PIN=&quot;!!!!&quot; multipleDraws=&quot;1&quot; totalAmount=&quot;300.0&quot;&gt;
 *    &lt;GameDraw gameId=&quot;LK-1&quot; number=&quot;001&quot;/&gt;
 *    &lt;Entry betOption=&quot;1&quot; inputChannel=&quot;0&quot; selectedNumber=&quot;PLAY&quot; totalBets=&quot;3&quot;/&gt;
 * &lt;/Ticket&gt;
 * }
 * &lt;/pre&gt;
 * 
 * Only one single entry whose 'totalBets' is 3, in this case, the backend will generate 3 'BaseEntry' records instead.
 * That says the 'totalBets' in sale request is telling that how many entries should be generated at the backend, and
 * the total bets of each entry is simply 1.
 * 
 * @author Ramon
 */
<span class="fc" id="L51">public class Magic100SaleService extends AbstractTicketService {</span>
<span class="fc" id="L52">    private Log logger = LogFactory.getLog(Magic100SaleService.class);</span>
    // SPRING DEPENDENCIES
    private LuckyNumberService luckyNumberService;
    private BaseEntryDao baseEntryDao;
    private PayoutDao payoutDao;
    private TaxService taxService;
    @Resource(name = &quot;payoutCommissionBalanceService&quot;)
    private CommissionBalanceService payoutCommissionBalanceService;
    @Resource(name = &quot;defaultBalanceService&quot;)
    private BalanceService balanceService;

    @Override
    protected void doSuccessfulSale(Context&lt;?&gt; respCtx, BaseTicket clientTicket) throws ApplicationException {
        // generate payout if wines a prize
<span class="fc bfc" id="L66" title="All 4 branches covered.">        if (clientTicket.isWinning() &amp;&amp; clientTicket.getGameInstance().getGame().isNeedAutoPayout()) {</span>
<span class="fc" id="L67">            Payout payout = this.generatePayout(respCtx, clientTicket);</span>

            // update operator's payout balance and calculate commission
<span class="fc" id="L70">            Context payoutCtx = (Context) respCtx.clone();</span>
<span class="fc" id="L71">            payoutCtx.getTransaction().setTotalAmount(payout.getTotalAmount());</span>
<span class="fc" id="L72">            payoutCtx.getTransaction().setGameId(clientTicket.getGameInstance().getGameId());</span>
<span class="fc" id="L73">            payoutCtx.getTransaction().setType(TransactionType.PAYOUT.getRequestType());</span>
<span class="fc" id="L74">            Object operatorOrMerchant = this.getBalanceService().balance(payoutCtx, payoutCtx.getTransaction(),</span>
                    BalanceService.BALANCE_TYPE_PAYOUT, payoutCtx.getTransaction().getOperatorId(), true);
            // generate balance logs
<span class="fc" id="L77">            this.getPayoutCommissionBalanceService().calCommission(payoutCtx, operatorOrMerchant);</span>
        }
<span class="fc" id="L79">    }</span>

    @Override
    protected void customizeAssembleEntry(BaseTicket clientTicket, BaseEntry entry) {
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (clientTicket.getGameInstance().getGame().isNeedAutoPayout()) {</span>
<span class="fc" id="L84">            Magic100Entry mEntry = (Magic100Entry) entry;</span>
<span class="fc" id="L85">            BigDecimal tmpTaxAmount = new BigDecimal(&quot;0&quot;);</span>
<span class="fc bfc" id="L86" title="All 4 branches covered.">            if (mEntry.isWinning() &amp;&amp; Game.TAXMETHOD_PAYOUT == clientTicket.getGameInstance().getGame().getTaxMethod()) {</span>

                // calculate tax based on prize level amount.
<span class="fc" id="L89">                tmpTaxAmount = this.getTaxService().tax(mEntry.getPrizeAmount(),</span>
                        clientTicket.getGameInstance().getGame().getId());
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L92">                    logger.debug(&quot;the tax amount of entry(&quot; + entry + &quot;) is &quot; + tmpTaxAmount);</span>
                }
            }
<span class="fc" id="L95">            mEntry.setTaxAmount(tmpTaxAmount);</span>
        }
<span class="fc" id="L97">    }</span>

    @Override
    protected void customAssembleClientTicket(Context&lt;?&gt; respCtx, BaseTicket clientTicket) throws ApplicationException {
<span class="fc" id="L101">        Magic100Ticket ticket = (Magic100Ticket) clientTicket;</span>
<span class="fc" id="L102">        ticket.getGameInstance().setGameId(ticket.getGameInstance().getGame().getId());</span>
        // assemble entries with lucky numbers
<span class="fc" id="L104">        List&lt;LuckyNumber&gt; luckyNumbers = this.getLuckyNumberService().determine(respCtx, ticket);</span>
        // clear original entry(selected number is 'PLAY')
<span class="fc" id="L106">        ticket.getEntries().clear();</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">        for (LuckyNumber luckyNumber : luckyNumbers) {</span>
            // generate entry
<span class="fc" id="L109">            Magic100Entry entry = new Magic100Entry();</span>
<span class="fc" id="L110">            entry.setTicketSerialNo(clientTicket.getSerialNo());</span>
<span class="fc" id="L111">            entry.setBetOption(BaseEntry.BETOPTION_SINGLE);</span>
<span class="fc" id="L112">            entry.setSelectNumber(luckyNumber.getLuckyNumber());</span>
<span class="fc" id="L113">            entry.setSequenceOfNumber(luckyNumber.getSequenceOfNumber());</span>
<span class="fc" id="L114">            entry.setPrizeAmount(luckyNumber.getPrizeAmount());</span>
<span class="fc" id="L115">            entry.setTaxAmount(luckyNumber.getTaxAmount());</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">            entry.setWinning(entry.getPrizeAmount().compareTo(new BigDecimal(&quot;0&quot;)) &gt; 0);</span>
<span class="fc" id="L117">            clientTicket.getEntries().add(entry);</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">            if (entry.isWinning()) {</span>
<span class="fc" id="L119">                clientTicket.setWinning(true);</span>
            }
<span class="fc" id="L121">        }</span>
<span class="fc" id="L122">    }</span>

    /**
     * Lookup Sale-ready game instances for sale.
     */
    @Override
    protected List&lt;? extends BaseGameInstance&gt; lookupSaleReadyGameInstance(Context&lt;?&gt; respCtx, BaseTicket clientTicket)
            throws ApplicationException {
<span class="fc" id="L130">        List&lt;? extends BaseGameInstance&gt; gameInstances = null;</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (clientTicket.getGameInstance() == null) {</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L133">                logger.debug(&quot;No game draw provided by client, the service side will randomly &quot;</span>
                        + &quot;pick a active game instance of Magic100.&quot;);
            }
<span class="fc" id="L136">            gameInstances = this.getGameInstanceService().enquirySaleReady(respCtx);</span>
        } else {
            // verify game instance
<span class="fc" id="L139">            gameInstances = this.getGameInstanceService().enquirySaleReady(respCtx,</span>
                    clientTicket.getGameInstance().getGameId(), clientTicket.getGameInstance().getNumber(),
                    clientTicket.getMultipleDraws());
        }
<span class="fc" id="L143">        return gameInstances;</span>
    }

    @Override
    protected void doSuccessfulCancel(Context&lt;?&gt; respCtx, BaseTicket soldTicket) throws ApplicationException {
<span class="fc" id="L148">        Magic100Ticket calcelTicket = (Magic100Ticket) soldTicket;</span>
        // update cancel counter
<span class="fc" id="L150">        List&lt;Magic100Entry&gt; entries = this.getBaseEntryDao().findByTicketSerialNo(Magic100Entry.class,</span>
                soldTicket.getSerialNo(), false);
<span class="fc bfc" id="L152" title="All 2 branches covered.">        for (Magic100Entry entry : entries) {</span>
<span class="fc" id="L153">            soldTicket.getEntries().add(entry);</span>
<span class="fc" id="L154">        }</span>
<span class="fc" id="L155">        this.getLuckyNumberService().cancel(respCtx, calcelTicket);</span>
        // invalid payout
<span class="pc bpc" id="L157" title="1 of 4 branches missed.">        if (soldTicket.isWinning() &amp;&amp; soldTicket.getGameInstance().getGame().isNeedAutoPayout()) {</span>
<span class="fc" id="L158">            List&lt;Payout&gt; payouts = this.getPayoutDao().getByTicketSerialNoAndStatus(soldTicket.getSerialNo(),</span>
                    Payout.STATUS_PAID);
<span class="fc" id="L160">            BigDecimal actualPrizeAmount = new BigDecimal(&quot;0&quot;);</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">            for (Payout payout : payouts) {</span>
<span class="fc" id="L162">                payout.setUpdateTime(respCtx.getTransaction().getUpdateTime());</span>
<span class="fc" id="L163">                payout.setStatus(Payout.STATUS_REVERSED);</span>
<span class="fc" id="L164">                this.getPayoutDao().update(payout);</span>
<span class="fc" id="L165">                actualPrizeAmount = actualPrizeAmount.add(payout.getTotalAmount());</span>
<span class="fc" id="L166">            }</span>

            // reverse operator's payout balance and calculate commission
<span class="fc" id="L169">            Context payoutCtx = (Context) respCtx.clone();</span>
<span class="fc" id="L170">            payoutCtx.getTransaction().setTotalAmount(actualPrizeAmount);</span>
<span class="fc" id="L171">            payoutCtx.getTransaction().setGameId(soldTicket.getGameInstance().getGame().getId());</span>
<span class="fc" id="L172">            Transaction targetTrans = (Transaction) payoutCtx.getTransaction().clone();</span>
<span class="fc" id="L173">            targetTrans.setType(TransactionType.PAYOUT.getRequestType());</span>
<span class="fc" id="L174">            Object operatorOrMerchant = this.getBalanceService().balance(payoutCtx, payoutCtx.getTransaction(),</span>
                    BalanceService.BALANCE_TYPE_PAYOUT, payoutCtx.getTransaction().getOperatorId(), false);
            /**
             * Fix bug#7126 No need to call CommissionBalanceService().cancelCommission() here, as the
             * AbstractTiccketService will call it. the CommissionBalanceService().cancelCommission() will handle all
             * commission logs, includes both sale and payout, so we can't call it twice.
             */
            // // generate balance logs
            // this.getPayoutCommissionBalanceService().cancelCommission(payoutCtx,
            // targetTrans,
            // operatorOrMerchant);
        }
<span class="fc" id="L186">    }</span>

    @Override
    public GameType supportedGameType() {
<span class="fc" id="L190">        return GameType.LUCKYNUMBER;</span>
    }

    @Override
    protected void customizeAssembleTicket(BaseTicket generatedTicket, BaseTicket clientTicket) {
<span class="fc bfc" id="L195" title="All 4 branches covered.">        if (generatedTicket.isWinning() &amp;&amp; clientTicket.getGameInstance().getGame().isNeedAutoPayout()) {</span>
<span class="fc" id="L196">            generatedTicket.setStatus(BaseTicket.STATUS_PAID);</span>
        }
<span class="fc" id="L198">    }</span>

    protected Payout generatePayout(Context&lt;?&gt; respCtx, BaseTicket clientTicket) throws ApplicationException {
<span class="fc" id="L201">        Payout payout = new Payout();</span>
<span class="fc" id="L202">        payout.setGameInstanceId(clientTicket.getGameInstance().getId());</span>
<span class="fc" id="L203">        payout.setGameId(clientTicket.getGameInstance().getGame().getId());</span>
<span class="fc" id="L204">        payout.setId(this.getUuidService().getGeneralID());</span>
<span class="fc" id="L205">        payout.setCreateTime(new Date());</span>
<span class="fc" id="L206">        payout.setUpdateTime(payout.getCreateTime());</span>
<span class="fc" id="L207">        payout.setTransaction(respCtx.getTransaction());</span>
<span class="fc" id="L208">        payout.setTicketSerialNo(clientTicket.getSerialNo());</span>
<span class="fc" id="L209">        payout.setType(Payout.TYPE_WINNING);</span>
<span class="fc" id="L210">        payout.setValid(true);</span>
<span class="fc" id="L211">        payout.setStatus(Payout.STATUS_PAID);</span>
<span class="fc" id="L212">        BigDecimal[] amounts = this.calTax((Magic100Ticket) clientTicket);</span>
<span class="fc" id="L213">        payout.setBeforeTaxTotalAmount(amounts[0]);</span>
<span class="fc" id="L214">        payout.setTotalAmount(amounts[0].subtract(amounts[1]));</span>
<span class="fc" id="L215">        payout.setInputChannel(Payout.INPUT_CHANNEL_MANUAL);</span>
<span class="fc" id="L216">        payout.setOperatorId(respCtx.getTransaction().getOperatorId());</span>
<span class="fc" id="L217">        payout.setDevId((int) respCtx.getTransaction().getDeviceId());</span>
<span class="fc" id="L218">        payout.setMerchantId((int) respCtx.getTransaction().getMerchantId());</span>

<span class="fc" id="L220">        this.getPayoutDao().insert(payout);</span>
<span class="fc" id="L221">        return payout;</span>
    }

    /**
     * Calculate the total prize amount and tax amount of a ticket.
     * 
     * @param clientTicket
     *            The magic100 ticket.
     * @return A array in which 1st is total prize amount and the 2nd is total tax amount.
     */
    protected BigDecimal[] calTax(Magic100Ticket clientTicket) throws ApplicationException {
<span class="fc" id="L232">        BigDecimal prizeAmount = new BigDecimal(&quot;0&quot;);</span>
<span class="fc" id="L233">        BigDecimal taxAmount = new BigDecimal(&quot;0&quot;);</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">        for (BaseEntry e : clientTicket.getEntries()) {</span>
<span class="fc" id="L235">            Magic100Entry entry = (Magic100Entry) e;</span>
<span class="fc" id="L236">            prizeAmount = prizeAmount.add(entry.getPrizeAmount());</span>
<span class="fc" id="L237">            taxAmount = taxAmount.add(entry.getTaxAmount());</span>
<span class="fc" id="L238">        }</span>
<span class="fc" id="L239">        return new BigDecimal[] { prizeAmount, taxAmount };</span>
    }

    // --------------------------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // --------------------------------------------------------------------

    public LuckyNumberService getLuckyNumberService() {
<span class="fc" id="L247">        return luckyNumberService;</span>
    }

    public void setLuckyNumberService(LuckyNumberService luckyNumberService) {
<span class="fc" id="L251">        this.luckyNumberService = luckyNumberService;</span>
<span class="fc" id="L252">    }</span>

    public PayoutDao getPayoutDao() {
<span class="fc" id="L255">        return payoutDao;</span>
    }

    public void setPayoutDao(PayoutDao payoutDao) {
<span class="fc" id="L259">        this.payoutDao = payoutDao;</span>
<span class="fc" id="L260">    }</span>

    public TaxService getTaxService() {
<span class="fc" id="L263">        return taxService;</span>
    }

    public void setTaxService(TaxService taxService) {
<span class="fc" id="L267">        this.taxService = taxService;</span>
<span class="fc" id="L268">    }</span>

    public BaseEntryDao getBaseEntryDao() {
<span class="fc" id="L271">        return baseEntryDao;</span>
    }

    public void setBaseEntryDao(BaseEntryDao baseEntryDao) {
<span class="fc" id="L275">        this.baseEntryDao = baseEntryDao;</span>
<span class="fc" id="L276">    }</span>

    public CommissionBalanceService getPayoutCommissionBalanceService() {
<span class="fc" id="L279">        return payoutCommissionBalanceService;</span>
    }

    public void setPayoutCommissionBalanceService(CommissionBalanceService payoutCommissionBalanceService) {
<span class="nc" id="L283">        this.payoutCommissionBalanceService = payoutCommissionBalanceService;</span>
<span class="nc" id="L284">    }</span>

    public BalanceService getBalanceService() {
<span class="fc" id="L287">        return balanceService;</span>
    }

    public void setBalanceService(BalanceService balanceService) {
<span class="nc" id="L291">        this.balanceService = balanceService;</span>
<span class="nc" id="L292">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>