<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TomcatContextListener.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.port.web.listener</a> &gt; <span class="el_source">TomcatContextListener.java</span></div><h1>TomcatContextListener.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.port.web.listener;

import com.mpos.lottery.te.config.MLotteryContext;
import com.mpos.lottery.te.config.exception.SystemException;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.sql.Driver;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Set;

import javax.management.MBeanServer;
import javax.management.MBeanServerFactory;
import javax.management.ObjectName;
import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;

/**
 * Refer to http://tomcat.apache.org/tomcat-6.0-doc/manager-howto.html Access http://localhost:8080/manager/jmxproxy/ to
 * get all MBeans information.
 */
<span class="nc" id="L27">public class TomcatContextListener implements ServletContextListener {</span>
<span class="nc" id="L28">    private static Log logger = LogFactory.getLog(TomcatContextListener.class);</span>

    public void contextDestroyed(ServletContextEvent ctx) {
<span class="nc" id="L31">        MLotteryContext context = MLotteryContext.getInstance();</span>
<span class="nc" id="L32">        int wait = context.getInt(&quot;seconds.beforeshutdown&quot;);</span>
<span class="nc" id="L33">        logger.debug(&quot;Start to shutdown servlet context, wait &quot; + wait + &quot; secodes.&quot;);</span>
        try {
<span class="nc" id="L35">            Thread.sleep(wait * 1000);</span>
<span class="nc" id="L36">        } catch (Exception e) {</span>
<span class="nc" id="L37">        }</span>

        // This manually deregisters JDBC driver, which prevents Tomcat 6.0.24
        // or above from complaining about memory leaks wrto this class
<span class="nc" id="L41">        Enumeration&lt;Driver&gt; drivers = DriverManager.getDrivers();</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">        while (drivers.hasMoreElements()) {</span>
<span class="nc" id="L43">            Driver driver = drivers.nextElement();</span>
            try {
<span class="nc" id="L45">                DriverManager.deregisterDriver(driver);</span>
<span class="nc" id="L46">                logger.info(String.format(&quot;deregistering jdbc driver: %s&quot;, driver));</span>
<span class="nc" id="L47">            } catch (SQLException e) {</span>
<span class="nc" id="L48">                logger.warn(String.format(&quot;Error deregistering driver %s&quot;, driver), e);</span>
<span class="nc" id="L49">            }</span>

<span class="nc" id="L51">        }</span>
<span class="nc" id="L52">        logger.debug(&quot;Shutdown servlet context.&quot;);</span>
<span class="nc" id="L53">    }</span>

    public void contextInitialized(ServletContextEvent ctx) {
        // initialJMX
<span class="nc" id="L57">    }</span>

    private void initialJMX() {
<span class="nc" id="L60">        MBeanServer mbserver = null;</span>

<span class="nc" id="L62">        ArrayList mbservers = MBeanServerFactory.findMBeanServer(null);</span>

<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (mbservers.size() &gt; 0) {</span>
<span class="nc" id="L65">            mbserver = (MBeanServer) mbservers.get(0);</span>
        }

<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (mbserver == null) {</span>
<span class="nc" id="L69">            mbserver = MBeanServerFactory.createMBeanServer();</span>
        }
<span class="nc" id="L71">        logger.debug(&quot;Create new MBean server:&quot; + mbserver + &quot;,count of mbeans:&quot; + mbserver.getMBeanCount());</span>
        try {
            // Access tomcat's MBean
<span class="nc" id="L74">            Hashtable&lt;String, String&gt; prop = new Hashtable&lt;String, String&gt;();</span>
<span class="nc" id="L75">            prop.put(&quot;type&quot;, &quot;Connector&quot;);</span>
<span class="nc" id="L76">            ObjectName objectName = new ObjectName(&quot;Catalina:type=Connector,*&quot;);</span>
<span class="nc" id="L77">            Set&lt;ObjectName&gt; objectNames = mbserver.queryNames(objectName, null);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            for (ObjectName name : objectNames) {</span>
<span class="nc" id="L79">                logger.debug(name.getDomain() + &quot;:&quot; + name.getKeyProperty(&quot;type&quot;));</span>
<span class="nc" id="L80">                logger.debug(mbserver.getAttribute(name, &quot;port&quot;));</span>
<span class="nc" id="L81">                logger.debug(mbserver.getAttribute(name, &quot;schema&quot;));</span>
<span class="nc" id="L82">            }</span>
<span class="nc" id="L83">        } catch (Exception e) {</span>
<span class="nc" id="L84">            throw new SystemException(e);</span>
<span class="nc" id="L85">        }</span>
<span class="nc" id="L86">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>