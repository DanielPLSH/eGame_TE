<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DefaultVoucherService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.valueaddservice.voucher.service</a> &gt; <span class="el_source">DefaultVoucherService.java</span></div><h1>DefaultVoucherService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.valueaddservice.voucher.service;

import com.mpos.lottery.te.common.dao.BaseJpaDao;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gamespec.game.Game;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.merchant.dao.MerchantCommissionDao;
import com.mpos.lottery.te.merchant.domain.MerchantCommission;
import com.mpos.lottery.te.merchant.service.balance.BalanceService;
import com.mpos.lottery.te.merchant.service.balance.SaleBalanceStrategy;
import com.mpos.lottery.te.merchant.service.commission.CommissionBalanceService;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.port.domain.router.RoutineKey;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.trans.domain.TransactionType;
import com.mpos.lottery.te.trans.domain.logic.AbstractReversalOrCancelStrategy;
import com.mpos.lottery.te.valueaddservice.voucher.Voucher;
import com.mpos.lottery.te.valueaddservice.voucher.VoucherOperationParameter;
import com.mpos.lottery.te.valueaddservice.voucher.VoucherSale;
import com.mpos.lottery.te.valueaddservice.voucher.VoucherStatistics;
import com.mpos.lottery.te.valueaddservice.voucher.dao.VoucherDao;
import com.mpos.lottery.te.valueaddservice.voucher.dao.VoucherSaleDao;
import com.mpos.lottery.te.valueaddservice.voucher.dao.VoucherStatisticsDao;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.springframework.util.Assert;

import javax.annotation.Resource;
import javax.persistence.EntityManager;
import javax.persistence.LockModeType;
import javax.persistence.PersistenceContext;

<span class="fc" id="L35">public class DefaultVoucherService extends AbstractReversalOrCancelStrategy implements VoucherService {</span>
<span class="fc" id="L36">    private Log logger = LogFactory.getLog(DefaultVoucherService.class);</span>
    @Resource(name = &quot;jpaVoucherDao&quot;)
    private VoucherDao voucherDao;
    @Resource(name = &quot;jpaVoucherSaleDao&quot;)
    private VoucherSaleDao voucherSaleDao;
    @Resource(name = &quot;baseJpaDao&quot;)
    private BaseJpaDao baseJpaDao;
    @Resource(name = &quot;defaultBalanceService&quot;)
    private BalanceService balanceService;
    @Resource(name = &quot;saleCommissionBalanceService&quot;)
    private CommissionBalanceService commissionService;
    @Resource(name = &quot;merchantCommissionDao&quot;)
    private MerchantCommissionDao merchantCommissionDao;
    @Resource(name = &quot;jpaVoucherStatDao&quot;)
    private VoucherStatisticsDao voucherStatDao;
    @PersistenceContext
    private EntityManager entityManager;

    @Override
    public Voucher sell(Context respCtx, Voucher reqDto) throws ApplicationException {
<span class="fc" id="L56">        Assert.notNull(reqDto.getFaceAmount(), &quot;The  face amount can't be null&quot;);</span>
<span class="fc" id="L57">        Assert.notNull(reqDto.getGame().getId(), &quot;THe game.id can't be null&quot;);</span>

        // --------------------------------
        // Verify Pro-Conditions
        // --------------------------------
        // verify whether game have been allocated to merchant
<span class="fc" id="L63">        this.verifyGameAllocation(respCtx, reqDto);</span>
        // verify sale balance and lock it to avoid other transaction modify it
<span class="fc" id="L65">        this.verifySaleBalance(respCtx, reqDto);</span>

        // --------------------------------
        // Sell Voucher
        // --------------------------------
<span class="fc" id="L70">        VoucherOperationParameter opPara = this.getBaseJpaDao().findById(VoucherOperationParameter.class,</span>
                reqDto.getGame().getOperatorParameterId());
<span class="fc" id="L72">        Voucher voucher = this.getVoucherDao().findByGameAndFaceAmount(reqDto.getGame().getId(),</span>
                reqDto.getFaceAmount(), opPara.getBufferExpireDay());
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (voucher == null) {</span>
<span class="fc" id="L75">            throw new ApplicationException(SystemException.CODE_NO_TICKET, &quot;No voucher found by (gameId:&quot;</span>
                    + reqDto.getGame().getId() + &quot;,faceAmount:&quot; + reqDto.getFaceAmount() + &quot;, bufferExpireDay:&quot;
                    + opPara.getBufferExpireDay() + &quot;)&quot;);
        }
<span class="fc" id="L79">        voucher.setStatus(Voucher.STATUS_SOLD);</span>
<span class="fc" id="L80">        voucher.decryptPin();</span>
<span class="fc" id="L81">        voucher.setUpdateTime(respCtx.getTransaction().getCreateTime());</span>
        // decrypt the PIN of voucher
<span class="fc" id="L83">        this.getVoucherDao().update(voucher);</span>
        // generate voucher sale entity
<span class="fc" id="L85">        VoucherSale sale = new VoucherSale();</span>
<span class="fc" id="L86">        sale.setId(respCtx.getTransaction().getId());</span>
<span class="fc" id="L87">        sale.setCreateTime(respCtx.getTransaction().getCreateTime());</span>
<span class="fc" id="L88">        sale.setUpdateTime(sale.getCreateTime());</span>
<span class="fc" id="L89">        sale.setDevId(respCtx.getTransaction().getDeviceId());</span>
<span class="fc" id="L90">        sale.setMerchantId(respCtx.getTransaction().getMerchantId());</span>
<span class="fc" id="L91">        sale.setOperatorId(respCtx.getTransaction().getOperatorId());</span>
<span class="fc" id="L92">        sale.setGame(reqDto.getGame());</span>
<span class="fc" id="L93">        sale.setStatus(VoucherSale.STATUS_SUCCESS);</span>
<span class="fc" id="L94">        sale.setTransaction(respCtx.getTransaction());</span>
<span class="fc" id="L95">        sale.setVoucherFaceAmount(reqDto.getFaceAmount());</span>
<span class="fc" id="L96">        sale.setVoucherId(voucher.getId());</span>
<span class="fc" id="L97">        sale.setVoucherSerialNo(voucher.getSerialNo());</span>
<span class="fc" id="L98">        this.getBaseJpaDao().insert(sale);</span>

        // maintain voucher stat
<span class="fc" id="L101">        VoucherStatistics voucherStat = this.getVoucherStatDao().findByGameAndFaceAmount(reqDto.getFaceAmount(),</span>
                reqDto.getGame().getId());
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (voucherStat != null) {</span>
<span class="fc" id="L104">            this.getEntityManager().lock(voucherStat, LockModeType.PESSIMISTIC_READ);</span>
<span class="fc" id="L105">            voucherStat.setRemainCount(voucherStat.getRemainCount() - 1);</span>
<span class="fc" id="L106">            this.getVoucherStatDao().update(voucherStat);</span>
        }

        // --------------------------------
        // Maintain Transaction
        // --------------------------------
<span class="fc" id="L112">        respCtx.getTransaction().setGameId(reqDto.getGame().getId());</span>
<span class="fc" id="L113">        respCtx.getTransaction().setTotalAmount(reqDto.getFaceAmount());</span>
<span class="fc" id="L114">        respCtx.getTransaction().setTicketSerialNo(voucher.getSerialNo());</span>

        // --------------------------------
        // Maintain sale balance and commission
        // --------------------------------
        // maintain the balance/commission the same way with sale.
<span class="fc" id="L120">        respCtx.setProperty(SaleBalanceStrategy.PROP_SOLD_BY_CREDIT_CARD, false);</span>
        // update sale balance
<span class="fc" id="L122">        Object operatorMerchant = this.getBalanceService().balance(respCtx, BalanceService.BALANCE_TYPE_SALE,</span>
                respCtx.getTransaction().getOperatorId(), false);
        // generate voucher sale transaction records
<span class="fc" id="L125">        this.getCommissionService().calCommission(respCtx, operatorMerchant);</span>

<span class="fc" id="L127">        return voucher;</span>
    }

    public RoutineKey supportedReversalRoutineKey() {
<span class="fc" id="L131">        return new RoutineKey(GameType.TELECO_VOUCHER.getType(), TransactionType.SELL_TELECO_VOUCHER.getRequestType());</span>
    }

    @Override
    public boolean cancelOrReverse(Context&lt;?&gt; respCtx, Transaction targetTrans) throws ApplicationException {
<span class="fc" id="L136">        VoucherSale sale = this.getVoucherSaleDao().findByTransaction(targetTrans.getId());</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        if (sale == null) {</span>
<span class="nc" id="L138">            throw new SystemException(&quot;No voucher record found by transId=&quot; + targetTrans.getId());</span>
        }
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (VoucherSale.STATUS_SUCCESS != sale.getStatus()) {</span>
<span class="nc" id="L141">            logger.warn(&quot;Only successful transaction can be cancelled, the status of trans(transId=&quot;</span>
                    + targetTrans.getId() + &quot;) is &quot; + sale.getStatus());
<span class="nc" id="L143">            return false;</span>
        }
<span class="fc" id="L145">        sale.setUpdateTime(respCtx.getTransaction().getCreateTime());</span>
<span class="fc" id="L146">        sale.setStatus(VoucherSale.STATUS_CANCEL);</span>
<span class="fc" id="L147">        this.getVoucherSaleDao().update(sale);</span>

<span class="fc" id="L149">        Voucher voucher = this.getVoucherDao().findById(Voucher.class, sale.getVoucherId());</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if (voucher == null) {</span>
<span class="nc" id="L151">            throw new SystemException(&quot;No voucher found by id=&quot; + sale.getVoucherId());</span>
        }
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">        if (Voucher.STATUS_SOLD != voucher.getStatus()) {</span>
<span class="nc" id="L154">            logger.warn(&quot;Only sold voucher can be cancelled, the status of voucher(id=&quot; + voucher.getId() + &quot;) is &quot;</span>
                    + voucher.getStatus());
<span class="nc" id="L156">            return false;</span>
        }
<span class="fc" id="L158">        voucher.setUpdateTime(respCtx.getTransaction().getCreateTime());</span>
<span class="fc" id="L159">        voucher.setStatus(Voucher.STATUS_IMPORTED);</span>
<span class="fc" id="L160">        this.getVoucherDao().update(voucher);</span>

        // maintain voucher stat
<span class="fc" id="L163">        VoucherStatistics voucherStat = this.getVoucherStatDao().findByGameAndFaceAmount(targetTrans.getTotalAmount(),</span>
                targetTrans.getGameId());
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        if (voucherStat != null) {</span>
<span class="fc" id="L166">            this.getEntityManager().lock(voucherStat, LockModeType.PESSIMISTIC_READ);</span>
<span class="fc" id="L167">            voucherStat.setRemainCount(voucherStat.getRemainCount() + 1);</span>
<span class="fc" id="L168">            this.getVoucherStatDao().update(voucherStat);</span>
        }

        // --------------------------------
        // Maintain sale balance and commission
        // --------------------------------
        // maintain the balance/commission the same way with sale.
<span class="fc" id="L175">        respCtx.setProperty(SaleBalanceStrategy.PROP_SOLD_BY_CREDIT_CARD, false);</span>
        // update sale balance
<span class="fc" id="L177">        Object operatorMerchant = this.getBalanceService().balance(respCtx, BalanceService.BALANCE_TYPE_SALE,</span>
                targetTrans.getOperatorId(), true);
        // generate voucher sale transaction records
<span class="fc" id="L180">        this.getCommissionService().cancelCommission(respCtx, targetTrans, operatorMerchant);</span>

<span class="fc" id="L182">        return false;</span>
    }

    // -------------------------------------------------------
    // HELPER METHODS
    // -------------------------------------------------------

    private void verifyGameAllocation(Context respCtx, Voucher reqDto) throws ApplicationException {
        // verify game status, actually a game represent a airtime service provider(telecom operator).
<span class="fc" id="L191">        Game game = this.getBaseJpaDao().findById(Game.class, reqDto.getGame().getId());</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L193">            throw new SystemException(&quot;No game found by id=&quot; + reqDto.getGame().getId());</span>
        }
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (Game.STATUS_ACTIVE != game.getState()) {</span>
<span class="fc" id="L196">            throw new ApplicationException(SystemException.CODE_GAME_INACTIVE, &quot;Game(id=&quot; + reqDto.getGame().getId()</span>
                    + &quot;) isn't active.&quot;);
        }
<span class="fc" id="L199">        reqDto.setGame(game);</span>
<span class="fc" id="L200">        MerchantCommission comm = this.getMerchantCommissionDao().getByMerchantAndGame(respCtx.getMerchant().getId(),</span>
                game.getId());
<span class="fc bfc" id="L202" title="All 2 branches covered.">        if (comm == null) {</span>
<span class="fc" id="L203">            throw new SystemException(SystemException.CODE_OPERATOR_SELL_NOPRIVILEDGE, &quot;operator(id=&quot;</span>
                    + respCtx.getOperatorId() + &quot;) has no priviledge to sell voucher of game(teleco operator) '&quot;
                    + game.getId() + &quot;', allocate the game to its merchant(id=&quot; + respCtx.getMerchant().getId()
                    + &quot;) first.&quot;);
        }
<span class="fc" id="L208">    }</span>

    /**
     * Verify whether the sale balance of operator/merchant is enough for transaction, and lock it for later updating.
     */
    protected void verifySaleBalance(Context respCtx, Voucher reqDto) throws ApplicationException {
<span class="fc" id="L214">        this.getBalanceService().lockAndVerifySaleBalance(respCtx.getTransaction().getOperatorId(),</span>
                respCtx.getTransaction().getMerchantId(), reqDto.getFaceAmount());
<span class="fc" id="L216">    }</span>

    // -------------------------------------------------------
    // SPRING DEPENDENDIES
    // -------------------------------------------------------

    public BaseJpaDao getBaseJpaDao() {
<span class="fc" id="L223">        return baseJpaDao;</span>
    }

    public void setBaseJpaDao(BaseJpaDao baseJpaDao) {
<span class="nc" id="L227">        this.baseJpaDao = baseJpaDao;</span>
<span class="nc" id="L228">    }</span>

    public BalanceService getBalanceService() {
<span class="fc" id="L231">        return balanceService;</span>
    }

    public void setBalanceService(BalanceService balanceService) {
<span class="nc" id="L235">        this.balanceService = balanceService;</span>
<span class="nc" id="L236">    }</span>

    public CommissionBalanceService getCommissionService() {
<span class="fc" id="L239">        return commissionService;</span>
    }

    public void setCommissionService(CommissionBalanceService commissionService) {
<span class="nc" id="L243">        this.commissionService = commissionService;</span>
<span class="nc" id="L244">    }</span>

    public MerchantCommissionDao getMerchantCommissionDao() {
<span class="fc" id="L247">        return merchantCommissionDao;</span>
    }

    public void setMerchantCommissionDao(MerchantCommissionDao merchantCommissionDao) {
<span class="nc" id="L251">        this.merchantCommissionDao = merchantCommissionDao;</span>
<span class="nc" id="L252">    }</span>

    public VoucherDao getVoucherDao() {
<span class="fc" id="L255">        return voucherDao;</span>
    }

    public void setVoucherDao(VoucherDao voucherDao) {
<span class="nc" id="L259">        this.voucherDao = voucherDao;</span>
<span class="nc" id="L260">    }</span>

    public VoucherSaleDao getVoucherSaleDao() {
<span class="fc" id="L263">        return voucherSaleDao;</span>
    }

    public void setVoucherSaleDao(VoucherSaleDao voucherSaleDao) {
<span class="nc" id="L267">        this.voucherSaleDao = voucherSaleDao;</span>
<span class="nc" id="L268">    }</span>

    public VoucherStatisticsDao getVoucherStatDao() {
<span class="fc" id="L271">        return voucherStatDao;</span>
    }

    public void setVoucherStatDao(VoucherStatisticsDao voucherStatDao) {
<span class="nc" id="L275">        this.voucherStatDao = voucherStatDao;</span>
<span class="nc" id="L276">    }</span>

    public EntityManager getEntityManager() {
<span class="fc" id="L279">        return entityManager;</span>
    }

    public void setEntityManager(EntityManager entityManager) {
<span class="nc" id="L283">        this.entityManager = entityManager;</span>
<span class="nc" id="L284">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>