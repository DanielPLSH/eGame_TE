<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Barcoder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.common.util</a> &gt; <span class="el_source">Barcoder.java</span></div><h1>Barcoder.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.common.util;

import com.mpos.lottery.te.common.encrypt.TriperDESCipher;
import com.mpos.lottery.te.config.exception.SystemException;

/**
 * To generate QR barcode. The algorithm of generating barcode is as below:
 * 
 * &lt;pre&gt;
 * Base64(3DES(input + DES_Key))
 * &lt;/pre&gt;
 * 
 * For example, to generate barcode of ticket, the &lt;code&gt;input&lt;/code&gt; will be the serialNo, however for daily summary
 * report, the input will be '${operatorID},${startTime},${endTime}'. It is better to know the input format at where the
 * barcode is generated.
 * 
 * @author Ramon
 */
public class Barcoder {
    // the 3DES key in BASE64 representation.
<span class="fc" id="L21">    private String desKey = &quot;W0JAMWQ1MGZkMjc2N2U2M2Y2LWVkYTIt&quot;;</span>
<span class="fc" id="L22">    private int sizeOfGameType = 2;</span>

    private int gameType;
    private String serialNo;
    private String barcode;

    /**
     * Encode the serial number of ticket.
     * 
     * @param input
     *            THe source to generate barcode, such as serial number.
     * @param gameType
     *            the game type of ticket.
     */
<span class="fc" id="L36">    public Barcoder(int gameType, String input) {</span>
<span class="pc bpc" id="L37" title="1 of 2 branches missed.">        if (input == null) {</span>
<span class="nc" id="L38">            throw new IllegalArgumentException(&quot;argument 'input' can not be null&quot;);</span>
        }
<span class="fc" id="L40">        this.gameType = gameType;</span>
<span class="fc" id="L41">        this.serialNo = input;</span>

        try {
<span class="fc" id="L44">            this.barcode = SimpleToolkit.fillLeft(sizeOfGameType, '0', gameType + &quot;&quot;)</span>
                    + TriperDESCipher.encrypt(desKey, this.desKey + input, TriperDESCipher.STR_IV);
<span class="nc" id="L46">        } catch (Exception e) {</span>
<span class="nc" id="L47">            throw new RuntimeException(e);</span>
<span class="fc" id="L48">        }</span>
<span class="fc" id="L49">    }</span>

    // public Barcoder(String desBase64Key) {
    // this.desKey = desBase64Key;
    // }

    /**
     * Decode the barcode of ticket.
     * 
     * @param barcode
     *            THe generated barcode in base64 representation.
     */
<span class="fc" id="L61">    public Barcoder(String barcode) {</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if (barcode == null) {</span>
<span class="nc" id="L63">            throw new IllegalArgumentException(&quot;argument 'barcode' can not be null&quot;);</span>
        }
<span class="fc" id="L65">        this.barcode = barcode;</span>

        try {
<span class="fc" id="L68">            this.gameType = Integer.parseInt(barcode.substring(0, sizeOfGameType));</span>
<span class="fc" id="L69">            String source = TriperDESCipher.decrypt(this.desKey, barcode.substring(sizeOfGameType),</span>
                    TriperDESCipher.STR_IV);
<span class="fc" id="L71">            this.serialNo = source.substring(this.desKey.length());</span>
<span class="nc" id="L72">        } catch (Exception e) {</span>
<span class="nc" id="L73">            throw new SystemException(SystemException.CODE_WRONGFORMAT_SERIALNO, e.getMessage());</span>
<span class="fc" id="L74">        }</span>
<span class="fc" id="L75">    }</span>

    public int getGameType() {
<span class="fc" id="L78">        return gameType;</span>
    }

    public String getSerialNo() {
<span class="fc" id="L82">        return serialNo;</span>
    }

    public String getBarcode() {
<span class="fc" id="L86">        return barcode;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>