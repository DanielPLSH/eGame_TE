<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SecurityMeasurements.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.common.util</a> &gt; <span class="el_source">SecurityMeasurements.java</span></div><h1>SecurityMeasurements.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.common.util;

import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.math.BigInteger;
import java.security.Key;
import java.security.KeyFactory;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.security.interfaces.RSAPublicKey;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.KeySpec;
import java.security.spec.PKCS8EncodedKeySpec;
import java.security.spec.RSAPrivateKeySpec;
import java.security.spec.RSAPublicKeySpec;
import java.security.spec.X509EncodedKeySpec;

import javax.crypto.Cipher;
import javax.crypto.Mac;
import javax.crypto.SecretKey;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;

/**
 * SecurityMeasurements
 */
<span class="nc" id="L29">public class SecurityMeasurements {</span>

<span class="nc" id="L31">    private final static IvParameterSpec IvParameters = new IvParameterSpec(new byte[] { Byte.parseByte(&quot;00&quot;, 16),</span>
            Byte.parseByte(&quot;00&quot;, 16), Byte.parseByte(&quot;00&quot;, 16), Byte.parseByte(&quot;00&quot;, 16), Byte.parseByte(&quot;00&quot;, 16),
            Byte.parseByte(&quot;00&quot;, 16), Byte.parseByte(&quot;00&quot;, 16), Byte.parseByte(&quot;00&quot;, 16) });

    public static byte[] RSAEncryptWithPublicKeyToByteArray(byte[] strPlainText, Key pPublicKey) throws Exception {
<span class="nc" id="L36">        Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;);</span>
<span class="nc" id="L37">        cipher.init(Cipher.ENCRYPT_MODE, pPublicKey);</span>
<span class="nc" id="L38">        return cipher.doFinal(strPlainText);</span>
    }

    public static byte[] RSAEncryptWithPublicKeyToByteArray(byte[] strPlainText, String strPublicKeyBase64)
            throws Exception {
<span class="nc" id="L43">        return RSAEncryptWithPublicKeyToByteArray(strPlainText, GetRSAKeyFromBase64String(strPublicKeyBase64, true));</span>
    }

    public static byte[] RSAEncryptWithPublicKeyToByteArray(byte[] strPlainText, String strModulus, String strExponent)
            throws Exception {
<span class="nc" id="L48">        return RSAEncryptWithPublicKeyToByteArray(strPlainText,</span>
                GetRSAKeyFromModulusExponentFormat(strModulus, strExponent, true));
    }

    /**
     * Encrypt a byte array with RSA public key in base64 format
     */
    public static String RSAEncryptWithPublicKeyToBase64String(byte[] strPlainText, String strPublicKeyBase64)
            throws Exception {
<span class="nc" id="L57">        return Utilities.Byte2Base64String(RSAEncryptWithPublicKeyToByteArray(strPlainText, strPublicKeyBase64));</span>
    }

    public static String RSAEncryptWithPublicKeyToBase64String(byte[] strPlainText, String strModulus,
            String strExponent) throws Exception {
<span class="nc" id="L62">        return Utilities.Byte2Base64String(RSAEncryptWithPublicKeyToByteArray(strPlainText, strModulus, strExponent));</span>
    }

    public static byte[] RSADecryptWithPublicKeyToByteArray(byte[] strEncryptedText, Key pPublicKey) throws Exception {
<span class="nc" id="L66">        Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;);</span>
        // System.out.println(&quot;nProvider is: &quot; + cipher.getProvider().getInfo());
<span class="nc" id="L68">        cipher.init(Cipher.DECRYPT_MODE, pPublicKey);</span>
<span class="nc" id="L69">        return cipher.doFinal(strEncryptedText);</span>
    }

    public static byte[] RSADecryptWithPublicKeyToByteArray(byte[] strEncryptedText, String strPublicKeyBase64)
            throws Exception {
<span class="nc" id="L74">        return RSADecryptWithPublicKeyToByteArray(strEncryptedText, GetRSAKeyFromBase64String(strPublicKeyBase64, true));</span>
    }

    public static byte[] RSADecryptWithPublicKeyToByteArray(byte[] strPlainText, String strModulus, String strExponent)
            throws Exception {
<span class="nc" id="L79">        return RSADecryptWithPublicKeyToByteArray(strPlainText,</span>
                GetRSAKeyFromModulusExponentFormat(strModulus, strExponent, true));
    }

    /**
     * Decrypt a byte array with RSA public key
     */
    public static String RSADecryptWithPublicKeyToBase64String(byte[] strEncryptedText, String strPublicKeyBase64)
            throws Exception {
<span class="nc" id="L88">        return Utilities.Byte2Base64String(RSADecryptWithPublicKeyToByteArray(strEncryptedText, strPublicKeyBase64));</span>
    }

    public static String RSADecryptWithPublicKeyToBase64String(byte[] strEncryptedText, String strModulus,
            String strExponent) throws Exception {
<span class="nc" id="L93">        return Utilities</span>
                .Byte2Base64String(RSADecryptWithPublicKeyToByteArray(strEncryptedText, strModulus, strExponent));
    }

    public static byte[] RSAEncryptWithPrivateKeyToByteArray(byte[] strPlainText, Key pPrivateKey) throws Exception {
<span class="nc" id="L98">        Cipher cipher = Cipher.getInstance(&quot;RSA/ECB/PKCS1Padding&quot;);</span>
        // System.out.println(&quot;nProvider is: &quot; + cipher.getProvider().getInfo());
<span class="nc" id="L100">        cipher.init(Cipher.ENCRYPT_MODE, pPrivateKey);</span>
<span class="nc" id="L101">        return cipher.doFinal(strPlainText);</span>
    }

    public static byte[] RSAEncryptWithPrivateKeyToByteArray(byte[] strPlainText, String strPrivateKeyBase64)
            throws Exception {
<span class="nc" id="L106">        return RSAEncryptWithPrivateKeyToByteArray(strPlainText, GetRSAKeyFromBase64String(strPrivateKeyBase64, false));</span>
    }

    public static byte[] RSAEncryptWithPrivateKeyToByteArray(byte[] strPlainText, String strModulus, String strExponent)
            throws Exception {
<span class="nc" id="L111">        return RSAEncryptWithPrivateKeyToByteArray(strPlainText,</span>
                GetRSAKeyFromModulusExponentFormat(strModulus, strExponent, false));
    }

    public static String RSAEncryptWithPrivateKeyToBase64String(byte[] strPlainText, String strPrivateKeyBase64)
            throws Exception {
<span class="nc" id="L117">        return Utilities.Byte2Base64String(RSAEncryptWithPrivateKeyToByteArray(strPlainText, strPrivateKeyBase64));</span>
    }

    public static String RSAEncryptWithPrivateKeyToBase64String(byte[] strPlainText, String strModulus,
            String strExponent) throws Exception {
<span class="nc" id="L122">        return Utilities.Byte2Base64String(RSAEncryptWithPrivateKeyToByteArray(strPlainText, strModulus, strExponent));</span>
    }

    public static byte[] RSADecryptWithPrivateKeyToByteArray(byte[] strEncryptedText, Key pPrivateKey) throws Exception {
<span class="nc" id="L126">        Cipher cipher = Cipher.getInstance(&quot;RSA&quot;);</span>
        // System.out.println(&quot;nProvider is: &quot; + cipher.getProvider().getInfo());
<span class="nc" id="L128">        cipher.init(Cipher.DECRYPT_MODE, pPrivateKey);</span>
<span class="nc" id="L129">        return cipher.doFinal(strEncryptedText);</span>
    }

    public static byte[] RSADecryptWithPrivateKeyToByteArray(byte[] strEncryptedText, String strPrivateKeyBase64)
            throws Exception {
<span class="nc" id="L134">        return RSADecryptWithPrivateKeyToByteArray(strEncryptedText,</span>
                GetRSAKeyFromBase64String(strPrivateKeyBase64, false));
    }

    public static byte[] RSADecryptWithPrivateKeyToByteArray(byte[] strEncryptedText, String strModulus,
            String strExponent) throws Exception {
<span class="nc" id="L140">        return RSADecryptWithPrivateKeyToByteArray(strEncryptedText,</span>
                GetRSAKeyFromModulusExponentFormat(strModulus, strExponent, false));
    }

    public static String RSADecryptWithPrivateKeyToBase64String(byte[] strEncryptedText, String strPrivateKeyBase64)
            throws Exception {
<span class="nc" id="L146">        return Utilities.Byte2Base64String(RSADecryptWithPrivateKeyToByteArray(strEncryptedText, strPrivateKeyBase64));</span>
    }

    public static String RSADecryptWithPrivateKeyToBase64String(byte[] strEncryptedText, String strModulus,
            String strExponent) throws Exception {
<span class="nc" id="L151">        return Utilities.Byte2Base64String(RSADecryptWithPrivateKeyToByteArray(strEncryptedText, strModulus,</span>
                strExponent));
    }

    public static Key GetRSAKeyFromBase64String(String key, boolean bIsPublicKey) throws NoSuchAlgorithmException,
            InvalidKeySpecException {
<span class="nc" id="L157">        KeySpec keySpec = null;</span>
<span class="nc" id="L158">        Key pKey = null;</span>
<span class="nc" id="L159">        KeyFactory pKeyFactory = KeyFactory.getInstance(&quot;RSA&quot;);</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (bIsPublicKey == true) {</span>
<span class="nc" id="L162">            keySpec = new X509EncodedKeySpec(Utilities.Base64String2Byte(key));</span>
<span class="nc" id="L163">            pKey = pKeyFactory.generatePublic(keySpec);</span>

            // RSAPublicKey secretKey = (RSAPublicKey)pKey;
            // System.out.println(&quot;Modulus = &quot; + secretKey.getModulus().toString(16).toUpperCase());
            // System.out.println(&quot;Public Exponent = &quot; +
            // secretKey.getPublicExponent().toString(16).toUpperCase());
        } else {
<span class="nc" id="L170">            keySpec = new PKCS8EncodedKeySpec(Utilities.Base64String2Byte(key));</span>
<span class="nc" id="L171">            pKey = pKeyFactory.generatePrivate(keySpec);</span>

            // RSAPrivateKey secretKey = (RSAPrivateKey)pKey;
            // System.out.println(&quot;Modulus = &quot; + secretKey.getModulus().toString(16).toUpperCase());
            // System.out.println(&quot;Private Exponent = &quot; +
            // secretKey.getPrivateExponent().toString(16).toUpperCase());
        }
        // System.out.println(&quot;public format: &quot; + pKey.getFormat());
        // System.out.println(&quot;public algorithm: &quot; + pKey.getAlgorithm());
        // System.out.println(&quot;public encoded: &quot; + Utilities.DumpBytes(pKey.getEncoded()));
<span class="nc" id="L181">        return pKey;</span>
    }

    public static Key GetRSAKeyFromModulusExponentFormat(String strModulus, String strExponent, boolean bIsPublicKey)
            throws NoSuchAlgorithmException, InvalidKeySpecException {
<span class="nc" id="L186">        KeyFactory pKeyFac = KeyFactory.getInstance(&quot;RSA&quot;);</span>
<span class="nc" id="L187">        Key pKey = null;</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (bIsPublicKey == true) {</span>
<span class="nc" id="L189">            RSAPublicKeySpec pKeySpec = new RSAPublicKeySpec(new BigInteger(strModulus, 16), new BigInteger(</span>
                    strExponent, 16));
<span class="nc" id="L191">            pKey = (Key) pKeyFac.generatePublic(pKeySpec);</span>
<span class="nc" id="L192">        } else {</span>
<span class="nc" id="L193">            RSAPrivateKeySpec pKeySpec = new RSAPrivateKeySpec(new BigInteger(strModulus, 16), new BigInteger(</span>
                    strExponent, 16));
<span class="nc" id="L195">            pKey = (Key) pKeyFac.generatePrivate(pKeySpec);</span>
        }
<span class="nc" id="L197">        return pKey;</span>
    }

    public static byte[] HMACMD5ToByteArray(byte[] strPlainText, String pKeyBase64) throws Exception {
<span class="nc" id="L201">        SecretKey sk = new SecretKeySpec(Utilities.Base64String2Byte(pKeyBase64), &quot;HmacMD5&quot;);</span>
        // System.out.println(&quot;Algorithm = &quot; +sk.getAlgorithm());
        // System.out.println(&quot;Format = &quot; + sk.getFormat());
        // System.out.println(Utilities.DumpBytes(Utilities.Base64String2Byte(pKeyBase64)));
        // System.out.println(Utilities.DumpBytes(sk.getEncoded()));
<span class="nc" id="L206">        Mac mac = Mac.getInstance(&quot;HmacMD5&quot;);</span>
<span class="nc" id="L207">        mac.init(sk);</span>
<span class="nc" id="L208">        return mac.doFinal(strPlainText);</span>
    }

    /**
     * To get the HMAC-MD5 hex string.
     */
    public static String HMACMD5ToHexString(byte[] strPlainText, String pKeyBase64) throws Exception {
<span class="nc" id="L215">        return Utilities.DumpBytes(HMACMD5ToByteArray(strPlainText, pKeyBase64));</span>
    }

    /**
     * Get the Triple DES of a plain text in form of byte array.
     */
    public static byte[] TripleDESCBCEncryptToByteArray(byte[] strPlainText, String pKeyBase64) throws Exception {
        // DESedeKeySpec keySpec = new DESedeKeySpec(Utilities.Base64String2Byte(pKeyBase64));
        // SecretKeyFactory keyFactory = SecretKeyFactory.getInstance(&quot;DESede&quot;);
        // SecretKey sk = keyFactory.generateSecret(keySpec);
<span class="nc" id="L225">        SecretKey sk = new SecretKeySpec(Utilities.Base64String2Byte(pKeyBase64), &quot;DESede&quot;);</span>
        // System.out.println(&quot;Algorithm = &quot; +sk.getAlgorithm());
        // System.out.println(&quot;Format = &quot; + sk.getFormat());
        // System.out.println(Utilities.DumpBytes(Utilities.Base64String2Byte(pKeyBase64)));
        // System.out.println(Utilities.DumpBytes(sk.getEncoded()));
<span class="nc" id="L230">        Cipher cipher = Cipher.getInstance(&quot;DESede/CBC/PKCS5Padding&quot;);</span>
        // Cipher cipher = Cipher.getInstance(&quot;DESede/CBC/NoPadding&quot;);
<span class="nc" id="L232">        cipher.init(Cipher.ENCRYPT_MODE, sk, IvParameters);</span>
<span class="nc" id="L233">        return cipher.doFinal(strPlainText);</span>
    }

    /**
     * Get the Triple DES of a plain text in form of base64 string.
     */
    public static String TripleDESCBCEncryptToBase64String(byte[] strPlainText, String pKeyBase64) throws Exception {
<span class="nc" id="L240">        return Utilities.Byte2Base64String(TripleDESCBCEncryptToByteArray(strPlainText, pKeyBase64));</span>
    }

    /**
     * Get the plain text from a triple des base64 string.
     */
    public static byte[] TripleDESCBCDecryptToByteArray(String pEncryptedText, String pKeyBase64) throws Exception {
<span class="nc" id="L247">        SecretKey sk = new SecretKeySpec(Utilities.Base64String2Byte(pKeyBase64), &quot;DESede&quot;);</span>
<span class="nc" id="L248">        Cipher cipher = Cipher.getInstance(&quot;DESede/CBC/PKCS5Padding&quot;);</span>
        // Cipher cipher = Cipher.getInstance(&quot;DESede/CBC/NoPadding&quot;);
<span class="nc" id="L250">        cipher.init(Cipher.DECRYPT_MODE, sk, IvParameters);</span>
<span class="nc" id="L251">        return cipher.doFinal(Utilities.Base64String2Byte(pEncryptedText));</span>
    }

    /**
     * Get the plain text from a triple des base64 string.
     */
    public static String TripleDESCBCDecryptToString(String pEncryptedText, String pKeyBase64) throws Exception {
<span class="nc" id="L258">        return new String(TripleDESCBCDecryptToByteArray(pEncryptedText, pKeyBase64));</span>
    }

    /**
     * Generate a MD5 byte array with input string.
     */
    public static byte[] MD5PlainTextToByteArray(String pPlainText) throws Exception {
<span class="nc" id="L265">        MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);</span>
<span class="nc" id="L266">        return md.digest(pPlainText.getBytes());</span>
    }

    /**
     * Generate a MD5 hex string with input string.
     */
    public static String MD5PlainTextToHexString(String pPlainText) throws Exception {
<span class="nc" id="L273">        return Utilities.DumpBytes(MD5PlainTextToByteArray(pPlainText));</span>
    }

    public static RSAPublicKey ReadPEM(String strFileName) throws FileNotFoundException, IOException,
            NoSuchAlgorithmException, InvalidKeySpecException {
<span class="nc" id="L278">        String pKeyString = &quot;&quot;;</span>
        // StringBuffer fileData = new StringBuffer(1000);
<span class="nc" id="L280">        BufferedReader reader = new BufferedReader(new FileReader(strFileName));</span>
<span class="nc" id="L281">        char[] buf = new char[1024];</span>
        String tmp;
<span class="nc bnc" id="L283" title="All 2 branches missed.">        while ((tmp = reader.readLine()) != null) {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (!tmp.startsWith(&quot;-----&quot;)) {</span>
<span class="nc" id="L285">                pKeyString += tmp;</span>
            }
        }
<span class="nc" id="L288">        reader.close();</span>
<span class="nc" id="L289">        return (RSAPublicKey) GetRSAKeyFromBase64String(pKeyString, true);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>