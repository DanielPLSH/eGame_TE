<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DefaultActivityReportService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.merchant.service.impl</a> &gt; <span class="el_source">DefaultActivityReportService.java</span></div><h1>DefaultActivityReportService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.merchant.service.impl;

import com.mpos.lottery.te.config.dao.SysConfigurationDao;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.merchant.dao.ActivityReportDao;
import com.mpos.lottery.te.merchant.domain.logic.GameTypeActivityReportHandler;
import com.mpos.lottery.te.merchant.service.ActivityReportService;
import com.mpos.lottery.te.merchant.web.ActivityReport;
import com.mpos.lottery.te.merchant.web.DailyActivityReport;
import com.mpos.lottery.te.port.Context;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

<span class="fc" id="L22">public class DefaultActivityReportService implements ActivityReportService {</span>
<span class="fc" id="L23">    private Log logger = LogFactory.getLog(DefaultActivityReportService.class);</span>
<span class="fc" id="L24">    private Map&lt;GameType, GameTypeActivityReportHandler&gt; gameTypeActivityReportHandlerMap = new HashMap&lt;GameType, GameTypeActivityReportHandler&gt;();</span>
    private SysConfigurationDao sysConfigurationDao;
    private ActivityReportDao payoutDao;
    private ActivityReportDao commissionDao;
    private ActivityReportDao destinationActivityReportDao;
    private ActivityReportDao generalActivityReportDao;
    private ActivityReportDao transferActivityReportDao;

    @Override
    public void registerHandler(GameType gameType, GameTypeActivityReportHandler handler) {
<span class="pc bpc" id="L34" title="1 of 2 branches missed.">        if (this.gameTypeActivityReportHandlerMap.get(gameType) != null) {</span>
<span class="nc" id="L35">            throw new SystemException(&quot;A handler(&quot; + this.gameTypeActivityReportHandlerMap.get(gameType)</span>
                    + &quot;) has registered with game type(&quot; + gameType + &quot;), however another handler(&quot; + handler
                    + &quot;) try to register with same game type.&quot;);
        }
<span class="fc" id="L39">        this.gameTypeActivityReportHandlerMap.put(gameType, handler);</span>
<span class="fc" id="L40">    }</span>

    @Override
    public ActivityReport query(@SuppressWarnings(&quot;rawtypes&quot;) Context context, ActivityReport request)
            throws ApplicationException {
<span class="fc" id="L45">        this.verifyTimeCriteria(context, request);</span>
        // initial report
<span class="fc" id="L47">        ActivityReport report = request;</span>

        // handle sale activity report
<span class="fc" id="L50">        Set&lt;GameType&gt; gameTypes = this.gameTypeActivityReportHandlerMap.keySet();</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">        for (GameType gameType : gameTypes) {</span>
            // handle the sale one by one
<span class="fc" id="L53">            List&lt;DailyActivityReport&gt; dailyActivityReports = this.gameTypeActivityReportHandlerMap.get(gameType)</span>
                    .enquiry(context, request.getOperatorId(), request.getStartTime(), request.getEndTime());
<span class="fc" id="L55">            report.mergeDailyActivityReports(dailyActivityReports);</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">            for (DailyActivityReport dailyReport : dailyActivityReports) {</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L58">                    logger.debug(&quot;DailyActivityReport of &quot; + gameType + &quot;:&quot; + dailyReport);</span>
                }
<span class="fc" id="L60">            }</span>
<span class="fc" id="L61">        }</span>

        // handle payout activity report
<span class="fc" id="L64">        List&lt;DailyActivityReport&gt; payoutReports = this.getPayoutDao().findActivityReport(context.getOperatorId(),</span>
                request.getStartTime(), request.getEndTime());
<span class="fc" id="L66">        report.mergeDailyActivityReports(payoutReports);</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        for (DailyActivityReport dailyReport : payoutReports) {</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L69">                logger.debug(&quot;DailyActivityReport of Payout:&quot; + dailyReport);</span>
            }
<span class="fc" id="L71">        }</span>

        // such as Operator Cash Out By Pass,Operator Cash Out Manually,Cashout of customer,cashout
        // withdraw etc
<span class="fc" id="L75">        List&lt;DailyActivityReport&gt; destinationActivityReports = destinationActivityReportDao.findActivityReport(</span>
                context.getOperatorId(), request.getStartTime(), request.getEndTime());
<span class="fc" id="L77">        report.mergeDailyActivityReports(destinationActivityReports);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        for (DailyActivityReport dailyReport : payoutReports) {</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L80">                logger.debug(&quot;DailyActivityReport of destination Operator Cash Out By Pass,Operator Cash Out &quot;</span>
                        + &quot;Manually,Cashout of customer,cashout withdraw:&quot; + dailyReport);
            }
<span class="fc" id="L83">        }</span>

        // such as Operator Cash Out By Pass,Operator Cash Out Manually,Income Balance Transfer, Top up
        // by
        // voucher,cashout withdraw,Cashout of customer etc
<span class="fc" id="L88">        List&lt;DailyActivityReport&gt; generalActivityReports = generalActivityReportDao.findActivityReport(</span>
                context.getOperatorId(), request.getStartTime(), request.getEndTime());
<span class="fc" id="L90">        report.mergeDailyActivityReports(generalActivityReports);</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        for (DailyActivityReport dailyReport : payoutReports) {</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L93">                logger.debug(&quot;DailyActivityReport of Cash Out By Pass,Operator Cash Out Manually,Income &quot;</span>
                        + &quot;Balance Transfer,Top up by voucher,cashout withdraw,Cashout of customer:&quot; + dailyReport);
            }
<span class="fc" id="L96">        }</span>

        // handle generate transactions which has no relationship with game,
        // such as Operator Cash Out By Pass,Operator Cash Out Manually,Income Balance Transfer etc
<span class="fc" id="L100">        List&lt;DailyActivityReport&gt; commissionReports = this.getCommissionDao().findActivityReport(</span>
                context.getOperatorId(), request.getStartTime(), request.getEndTime());
<span class="fc" id="L102">        report.mergeDailyActivityReports(commissionReports);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">        for (DailyActivityReport dailyReport : commissionReports) {</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L105">                logger.debug(&quot;DailyActivityReport of Commission:&quot; + dailyReport);</span>
            }
<span class="fc" id="L107">        }</span>


        //Need to invoke transferActivityReportDao to handle balance transfer transaction
<span class="fc" id="L111">        List&lt;DailyActivityReport&gt; transferReports = this.getTransferActivityReportDao().findActivityReport(</span>
                context.getOperatorId(), request.getStartTime(), request.getEndTime());
<span class="fc" id="L113">        report.mergeDailyActivityReports(transferReports);</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">        for (DailyActivityReport dailyReport : transferReports) {</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L116">                logger.debug(&quot;DailyActivityReport of Commission:&quot; + dailyReport);</span>
            }
<span class="fc" id="L118">        }</span>
       
        

<span class="fc" id="L122">        return report;</span>
    }

    // --------------------------------------------------------
    // PROTECTED METHODS
    // --------------------------------------------------------

    /**
     * Check the query criteria, includes:
     * &lt;ul&gt;
     * &lt;li&gt;startTime must be earlier than endTime.&lt;/li&gt;
     * &lt;li&gt;startTime can't be earlier than max allowed querying days.&lt;/li&gt;
     * &lt;/ul&gt;
     */
    protected void verifyTimeCriteria(Context context, ActivityReport request) throws ApplicationException {
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        if (request.getOperatorId() == null) {</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L139">                logger.debug(&quot;No operator provided in request body, the X-Operator-Id(&quot; + context.getOperatorId()</span>
                        + &quot;) will be used.&quot;);
            }
<span class="fc" id="L142">            request.setOperatorId(context.getOperatorId());</span>
        }
        // endTime must be later than startTime
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (!request.getEndTime().after(request.getStartTime())) {</span>
<span class="nc" id="L146">            throw new ApplicationException(SystemException.CODE_STARTTIME_LATER_THAN_ENDTIME, &quot;The start time(&quot;</span>
                    + request.getStartTime() + &quot;) can't be later than end time(&quot; + request.getEndTime() + &quot;).&quot;);
        }
<span class="fc" id="L149">        long allowedQueeryDays = this.getSysConfigurationDao().getSysConfiguration()</span>
                .getMaxAllowedDaysOfActivityReport();
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (request.getEndTime().getTime() - request.getStartTime().getTime() &gt; allowedQueeryDays * 24 * 3600 * 1000) {</span>
<span class="nc" id="L152">            throw new ApplicationException(SystemException.CODE_EXCEED_MAX_ALLOWED_QUERY_DAYS, &quot;Can only query max &quot;</span>
                    + allowedQueeryDays + &quot; days' report.&quot;);
        }
<span class="fc" id="L155">    }</span>

    // --------------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // --------------------------------------------------------

    public SysConfigurationDao getSysConfigurationDao() {
<span class="fc" id="L162">        return sysConfigurationDao;</span>
    }

    public void setSysConfigurationDao(SysConfigurationDao sysConfigurationDao) {
<span class="fc" id="L166">        this.sysConfigurationDao = sysConfigurationDao;</span>
<span class="fc" id="L167">    }</span>

    public ActivityReportDao getPayoutDao() {
<span class="fc" id="L170">        return payoutDao;</span>
    }

    public void setPayoutDao(ActivityReportDao payoutDao) {
<span class="fc" id="L174">        this.payoutDao = payoutDao;</span>
<span class="fc" id="L175">    }</span>

    /**
     * @return commissionDao
     */
    public ActivityReportDao getCommissionDao() {
<span class="fc" id="L181">        return commissionDao;</span>
    }

    /**
     * @param commissionDao
     */
    public void setCommissionDao(ActivityReportDao commissionDao) {
<span class="fc" id="L188">        this.commissionDao = commissionDao;</span>
<span class="fc" id="L189">    }</span>

    /**
     * @return destinationActivityReportDao
     */
    public ActivityReportDao getDestinationActivityReportDao() {
<span class="nc" id="L195">        return destinationActivityReportDao;</span>
    }

    /**
     * @param destinationActivityReportDao
     */
    public void setDestinationActivityReportDao(ActivityReportDao destinationActivityReportDao) {
<span class="fc" id="L202">        this.destinationActivityReportDao = destinationActivityReportDao;</span>
<span class="fc" id="L203">    }</span>

    /**
     * @return generalActivityReportDao
     */
    public ActivityReportDao getGeneralActivityReportDao() {
<span class="nc" id="L209">        return generalActivityReportDao;</span>
    }

    /**
     * @param generalActivityReportDao
     */
    public void setGeneralActivityReportDao(ActivityReportDao generalActivityReportDao) {
<span class="fc" id="L216">        this.generalActivityReportDao = generalActivityReportDao;</span>
<span class="fc" id="L217">    }</span>

    public ActivityReportDao getTransferActivityReportDao() {
<span class="fc" id="L220">        return transferActivityReportDao;</span>
    }

    public void setTransferActivityReportDao(ActivityReportDao transferActivityReportDao) {
<span class="fc" id="L224">        this.transferActivityReportDao = transferActivityReportDao;</span>
<span class="fc" id="L225">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>