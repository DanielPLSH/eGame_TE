<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BaseGameInstance.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gamespec.game</a> &gt; <span class="el_source">BaseGameInstance.java</span></div><h1>BaseGameInstance.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gamespec.game;

import com.google.protobuf.Message;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.lotto.draw.domain.LottoGameInstance;
import com.mpos.lottery.te.gamespec.game.web.GameInstanceDto;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.thirdpartyservice.amqp.TeTransactionMessage;
import com.mpos.lottery.te.thirdpartyservice.amqp.TeTransactionMessageSerializer;

import java.math.BigDecimal;
import java.util.Calendar;
import java.util.Date;

import javax.persistence.Column;
import javax.persistence.FetchType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.MappedSuperclass;
import javax.persistence.Temporal;
import javax.persistence.TemporalType;
import javax.persistence.Transient;

/**
 * A base game instance for all game types.
 * 
 * @author Ramon Li
 */
@SuppressWarnings(&quot;serial&quot;)
@MappedSuperclass
<span class="fc" id="L34">public class BaseGameInstance implements java.io.Serializable, TeTransactionMessageSerializer {</span>
    public static final int STATE_NEW = 1; // New
    public static final int STATE_ACTIVE = 2; // Active
    public static final int STATE_INACTIVE = 3; // Inactive
    public static final int STATE_STOP = 4; // Stop Sale
    public static final int STATE_RESULT_ENTERED = 5; // Result Entered
    public static final int STATE_RESULT_AUDITED = 6; // Result Audited
    public static final int STATE_PAYOUT_STARTED = 7; // Payout Started
    // public static final int STATE_PAYOUT_BLOCKED = 8; // Payout Blocked
    public static final int STATE_WINANALYSIS_STARTED = 9;

    public static final int RISKCONTROL_METHOD_MAX_LOSS = 1;
    public static final int RISKCONTROL_METHOD_DYNAMIC = 2;

    @Id
    @Column(name = &quot;ID&quot;)
    // // create seqence TE_SEQ start with 1 increment by 1;
    // @SequenceGenerator(name=&quot;TE_SEQ&quot;, sequenceName=&quot;TE_SEQ&quot;)
    // @GeneratedValue(strategy = GenerationType.SEQUENCE, generator=&quot;TE_SEQ&quot;)
    private String id;

    @Column(name = &quot;VERSION&quot;)
    private long version;

    @Column(name = &quot;DRAW_DATE&quot;)
    private Date drawDate;

    @Column(name = &quot;DRAW_NO&quot;)
    private String number;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;GAME_ID&quot;, nullable = false)
    // explicitly require underlying hibernate to generate SQL with 'join'.
    // @Fetch(FetchMode.JOIN)
    private Game game;

    @Column(name = &quot;START_SELLING_TIME&quot;)
    @Temporal(TemporalType.TIMESTAMP)
    private Date beginTime;

    @Column(name = &quot;GAME_FREEZING_TIME&quot;)
    @Temporal(TemporalType.TIMESTAMP)
    private Date freezeTime;

    @Column(name = &quot;STOP_SELLING_TIME&quot;)
    @Temporal(TemporalType.TIMESTAMP)
    private Date endTime;

    @Column(name = &quot;GAME_INSTANCE_NAME&quot;)
    private String name;

    @Column(name = &quot;MAX_CLAIM_PERIOD&quot;)
    private int maxClaimDays;

    @Column(name = &quot;BD_CHANNEL_SETTING_ID&quot;)
    private String gameChannelSettingId;

    @Column(name = &quot;STATUS&quot;)
    private int state;

    @Column(name = &quot;IS_SUSPEND_PAYOUT&quot;)
    private boolean payoutBlocked;

    @Column(name = &quot;IS_SUSPEND_MANUAL_CANCEL&quot;)
    private boolean suspendManualCancel;

    @Column(name = &quot;IS_SUSPEND_SALE&quot;)
    private boolean saleSuspended;

    @Column(name = &quot;CONTORL_METHOD&quot;)
    private int riskControlMethod;

<span class="fc" id="L106">    @Column(name = &quot;SALES_AMOUNT_PERCENT&quot;)</span>
    private BigDecimal percentageOfTurnover = new BigDecimal(&quot;0&quot;);

<span class="fc" id="L109">    @Column(name = &quot;LOSS_AMOUNT&quot;)</span>
    private BigDecimal maxLossAmount = new BigDecimal(&quot;0&quot;);

    // Only for DTO usage
    @Transient
    private String gameId;
    @Transient
    private Integer gameType;

    /**
     * Convert a game instance into DTO.
     */
    public GameInstanceDto toDto() {
<span class="nc" id="L122">        GameInstanceDto dto = new GameInstanceDto();</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        dto.setGameId(this.game == null ? this.getGameId() : this.getGame().getId());</span>
<span class="nc" id="L124">        dto.setNumber(this.number);</span>
<span class="nc" id="L125">        this.customizeToDto(dto);</span>
<span class="nc" id="L126">        return dto;</span>
    }

    protected void customizeToDto(GameInstanceDto dto) {
        // template method for subclass to customize the process.
<span class="nc" id="L131">    }</span>

    public BaseGameResult getGameResult() {
        // template method for subclass to implement
<span class="fc" id="L135">        return null;</span>
    }

    /**
     * check if current time is after last claim day.
     */
    public void isPastLastClaimDay() throws ApplicationException {
<span class="fc" id="L142">        Calendar c = Calendar.getInstance();</span>
<span class="fc" id="L143">        c.setTime(this.getEndTime());</span>
        // c.set(Calendar.HOUR_OF_DAY, 0);
        // c.set(Calendar.MINUTE, 0);
        // c.set(Calendar.SECOND, 0);
<span class="fc" id="L147">        c.add(Calendar.DAY_OF_MONTH, this.getMaxClaimDays());</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (new Date().after(c.getTime())) {</span>
<span class="nc" id="L149">            throw new ApplicationException(SystemException.CODE_EXCEED_LAST_CLAIMTIME,</span>
                    &quot;Current time has passed last payout time(&quot; + c.getTime() + &quot;), can NOT payout.&quot;);
        }
<span class="fc" id="L152">    }</span>

    /**
     * Whether a sale of given game instance can be cancelled. Return true is cancellation allowed, otherwise
     * false(cancel decline).
     */
    public boolean canCancelNormally() throws ApplicationException {
<span class="fc" id="L159">        boolean isCancelDeclined = false;</span>
        // check the status of current game draw
<span class="fc" id="L161">        Date now = new Date();</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (now.before(this.getFreezeTime())) {</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (this.getState() == LottoGameInstance.STATE_INACTIVE) {</span>
<span class="nc" id="L164">                throw new ApplicationException(SystemException.CODE_NOT_ACTIVE_DRAW, &quot;Game instance(number=&quot;</span>
                        + this.getNumber() + &quot;,gameId=&quot; + this.getGameId() + &quot;) is not active.&quot;);
            }
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">            if (this.getState() &gt;= LottoGameInstance.STATE_PAYOUT_STARTED) {</span>
                // TODO: reject canceling request
            }
        } else {
<span class="fc" id="L171">            isCancelDeclined = true;</span>
        }
<span class="fc bfc" id="L173" title="All 2 branches covered.">        return !isCancelDeclined;</span>
    }

    public String getId() {
<span class="fc" id="L177">        return id;</span>
    }

    public void setId(String id) {
<span class="fc" id="L181">        this.id = id;</span>
<span class="fc" id="L182">    }</span>

    public long getVersion() {
<span class="fc" id="L185">        return version;</span>
    }

    public void setVersion(long version) {
<span class="fc" id="L189">        this.version = version;</span>
<span class="fc" id="L190">    }</span>

    public String getNumber() {
<span class="fc" id="L193">        return number;</span>
    }

    public void setNumber(String number) {
<span class="fc" id="L197">        this.number = number;</span>
<span class="fc" id="L198">    }</span>

    public Game getGame() {
<span class="fc" id="L201">        return game;</span>
    }

    public void setGame(Game game) {
<span class="fc" id="L205">        this.game = game;</span>
<span class="fc" id="L206">    }</span>

    public Date getBeginTime() {
<span class="fc" id="L209">        return beginTime;</span>
    }

    public void setBeginTime(Date beginTime) {
<span class="fc" id="L213">        this.beginTime = beginTime;</span>
<span class="fc" id="L214">    }</span>

    public Date getEndTime() {
<span class="fc" id="L217">        return endTime;</span>
    }

    public void setEndTime(Date endTime) {
<span class="fc" id="L221">        this.endTime = endTime;</span>
<span class="fc" id="L222">    }</span>

    public int getState() {
<span class="fc" id="L225">        return state;</span>
    }

    public void setState(int state) {
<span class="fc" id="L229">        this.state = state;</span>
<span class="fc" id="L230">    }</span>

    public String getName() {
<span class="fc" id="L233">        return name;</span>
    }

    public void setName(String name) {
<span class="fc" id="L237">        this.name = name;</span>
<span class="fc" id="L238">    }</span>

    public int getMaxClaimDays() {
<span class="fc" id="L241">        return maxClaimDays;</span>
    }

    public void setMaxClaimDays(int maxClaimDays) {
<span class="fc" id="L245">        this.maxClaimDays = maxClaimDays;</span>
<span class="fc" id="L246">    }</span>

    public Date getFreezeTime() {
<span class="fc" id="L249">        return freezeTime;</span>
    }

    public void setFreezeTime(Date freezeTime) {
<span class="fc" id="L253">        this.freezeTime = freezeTime;</span>
<span class="fc" id="L254">    }</span>

    public String getKey() {
<span class="pc bpc" id="L257" title="1 of 4 branches missed.">        if (this.number == null || this.game == null) {</span>
<span class="fc" id="L258">            throw new IllegalStateException(&quot;Either this.number or this.gameId is null.&quot;);</span>
        }
<span class="fc" id="L260">        return new StringBuffer(this.number).append(&quot;-&quot;).append(this.game.getId()).toString();</span>
    }

    public Date getDrawDate() {
<span class="fc" id="L264">        return drawDate;</span>
    }

    public void setDrawDate(Date drawDate) {
<span class="fc" id="L268">        this.drawDate = drawDate;</span>
<span class="fc" id="L269">    }</span>

    public boolean isPayoutBlocked() {
<span class="fc" id="L272">        return payoutBlocked;</span>
    }

    public void setPayoutBlocked(boolean payoutBlocked) {
<span class="fc" id="L276">        this.payoutBlocked = payoutBlocked;</span>
<span class="fc" id="L277">    }</span>

    public String getGameId() {
<span class="fc" id="L280">        return gameId;</span>
    }

    public void setGameId(String gameId) {
<span class="fc" id="L284">        this.gameId = gameId;</span>
<span class="fc" id="L285">    }</span>

    public int getRiskControlMethod() {
<span class="fc" id="L288">        return riskControlMethod;</span>
    }

    public void setRiskControlMethod(int riskControlMethod) {
<span class="fc" id="L292">        this.riskControlMethod = riskControlMethod;</span>
<span class="fc" id="L293">    }</span>

    public BigDecimal getPercentageOfTurnover() {
<span class="fc" id="L296">        return percentageOfTurnover;</span>
    }

    public void setPercentageOfTurnover(BigDecimal percentageOfTurnover) {
<span class="fc" id="L300">        this.percentageOfTurnover = percentageOfTurnover;</span>
<span class="fc" id="L301">    }</span>

    public BigDecimal getMaxLossAmount() {
<span class="fc" id="L304">        return maxLossAmount;</span>
    }

    public void setMaxLossAmount(BigDecimal maxLossAmount) {
<span class="fc" id="L308">        this.maxLossAmount = maxLossAmount;</span>
<span class="fc" id="L309">    }</span>

    public String getGameChannelSettingId() {
<span class="fc" id="L312">        return gameChannelSettingId;</span>
    }

    public void setGameChannelSettingId(String gameChannelSettingId) {
<span class="fc" id="L316">        this.gameChannelSettingId = gameChannelSettingId;</span>
<span class="fc" id="L317">    }</span>

    public boolean isSuspendManualCancel() {
<span class="fc" id="L320">        return suspendManualCancel;</span>
    }

    public void setSuspendManualCancel(boolean suspendManualCancel) {
<span class="fc" id="L324">        this.suspendManualCancel = suspendManualCancel;</span>
<span class="fc" id="L325">    }</span>

    public boolean isSaleSuspended() {
<span class="fc" id="L328">        return saleSuspended;</span>
    }

    public void setSaleSuspended(boolean saleSuspended) {
<span class="fc" id="L332">        this.saleSuspended = saleSuspended;</span>
<span class="fc" id="L333">    }</span>

    @Override
    public Message toProtoMessage(Context respCtx) {
<span class="fc" id="L337">        return TeTransactionMessage.GameInstance.newBuilder().setId(this.getId()).build();</span>
    }

    public Integer getGameType() {
<span class="fc" id="L341">        return gameType;</span>
    }

    public void setGameType(Integer gameType) {
<span class="fc" id="L345">        this.gameType = gameType;</span>
<span class="fc" id="L346">    }</span>

    /**
     * Generate a instance of BaseGameInstance to easy castor mapping, for example map the response of prize enquiry.
     */
    public BaseGameInstance genCastorBaseGameInstance() {
<span class="fc" id="L352">        BaseGameInstance gameInstance = new BaseGameInstance();</span>
<span class="fc" id="L353">        gameInstance.setGameId(this.getGame().getId());</span>
<span class="fc" id="L354">        gameInstance.setGameType(this.getGame().getType());</span>
<span class="fc" id="L355">        gameInstance.setNumber(this.getNumber());</span>
<span class="fc" id="L356">        return gameInstance;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>