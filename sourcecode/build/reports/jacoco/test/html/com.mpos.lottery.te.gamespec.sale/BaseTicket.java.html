<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BaseTicket.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gamespec.sale</a> &gt; <span class="el_source">BaseTicket.java</span></div><h1>BaseTicket.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gamespec.sale;

import com.google.protobuf.Message;

import com.mpos.lottery.te.common.dao.SettlementEntity;
import com.mpos.lottery.te.common.encrypt.HMacMd5SelectedNumber;
import com.mpos.lottery.te.common.encrypt.KeyStore;
import com.mpos.lottery.te.common.encrypt.TriperDESCipher;
import com.mpos.lottery.te.common.util.Barcoder;
import com.mpos.lottery.te.common.util.Base64Coder;
import com.mpos.lottery.te.common.util.SimpleToolkit;
import com.mpos.lottery.te.config.MLotteryContext;
import com.mpos.lottery.te.config.SysConfiguration;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.MessageFormatException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.lotto.sale.Payment;
import com.mpos.lottery.te.gamespec.game.BaseGameInstance;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.thirdpartyservice.amqp.AmqpMessageUtils;
import com.mpos.lottery.te.thirdpartyservice.amqp.TeTransactionMessage;
import com.mpos.lottery.te.thirdpartyservice.amqp.TeTransactionMessageSerializer;
import com.mpos.lottery.te.thirdpartyservice.playeraccount.User;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.trans.domain.TransactionType;

import java.io.File;
import java.math.BigDecimal;
import java.util.Collections;
import java.util.Comparator;
import java.util.LinkedList;
import java.util.List;

import javax.persistence.Column;
import javax.persistence.FetchType;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.MappedSuperclass;
import javax.persistence.Transient;

/**
 * A base ticket definition for all game type.
 * 
 * @author Ramon Li
 */
@SuppressWarnings(&quot;serial&quot;)
@MappedSuperclass
<span class="fc" id="L48">public abstract class BaseTicket extends SettlementEntity implements Cloneable, TeTransactionMessageSerializer {</span>
    public static final int STATUS_INVALID = 0; // Invalid
    public static final int STATUS_ACCEPTED = 1; // Accepted
    public static final int STATUS_CANCELED = 2; // Canceled
    public static final int STATUS_RETURNED = 3; // Returned
    public static final int STATUS_CANCEL_DECLINED = 4; // cancel declined
    public static final int STATUS_PAID = 5; // Paid

    public static final int TICKET_TYPE_NORMAL = 1;
    public static final int TICKET_TYPE_PRIZE = 2;
    public static final int TICKET_TYPE_INCENTIVE = 3;

    public static final int TICKET_FROM_POS = 1;
    public static final int TICKET_FROM_IBETTING = 2;
    public static final int TICKET_FROM_SGPE = 3;
    public static final int TICKET_FROM_MGPE = 4;
    public static final int TICKET_FROM_WGPESMS = 5;
    public static final int TICKET_FROM_WGPEPOS = 6;
    public static final int TICKET_FROM_TGPE = 9;

    @Column(name = &quot;VERSION&quot;)
    private long version;

    /**
     * The type of transaction depends on:
     * &lt;ol&gt;
     * &lt;li&gt;If a ticket is successful(accepted/paid), the transction will be sale transactin.&lt;/li&gt;
     * &lt;li&gt;If ticket is cancelled, the transction will be cancel transaction.&lt;/li&gt;
     * &lt;li&gt;If ticket is newly generated in payout(multi-draw), the transaction will be payout transction(while the
     * original paid ticket still associates with sale transaction).&lt;/li&gt;
     * &lt;/ol&gt;
     */
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;TRANSACTION_ID&quot;, nullable = false)
    private Transaction transaction;

    @Column(name = &quot;SERIAL_NO&quot;)
    private String serialNo; // may be encrypted

    @Transient
    private String rawSerialNo; // retrieve from client request

    @Column(name = &quot;TOTAL_AMOUNT&quot;)
    private BigDecimal totalAmount;

    @Column(name = &quot;IS_WINNING&quot;)
    private boolean isWinning;

    /**
     * Whether this ticket wins a lucky draw?.
     */
    @Column(name = &quot;IS_WINING_lUCKY_DRAW&quot;)
    private boolean isLuckyWinning;

    @Column(name = &quot;LD_WINING_TOTAL_BETS&quot;)
    private int countOfLuckyWinning;

<span class="fc" id="L105">    @Column(name = &quot;STATUS&quot;)</span>
    private int status = STATUS_ACCEPTED;

    @Column(name = &quot;IS_BLOCK_PAYOUT&quot;)
    private boolean isPayoutBlocked;

    @Column(name = &quot;IS_OFFLINE&quot;)
    private boolean isOffline;

    // only cancel and confirmPayout
    // will influence this field.
<span class="fc" id="L116">    @Column(name = &quot;IS_COUNT_IN_POOL&quot;)</span>
    private boolean isCountInPool = true;

    /* Refer to TICKET_TYPE_XXX */
<span class="fc" id="L120">    @Column(name = &quot;TICKET_TYPE&quot;)</span>
    private int ticketType = TICKET_TYPE_NORMAL;
    /* Refer to TICKET_FROM_XXX */
    @Column(name = &quot;TICKET_FROM&quot;)
    private int ticketFrom;

<span class="fc" id="L126">    @Column(name = &quot;MUTLI_DRAW&quot;)</span>
    private int multipleDraws = 1;

<span class="fc" id="L129">    @Column(name = &quot;PIN&quot;)</span>
    private String PIN = &quot;!!!!&quot;;

    /**
     * The total bets of this ticket.
     */
    @Column(name = &quot;TOTAL_BETS&quot;)
    private int totalBets;

    // the validation cod will be used to make sure only ticket holder can claim
    // prize...actually PIN already can achieved this goal.
    @Column(name = &quot;VALIDATION_CODE&quot;)
    private String validationCode;

    @Column(name = &quot;BARCODE&quot;)
    private String barcode;

    /* Player's mobile number */
    @Column(name = &quot;MOBILE_NO&quot;)
    private String mobile;
    @Column(name = &quot;CREDIT_CARD_NUM&quot;)
    private String creditCardSN;
    @Column(name = &quot;USER_ID&quot;)
    private String userId;
    /**
     * What kind of transaction marks current ticket's status? Only sale and sale cancellation will affect this field.
     */
<span class="fc" id="L156">    @Column(name = &quot;TRANS_TYPE&quot;)</span>
    private int transType = TransactionType.SELL_TICKET.getRequestType();

    /**
     * If a cancel-declined ticket is paid, this field will be set to true.
     */
    @Column(name = &quot;IS_ABSORPTION_PAID&quot;)
    private boolean absorptionPaid;

<span class="fc" id="L165">    @Transient</span>
    private List&lt;BaseEntry&gt; entries = new LinkedList&lt;BaseEntry&gt;();
    /**
     * If a multiple-draw ticket, for example 3 draws ticket(draw#1, draw#2, draw#3), this field will be the number of
     * draw#3.
     */
    @Transient
    private String lastDrawNo;
    // THe input channel when payout.
    @Transient
    private int payoutInputChannel;

    @Transient
    private User user;
    /**
     * Is the cancellation manual or auto? only affect when 'cancel by ticket'(201).
     */
    @Transient
    private boolean manualCancel;

    /**
     * Whether the serial number is generated from barcode.
     */
    @Transient
    private boolean serialNoGeneratedFromBarcode;

    /**
     * This is a workaround of JPA's lack of polymorphic association. As &lt;code&gt;BaseGameInstance&lt;/code&gt; is a
     * &lt;code&gt;@MappedSuperclass&lt;/code&gt;, no entity association can be annotated on it. But we need a unified interface for
     * accessing game instance from &lt;code&gt;BaseTicket&lt;/code&gt;, that is why these 2 abstract methods defined:
     * &lt;code&gt;getGameInstance()&lt;/code&gt; and &lt;code&gt;setGameInstance()&lt;/code&gt;.
     * &lt;p&gt;
     * Refer to
     * &lt;ul&gt;
     * &lt;li&gt;
     * https://hibernate.onjira.com/browse/EJB-199?focusedCommentId=32855&amp;page =com
     * .atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment- 32855&lt;/li&gt;
     * &lt;li&gt;
     * http://stackoverflow.com/questions/6853802/jpa-table-per-class-problems -with-manytoone&lt;/li&gt;
     * &lt;/ul&gt;
     * I do agree with Don Tam's solution.
     */
    public abstract BaseGameInstance getGameInstance();

    public abstract void setGameInstance(BaseGameInstance gameInstance);

    public BigDecimal calculateMultipleDrawAmount() {
<span class="fc" id="L212">        return this.getTotalAmount().divide(new BigDecimal(this.getMultipleDraws()), 2, BigDecimal.ROUND_HALF_UP);</span>
    }

    /**
     * Whether player buy this ticket by credit card.
     * 
     * @return true if buy by credit card, otherwise false will be returned.
     */
    public boolean isSoldByCreditCard() {
<span class="fc bfc" id="L221" title="All 4 branches covered.">        if (this.getUser() != null &amp;&amp; this.getUser().getCreditCardSN() != null) {</span>
<span class="fc" id="L222">            return true;</span>
        }
<span class="fc bfc" id="L224" title="All 2 branches covered.">        if (this.getCreditCardSN() != null) {</span>
<span class="fc" id="L225">            return true;</span>
        }
<span class="fc" id="L227">        return false;</span>
    }

    /**
     * Update raw serialNo, and encrypt raw serialNo to get serialNo if needed.
     * 
     * @param needToUpdateSerialNo
     *            Need to update serialNo based on raw serialNo??
     * @param rawSerialNo
     *            The raw serialNo.
     */
    public void setRawSerialNo(boolean needToUpdateSerialNo, String rawSerialNo) {
<span class="fc" id="L239">        this.rawSerialNo = rawSerialNo;</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">        if (needToUpdateSerialNo) {</span>
<span class="fc" id="L241">            this.setSerialNo(encryptSerialNo(rawSerialNo));</span>
        }
<span class="fc" id="L243">    }</span>

    public void setRawSerialNo(String rawSerialNo) {
<span class="fc" id="L246">        this.setRawSerialNo(true, rawSerialNo);</span>
<span class="fc" id="L247">    }</span>

    /**
     * generate a 6 random digital number.
     */
    public static String generateValidationCode() {
<span class="fc bfc" id="L253" title="All 2 branches covered.">        if (MLotteryContext.getInstance().getSysConfiguration().isGenValidationCode()) {</span>
<span class="fc" id="L254">            int pin = SimpleToolkit.generatePin(1000000, 9999999);</span>
<span class="fc" id="L255">            return (pin + &quot;&quot;).substring(1);</span>
        } else {
<span class="fc" id="L257">            return &quot;FFFFFF&quot;;</span>
        }
    }

    /**
     * Split the total amount among multiple tickets. For example, client buy a 3-draw ticket, and paid with
     * voucher(capitalAmount:1000 + freeAmount:200). As the backend will generate 3 tickets records according, how to
     * determine the total/free amount of each ticket records??
     * &lt;p/&gt;
     * The method will deduct capital amount of voucher first, then free amount. In our example the total amount,
     * including capital and free amount, of each ticket is 400, the for the 1st ticket, the 400 will be deducted from
     * capital amount.
     * &lt;p/&gt;
     * &lt;table border=&quot;1&quot;&gt;
     * &lt;tr&gt;
     * &lt;td&gt;No. of LottoTicket&lt;/td&gt;
     * &lt;td&gt;capitalAmount&lt;/td&gt;
     * &lt;td&gt;freeAmount&lt;/td&gt;
     * &lt;td&gt;Status Of Voucher&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;1&lt;/td&gt;
     * &lt;td&gt;400&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;td&gt;capitalAmount:600, freeAmount:200&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;2&lt;/td&gt;
     * &lt;td&gt;400&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;td&gt;capitalAmount:600, freeAmount:200&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;3&lt;/td&gt;
     * &lt;td&gt;200&lt;/td&gt;
     * &lt;td&gt;200&lt;/td&gt;
     * &lt;td&gt;capitalAmount:0, freeAmount:0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;/table&gt;
     * &lt;p/&gt;
     * Absolutely at last the capital amount and free amount of voucher should both be 0.
     * &lt;p/&gt;
     * If buy tickets for multiple recievers, the amount splitting will follow same logic.
     * &lt;p/&gt;
     * While when you call this method, must keep in mind that &lt;code&gt;respPayment&lt;/code&gt; shoud be a shared reference
     * among multiple invocations, like below:
     * 
     * &lt;pre&gt;
     * &lt;code&gt;
     * Payment respPayment = new Payment(new BigDecimal(&quot;1000&quot;), new BigDecimal(&quot;200&quot;);
     * BigDecimal requiredAmount = new BigDecimal(&quot;400&quot;);
     * for (int i = 0; i &lt; tickets.size(); i++){
     * 	  BigDecimal amounts[] = BaseTicket.splitAmount(respPayment, requiredAmount, 
     * 	    i == tickets.size() - 1 ? true : false);
     * 	  tickets.get(i).setTotalAmount(amounts[0]);
     * 	  tickets.get(i).setFreeAmount(amounts[1]);
     * )
     * &lt;/code&gt;
     * &lt;/pre&gt;
     * 
     * @param respPayment
     *            The total amount which will be splitted, and following components must not be null: capitalAmount,
     *            freeAmount
     * @param requiredAmount
     *            The required amount. Every splitting must return the required amount.
     * @param isLast
     *            Is this split is the last? If true, then capital/free amount of &lt;code&gt;respPayment&lt;/code&gt; must be 0.
     * @return a 2 length array of amount. The 1st will be capital amount, and the 2nd will be free amount.
     * @throws ApplicationException
     *             CODE_EVENLY_DIVIDED_BASE_AMOUNT
     */
    public static BigDecimal[] splitAmount(Payment respPayment, BigDecimal requiredAmount, boolean isLast)
            throws ApplicationException {
<span class="nc" id="L330">        BigDecimal[] amounts = new BigDecimal[] { new BigDecimal(&quot;0&quot;), new BigDecimal(&quot;0&quot;) };</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (respPayment.getCapitalAmount().compareTo(requiredAmount) &gt;= 0) {</span>
<span class="nc" id="L332">            amounts[0] = requiredAmount;</span>
<span class="nc" id="L333">            respPayment.setCapitalAmount(respPayment.getCapitalAmount().subtract(requiredAmount));</span>
        } else {
<span class="nc" id="L335">            amounts[0] = respPayment.getCapitalAmount();</span>
<span class="nc" id="L336">            amounts[1] = requiredAmount.subtract(respPayment.getCapitalAmount());</span>
<span class="nc" id="L337">            respPayment.setCapitalAmount(new BigDecimal(&quot;0&quot;));</span>
<span class="nc" id="L338">            respPayment.setFreeAmount(respPayment.getFreeAmount().subtract(amounts[1]));</span>
        }
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (isLast) {</span>
<span class="nc bnc" id="L341" title="All 4 branches missed.">            if (respPayment.getCapitalAmount().compareTo(new BigDecimal(&quot;0&quot;)) != 0</span>
                    || respPayment.getFreeAmount().compareTo(new BigDecimal(&quot;0&quot;)) != 0) {
<span class="nc" id="L343">                throw new ApplicationException(SystemException.CODE_EVENLY_DIVIDED_BASE_AMOUNT,</span>
                        &quot;The reqiured amount is &quot; + requiredAmount
                                + &quot;, while after last splitting, there is still some amount &quot;
                                + &quot;remained(capitalAmount:&quot; + respPayment.getCapitalAmount() + &quot;,freeAmount:&quot;
                                + respPayment.getFreeAmount() + &quot;).&quot;);
            }
        }
<span class="nc" id="L350">        return amounts;</span>
    }

    /**
     * Generate the HMAC of all entries of a ticket.
     */
    public static String generateExtendText(List&lt;BaseEntry&gt; entries) {
<span class="fc" id="L357">        String hmacInput = &quot;&quot;;</span>
        /**
         * No matter what is the sorting criteria, just make it follows a given criteria.
         */
<span class="fc" id="L361">        Collections.sort(entries, new Comparator&lt;BaseEntry&gt;() {</span>

            @Override
            public int compare(BaseEntry o1, BaseEntry o2) {
<span class="fc" id="L365">                return o1.getSelectNumber().compareTo(o2.getSelectNumber());</span>
            }

        });
<span class="fc bfc" id="L369" title="All 2 branches covered.">        for (BaseEntry entry : entries) {</span>
<span class="fc" id="L370">            hmacInput += entry.getSelectNumber();</span>
<span class="fc" id="L371">        }</span>
<span class="fc" id="L372">        return HMacMd5SelectedNumber.doDigestBySelectedNumbers(hmacInput);</span>
    }

    /**
     * Whether a ticket is ready for payout.
     */
    public void allowPayout(Context respCtx, BaseTicket clientTicket, boolean isPrizeEnquiry,
            List&lt;? extends BaseEntry&gt; actualEntries) throws ApplicationException {
        // check whether ticket is payout blocked
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">        if (this.isPayoutBlocked()) {</span>
<span class="nc" id="L382">            throw new ApplicationException(SystemException.CODE_TICKET_BLOCKPAYOUT, &quot;Ticket(serialNo=&quot;</span>
                    + this.getSerialNo() + &quot;) has been blocked for payout.&quot;);
        }
<span class="pc bpc" id="L385" title="1 of 4 branches missed.">        if (!clientTicket.isSerialNoGeneratedFromBarcode() &amp;&amp; clientTicket.getValidationCode() == null) {</span>
<span class="nc" id="L386">            throw new MessageFormatException(SystemException.CODE_WRONG_MESSAGEBODY,</span>
                    &quot;THe validation code must be provided.&quot;);
        }
<span class="fc bfc" id="L389" title="All 2 branches covered.">        if (!clientTicket.isSerialNoGeneratedFromBarcode()) {</span>
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">            if (!clientTicket.getValidationCode().equalsIgnoreCase(this.getValidationCode())) {</span>
<span class="nc" id="L391">                throw new ApplicationException(SystemException.CODE_UNMATCHED_PIN,</span>
                        &quot;Unmatched validation code of ticket(serialNo=&quot; + this.getSerialNo() + &quot;), expect[&quot;
                                + this.getValidationCode() + &quot;], client provide:&quot; + clientTicket.getValidationCode());
            }
        }
<span class="fc bfc" id="L396" title="All 2 branches covered.">        if (!isPrizeEnquiry) {</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">            if (respCtx.isInternalCall()) {</span>
                // If internal call, only cancel-declined ticket is allowed for
                // this operation
<span class="fc bfc" id="L400" title="All 2 branches covered.">                if (STATUS_CANCEL_DECLINED != this.getStatus()) {</span>
<span class="fc" id="L401">                    throw new ApplicationException(SystemException.CODE_INVALID_PAYOUT, &quot;Status of ticket(serialNo=&quot;</span>
                            + this.getSerialNo() + &quot;) is &quot; + this.getStatus()
                            + &quot;, can't be paid internally, only cancel-declined(&quot; + BaseTicket.STATUS_CANCEL_DECLINED
                            + &quot;) ticket allowed.&quot;);
                }
            } else {
                // check if this ticket is accepted
<span class="fc bfc" id="L408" title="All 2 branches covered.">                if (STATUS_ACCEPTED != this.getStatus()) {</span>
<span class="fc" id="L409">                    throw new ApplicationException(SystemException.CODE_INVALID_PAYOUT, &quot;Status of ticket(serialNo=&quot;</span>
                            + this.getSerialNo() + &quot;) is &quot; + this.getStatus() + &quot;, can't be paid, only accepted(&quot;
                            + BaseTicket.STATUS_ACCEPTED + &quot;) ticket allowed.&quot;);
                }
            }

            // need to check PIN??
<span class="fc bfc" id="L416" title="All 2 branches covered.">            if (!this.getPIN().equals(MLotteryContext.getInstance().getIgnoredPIN())) {</span>
                // md5 digest ticket.PIN
<span class="fc" id="L418">                String clientPin = SimpleToolkit.md5(clientTicket.getPIN());</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">                if (!clientPin.equals(this.getPIN())) {</span>
<span class="nc" id="L420">                    throw new ApplicationException(SystemException.CODE_UNMATCHED_PIN, &quot;Unmatched ticket 'PIN':&quot;</span>
                            + clientPin + &quot;, expected:&quot; + this.getPIN());
                }
            }
<span class="fc bfc" id="L424" title="All 2 branches covered.">            if (this instanceof BaseTamperProofTicket) {</span>
<span class="fc" id="L425">                this.verifyExtendTxt(actualEntries);</span>
            }
        }
<span class="fc" id="L428">    }</span>

    /**
     * Verify whether the MAC of ticket is matched when payout.
     */
    protected void verifyExtendTxt(List&lt;? extends BaseEntry&gt; actualEntries) throws ApplicationException {
        // template for sub-implementation
<span class="nc" id="L435">    }</span>

    /**
     * Encrypt ticket serial number.
     */
    public static String encryptSerialNo(String plainSerialNO) {
<span class="fc" id="L441">        MLotteryContext context = MLotteryContext.getInstance();</span>
<span class="fc" id="L442">        SysConfiguration sysConf = context.getSysConfiguration();</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">        if (sysConf.isEncryptSerialNo()) {</span>
<span class="pc bpc" id="L444" title="1 of 2 branches missed.">            if (sysConf.getSerialNoPublicKeyPath() == null) {</span>
<span class="nc" id="L445">                throw new SystemException(&quot;can't find 'serialno_public_key_path' in sys-configuration.&quot;);</span>
            }
            try {
                // retrieve DES key
<span class="fc" id="L449">                byte[] desKey = KeyStore.readKey(new File(sysConf.getSerialNoPublicKeyPath()),</span>
                        new File(context.get(&quot;des.key&quot;)));
                // encrypt serial number by 3DES, and encoded into base64
<span class="fc" id="L452">                return new String(Base64Coder.encode(TriperDESCipher.encrypt(desKey, plainSerialNO.getBytes(),</span>
                        TriperDESCipher.IV)));
<span class="nc" id="L454">            } catch (Exception e) {</span>
<span class="nc" id="L455">                throw new SystemException(e);</span>
            }
        } else {
<span class="nc" id="L458">            return plainSerialNO;</span>
        }
    }

    /**
     * Decrypt ticket serial number.
     */
    public static String descryptSerialNo(String serialNo) {
<span class="fc" id="L466">        MLotteryContext context = MLotteryContext.getInstance();</span>
<span class="pc bpc" id="L467" title="1 of 2 branches missed.">        if (context.getSysConfiguration().isEncryptSerialNo()) {</span>
            try {
<span class="fc" id="L469">                byte[] desKey = KeyStore.readKey(new File(context.getSysConfiguration().getSerialNoPublicKeyPath()),</span>
                        new File(context.get(&quot;des.key&quot;)));
<span class="fc" id="L471">                String raw = new String(TriperDESCipher.decrypt(desKey, Base64Coder.decode(serialNo),</span>
                        TriperDESCipher.IV));
                // if (logger.isDebugEnabled())
                // logger.debug(&quot;Decrypt serialNo(&quot; + serialNo +&quot;) into (&quot; + raw
                // + &quot;).&quot;);
<span class="fc" id="L476">                return raw;</span>
<span class="nc" id="L477">            } catch (Exception e) {</span>
<span class="nc" id="L478">                throw new SystemException(e);</span>
            }
        }
<span class="nc" id="L481">        return serialNo;</span>
    }

    /**
     * Deeply clone a &lt;code&gt;LottoTicket&lt;/code&gt;. Here deeply means all entires will be cloned too, while associated
     * transaction and game instance will keep untouched.
     */
    @Override
    public Object clone() {
        try {
<span class="fc" id="L491">            BaseTicket t = (BaseTicket) super.clone();</span>
            // deep clone... while all cloned tickets should associate with same
            // transaction.
<span class="fc" id="L494">            List entries = new LinkedList();</span>
<span class="fc bfc" id="L495" title="All 2 branches covered.">            for (Object entry : t.getEntries()) {</span>
<span class="fc" id="L496">                entries.add(((BaseEntry) entry).clone());</span>
<span class="fc" id="L497">            }</span>
<span class="fc" id="L498">            t.setEntries(entries);</span>
<span class="fc" id="L499">            return t;</span>
<span class="nc" id="L500">        } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L501">            throw new SystemException(e);</span>
        }
    }

    public String getSerialNo() {
<span class="fc" id="L506">        return serialNo;</span>
    }

    public void setSerialNo(String serialNo) {
<span class="fc" id="L510">        this.serialNo = serialNo;</span>
<span class="fc" id="L511">    }</span>

    public String getRawSerialNo() {
<span class="fc bfc" id="L514" title="All 2 branches covered.">        return rawSerialNo == null ? this.serialNo : this.rawSerialNo;</span>
    }

    public BigDecimal getTotalAmount() {
<span class="fc" id="L518">        return totalAmount;</span>
    }

    public void setTotalAmount(BigDecimal totalAmount) {
<span class="fc" id="L522">        this.totalAmount = totalAmount;</span>
<span class="fc" id="L523">    }</span>

    public boolean isWinning() {
<span class="fc" id="L526">        return isWinning;</span>
    }

    public void setWinning(boolean isWinning) {
<span class="fc" id="L530">        this.isWinning = isWinning;</span>
<span class="fc" id="L531">    }</span>

    public boolean isLuckyWinning() {
<span class="fc" id="L534">        return isLuckyWinning;</span>
    }

    public void setLuckyWinning(boolean isLuckyWinning) {
<span class="fc" id="L538">        this.isLuckyWinning = isLuckyWinning;</span>
<span class="fc" id="L539">    }</span>

    public int getStatus() {
<span class="fc" id="L542">        return status;</span>
    }

    public void setStatus(int status) {
<span class="fc" id="L546">        this.status = status;</span>
<span class="fc" id="L547">    }</span>

    public Transaction getTransaction() {
<span class="fc" id="L550">        return transaction;</span>
    }

    public void setTransaction(Transaction transaction) {
<span class="fc" id="L554">        this.transaction = transaction;</span>
<span class="fc" id="L555">    }</span>

    public boolean isPayoutBlocked() {
<span class="fc" id="L558">        return isPayoutBlocked;</span>
    }

    public void setPayoutBlocked(boolean isPayoutBlocked) {
<span class="fc" id="L562">        this.isPayoutBlocked = isPayoutBlocked;</span>
<span class="fc" id="L563">    }</span>

    public int getTicketType() {
<span class="fc" id="L566">        return ticketType;</span>
    }

    public void setTicketType(int ticketType) {
<span class="fc" id="L570">        this.ticketType = ticketType;</span>
<span class="fc" id="L571">    }</span>

    public List&lt;BaseEntry&gt; getEntries() {
<span class="fc" id="L574">        return entries;</span>
    }

    public void setEntries(List&lt;BaseEntry&gt; entries) {
<span class="fc" id="L578">        this.entries = entries;</span>
<span class="fc" id="L579">    }</span>

    public String getLastDrawNo() {
<span class="fc" id="L582">        return lastDrawNo;</span>
    }

    public void setLastDrawNo(String lastDrawNo) {
<span class="fc" id="L586">        this.lastDrawNo = lastDrawNo;</span>
<span class="fc" id="L587">    }</span>

    /**
     * Retrieve the number of multiple game instances.
     */
    public int getMultipleDraws() {
<span class="fc" id="L593">        return multipleDraws;</span>
    }

    /**
     * For a single draw ticket, the value of &lt;code&gt;multipleDraw&lt;/code&gt; will be 1.
     * &lt;p&gt;
     * If a multple-draws ticket, for example 3-draws, there will be 3 ticket entities, and each of them will associate
     * with a game instance. The &lt;code&gt;multipleDraws&lt;/code&gt; of 1st ticket entity which is associated with sold game
     * instance will be 3, while value of &lt;code&gt;multipleDraws&lt;/code&gt; of other 2 ticket entities will be 0.
     */
    public void setMultipleDraws(int multipleDraws) {
<span class="fc" id="L604">        this.multipleDraws = multipleDraws;</span>
<span class="fc" id="L605">    }</span>

    public long getVersion() {
<span class="fc" id="L608">        return version;</span>
    }

    public void setVersion(long version) {
<span class="fc" id="L612">        this.version = version;</span>
<span class="fc" id="L613">    }</span>

    public User getUser() {
<span class="fc" id="L616">        return user;</span>
    }

    public void setUser(User user) {
<span class="fc" id="L620">        this.user = user;</span>
<span class="fc" id="L621">    }</span>

    public String getPIN() {
<span class="fc" id="L624">        return PIN;</span>
    }

    public void setPIN(String pIN) {
<span class="fc" id="L628">        PIN = pIN;</span>
<span class="fc" id="L629">    }</span>

    public int getPayoutInputChannel() {
<span class="fc" id="L632">        return payoutInputChannel;</span>
    }

    public void setPayoutInputChannel(int payoutInputChannel) {
<span class="fc" id="L636">        this.payoutInputChannel = payoutInputChannel;</span>
<span class="fc" id="L637">    }</span>

    public int getTicketFrom() {
<span class="fc" id="L640">        return ticketFrom;</span>
    }

    public void setTicketFrom(int ticketFrom) {
<span class="fc" id="L644">        this.ticketFrom = ticketFrom;</span>
<span class="fc" id="L645">    }</span>

    public String getMobile() {
<span class="fc" id="L648">        return mobile;</span>
    }

    public void setMobile(String mobile) {
<span class="fc" id="L652">        this.mobile = mobile;</span>
<span class="fc" id="L653">    }</span>

    public String getCreditCardSN() {
<span class="fc" id="L656">        return creditCardSN;</span>
    }

    public void setCreditCardSN(String creditCardSN) {
<span class="fc" id="L660">        this.creditCardSN = creditCardSN;</span>
<span class="fc" id="L661">    }</span>

    public int getTransType() {
<span class="fc" id="L664">        return transType;</span>
    }

    public void setTransType(int transType) {
<span class="fc" id="L668">        this.transType = transType;</span>
<span class="fc" id="L669">    }</span>

    public boolean isManualCancel() {
<span class="fc" id="L672">        return manualCancel;</span>
    }

    public void setManualCancel(boolean manualCancel) {
<span class="fc" id="L676">        this.manualCancel = manualCancel;</span>
<span class="fc" id="L677">    }</span>

    public boolean isCountInPool() {
<span class="fc" id="L680">        return isCountInPool;</span>
    }

    public void setCountInPool(boolean isCountInPool) {
<span class="fc" id="L684">        this.isCountInPool = isCountInPool;</span>
<span class="fc" id="L685">    }</span>

    public boolean isAbsorptionPaid() {
<span class="fc" id="L688">        return absorptionPaid;</span>
    }

    public void setAbsorptionPaid(boolean absorptionPaid) {
<span class="fc" id="L692">        this.absorptionPaid = absorptionPaid;</span>
<span class="fc" id="L693">    }</span>

    // public boolean isOffline() {
    // return isOffline;
    // }
    //
    // public void setOffline(boolean isOffline) {
    // this.isOffline = isOffline;
    // }

    public int getTotalBets() {
<span class="fc" id="L704">        return totalBets;</span>
    }

    public void setTotalBets(int totalBets) {
<span class="fc" id="L708">        this.totalBets = totalBets;</span>
<span class="fc" id="L709">    }</span>

    public String getBarcode() {
<span class="fc" id="L712">        return barcode;</span>
    }

    public void setBarcode(String barcode) {
<span class="fc" id="L716">        this.setBarcode(true, barcode);</span>
<span class="fc" id="L717">    }</span>

    /**
     * Update the barcode, and serialNo as well if need.
     * 
     * @param needToUpdateSerialNo
     *            Whether need to update serialNo based on the provided barcode.
     * @param barcode
     *            the barcode of ticket.
     */
    public void setBarcode(boolean needToUpdateSerialNo, String barcode) {
<span class="fc" id="L728">        this.barcode = barcode;</span>
<span class="fc bfc" id="L729" title="All 4 branches covered.">        if (needToUpdateSerialNo &amp;&amp; this.getRawSerialNo() == null) {</span>
            // update both serialNo and rawSerialNo
<span class="fc" id="L731">            Barcoder barcoder = new Barcoder(barcode);</span>
<span class="fc" id="L732">            this.setRawSerialNo(true, barcoder.getSerialNo());</span>
<span class="fc" id="L733">            this.setSerialNoGeneratedFromBarcode(true);</span>
        }
<span class="fc" id="L735">    }</span>

    public String getUserId() {
<span class="fc" id="L738">        return userId;</span>
    }

    public void setUserId(String userId) {
<span class="fc" id="L742">        this.userId = userId;</span>
<span class="fc" id="L743">    }</span>

    public boolean isSerialNoGeneratedFromBarcode() {
<span class="fc" id="L746">        return serialNoGeneratedFromBarcode;</span>
    }

    public void setSerialNoGeneratedFromBarcode(boolean serialNoGeneratedFromBarcode) {
<span class="fc" id="L750">        this.serialNoGeneratedFromBarcode = serialNoGeneratedFromBarcode;</span>
<span class="fc" id="L751">    }</span>

    public String getValidationCode() {
<span class="fc" id="L754">        return validationCode;</span>
    }

    public void setValidationCode(String validationCode) {
<span class="fc" id="L758">        this.validationCode = validationCode;</span>
<span class="fc" id="L759">    }</span>

    public int getCountOfLuckyWinning() {
<span class="fc" id="L762">        return countOfLuckyWinning;</span>
    }

    public void setCountOfLuckyWinning(int countOfLuckyWinning) {
<span class="fc" id="L766">        this.countOfLuckyWinning = countOfLuckyWinning;</span>
<span class="fc" id="L767">    }</span>

    public boolean isOffline() {
<span class="fc" id="L770">        return isOffline;</span>
    }

    public void setOffline(boolean isOffline) {
<span class="fc" id="L774">        this.isOffline = isOffline;</span>
<span class="fc" id="L775">    }</span>

    /**
     * Give a string representation of instance.
     */
    public String toString() {
<span class="nc" id="L781">        StringBuffer buffer = new StringBuffer();</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">        buffer.append(&quot;(ID:&quot;).append(this.getId()).append(&quot;,TRANS_ID:&quot;)</span>
                .append(this.getTransaction() == null ? &quot;null&quot; : this.getTransaction().getId());
<span class="nc" id="L784">        buffer.append(&quot;,SERIAL_NO:&quot;).append(this.getSerialNo()).append(&quot;,TOTAL_AMOUNT:&quot;).append(this.getTotalAmount());</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">        buffer.append(&quot;,STATUS:&quot;).append(this.getStatus()).append(&quot;,TRAN.GAME_ID:&quot;)</span>
                .append(this.getTransaction() == null ? &quot;null&quot; : this.getTransaction().getGameId());
<span class="nc bnc" id="L787" title="All 2 branches missed.">        buffer.append(&quot;,DRAW_NO:&quot;).append(this.getGameInstance() == null ? &quot;null&quot; : this.getGameInstance().getNumber());</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">        buffer.append(&quot;,GAMEDRAW.GAME_ID:&quot;)</span>
                .append(this.getGameInstance() == null ? &quot;null&quot; : this.getGameInstance().getGame().getId()).append(&quot;)&quot;);
<span class="nc" id="L790">        return buffer.toString();</span>
    }

    @Override
    public Message toProtoMessage(Context respCtx) {
<span class="fc" id="L795">        TeTransactionMessage.Sale.Builder builder = TeTransactionMessage.Sale.newBuilder();</span>
<span class="fc" id="L796">        builder.setSerialNo(this.getSerialNo()).setTransaction(AmqpMessageUtils.assembleTransactionMsg(respCtx));</span>
<span class="fc" id="L797">        builder.setMultiDraw(this.getMultipleDraws()).setTotalAmount(this.getTotalAmount().toString());</span>
<span class="fc" id="L798">        builder.setGameInstance((TeTransactionMessage.GameInstance) this.getGameInstance().toProtoMessage(respCtx));</span>

<span class="fc bfc" id="L800" title="All 2 branches covered.">        for (int i = 0; i &lt; this.getEntries().size(); i++) {</span>
<span class="fc" id="L801">            builder.addEntries((TeTransactionMessage.Sale.Entry) this.getEntries().get(i).toProtoMessage(respCtx));</span>
        }

<span class="fc" id="L804">        return builder.build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>