<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Merchant.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.merchant.domain</a> &gt; <span class="el_source">Merchant.java</span></div><h1>Merchant.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.merchant.domain;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;

import java.math.BigDecimal;
import java.sql.Timestamp;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.Table;
import javax.persistence.Transient;

@Entity
@Table(name = &quot;MERCHANT&quot;)
<span class="fc" id="L20">public class Merchant implements java.io.Serializable {</span>
    private static final long serialVersionUID = 6139641558287268977L;
    // The identifier of top(super) merchant.
    public static final long SUPER_MERCHANT_ID = 1;
    public static final String MERCHANT_DELIMITER = &quot;,&quot;;
    // Completely no idea why there are 4 kinds of credit type: credit and
    // prepaid?? anyway in Nigeria project only 1 and 4 will be used.
<span class="fc" id="L27">    public static int CREDIT_TYPE_DEFINITIVEVALUE = 1;</span>
<span class="fc" id="L28">    public static int CREDIT_TYPE_PREPAID = 2;</span>
<span class="fc" id="L29">    public static int CREDIT_TYPE_PRESALE = 3;</span>
<span class="fc" id="L30">    public static int CREDIT_TYPE_USE_PARENT = 4;</span>

    @Id
    @Column(name = &quot;MERCHANT_ID&quot;)
    private long id;

    @Column(name = &quot;MERCHANT_NAME&quot;)
    private String name;

    @Column(name = &quot;MERCHANT_CODE&quot;)
    private String code;

<span class="fc" id="L42">    @Column(name = &quot;SALE_BALANCE&quot;)</span>
    private BigDecimal saleCreditLevel = new BigDecimal(&quot;0&quot;);

<span class="fc" id="L45">    @Column(name = &quot;PAYOUT_BALANCE&quot;)</span>
    private BigDecimal payoutCreditLevel = new BigDecimal(&quot;0&quot;);

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;PARENT_ID&quot;, nullable = true)
    private Merchant parentMerchant;

    @Column(name = &quot;IS_DISTRIBUTE&quot;)
    private boolean distributor;

    /**
     * If ticket is sold by distributor A, the payout must be performed under distributor A.
     */
    @Column(name = &quot;DISTRIBUTOR_LIMITATION&quot;)
    private boolean salePayoutUnderSameDistributor;

    @Column(name = &quot;STATUS&quot;)
    private int status; // refer to Operator.status

    /*
     * Suppose there are A-&gt;B-&gt;C-&gt;D merchants relationship(D's parent is C, C's parent is B, and so forth), and current
     * merchant'id is 'D', then parentMerchants will be 'A,B,C'. The left first parent(A) is a virtual parent, do NOT do
     * any manipulation on it.
     */
    @Column(name = &quot;MERCHANTS&quot;)
    private String parentMerchants;

    // How many numbers can be chose when is multiple bet option. 0 means no
    // limit.
    @Column(name = &quot;MAX_MULTIPLE&quot;)
    private int maxMultipleBets;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;BD_PRIZE_GROUP_ID&quot;, nullable = true)
    private PrizeGroup prizeGroup;

    @Column(name = &quot;MULTI_DRAW&quot;)
    private int allowedMultiDraw;

    // refer to CREDIT_TYPE_XXX
    @Column(name = &quot;LIMIT_TYPE&quot;)
    private int creditType;

    @Column(name = &quot;RETAILER_TARGET_BETS&quot;)
    private int incentiveTarget;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;BD_CASH_GROUP_ID&quot;, nullable = true)
    private PrizeGroup cashoutGroup; // payout group

<span class="fc" id="L95">    @Column(name = &quot;CASH_OUT_DAY_LEVEL&quot;)</span>
    private BigDecimal dailyCashoutLevel = new BigDecimal(&quot;0&quot;);

    /**
     * Whether need to deduct sale credit when player buy ticket with credit card.
     */
    @Column(name = &quot;CREDIT_CARD_NEED&quot;)
    private boolean deductSaleByCreditCard;

    @Column(name = &quot;TAX_ID&quot;)
    private String taxNo;

    @Column(name = &quot;MAX_OFFLINE_TICKETS&quot;)
    private long maxOfflineTickets;

<span class="fc" id="L110">    @Column(name = &quot;CASHOUT_BALANCE&quot;)</span>
    private BigDecimal cashoutBalance = new BigDecimal(&quot;0&quot;);

<span class="fc" id="L113">    @Column(name = &quot;COMMISION_BALANCE&quot;)</span>
    private BigDecimal commisionBalance = new BigDecimal(&quot;0&quot;);

<span class="fc" id="L116">    @Column(name = &quot;TOPUP_RATE&quot;)</span>
    private BigDecimal topupReat = new BigDecimal(&quot;0&quot;);

<span class="fc" id="L119">    @Column(name = &quot;CASHOUT_RATE&quot;)</span>
    private BigDecimal cashoutRate = new BigDecimal(&quot;0&quot;);

<span class="fc" id="L122">    @Column(name = &quot;UPDATE_TIME&quot;, nullable = true)</span>
    private Timestamp updateTime = new Timestamp(System.currentTimeMillis());

    @Transient
    private OperatorCommission operatorCommission;
    @Transient
    private MerchantCommission merchantCommission;

    /**
     * Lookup distributor of a retailer. Theoretically each retailer must under a distributor.
     * 
     * @return the distributor, or null if no found.
     */
    public Merchant lookupDistributor() {
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        if (this.getId() == SUPER_MERCHANT_ID) {</span>
<span class="nc" id="L137">            return null;</span>
        }
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (this.isDistributor()) {</span>
<span class="fc" id="L140">            return this;</span>
        } else {
<span class="fc" id="L142">            return this.getParentMerchant().lookupDistributor();</span>
        }
    }

    public void verifyActiveStatusRecursively() throws ApplicationException {
<span class="fc bfc" id="L147" title="All 2 branches covered.">        if (this.getId() == SUPER_MERCHANT_ID) {</span>
<span class="fc" id="L148">            return;</span>
        }
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if (Operator.STATUS_ACTIVE != this.getStatus()) {</span>
            {
<span class="nc" id="L152">                throw new ApplicationException(SystemException.CODE_MERCHANT_INACTIVE, &quot;merchant(id=&quot; + this.getId()</span>
                        + &quot;) is not active.&quot;);
            }
        } else {
<span class="fc" id="L156">            this.getParentMerchant().verifyActiveStatusRecursively();</span>
        }
<span class="fc" id="L158">    }</span>

    public long getId() {
<span class="fc" id="L161">        return id;</span>
    }

    public void setId(long id) {
<span class="fc" id="L165">        this.id = id;</span>
<span class="fc" id="L166">    }</span>

    public int getStatus() {
<span class="fc" id="L169">        return status;</span>
    }

    public void setStatus(int status) {
<span class="nc" id="L173">        this.status = status;</span>
<span class="nc" id="L174">    }</span>

    public String getParentMerchants() {
<span class="fc" id="L177">        return parentMerchants;</span>
    }

    public void setParentMerchants(String parentMerchants) {
<span class="nc" id="L181">        this.parentMerchants = parentMerchants;</span>
<span class="nc" id="L182">    }</span>

    public Merchant getParentMerchant() {
<span class="fc" id="L185">        return parentMerchant;</span>
    }

    public void setParentMerchant(Merchant parentMerchant) {
<span class="nc" id="L189">        this.parentMerchant = parentMerchant;</span>
<span class="nc" id="L190">    }</span>

    public String getName() {
<span class="fc" id="L193">        return name;</span>
    }

    public void setName(String name) {
<span class="fc" id="L197">        this.name = name;</span>
<span class="fc" id="L198">    }</span>

    public String getCode() {
<span class="fc" id="L201">        return code;</span>
    }

    public void setCode(String code) {
<span class="fc" id="L205">        this.code = code;</span>
<span class="fc" id="L206">    }</span>

    public int getMaxMultipleBets() {
<span class="fc" id="L209">        return maxMultipleBets;</span>
    }

    public void setMaxMultipleBets(int maxMultipleBets) {
<span class="nc" id="L213">        this.maxMultipleBets = maxMultipleBets;</span>
<span class="nc" id="L214">    }</span>

    public PrizeGroup getPrizeGroup() {
<span class="nc" id="L217">        return prizeGroup;</span>
    }

    public void setPrizeGroup(PrizeGroup prizeGroup) {
<span class="nc" id="L221">        this.prizeGroup = prizeGroup;</span>
<span class="nc" id="L222">    }</span>

    public int getAllowedMultiDraw() {
<span class="fc" id="L225">        return allowedMultiDraw;</span>
    }

    public void setAllowedMultiDraw(int allowedMultiDraw) {
<span class="nc" id="L229">        this.allowedMultiDraw = allowedMultiDraw;</span>
<span class="nc" id="L230">    }</span>

    public int getIncentiveTarget() {
<span class="nc" id="L233">        return incentiveTarget;</span>
    }

    public void setIncentiveTarget(int incentiveTarget) {
<span class="nc" id="L237">        this.incentiveTarget = incentiveTarget;</span>
<span class="nc" id="L238">    }</span>

    public BigDecimal getSaleCreditLevel() {
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        return saleCreditLevel == null ? new BigDecimal(&quot;0&quot;) : saleCreditLevel;</span>
    }

    public void setSaleCreditLevel(BigDecimal saleCreditLevel) {
<span class="fc" id="L245">        this.saleCreditLevel = saleCreditLevel;</span>
<span class="fc" id="L246">    }</span>

    public BigDecimal getPayoutCreditLevel() {
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        return payoutCreditLevel == null ? new BigDecimal(&quot;0&quot;) : payoutCreditLevel;</span>
    }

    public void setPayoutCreditLevel(BigDecimal payoutCreditLevel) {
<span class="fc" id="L253">        this.payoutCreditLevel = payoutCreditLevel;</span>
<span class="fc" id="L254">    }</span>

    public PrizeGroup getCashoutGroup() {
<span class="nc" id="L257">        return cashoutGroup;</span>
    }

    public void setCashoutGroup(PrizeGroup cashoutGroup) {
<span class="nc" id="L261">        this.cashoutGroup = cashoutGroup;</span>
<span class="nc" id="L262">    }</span>

    public BigDecimal getDailyCashoutLevel() {
<span class="nc bnc" id="L265" title="All 2 branches missed.">        return this.dailyCashoutLevel == null ? new BigDecimal(&quot;0&quot;) : this.dailyCashoutLevel;</span>
    }

    public void setDailyCashoutLevel(BigDecimal dailyCashoutLevel) {
<span class="nc" id="L269">        this.dailyCashoutLevel = dailyCashoutLevel;</span>
<span class="nc" id="L270">    }</span>

    public int getCreditType() {
<span class="fc" id="L273">        return creditType;</span>
    }

    public void setCreditType(int creditType) {
<span class="nc" id="L277">        this.creditType = creditType;</span>
<span class="nc" id="L278">    }</span>

    public OperatorCommission getOperatorCommission() {
<span class="nc" id="L281">        return operatorCommission;</span>
    }

    public void setOperatorCommission(OperatorCommission operatorCommission) {
<span class="nc" id="L285">        this.operatorCommission = operatorCommission;</span>
<span class="nc" id="L286">    }</span>

    public MerchantCommission getMerchantCommission() {
<span class="nc" id="L289">        return merchantCommission;</span>
    }

    public void setMerchantCommission(MerchantCommission merchantCommission) {
<span class="nc" id="L293">        this.merchantCommission = merchantCommission;</span>
<span class="nc" id="L294">    }</span>

    public boolean isDeductSaleByCreditCard() {
<span class="fc" id="L297">        return deductSaleByCreditCard;</span>
    }

    public void setDeductSaleByCreditCard(boolean deductSaleByCreditCard) {
<span class="nc" id="L301">        this.deductSaleByCreditCard = deductSaleByCreditCard;</span>
<span class="nc" id="L302">    }</span>

    public boolean isDistributor() {
<span class="fc" id="L305">        return distributor;</span>
    }

    public void setDistributor(boolean distributor) {
<span class="nc" id="L309">        this.distributor = distributor;</span>
<span class="nc" id="L310">    }</span>

    public String getTaxNo() {
<span class="nc" id="L313">        return taxNo;</span>
    }

    public void setTaxNo(String taxNo) {
<span class="nc" id="L317">        this.taxNo = taxNo;</span>
<span class="nc" id="L318">    }</span>

    public boolean isSalePayoutUnderSameDistributor() {
<span class="fc" id="L321">        return salePayoutUnderSameDistributor;</span>
    }

    public void setSalePayoutUnderSameDistributor(boolean salePayoutUnderSameDistributor) {
<span class="nc" id="L325">        this.salePayoutUnderSameDistributor = salePayoutUnderSameDistributor;</span>
<span class="nc" id="L326">    }</span>

    /**
     * The merchant with given identifier is the parent of current merchant? If current merchant has the same identifier
     * with the given &lt;code&gt;merchantId&lt;/code&gt;, true will be returned. This method can only be ran in JPA context.
     */
    public boolean isParent(long merchantId) {
<span class="nc bnc" id="L333" title="All 2 branches missed.">        if (merchantId == SUPER_MERCHANT_ID) {</span>
<span class="nc" id="L334">            return true;</span>
        }

<span class="nc" id="L337">        Merchant parent = this;</span>
        while (true) {
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (parent.getId() == merchantId) {</span>
<span class="nc" id="L340">                return true;</span>
            } else {
<span class="nc" id="L342">                parent = parent.getParentMerchant();</span>
<span class="nc bnc" id="L343" title="All 4 branches missed.">                if (parent == null || parent.getId() == SUPER_MERCHANT_ID) {</span>
<span class="nc" id="L344">                    break;</span>
                }
            }
        }
<span class="nc" id="L348">        return false;</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L353">        return &quot;Merchant [id=&quot; + id + &quot;, name=&quot; + name + &quot;, saleCreditLevel=&quot; + saleCreditLevel</span>
                + &quot;, payoutCreditLevel=&quot; + payoutCreditLevel + &quot;, creditType=&quot; + creditType + &quot;, cashoutBalance=&quot;
                + cashoutBalance + &quot;, commisionBalance=&quot; + commisionBalance + &quot;]&quot;;
    }

    public long getMaxOfflineTickets() {
<span class="fc" id="L359">        return maxOfflineTickets;</span>
    }

    public void setMaxOfflineTickets(long maxOfflineTickets) {
<span class="nc" id="L363">        this.maxOfflineTickets = maxOfflineTickets;</span>
<span class="nc" id="L364">    }</span>

    public BigDecimal getCashoutBalance() {
<span class="fc" id="L367">        return cashoutBalance;</span>
    }

    public void setCashoutBalance(BigDecimal cashoutBalance) {
<span class="fc" id="L371">        this.cashoutBalance = cashoutBalance;</span>
<span class="fc" id="L372">    }</span>

    public BigDecimal getCommisionBalance() {
<span class="fc" id="L375">        return commisionBalance;</span>
    }

    public void setCommisionBalance(BigDecimal commisionBalance) {
<span class="fc" id="L379">        this.commisionBalance = commisionBalance;</span>
<span class="fc" id="L380">    }</span>

    public BigDecimal getTopupReat() {
<span class="nc" id="L383">        return topupReat;</span>
    }

    public void setTopupReat(BigDecimal topupReat) {
<span class="nc" id="L387">        this.topupReat = topupReat;</span>
<span class="nc" id="L388">    }</span>

    public BigDecimal getCashoutRate() {
<span class="nc" id="L391">        return cashoutRate;</span>
    }

    public void setCashoutRate(BigDecimal cashoutRate) {
<span class="nc" id="L395">        this.cashoutRate = cashoutRate;</span>
<span class="nc" id="L396">    }</span>

    public void setUpdateTime(Timestamp updateTime) {
<span class="fc" id="L399">        this.updateTime = updateTime;</span>
<span class="fc" id="L400">    }</span>

    public Timestamp getUpdateTime() {
<span class="nc" id="L403">        return updateTime;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>