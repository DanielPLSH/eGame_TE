<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ProtocolSerializer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.port.protocol</a> &gt; <span class="el_source">ProtocolSerializer.java</span></div><h1>ProtocolSerializer.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.port.protocol;

import com.mpos.lottery.te.common.encrypt.HMacMd5Cipher;
import com.mpos.lottery.te.common.encrypt.TriperDESCipher;
import com.mpos.lottery.te.config.MLotteryContext;
import com.mpos.lottery.te.config.exception.MessageFormatException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.trans.domain.TransactionType;
import com.mpos.lottery.te.workingkey.domain.WorkingKey;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

<span class="fc" id="L15">public class ProtocolSerializer {</span>
<span class="fc" id="L16">    private Log logger = LogFactory.getLog(ProtocolSerializer.class);</span>

<span class="fc" id="L18">    private MLotteryContext prop = MLotteryContext.getInstance();</span>

    /**
     * Serialize response, and then do MAC and DES encryption.
     */
    public void serialize(Context responseCtx) {
        try {
<span class="fc bfc" id="L25" title="All 2 branches covered.">            if (responseCtx.getModel() != null) {</span>
<span class="pc bpc" id="L26" title="1 of 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L27">                    logger.debug(&quot;Start to serialize model(&quot;</span>
                            + responseCtx.getModel().getClass()
                            + &quot;),mappingFile=&quot;
                            + getMappingFile(responseCtx.getTransType(), responseCtx.getProtocalVersion(),
                                    responseCtx.getGameTypeId()));
                }
<span class="fc" id="L33">                String xml = CastorHelper.marshal(</span>
                        responseCtx.getModel(),
                        getMappingFile(responseCtx.getTransType(), responseCtx.getProtocalVersion(),
                                responseCtx.getGameTypeId()));
<span class="fc" id="L37">                responseCtx.setOriginalBody(xml);</span>
            }
            // if (responseCtx.getTransType() !=
            // TransactionType.GET_WORKING_KEY.getResponseType())
<span class="pc bpc" id="L41" title="1 of 4 branches missed.">            if (responseCtx.getTransType() != TransactionType.GET_WORKING_KEY.getResponseType()</span>
                    &amp;&amp; responseCtx.getTransType() != TransactionType.CHECK_ALIVE.getResponseType()) {
<span class="fc" id="L43">                this.macAndEncrypt(responseCtx);</span>
            } else {
                // only encryption message body will be write out.
<span class="fc" id="L46">                responseCtx.setEncrptedBody(responseCtx.getOriginalBody());</span>
            }
            // if (logger.isDebugEnabled()){
            // logger.debug(&quot;Finish serializing response context(&quot; +
            // responseCtx.getMacString() + &quot;).&quot;);
            // }
<span class="nc" id="L52">        } catch (Exception e) {</span>
<span class="nc" id="L53">            logger.error(e.getMessage(), e);</span>
<span class="nc" id="L54">            throw new SystemException(e);</span>
<span class="fc" id="L55">        }</span>
<span class="fc" id="L56">    }</span>

    /**
     * Decrypt messagebody, verify MAC, and then deserialize message body.
     */
    public void deserialize(Context requestCtx) {
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L63">            logger.debug(&quot;Start to deserialize request context(&quot; + requestCtx.getMacString() + &quot;).&quot;);</span>
        }
<span class="pc bpc" id="L65" title="1 of 4 branches missed.">        if (requestCtx.getTransType() != TransactionType.GET_WORKING_KEY.getRequestType()</span>
                &amp;&amp; requestCtx.getTransType() != TransactionType.CHECK_ALIVE.getRequestType()) {
<span class="fc" id="L67">            this.decryptAndMac(requestCtx);</span>
        }
        try {
<span class="pc bpc" id="L70" title="1 of 4 branches missed.">            if (requestCtx.getEncrptedBody() != null &amp;&amp; !&quot;&quot;.equals(requestCtx.getEncrptedBody())) {</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L72">                    logger.debug(&quot;Start to deserialize model: model=&quot;</span>
                            + requestCtx.getModel()
                            + &quot;,mappingFile=&quot;
                            + getMappingFile(requestCtx.getTransType(), requestCtx.getProtocalVersion(),
                                    requestCtx.getGameTypeIdIntValue() + &quot;&quot;));
                }
<span class="fc" id="L78">                Object model = CastorHelper.unmarshal(</span>
                        requestCtx.getOriginalBody(),
                        this.getMappingFile(requestCtx.getTransType(), requestCtx.getProtocalVersion(),
                                requestCtx.getGameTypeId()));
<span class="fc" id="L82">                requestCtx.setModel(model);</span>
            }
<span class="fc" id="L84">        } catch (Exception e) {</span>
<span class="fc" id="L85">            throw new MessageFormatException(SystemException.CODE_WRONG_MESSAGEBODY,</span>
                    &quot;Fail to parse message body(mappingFile=&quot;
                            + this.getMappingFile(requestCtx.getTransType(), requestCtx.getProtocalVersion(),
                                    requestCtx.getGameTypeId()) + &quot;):&quot; + requestCtx.getOriginalBody(), e);
<span class="fc" id="L89">        }</span>
<span class="fc" id="L90">    }</span>

    /**
     * Do MAC and DES encryption on response
     */
    public void macAndEncrypt(Context responseCtx) throws Exception {
<span class="fc" id="L96">        WorkingKey key = responseCtx.getWorkingKey();</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if (key != null) {</span>
            // do mac
<span class="fc" id="L99">            String macString = responseCtx.getMacString();</span>
<span class="fc" id="L100">            String mac = HMacMd5Cipher.doDigest(macString, key.getMacKey());</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L102">                logger.debug(&quot;Finish mac(macKey=&quot; + key.getMacKey() + &quot;,macString=&quot; + macString + &quot;):&quot; + mac);</span>
            }
<span class="fc" id="L104">            responseCtx.setMac(mac);</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">            if (responseCtx.getModel() != null) {</span>
                // des encryption
<span class="fc" id="L107">                String encrypt = TriperDESCipher.encrypt(key.getDataKey(), responseCtx.getOriginalBody(),</span>
                        prop.getTriperDesIV());
<span class="fc" id="L109">                responseCtx.setEncrptedBody(encrypt);</span>
            }
        } else {
            // logger.warn(&quot;No working key &quot;)
        }
<span class="fc" id="L114">    }</span>

    /**
     * decrypt message body and verify MAC
     */
    public void decryptAndMac(Context requestCtx) {
<span class="fc" id="L120">        WorkingKey key = requestCtx.getWorkingKey();</span>
<span class="fc" id="L121">        String digest = null;</span>
        try {
<span class="fc bfc" id="L123" title="All 2 branches covered.">            if (requestCtx.getEncrptedBody() != null) {</span>
<span class="fc" id="L124">                String originalBody = TriperDESCipher.decrypt(key.getDataKey(), requestCtx.getEncrptedBody(),</span>
                        prop.getTriperDesIV());
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L127">                    logger.debug(&quot;Finish decrypting cipher into original xml:&quot; + originalBody);</span>
                }
<span class="fc" id="L129">                requestCtx.setOriginalBody(originalBody);</span>
            }
<span class="fc" id="L131">            String macString = requestCtx.getMacString().trim();</span>
<span class="fc" id="L132">            digest = HMacMd5Cipher.doDigest(macString, key.getMacKey());</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L134">                logger.debug(&quot;Start to do MAC(key=&quot; + key.getMacKey() + &quot;) on (&quot; + macString + &quot;,hash=&quot;</span>
                        + macString.hashCode() + &quot;), get digest:&quot; + digest);
            }
<span class="nc" id="L137">        } catch (Exception e) {</span>
<span class="nc" id="L138">            throw new SystemException(SystemException.CODE_FAILTO_DECRYPT,</span>
                    &quot;Fail to decrypt message body(traceMesageId=&quot; + requestCtx.getTraceMessageId() + &quot;,terminalId=&quot;
                            + requestCtx.getTerminalId() + &quot;).&quot;, e);
<span class="fc" id="L141">        }</span>
        // verify mac
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (!digest.equalsIgnoreCase(requestCtx.getMac())) {</span>
<span class="nc" id="L144">            throw new MessageFormatException(SystemException.CODE_UNMATCHED_MAC, &quot;Excepted mac:&quot; + digest + &quot;, but:&quot;</span>
                    + requestCtx.getMac());
        }
<span class="fc" id="L147">    }</span>

    // ---------------------------------------
    // PRIVATE METHODS
    // ---------------------------------------

    protected String getMappingFile(int transType, String protocolVersion, String gameTypeId) {
<span class="fc" id="L154">        return prop.getMappingFile(transType, protocolVersion, gameTypeId);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>