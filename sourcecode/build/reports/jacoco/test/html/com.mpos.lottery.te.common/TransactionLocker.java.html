<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TransactionLocker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.common</a> &gt; <span class="el_source">TransactionLocker.java</span></div><h1>TransactionLocker.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.common;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;

public class TransactionLocker {
<span class="nc" id="L11">    private Log logger = LogFactory.getLog(TransactionLocker.class);</span>
<span class="nc" id="L12">    private Map&lt;String, Locker&gt; transMap = Collections.synchronizedMap(new HashMap&lt;String, Locker&gt;());</span>
    private static TransactionLocker transLocker;
<span class="nc" id="L14">    private final Object globeLock = new Object();</span>

<span class="nc" id="L16">    private TransactionLocker() {</span>
<span class="nc" id="L17">    }</span>

    public synchronized static TransactionLocker getInstance() {
<span class="nc bnc" id="L20" title="All 2 branches missed.">        if (transLocker == null) {</span>
<span class="nc" id="L21">            transLocker = new TransactionLocker();</span>
        }
<span class="nc" id="L23">        return transLocker;</span>
    }

    /**
     * Record which transaction(deviceId+operatorId+batchNo+transType) is in progress.
     * 
     * @param key
     *            deviceId-operatorId-batchNo-transType
     */
    public void acquire(String key) {
<span class="nc bnc" id="L33" title="All 2 branches missed.">        if (key == null) {</span>
<span class="nc" id="L34">            throw new IllegalArgumentException(&quot;argument 'key' can NOT be null&quot;);</span>
        }
        // all threads handling same type of
        // transaction(deviceId+operatorId+batchNo+transType)
        // must monitor the same object, by contrast the thread handling
        // different type transaction
        // must monitor different object.
<span class="nc" id="L41">        Locker locker = null;</span>
<span class="nc" id="L42">        synchronized (globeLock) {</span>
<span class="nc" id="L43">            locker = transMap.get(key);</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">            if (locker == null) {</span>
<span class="nc" id="L45">                locker = new Locker();</span>
<span class="nc" id="L46">                locker.setKey(key);</span>
<span class="nc" id="L47">                transMap.put(key, locker);</span>
<span class="nc" id="L48">                return;</span>
            }
<span class="nc" id="L50">        }</span>
<span class="nc" id="L51">        synchronized (locker) {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if (locker != null) { // the lock has been assigned.</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L54">                    logger.debug(&quot;A same type transaction(&quot; + key + &quot;) is in progress, current &quot;</span>
                            + &quot;transaction will be blocked until the previous transaction finished.&quot;);
                }
<span class="nc" id="L57">                locker.addWaiter();</span>
                try {
                    // the current thread must be the object's monitor, and
                    // wait() will release
                    // the ownership of this monitor.
<span class="nc" id="L62">                    locker.wait();</span>

<span class="nc" id="L64">                } catch (InterruptedException e) {</span>
<span class="nc" id="L65">                    logger.warn(e.getMessage(), e);</span>
<span class="nc" id="L66">                }</span>
                // got notification...means some thread invoke release().
<span class="nc" id="L68">                locker.removeWaiter();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L70">                    logger.debug(&quot;Got transaction lock(&quot; + key + &quot;), resume current transaction.&quot;);</span>
                }
            }
<span class="nc" id="L73">        }</span>
<span class="nc" id="L74">    }</span>

    /**
     * Release the lock, then other transaction of same type can continue.
     */
    public void release(String key) {
<span class="nc bnc" id="L80" title="All 2 branches missed.">        if (key == null) {</span>
<span class="nc" id="L81">            return;</span>
        }
<span class="nc" id="L83">        Locker locker = transMap.get(key);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (locker != null) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (locker.getWaiter() &gt; 0) {</span>
<span class="nc" id="L86">                synchronized (locker) {</span>
<span class="nc" id="L87">                    logger.debug(&quot;Release lock(&quot; + key + &quot;), there are &quot; + locker.getWaiter() + &quot; waiters.&quot;);</span>
<span class="nc" id="L88">                    locker.notify();</span>
<span class="nc" id="L89">                }</span>
            } else {
<span class="nc bnc" id="L91" title="All 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L92">                    logger.debug(&quot;No threads waiting for this lock(&quot; + key + &quot;), remove it directly.&quot;);</span>
                }
                // or transMap will result in outofmemory.
<span class="nc" id="L95">                transMap.remove(key);</span>
            }
        }
<span class="nc" id="L98">    }</span>

<span class="nc" id="L100">    public static class Locker {</span>
        private String key;
        // How many threads waiting for the lock?
        private int waiter;

        public String getKey() {
<span class="nc" id="L106">            return key;</span>
        }

        public void setKey(String key) {
<span class="nc" id="L110">            this.key = key;</span>
<span class="nc" id="L111">        }</span>

        public int getWaiter() {
<span class="nc" id="L114">            return waiter;</span>
        }

        public void addWaiter() {
<span class="nc" id="L118">            this.waiter++;</span>
<span class="nc" id="L119">        }</span>

        public void removeWaiter() {
<span class="nc" id="L122">            this.waiter--;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (this.waiter &lt;= 0) {</span>
<span class="nc" id="L124">                this.waiter = 0;</span>
            }
<span class="nc" id="L126">        }</span>

        public String toString() {
<span class="nc" id="L129">            return this + &quot;(key=&quot; + this.key + &quot;,waiter=&quot; + this.waiter + &quot;)&quot;;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>