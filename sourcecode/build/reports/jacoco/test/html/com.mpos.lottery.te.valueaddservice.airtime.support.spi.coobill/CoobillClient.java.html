<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CoobillClient.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.valueaddservice.airtime.support.spi.coobill</a> &gt; <span class="el_source">CoobillClient.java</span></div><h1>CoobillClient.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.valueaddservice.airtime.support.spi.coobill;

import org.apache.cxf.endpoint.Client;
import org.apache.cxf.frontend.ClientProxy;
import org.apache.cxf.transport.http.HTTPConduit;
import org.apache.cxf.transports.http.configuration.HTTPClientPolicy;

import java.net.MalformedURLException;
import java.net.SocketTimeoutException;
import java.net.URL;

import javax.xml.namespace.QName;
import javax.xml.stream.XMLStreamException;

public class CoobillClient {

    protected RechargeMsisdnService service;

    private long connectionTimeout;
    private long receiveTimeout;
    private URL url;
    private QName serviceName;

<span class="fc" id="L24">    public CoobillClient(String wsdl, long connectionTimeout, long receiveTimeout) throws MalformedURLException {</span>
<span class="fc" id="L25">        this.connectionTimeout = connectionTimeout;</span>
<span class="fc" id="L26">        this.receiveTimeout = receiveTimeout;</span>
<span class="fc" id="L27">        URL baseUrl = com.mpos.lottery.te.valueaddservice.airtime.support.spi.coobill.RechargeMsisdnService.class.getResource(&quot;.&quot;);</span>
<span class="fc" id="L28">        url = new URL(baseUrl, wsdl);</span>
<span class="fc" id="L29">        serviceName = new QName(&quot;http://tempuri.org/&quot;, &quot;RechargeMsisdnService&quot;);</span>

<span class="fc" id="L31">        service = new RechargeMsisdnService(url, serviceName);</span>
<span class="fc" id="L32">    }</span>

    /**
     * Coolbill topup Msisdn transaction.
     * 
     * @param topupMsisdnReq
     *            Topup Msisdn request parameter object
     * @return TopupMsisdnResult
     * @throws SocketTimeoutException
     *             Response Exception
     * @throws XMLStreamException
     *             Connect Exception
     */
    public TopupMsisdnResult topupMsisdn(TopupMsisdnReq topupMsisdnReq) throws SocketTimeoutException,
            XMLStreamException {
        try {
<span class="fc" id="L48">            RechargeMsisdn rechargeMsisdn = service.getRechargeMsisdnPort();</span>

            // set transaction timeout
<span class="fc" id="L51">            this.setTimeout(rechargeMsisdn);</span>
            // String agent = MLotteryContext.getInstance().get(MLotteryContext.COOBILL_AGENT);
            // String password = MLotteryContext.getInstance().get(MLotteryContext.COOBILL_PASSWORD);

<span class="fc" id="L55">            TopupMsisdnResult result = rechargeMsisdn.topupMsisdn(topupMsisdnReq.getAgent(),</span>
                    topupMsisdnReq.getPassword(), topupMsisdnReq.getMsisdn(), topupMsisdnReq.getAmout(),
                    topupMsisdnReq.getRefTrx());
<span class="fc" id="L58">            return result;</span>
<span class="fc" id="L59">        } catch (RuntimeException e) {</span>
<span class="fc" id="L60">            Throwable ta = e.getCause();</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">            if (ta instanceof SocketTimeoutException) {</span>
<span class="fc" id="L62">                throw (SocketTimeoutException) ta;</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            } else if (ta instanceof XMLStreamException) {</span>
<span class="nc" id="L64">                throw (XMLStreamException) ta;</span>
            } else {
<span class="nc" id="L66">                throw e;</span>
            }
        }

    }

    /**
     * Query top up transaction info by transaction id
     * 
     * @param queryMsisdnReq
     *            telNo : msisdn of TopupMsisdnReq ,reqTransid:refTrx of TopupMsisdnReq
     * @return OrderPaymentItem return transaction info
     * @throws SocketTimeoutException
     * @throws XMLStreamException
     */
    public OrderPaymentItem queryMsisdn(QueryMsisdnReq queryMsisdnReq) throws SocketTimeoutException,
            XMLStreamException {
<span class="nc" id="L83">        RechargeMsisdn rechargeMsisdn = service.getRechargeMsisdnPort();</span>
        // set transaction timeout
        try {
<span class="nc" id="L86">            this.setTimeout(rechargeMsisdn);</span>
<span class="nc" id="L87">            return rechargeMsisdn.queryMsisdn(queryMsisdnReq.getTelNo(), queryMsisdnReq.getReqTransid());</span>
<span class="nc" id="L88">        } catch (RuntimeException e) {</span>
<span class="nc" id="L89">            Throwable ta = e.getCause();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (ta instanceof SocketTimeoutException) {</span>
<span class="nc" id="L91">                throw (SocketTimeoutException) ta;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            } else if (ta instanceof XMLStreamException) {</span>
<span class="nc" id="L93">                throw (XMLStreamException) ta;</span>
            } else {
<span class="nc" id="L95">                throw e;</span>
            }
        }
    }

    private void setTimeout(RechargeMsisdn rechargeMsisdn) {

<span class="fc" id="L102">        Client cl = ClientProxy.getClient(rechargeMsisdn);</span>
<span class="fc" id="L103">        HTTPConduit http = (HTTPConduit) cl.getConduit();</span>
<span class="fc" id="L104">        HTTPClientPolicy httpClientPolicy = new HTTPClientPolicy();</span>
<span class="fc" id="L105">        httpClientPolicy.setConnectionTimeout(connectionTimeout);</span>
<span class="fc" id="L106">        httpClientPolicy.setReceiveTimeout(receiveTimeout);</span>
<span class="fc" id="L107">        http.setClient(httpClientPolicy);</span>
<span class="fc" id="L108">    }</span>

    /**
     * main method.
     * 
     * @param args
     *            agres
     * @throws XMLStreamException
     * @throws SocketTimeoutException
     * @throws MalformedURLException
     */
    public static void main(String[] args) throws SocketTimeoutException, XMLStreamException, MalformedURLException {
        // CoobillClient client = new CoobillClient(&quot;http://onlinehall.cootel.com.kh/bankAgentRecharge/terminal?wsdl&quot;,
        // 1000, 1000);
<span class="nc" id="L122">        CoobillClient client = new CoobillClient(&quot;http://localhost:9090/3rdparty/cb/&quot;, 30 * 1000, 30 * 1000);</span>
        // TopupMsisdnReq topupMsisdnReq = new TopupMsisdnReq();
        // topupMsisdnReq.setAgent(&quot;paygo24&quot;);
        // topupMsisdnReq.setPassword(&quot;20b7889cf6325b4644ab&quot;);
        // topupMsisdnReq.setAmout(1);
        // // topupMsisdnReq.setMsisdn(&quot;008613825207590&quot;);
        // topupMsisdnReq.setMsisdn(&quot;222&quot;);
        // topupMsisdnReq.setRefTrx(&quot;20144230101235&quot;);
        // TopupMsisdnResult result = client.topupMsisdn(topupMsisdnReq);
        // System.out.println(&quot;Description : &quot; + result.getDescription());
        // System.out.println(&quot;Status : &quot; + result.getStatus());
        // System.out.println(&quot;TransactionDate : &quot; + result.getTransactionDate());
        // System.out.println(&quot;TransactionId : &quot; + result.getTransactionId());

<span class="nc" id="L136">        QueryMsisdnReq req = new QueryMsisdnReq();</span>
<span class="nc" id="L137">        req.setReqTransid(&quot;14225985390228460&quot;);</span>
<span class="nc" id="L138">        req.setTelNo(&quot;008613590495473&quot;);</span>
<span class="nc" id="L139">        OrderPaymentItem result = client.queryMsisdn(req);</span>
<span class="nc" id="L140">        System.out.println(&quot;[Status]&quot; + result.getPayStatus());</span>
<span class="nc" id="L141">        System.out.println(&quot;[TransId]&quot; + result.getTransactionId());</span>
<span class="nc" id="L142">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>