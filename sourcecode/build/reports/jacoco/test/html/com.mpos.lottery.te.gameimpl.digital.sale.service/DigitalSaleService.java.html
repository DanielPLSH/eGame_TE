<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DigitalSaleService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.digital.sale.service</a> &gt; <span class="el_source">DigitalSaleService.java</span></div><h1>DigitalSaleService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.digital.sale.service;

import com.mpos.lottery.te.config.MLotteryContext;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.digital.sale.DigitalEntry;
import com.mpos.lottery.te.gameimpl.digital.sale.dao.DigitalStatOfSelectedNumberDao;
import com.mpos.lottery.te.gamespec.game.BaseGameInstance;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.gamespec.sale.BaseEntry;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.gamespec.sale.StatOfSelectedNumber;
import com.mpos.lottery.te.gamespec.sale.service.AbstractTicketService;
import com.mpos.lottery.te.gamespec.sale.support.validator.SelectedNumber;
import com.mpos.lottery.te.port.Context;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.perf4j.StopWatch;
import org.perf4j.log4j.Log4JStopWatch;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

<span class="fc" id="L29">public class DigitalSaleService extends AbstractTicketService {</span>
<span class="fc" id="L30">    private Log logger = LogFactory.getLog(DigitalSaleService.class);</span>
    private DigitalStatOfSelectedNumberDao statOfSelectedNumberDao;

    @Override
    public GameType supportedGameType() {
<span class="fc" id="L35">        return GameType.DIGITAL;</span>
    }

    @Override
    protected void generateQPWhenSale(Context&lt;?&gt; respCtx, BaseTicket clientTicket) throws ApplicationException {
<span class="fc bfc" id="L40" title="All 2 branches covered.">        for (BaseEntry entry : clientTicket.getEntries()) {</span>
<span class="pc bpc" id="L41" title="1 of 4 branches missed.">            if (entry.isQP() &amp;&amp; ((DigitalEntry) entry).isXD()) {</span>
                // generate QP for XD option only
<span class="fc" id="L43">                int countOfQPNumber = this.determineCountOfQPNumber(entry);</span>
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">                if (countOfQPNumber &gt; 0) {</span>
<span class="fc" id="L45">                    StopWatch sw = new Log4JStopWatch();</span>
<span class="fc" id="L46">                    entry.setSelectNumber(doGeneratingQP(respCtx, clientTicket.getGameInstance(), countOfQPNumber));</span>
<span class="fc" id="L47">                    sw.stop(&quot;Generate_QP&quot;, &quot;Generate QP number for ticket(&quot; + clientTicket.getSerialNo() + &quot;)&quot;);</span>
                }
            }
<span class="fc" id="L50">        }</span>
<span class="fc" id="L51">    }</span>

    /**
     * Generate QP numbers for digital game.
     * &lt;p/&gt;
     * &lt;h1&gt;Prepare Stat of Selected Numbers&lt;/h1&gt;
     * &lt;p/&gt;
     * When create digital game instances, M.Lottery will insert statOfSelectedNumbers records in advance. For example a
     * 3D game, there should be total 30 records, just as below,
     * &lt;table border=&quot;1&quot;&gt;
     * &lt;tr&gt;
     * &lt;td&gt;gameInstance&lt;/td&gt;
     * &lt;td&gt;selecedNumber&lt;/td&gt;
     * &lt;td&gt;count&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;...&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;9&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;00&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;...&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;90&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;000&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;...&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;900&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;/table&gt;
     * &lt;ul&gt;
     * &lt;li&gt;The selected number 0..9 represents the 1st number of a selected number&lt;/li&gt;
     * &lt;li&gt;The selected number 00..90 represents the 2nd number of a selected number&lt;/li&gt;
     * &lt;li&gt;the selected number 000..900 represented the 3rd number of a selected number
     * &lt;li&gt;
     * &lt;/ul&gt;
     * For example a selected number '1,9,7', the 1st number is 7, 2nd number is 9 and the 3rd number is 1.
     * &lt;p/&gt;
     * &lt;h1&gt;Update Stat of Selected Numbers&lt;/h1&gt;
     * When make sale of digital game, the selected number of each sale will be parsed and update the stat. For example
     * a sale with below entries:
     * &lt;ul&gt;
     * &lt;li&gt;2,8,7&lt;/li&gt;
     * &lt;li&gt;3,8,6&lt;/li&gt;
     * &lt;li&gt;3,8,7
     * &lt;li&gt;
     * &lt;/ul&gt;
     * and the stat will be updated as
     * &lt;table&gt;
     * &lt;tr&gt;
     * &lt;td&gt;gameInstance&lt;/td&gt;
     * &lt;td&gt;selecedNumber&lt;/td&gt;
     * &lt;td&gt;count&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;...&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;7&lt;/td&gt;
     * &lt;td&gt;2&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;8&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;9&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;00&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;...&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;80&lt;/td&gt;
     * &lt;td&gt;3&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;90&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;000&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;...&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;200&lt;/td&gt;
     * &lt;td&gt;1&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;300&lt;/td&gt;
     * &lt;td&gt;2&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;...&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td&gt;Draw-1&lt;/td&gt;
     * &lt;td&gt;900&lt;/td&gt;
     * &lt;td&gt;0&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;/table&gt;
     * &lt;p/&gt;
     * &lt;h1&gt;Generate QP Numbers&lt;/h1&gt;
     * &lt;p/&gt;
     * This service will generate QP number based on stat of selected number. If client requests a QP numbers of 3D,
     * this service will parse the stat of selected numbers of given game instance. If the game instance is 'Draw-1',
     * then
     * &lt;ol&gt;
     * &lt;li&gt;Retrieve the list of selected numbers of 3rd position(0..9), and sort them by count. Construct a new array
     * based on, for example the last 8 selected numbers(8 is a configurable value), then pick one number randomly from
     * this array.&lt;/li&gt;
     * &lt;li&gt;Determine the 2nd number following the same algorithm as the 1st step&lt;/li&gt;
     * &lt;li&gt;Determine the 3rd number following the same algorithm as the 1st step&lt;/li&gt;
     * &lt;/ol&gt;
     * Finally you get a QP numbers.
     */
    @Override
    protected String doGeneratingQP(Context&lt;?&gt; respCtx, BaseGameInstance gameInstance, int countOfQPNumber)
            throws ApplicationException {
        // TODO no need to enquiry the list of StatOfSelectedNumbers for each QP
        // entry.
<span class="fc" id="L232">        List&lt;StatOfSelectedNumber&gt; stats = this.getStatOfSelectedNumberDao().findByGameInstance(gameInstance.getId());</span>
        // organize into map, key is the position
<span class="fc" id="L234">        Map&lt;Integer, List&lt;StatOfSelectedNumber&gt;&gt; statMap = new HashMap&lt;Integer, List&lt;StatOfSelectedNumber&gt;&gt;();</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">        for (StatOfSelectedNumber stat : stats) {</span>
<span class="fc" id="L236">            Integer key = stat.getSelecteNumber().length();</span>
<span class="fc" id="L237">            List&lt;StatOfSelectedNumber&gt; positionStat = statMap.get(key);</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">            if (positionStat == null) {</span>
<span class="fc" id="L239">                positionStat = new ArrayList&lt;StatOfSelectedNumber&gt;();</span>
<span class="fc" id="L240">                statMap.put(key, positionStat);</span>
            }
<span class="fc" id="L242">            positionStat.add(stat);</span>
<span class="fc" id="L243">        }</span>

<span class="fc" id="L245">        StringBuffer qp = new StringBuffer();</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">        for (int i = countOfQPNumber; i &gt; 0; i--) {</span>
<span class="fc" id="L247">            int number = this.determineNumber(statMap.get(i), i);</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">            if (i != countOfQPNumber) {</span>
<span class="fc" id="L249">                qp.append(SelectedNumber.DELEMETER_NUMBER);</span>
            }
<span class="fc" id="L251">            qp.append(number + &quot;&quot;);</span>
        }
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L254">            logger.debug(&quot;Generate QP number:&quot; + qp.toString() + &quot; of game instance(id=&quot; + gameInstance.getId() + &quot;).&quot;);</span>
        }
<span class="fc" id="L256">        return qp.toString();</span>
    }

    /**
     * Determine the number of given index. For example if QP a 3D selected number, and wanna determine the number of
     * 2nd position, the procedure will be follow:
     * &lt;ol&gt;
     * &lt;li&gt;Lookup all StatOfSelectedNumber range from '00' to '90'(if X/Y is 0/9)&lt;/li&gt;
     * &lt;li&gt;Sort the list of StatOfSelectedNumbers, and find the 5 less used numbers&lt;/li&gt;
     * &lt;li&gt;Pick one number randomly from those 5 samples&lt;/li&gt;
     * &lt;/ol&gt;
     * 
     * If X/Y is 0/9, there should be 10 StatOfSelectedNumber records for each position(the 1st position is '0' to '9',
     * the 2nd position is '00' to '90', and so on). Then for a 3D selected number, for example '1,9,7', the 1st
     * position is 7, the 2nd position is 9 and the 3rd position is 1.
     * 
     * @param positionStats
     *            The list of all &lt;code&gt;StatOfSelectedNumber&lt;/code&gt;s of a given game instance.
     * @param position
     *            THe index at which position the number will be generated.
     * @return a number to given position.
     */
    private int determineNumber(List&lt;StatOfSelectedNumber&gt; positionStats, int position) throws ApplicationException {
<span class="pc bpc" id="L279" title="2 of 4 branches missed.">        if (positionStats == null || positionStats.size() == 0) {</span>
<span class="nc" id="L280">            throw new SystemException(&quot;No any StatOfSelectedNumber found of position:&quot; + position);</span>
        }
        // sort list in the order of StatOfSelectedNumber.count
<span class="fc" id="L283">        Collections.sort(positionStats, new Comparator&lt;StatOfSelectedNumber&gt;() {</span>

            @Override
            public int compare(StatOfSelectedNumber o1, StatOfSelectedNumber o2) {
<span class="fc" id="L287">                return o1.getCount() - o2.getCount();</span>
            }
        });
<span class="fc" id="L290">        int qpSampleRate = MLotteryContext.getInstance().getInt(&quot;digital.qp.rate&quot;, 90);</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        int countOfSample = (positionStats.size() * qpSampleRate / 100 == 0)</span>
                ? 1
                : (positionStats.size() * qpSampleRate / 100);
<span class="fc" id="L294">        List&lt;StatOfSelectedNumber&gt; sampleStats = new ArrayList&lt;StatOfSelectedNumber&gt;();</span>
<span class="fc bfc" id="L295" title="All 2 branches covered.">        for (int i = 0; i &lt; countOfSample; i++) {</span>
<span class="fc" id="L296">            sampleStats.add(positionStats.get(i));</span>
        }
<span class="fc" id="L298">        Collections.shuffle(sampleStats);</span>

<span class="fc" id="L300">        int number = Integer.parseInt(sampleStats.get(0).getSelecteNumber().substring(0, 1));</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L302">            logger.debug(qpSampleRate + &quot;% of total &quot; + positionStats.size() + &quot; of position[&quot; + position</span>
                    + &quot;] will be put in QP sample, &quot; + number + &quot; is picked.&quot;);
        }
<span class="fc" id="L305">        return number;</span>
    }

    private int determineCountOfQPNumber(BaseEntry entry) throws ApplicationException {
<span class="pc bpc" id="L309" title="3 of 4 branches missed.">        if (entry.getSelectNumber() != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(entry.getSelectNumber())) {</span>
            // no need to generate QP, as client has provided the numbers.
<span class="nc" id="L311">            return 0;</span>
        } else {
<span class="fc" id="L313">            return entry.getBetOption();</span>
        }
    }

    public DigitalStatOfSelectedNumberDao getStatOfSelectedNumberDao() {
<span class="fc" id="L318">        return statOfSelectedNumberDao;</span>
    }

    public void setStatOfSelectedNumberDao(DigitalStatOfSelectedNumberDao statOfSelectedNumberDao) {
<span class="fc" id="L322">        this.statOfSelectedNumberDao = statOfSelectedNumberDao;</span>
<span class="fc" id="L323">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>