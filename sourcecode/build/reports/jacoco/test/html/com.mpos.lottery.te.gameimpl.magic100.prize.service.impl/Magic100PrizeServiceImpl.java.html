<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Magic100PrizeServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.magic100.prize.service.impl</a> &gt; <span class="el_source">Magic100PrizeServiceImpl.java</span></div><h1>Magic100PrizeServiceImpl.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.magic100.prize.service.impl;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.lotto.prize.domain.WinningStatistics;
import com.mpos.lottery.te.gameimpl.magic100.sale.Magic100Entry;
import com.mpos.lottery.te.gameimpl.magic100.sale.service.LuckyNumberService;
import com.mpos.lottery.te.gamespec.game.BaseGameInstance;
import com.mpos.lottery.te.gamespec.game.BaseOperationParameter;
import com.mpos.lottery.te.gamespec.game.Game;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.gamespec.prize.BaseWinningItem;
import com.mpos.lottery.te.gamespec.prize.PrizeGroupItem;
import com.mpos.lottery.te.gamespec.prize.service.impl.AbstractPrizeService;
import com.mpos.lottery.te.gamespec.prize.web.PrizeAmount;
import com.mpos.lottery.te.gamespec.prize.web.PrizeDto;
import com.mpos.lottery.te.gamespec.prize.web.PrizeItemDto;
import com.mpos.lottery.te.gamespec.prize.web.PrizeLevelItemDto;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.merchant.web.PayoutLevelAllowRequest;
import com.mpos.lottery.te.port.Context;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.perf4j.StopWatch;
import org.perf4j.log4j.Log4JStopWatch;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

<span class="fc" id="L32">public class Magic100PrizeServiceImpl extends AbstractPrizeService {</span>
    private LuckyNumberService luckyNumberService;
<span class="fc" id="L34">    private Log logger = LogFactory.getLog(Magic100PrizeServiceImpl.class);</span>

    @Override
    public GameType supportedGameType() {
<span class="fc" id="L38">        return GameType.LUCKYNUMBER;</span>
    }

    private WinningStatistics lookupWinningStatistics(BaseGameInstance gameInstance, BaseWinningItem winningItem)
            throws ApplicationException {
        // should cache winning statistics
<span class="nc" id="L44">        WinningStatistics stat = this.getBaseWinningStatisticsDao().getByGameDrawAndPrizeLevelAndVersion(</span>
                WinningStatistics.class, gameInstance.getId(), winningItem.getPrizeLevel(), gameInstance.getVersion());
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (stat == null) {</span>
<span class="nc" id="L47">            throw new ApplicationException(SystemException.CODE_INTERNAL_SERVER_ERROR,</span>
                    &quot;can NOT LOTTO find winning statistics(gameDrawId=&quot; + gameInstance.getId() + &quot;,prizeLeve=&quot;
                            + winningItem.getPrizeLevel() + &quot;,version=&quot; + gameInstance.getVersion() + &quot;).&quot;);
        }
<span class="nc" id="L51">        return stat;</span>
    }

    @Override
    protected PrizeAmount lookupAnnouncedPrizeAmount(BaseWinningItem winningItem, BaseTicket ticket)
            throws ApplicationException {
<span class="nc" id="L57">        WinningStatistics stat = this.lookupWinningStatistics(ticket.getGameInstance(), winningItem);</span>
<span class="nc" id="L58">        return new PrizeAmount(stat.getPrizeAmount(), stat.getTaxAmount(), stat.getActualAmount());</span>
    }

    /**
     * Calculate prize information of a given ticket.
     */
    @Override
    protected PrizeDto assemblePrize(Context&lt;?&gt; respCtx, BaseTicket clientTicket,
            List&lt;? extends BaseTicket&gt; hostTickets, boolean isPrizeEnquiry) throws ApplicationException {
<span class="fc" id="L67">        BaseTicket soldTicket = hostTickets.get(0);</span>
        // initial PrizeDto
<span class="fc" id="L69">        PrizeDto prize = this.newPrize(clientTicket, hostTickets);</span>

        // ** Handle normal draw
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        if (clientTicket.isWinning()) {</span>
<span class="fc" id="L73">            StopWatch sw = new Log4JStopWatch();</span>
            // handle ticket one by one, that says one game instance by one game
            // instance
<span class="fc bfc" id="L76" title="All 2 branches covered.">            for (BaseTicket t : hostTickets) {</span>
<span class="fc" id="L77">                prize.getPaidTickets().add(t);</span>
                // assemble normal prize information
<span class="fc" id="L79">                List&lt;? extends BaseWinningItem&gt; winningItems = new ArrayList();</span>

<span class="fc" id="L81">                PrizeItemDto prizeItem = new PrizeItemDto();</span>
<span class="fc" id="L82">                prizeItem.setGameInstance(t.getGameInstance());</span>
<span class="fc" id="L83">                prizeItem.getGameInstance().setGameId(t.getGameInstance().getGame().getId());</span>
<span class="fc" id="L84">                prizeItem.setType(PrizeGroupItem.GROUP_TYPE_NORMAL_DRAW);</span>
<span class="fc" id="L85">                this.assembleNormalPrizeItem(prize, prizeItem, t, winningItems);</span>

                // if calculate tax per ticket, do it here
<span class="fc" id="L88">                this.calculateTaxBasedOnPerTicket(prize, t, prizeItem);</span>
<span class="fc" id="L89">            }</span>
<span class="fc" id="L90">            sw.stop(&quot;Assemble_Normal_Prize&quot;, &quot;Assemble normal draw prize of ticket(&quot; + clientTicket.getSerialNo() + &quot;)&quot;);</span>
        }
<span class="fc" id="L92">        prize.setPayoutMode(BaseOperationParameter.PAYOUTMODE_REFUND);</span>
        // prize.setPayoutMode(this.lookupOperationParameter(soldTicket.getGameInstance().getGame()).getPayoutMode());
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (BaseOperationParameter.PAYOUTMODE_REFUND == prize.getPayoutMode()) {</span>
<span class="fc" id="L95">            prize.setActualAmount(prize.getActualAmount().add(prize.getReturnAmount()));</span>
        }

<span class="fc" id="L98">        return prize;</span>
    }

    @Override
    protected void assembleNormalPrizeItem(PrizeDto prize, PrizeItemDto prizeItem, BaseTicket ticket,
            List&lt;? extends BaseWinningItem&gt; winningItems) throws ApplicationException {
<span class="fc" id="L104">        List&lt;Magic100Entry&gt; entrys = (List&lt;Magic100Entry&gt;) this.lookupTicketEntriess(ticket.getSerialNo());</span>
        // generate prize level items
<span class="fc bfc" id="L106" title="All 2 branches covered.">        for (Magic100Entry magic100Entry : entrys) {</span>
            // check if the winning item is valid
<span class="fc bfc" id="L108" title="All 2 branches covered.">            if (!magic100Entry.isWinning()) {</span>
<span class="fc" id="L109">                continue;</span>
            }
<span class="fc" id="L111">            BigDecimal totalTaxAmountOfLevel = this.getTaxService().tax(magic100Entry.getPrizeAmount(),</span>
                    ticket.getGameInstance().getGame().getId());
<span class="fc" id="L113">            prize.setPrizeAmount(prize.getPrizeAmount().add(magic100Entry.getPrizeAmount()));</span>
            //
<span class="fc bfc" id="L115" title="All 2 branches covered.">            if (Game.TAXMETHOD_PAYOUT == ticket.getGameInstance().getGame().getTaxMethod()) {</span>
<span class="fc" id="L116">                prize.setTaxAmount(prize.getTaxAmount().add(totalTaxAmountOfLevel));</span>
            }
<span class="fc" id="L118">            prize.setActualAmount(prize.getActualAmount().add(</span>
                    magic100Entry.getPrizeAmount().subtract(totalTaxAmountOfLevel)));

<span class="fc" id="L121">            prizeItem.setActualAmount(prize.getActualAmount());</span>
<span class="fc" id="L122">            prizeItem.setPrizeAmount(prize.getPrizeAmount());</span>
<span class="fc" id="L123">            prizeItem.setTaxAmount(prize.getTaxAmount());</span>
<span class="fc" id="L124">            prizeItem.setGameInstance(ticket.getGameInstance());</span>

            // Provide a default value, call public interface insert data support
<span class="fc" id="L127">            PrizeLevelItemDto prizeLevelItem = new PrizeLevelItemDto();</span>
<span class="fc" id="L128">            prizeItem.getPrizeLevelItems().add(prizeLevelItem);</span>
<span class="fc" id="L129">            prize.getPrizeItems().add(prizeItem);</span>

<span class="fc" id="L131">        }</span>
<span class="fc" id="L132">    }</span>

    @Override
    protected PayoutLevelAllowRequest[] assemblePayoutLevelAllowRequests(Context&lt;?&gt; respCtx, PrizeDto prize,
            BaseTicket ticket) {
<span class="fc" id="L137">        return null;</span>
    }

    /**
     * @return luckyNumberService
     */
    public LuckyNumberService getLuckyNumberService() {
<span class="nc" id="L144">        return luckyNumberService;</span>
    }

    /**
     * @param luckyNumberService
     */
    public void setLuckyNumberService(LuckyNumberService luckyNumberService) {
<span class="fc" id="L151">        this.luckyNumberService = luckyNumberService;</span>
<span class="fc" id="L152">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>