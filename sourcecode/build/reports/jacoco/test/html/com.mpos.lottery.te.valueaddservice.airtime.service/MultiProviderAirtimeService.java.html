<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MultiProviderAirtimeService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.valueaddservice.airtime.service</a> &gt; <span class="el_source">MultiProviderAirtimeService.java</span></div><h1>MultiProviderAirtimeService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.valueaddservice.airtime.service;

import com.mpos.lottery.te.common.dao.BaseJpaDao;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gamespec.game.Game;
import com.mpos.lottery.te.merchant.dao.MerchantCommissionDao;
import com.mpos.lottery.te.merchant.domain.MerchantCommission;
import com.mpos.lottery.te.merchant.service.balance.BalanceService;
import com.mpos.lottery.te.merchant.service.balance.SaleBalanceStrategy;
import com.mpos.lottery.te.merchant.service.commission.CommissionBalanceService;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.thirdpartyservice.amqp.AmqpMessageUtils;
import com.mpos.lottery.te.thirdpartyservice.amqp.MessagePack;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.valueaddservice.airtime.AirtimeParameter;
import com.mpos.lottery.te.valueaddservice.airtime.AirtimeTopup;
import com.mpos.lottery.te.valueaddservice.airtime.dao.AirtimeDao;
import com.mpos.lottery.te.valueaddservice.airtime.support.AirtimeProvider;
import com.mpos.lottery.te.valueaddservice.airtime.support.AirtimeProviderFactory;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.quartz.JobExecutionContext;
import org.quartz.Scheduler;
import org.quartz.SchedulerException;
import org.springframework.amqp.core.AmqpTemplate;
import org.springframework.util.Assert;

import java.math.BigDecimal;
import java.util.Date;

import javax.annotation.Resource;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;

/**
 * This implementation will support multiple airtime service providers. Client should call
 * {@link #topup(Context, AirtimeTopup)} to topup mobile balance, this implementation will route cient's request to
 * appropriate service provider (airtime telecomm).
 * 
 * @author Ramon
 */
<span class="fc" id="L44">public class MultiProviderAirtimeService implements AirtimeService {</span>
<span class="fc" id="L45">    private Log logger = LogFactory.getLog(MultiProviderAirtimeService.class);</span>
    @Resource(name = &quot;jpaAirtimeDao&quot;)
    private AirtimeDao airtimeDao;
    @Resource(name = &quot;baseJpaDao&quot;)
    private BaseJpaDao baseJpaDao;
    @Resource(name = &quot;defaultBalanceService&quot;)
    private BalanceService balanceService;
    @Resource(name = &quot;saleCommissionBalanceService&quot;)
    private CommissionBalanceService commissionService;
    @Resource(name = &quot;airtimeProviderFactory&quot;)
    private AirtimeProviderFactory airtimeProviderFactory;
    @Resource(name = &quot;amqpTemplate&quot;)
    private AmqpTemplate amqpTemplate;
    @Resource(name = &quot;merchantCommissionDao&quot;)
    private MerchantCommissionDao merchantCommissionDao;

    @Override
    public AirtimeTopup topup(Context respCtx, AirtimeTopup topupReq) throws ApplicationException {
<span class="fc" id="L63">        Assert.notNull(topupReq.getAmount(), &quot;The amount can't be null&quot;);</span>
<span class="fc" id="L64">        Assert.notNull(topupReq.getMobileNo(), &quot;The mobileNo can't be null&quot;);</span>
<span class="fc" id="L65">        Assert.notNull(topupReq.getGame().getId(), &quot;THe game.id can't be null&quot;);</span>

        // verify game status, accautlly a game represent a airtime service provider(telecom operator).
<span class="fc" id="L68">        Game game = this.getBaseJpaDao().findById(Game.class, topupReq.getGame().getId());</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (Game.STATUS_ACTIVE != game.getState()) {</span>
<span class="fc" id="L70">            throw new ApplicationException(SystemException.CODE_GAME_INACTIVE, &quot;Game(id=&quot; + game.getId()</span>
                    + &quot;) isn't active.&quot;);
        }
        // verify whether game have been allocated to merchant
<span class="fc" id="L74">        this.verifyGameAllocation(respCtx, game);</span>
        // verify amount
<span class="fc" id="L76">        this.verifyGameParameter(respCtx, topupReq, game);</span>
        // verify sale balance and lock it to avoid other transaction modify it
<span class="fc" id="L78">        this.verifyBalance(respCtx, topupReq);</span>

        // call remote service
<span class="fc" id="L81">        AirtimeParameter parameter = this.getBaseJpaDao().findById(AirtimeParameter.class,</span>
                game.getOperatorParameterId());
<span class="fc" id="L83">        AirtimeProvider provider = this.getAirtimeProviderFactory().lookupProvider(parameter.getAirtimeProviderId());</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (provider == null) {</span>
<span class="nc" id="L85">            throw new SystemException(&quot;No airtime p&quot; + &quot;rovider found by given providerId(&quot;</span>
                    + parameter.getAirtimeProviderId() + &quot;)&quot;);
        }
<span class="fc" id="L88">        AirtimeTopup result = provider.topup(respCtx, topupReq);</span>

<span class="fc bfc" id="L90" title="All 4 branches covered.">        if (AirtimeTopup.STATUS_SUCCESS == result.getStatus() || AirtimeTopup.STATUS_PENDING == result.getStatus()) {</span>
            // assemble transaction
<span class="fc" id="L92">            respCtx.getTransaction().setTotalAmount(topupReq.getAmount());</span>
<span class="fc" id="L93">            respCtx.getTransaction().setGameId(game.getId());</span>
<span class="fc" id="L94">            respCtx.getTransaction().setTicketSerialNo(respCtx.getTransaction().getId());</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">            if (AirtimeTopup.STATUS_SUCCESS == result.getStatus()) {</span>
                // maintain the balance/commission the same way with sale.
<span class="fc" id="L97">                respCtx.setProperty(SaleBalanceStrategy.PROP_SOLD_BY_CREDIT_CARD, false);</span>
                // update sale balance
<span class="fc" id="L99">                Object operatorMerchant = this.getBalanceService().balance(respCtx, BalanceService.BALANCE_TYPE_SALE,</span>
                        respCtx.getTransaction().getOperatorId(), false);
                // generate topup transaction records
<span class="fc" id="L102">                this.getCommissionService().calCommission(respCtx, operatorMerchant);</span>
            }
<span class="fc bfc" id="L104" title="All 2 branches covered.">            if (AirtimeTopup.STATUS_PENDING == result.getStatus()) {</span>
<span class="fc" id="L105">                respCtx.getTransaction().setResponseCode(SystemException.CODE_REMOTE_SERVICE_TIMEOUT);</span>
<span class="fc" id="L106">                respCtx.setResponseCode(SystemException.CODE_REMOTE_SERVICE_TIMEOUT);</span>
                // as it is pending, we shouldn't publish AMQP message now.
<span class="fc" id="L108">                respCtx.setProperty(Context.KEY_PUBLISH_AMQP_MESSAGE, false);</span>
            }

            // assemble airtim topup entity
<span class="fc" id="L112">            result.setId(respCtx.getTransaction().getId());</span>
<span class="fc" id="L113">            result.setGame(game);</span>
<span class="fc" id="L114">            result.setGpeSourceType(respCtx.getGpe().getTicketFrom());</span>
<span class="fc" id="L115">            result.setOperatorId(respCtx.getTransaction().getOperatorId());</span>
<span class="fc" id="L116">            result.setDevId(respCtx.getTransaction().getDeviceId());</span>
<span class="fc" id="L117">            result.setMerchantId(respCtx.getTransaction().getMerchantId());</span>
<span class="fc" id="L118">            result.setCreateTime(respCtx.getTransaction().getCreateTime());</span>
<span class="fc" id="L119">            result.setUpdateTime(respCtx.getTransaction().getCreateTime());</span>
<span class="fc" id="L120">            result.setTransaction(respCtx.getTransaction());</span>
<span class="fc" id="L121">            this.getBaseJpaDao().insert(result);</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        } else if (AirtimeTopup.STATUS_FAIL == result.getStatus()) {</span>
<span class="fc" id="L123">            throw new ApplicationException(SystemException.CODE_REMOTE_SERVICE_FAILUER,</span>
                    result.getRespMessageOfRemoteService());
        }

<span class="fc" id="L127">        return result;</span>
    }

    @Override
    public void jobTopup(JobExecutionContext jobContext, String transactionId, AirtimeTopup result)
            throws ApplicationException {
<span class="nc" id="L133">        AirtimeTopup pending = this.getBaseJpaDao().findById(AirtimeTopup.class, transactionId);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (AirtimeTopup.STATUS_PENDING != pending.getStatus()) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (logger.isInfoEnabled()) {</span>
<span class="nc" id="L136">                logger.info(&quot;THe transaction(id=&quot; + transactionId + &quot;) isn't pending, ignore and delete the job.&quot;);</span>
            }
<span class="nc" id="L138">            return;</span>
        }

<span class="nc" id="L141">        Context transContext = new Context();</span>
<span class="nc" id="L142">        Transaction teTrans = this.getBaseJpaDao().findById(Transaction.class, transactionId);</span>
<span class="nc" id="L143">        transContext.setTransaction(teTrans);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (AirtimeTopup.STATUS_SUCCESS == result.getStatus()) {</span>
            // maintain the balance/commission the same way with sale.
<span class="nc" id="L146">            transContext.setProperty(SaleBalanceStrategy.PROP_SOLD_BY_CREDIT_CARD, false);</span>
            // update sale balance
<span class="nc" id="L148">            Object operatorMerchant = this.getBalanceService().balance(transContext, BalanceService.BALANCE_TYPE_SALE,</span>
                    transContext.getTransaction().getOperatorId(), false);
            // generate topup transaction records
<span class="nc" id="L151">            this.getCommissionService().calCommission(transContext, operatorMerchant);</span>
<span class="nc" id="L152">            teTrans.setResponseCode(SystemException.CODE_OK);</span>

            // publish AMQP message.
<span class="nc" id="L155">            this.publishAmqp(transContext, teTrans);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        } else if (AirtimeTopup.STATUS_FAIL == result.getStatus()) {</span>
<span class="nc" id="L157">            teTrans.setResponseCode(SystemException.CODE_REMOTE_SERVICE_FAILUER);</span>
        }
<span class="nc" id="L159">        pending.setTelcCommTransId(result.getTelcCommTransId());</span>
<span class="nc" id="L160">        pending.setStatus(result.getStatus());</span>
<span class="nc" id="L161">        pending.setUpdateTime(new Date());</span>
<span class="nc" id="L162">        this.getBaseJpaDao().update(pending);</span>

<span class="nc" id="L164">        teTrans.setUpdateTime(pending.getUpdateTime());</span>
<span class="nc" id="L165">        this.getBaseJpaDao().insert(teTrans);</span>

        try {
<span class="nc" id="L168">            Scheduler scheduler = jobContext.getScheduler();</span>
<span class="nc" id="L169">            scheduler.deleteJob(jobContext.getJobDetail().getKey());</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (logger.isInfoEnabled()) {</span>
<span class="nc" id="L171">                logger.info(&quot;Delete job(&quot; + jobContext.getJobDetail().getKey() + &quot;) successfully.&quot;);</span>
            }
<span class="nc" id="L173">        } catch (SchedulerException e) {</span>
<span class="nc" id="L174">            throw new SystemException(e);</span>
<span class="nc" id="L175">        }</span>
<span class="nc" id="L176">    }</span>

    protected void publishAmqp(Context transContext, Transaction teTrans) {
<span class="nc" id="L179">        Game game = this.getBaseJpaDao().findById(Game.class, teTrans.getGameId());</span>
<span class="nc" id="L180">        MessagePack amqpMsg = new MessagePack(MessagePack.PREFIX + &quot;.&quot; + teTrans.getType(), MessagePack.PREFIX + &quot;.&quot;</span>
                + teTrans.getType() + &quot;.&quot; + game.getType(), AmqpMessageUtils.assembleTransactionMsg(transContext));
<span class="nc" id="L182">        amqpMsg.getMessageProperties().setHeader(MessagePack.HEADER_TRANSACTION, teTrans.getId());</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L184">            logger.debug(&quot;Prepare to publish message to exchange[&quot; + amqpMsg.getExchangeName() + &quot;] with routing key[&quot;</span>
                    + amqpMsg.getRoutingKey() + &quot;]: &quot; + amqpMsg.getProtobuffMessage());
        }

<span class="nc" id="L188">        this.getAmqpTemplate().send(amqpMsg.getExchangeName(), amqpMsg.getRoutingKey(), amqpMsg.getAmqpMessage());</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L190">            logger.debug(&quot;Publish message successfully&quot;);</span>
        }
<span class="nc" id="L192">    }</span>

    // -------------------------------------------------------
    // HELPER METHODS
    // -------------------------------------------------------

    private void verifyGameAllocation(Context respCtx, Game game) {
<span class="fc" id="L199">        MerchantCommission comm = this.getMerchantCommissionDao().getByMerchantAndGame(respCtx.getMerchant().getId(),</span>
                game.getId());
<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (comm == null) {</span>
<span class="fc" id="L202">            throw new SystemException(SystemException.CODE_OPERATOR_SELL_NOPRIVILEDGE, &quot;operator(id=&quot;</span>
                    + respCtx.getOperatorId() + &quot;) has no priviledge to sell ticket of game '&quot; + game.getId()
                    + &quot;', allocate the game to its merchant first.&quot;);
        }
<span class="fc" id="L206">    }</span>

    /**
     * Verify whether the sale balance of operator/merchant is enough for transaction, and lock it for later updating.
     */
    protected void verifyBalance(Context respCtx, AirtimeTopup topupReq) throws ApplicationException {
<span class="fc" id="L212">        this.getBalanceService().lockAndVerifySaleBalance(respCtx.getTransaction().getOperatorId(),</span>
                respCtx.getTransaction().getMerchantId(), topupReq.getAmount());
<span class="fc" id="L214">    }</span>

    protected void verifyGameParameter(Context respCtx, AirtimeTopup topupReq, Game game) throws ApplicationException {
<span class="fc" id="L217">        AirtimeParameter param = this.getBaseJpaDao().findById(AirtimeParameter.class, game.getOperatorParameterId());</span>
<span class="pc bpc" id="L218" title="1 of 4 branches missed.">        if (topupReq.getAmount().compareTo(param.getMinAmount()) &lt; 0</span>
                || topupReq.getAmount().compareTo(param.getMaxAmount()) &gt; 0) {
<span class="fc" id="L220">            throw new ApplicationException(SystemException.CODE_UNMATCHED_SALEAMOUNT, &quot;The amount must be in range(&quot;</span>
                    + param.getMinAmount() + &quot;,&quot; + param.getMaxAmount() + &quot;), however the amount is &quot;
                    + topupReq.getAmount());
        }
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (param.isAmountStepSupport()) {</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">            if (topupReq.getAmount().subtract(param.getMinAmount()).remainder(param.getStepAmount())</span>
                    .compareTo(new BigDecimal(&quot;0&quot;)) != 0) {
<span class="fc" id="L227">                throw new ApplicationException(SystemException.CODE_UNMATCHED_SALEAMOUNT, &quot;The amount(&quot;</span>
                        + topupReq.getAmount() + &quot;) must follow the rule of step-amount(&quot; + param.getStepAmount()
                        + &quot;).&quot;);
            }
        }
<span class="fc" id="L232">    }</span>

    // -------------------------------------------------------
    // SPRING DEPENDENDIES
    // -------------------------------------------------------

    public AirtimeDao getAirtimeDao() {
<span class="nc" id="L239">        return airtimeDao;</span>
    }

    public void setAirtimeDao(AirtimeDao airtimeDao) {
<span class="nc" id="L243">        this.airtimeDao = airtimeDao;</span>
<span class="nc" id="L244">    }</span>

    public BaseJpaDao getBaseJpaDao() {
<span class="fc" id="L247">        return baseJpaDao;</span>
    }

    public void setBaseJpaDao(BaseJpaDao baseJpaDao) {
<span class="nc" id="L251">        this.baseJpaDao = baseJpaDao;</span>
<span class="nc" id="L252">    }</span>

    public BalanceService getBalanceService() {
<span class="fc" id="L255">        return balanceService;</span>
    }

    public void setBalanceService(BalanceService balanceService) {
<span class="nc" id="L259">        this.balanceService = balanceService;</span>
<span class="nc" id="L260">    }</span>

    public CommissionBalanceService getCommissionService() {
<span class="fc" id="L263">        return commissionService;</span>
    }

    public void setCommissionService(CommissionBalanceService commissionService) {
<span class="nc" id="L267">        this.commissionService = commissionService;</span>
<span class="nc" id="L268">    }</span>

    public AirtimeProviderFactory getAirtimeProviderFactory() {
<span class="fc" id="L271">        return airtimeProviderFactory;</span>
    }

    public void setAirtimeProviderFactory(AirtimeProviderFactory airtimeProviderFactory) {
<span class="nc" id="L275">        this.airtimeProviderFactory = airtimeProviderFactory;</span>
<span class="nc" id="L276">    }</span>

    public AmqpTemplate getAmqpTemplate() {
<span class="nc" id="L279">        return amqpTemplate;</span>
    }

    public void setAmqpTemplate(AmqpTemplate amqpTemplate) {
<span class="nc" id="L283">        this.amqpTemplate = amqpTemplate;</span>
<span class="nc" id="L284">    }</span>

    public MerchantCommissionDao getMerchantCommissionDao() {
<span class="fc" id="L287">        return merchantCommissionDao;</span>
    }

    public void setMerchantCommissionDao(MerchantCommissionDao merchantCommissionDao) {
<span class="nc" id="L291">        this.merchantCommissionDao = merchantCommissionDao;</span>
<span class="nc" id="L292">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>