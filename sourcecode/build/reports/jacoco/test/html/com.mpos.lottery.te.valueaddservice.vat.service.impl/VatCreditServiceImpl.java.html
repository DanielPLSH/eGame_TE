<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>VatCreditServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.valueaddservice.vat.service.impl</a> &gt; <span class="el_source">VatCreditServiceImpl.java</span></div><h1>VatCreditServiceImpl.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.valueaddservice.vat.service.impl;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.merchant.dao.OperatorDao;
import com.mpos.lottery.te.merchant.domain.Operator;
import com.mpos.lottery.te.merchant.service.MerchantService;
import com.mpos.lottery.te.merchant.web.VatTransferDto;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.sequence.service.UUIDService;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.trans.domain.logic.AbstractReversalOrCancelStrategy;
import com.mpos.lottery.te.valueaddservice.vat.VatOperatorBalance;
import com.mpos.lottery.te.valueaddservice.vat.dao.VatOperatorBalanceDao;
import com.mpos.lottery.te.valueaddservice.vat.service.VatCreditService;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.math.BigDecimal;

import javax.persistence.EntityManager;
import javax.persistence.LockModeType;
import javax.persistence.PersistenceContext;

<span class="fc" id="L26">public class VatCreditServiceImpl extends AbstractReversalOrCancelStrategy implements VatCreditService {</span>
<span class="fc" id="L27">    private Log logger = LogFactory.getLog(VatCreditServiceImpl.class);</span>

    private OperatorDao operatorDao;
    private VatOperatorBalanceDao vatOperatorBalanceDao;
    @PersistenceContext(unitName = &quot;lottery_te&quot;)
    private EntityManager entityManager;
    private MerchantService merchantService;
    private UUIDService uuidManager;

    @Override
    public VatTransferDto vatTransferCredit(Context respCtx, VatTransferDto dto) throws ApplicationException {
        // lookup from operator
<span class="nc" id="L39">        Operator fromOperator = this.getOperatorDao().findByLoginNameForUpdate(dto.getFromOperatorLoginName());</span>
<span class="nc bnc" id="L40" title="All 2 branches missed.">        if (fromOperator == null) {</span>
<span class="nc" id="L41">            throw new ApplicationException(SystemException.CODE_NO_OPERATOR, &quot;No operator found by login name(&quot;</span>
                    + dto.getFromOperatorLoginName() + &quot;).&quot;);
        }
        // Merchant fromMerchant = this.getMerchantService().getMerchantByOperator(fromOperator.getId(),
        // true);
<span class="nc" id="L46">        VatOperatorBalance fromVatOperatorBalance = this.getVatOperatorBalanceDao().findByOperatorIdForUpdate(</span>
                fromOperator.getId());
<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (fromVatOperatorBalance == null) {</span>
<span class="nc" id="L49">            throw new ApplicationException(SystemException.CODE_NO_OPERATOR,</span>
                    &quot;No vat_operator_balance found by login name(&quot; + dto.getFromOperatorLoginName() + &quot;).&quot;);
        }

        // lookup to operator
<span class="nc" id="L54">        Operator toOperator = this.getOperatorDao().findByLoginNameForUpdate(dto.getToOperatorLoginName());</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (toOperator == null) {</span>
<span class="nc" id="L56">            throw new ApplicationException(SystemException.CODE_NO_OPERATOR, &quot;No operator found by login name(&quot;</span>
                    + dto.getToOperatorLoginName() + &quot;).&quot;);
        }
        // Merchant toMerchant = this.getMerchantService().getMerchantByOperator(toOperator.getId(),
        // true);
<span class="nc" id="L61">        VatOperatorBalance toVatOperatorBalance = this.getVatOperatorBalanceDao().findByOperatorIdForUpdate(</span>
                toOperator.getId());
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (toVatOperatorBalance == null) {</span>
<span class="nc" id="L64">            throw new ApplicationException(SystemException.CODE_NO_OPERATOR,</span>
                    &quot;No vat_operator_balance found by login name(&quot; + dto.getToOperatorLoginName() + &quot;).&quot;);
        }

<span class="nc" id="L68">        Object fromTarget = null;</span>
<span class="nc" id="L69">        Object toTarget = null;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (VatTransferDto.CREDITTYPE_SALE == dto.getCreditType()) {</span>
            // deduct from from-operator
<span class="nc" id="L72">            fromTarget = this.doCredit(fromVatOperatorBalance, dto.getAmount(), null, false, true);</span>
            // topup
<span class="nc" id="L74">            toTarget = this.doCredit(toVatOperatorBalance, dto.getAmount(), null, true, true);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        } else if (VatTransferDto.CREDITTYPE_PAYOUT == dto.getCreditType()) {</span>
            // deduct from from-operator
<span class="nc" id="L77">            fromTarget = this.doCredit(fromVatOperatorBalance, dto.getAmount(), null, false, false);</span>
            // topup
<span class="nc" id="L79">            toTarget = this.doCredit(toVatOperatorBalance, dto.getAmount(), null, true, false);</span>
        } else {
<span class="nc" id="L81">            throw new SystemException(&quot;Unsupported credit type of [&quot; + VatTransferDto.class + &quot;]:&quot;</span>
                    + dto.getCreditType());
        }

        // initialize a transfer log

        // assemble response DTO
<span class="nc" id="L88">        this.assembleCreditBalance(dto, fromTarget, toTarget);</span>

<span class="nc" id="L90">        return dto;</span>
    }

    @Override
    public boolean cancelOrReverse(Context&lt;?&gt; respCtx, Transaction targetTrans) throws ApplicationException {
<span class="nc" id="L95">        return false;</span>
    }

    // ----------------------------------------------------
    // HELPER METHODS
    // ----------------------------------------------------

    protected Object doCredit(VatOperatorBalance vatOperatorBalance, BigDecimal amount, String gameId,
            boolean isRestore, boolean isSaleStyle) throws ApplicationException {
        // if (Merchant.CREDIT_TYPE_DEFINITIVEVALUE == operator.getCreditType()) {
        /**
         * If try to refresh a entity before flush state changes into underlying database, the changes of entity will be
         * lost.
         */
<span class="nc" id="L109">        this.getEntityManager().flush();</span>
        /**
         * Refresh entity to latest state of underlying database and lock it.
         */
<span class="nc" id="L113">        this.getEntityManager().refresh(vatOperatorBalance, LockModeType.PESSIMISTIC_READ);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L115">            logger.debug(&quot;The current vatOperatorBalance credit level(before transaction) of &quot; + vatOperatorBalance</span>
                    + &quot; is &quot; + &quot;saleCreditLevel:&quot; + vatOperatorBalance.getSaleBalance() + &quot;,payoutCreditLevel:&quot;
                    + vatOperatorBalance.getPayoutBalance());
        }
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (isSaleStyle) {</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (!isRestore) { // sale</span>
<span class="nc" id="L121">                BigDecimal tmpCreditLevel = vatOperatorBalance.getSaleBalance().subtract(amount);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (tmpCreditLevel.compareTo(new BigDecimal(&quot;0&quot;)) &lt; 0) {</span>
<span class="nc" id="L123">                    throw new ApplicationException(SystemException.CODE_EXCEED_CREDITLIMIT,</span>
                            &quot;The balance of sale credit level(&quot; + vatOperatorBalance.getSaleBalance() + &quot;) of &quot;
                                    + vatOperatorBalance + &quot; isn't enough for sale(amount=&quot; + amount + &quot;).&quot;);
                }
<span class="nc" id="L127">                vatOperatorBalance.setSaleBalance(tmpCreditLevel);</span>
<span class="nc" id="L128">            } else { // sale cancellation</span>
<span class="nc" id="L129">                vatOperatorBalance.setSaleBalance(vatOperatorBalance.getSaleBalance().add(amount));</span>
            }
<span class="nc bnc" id="L131" title="All 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L132">                logger.debug(&quot;The new sale credit level of &quot; + vatOperatorBalance + &quot; is &quot;</span>
                        + vatOperatorBalance.getSaleBalance());
            }
        } else {
<span class="nc bnc" id="L136" title="All 2 branches missed.">            if (isRestore) { // payout</span>
<span class="nc" id="L137">                vatOperatorBalance.setPayoutBalance(vatOperatorBalance.getPayoutBalance().add(amount));</span>
            } else { // payout cancellation.
<span class="nc" id="L139">                BigDecimal tmpCreditLevel = vatOperatorBalance.getPayoutBalance().subtract(amount);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (tmpCreditLevel.compareTo(new BigDecimal(&quot;0&quot;)) &lt; 0) {</span>
<span class="nc" id="L141">                    throw new ApplicationException(SystemException.CODE_EXCEED_CREDITLIMIT,</span>
                            &quot;The balance of payout credit level(&quot; + vatOperatorBalance.getPayoutBalance() + &quot;) of &quot;
                                    + vatOperatorBalance + &quot; isn't enough for payout(amount=&quot; + amount + &quot;).&quot;);
                }
<span class="nc" id="L145">                vatOperatorBalance.setPayoutBalance(tmpCreditLevel);</span>
            }
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L148">                logger.debug(&quot;The new payout credit level of &quot; + vatOperatorBalance + &quot; is &quot;</span>
                        + vatOperatorBalance.getPayoutBalance());
            }
        }
<span class="nc" id="L152">        this.getVatOperatorBalanceDao().update(vatOperatorBalance);</span>
<span class="nc" id="L153">        return vatOperatorBalance;</span>
        // else if (Merchant.CREDIT_TYPE_USE_PARENT == operator.getCreditType()) {
        // if (logger.isDebugEnabled())
        // logger.debug(&quot;Ignore credit level calculation, as the credit type of &quot; + operator
        // + &quot; is USE PARENT... check its parent merchant&quot;);
        // return this.creditMerchant(merchant, amount, gameId, isRestore, isSaleStyle,
        // isSoldByCrecitCard);
        // }
        // else {
        // logger.info(&quot;Ignore calculation of credit level, as the credit type of &quot; + operator + &quot; is &quot;
        // + operator.getCreditType());
        // return null;
        // }
    }

    protected void assembleCreditBalance(VatTransferDto dto, Object fromTarget, Object toTarget) {
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (VatTransferDto.CREDITTYPE_SALE == dto.getCreditType()) {</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (fromTarget instanceof VatOperatorBalance) {</span>
<span class="nc" id="L171">                dto.setCreditBalanceOfFromOperator(((VatOperatorBalance) fromTarget).getSaleBalance());</span>
            }

<span class="nc bnc" id="L174" title="All 2 branches missed.">            if (toTarget instanceof VatOperatorBalance) {</span>
<span class="nc" id="L175">                dto.setCreditBalanceOfToOperator(((VatOperatorBalance) toTarget).getSaleBalance());</span>
            }
<span class="nc bnc" id="L177" title="All 2 branches missed.">        } else if (VatTransferDto.CREDITTYPE_PAYOUT == dto.getCreditType()) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (fromTarget instanceof VatOperatorBalance) {</span>
<span class="nc" id="L179">                dto.setCreditBalanceOfFromOperator(((VatOperatorBalance) fromTarget).getPayoutBalance());</span>
            }

<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (toTarget instanceof VatOperatorBalance) {</span>
<span class="nc" id="L183">                dto.setCreditBalanceOfToOperator(((VatOperatorBalance) toTarget).getPayoutBalance());</span>
            }
        }
<span class="nc" id="L186">    }</span>

    public OperatorDao getOperatorDao() {
<span class="nc" id="L189">        return operatorDao;</span>
    }

    public void setOperatorDao(OperatorDao operatorDao) {
<span class="fc" id="L193">        this.operatorDao = operatorDao;</span>
<span class="fc" id="L194">    }</span>

    public MerchantService getMerchantService() {
<span class="nc" id="L197">        return merchantService;</span>
    }

    public void setMerchantService(MerchantService merchantService) {
<span class="fc" id="L201">        this.merchantService = merchantService;</span>
<span class="fc" id="L202">    }</span>

    public EntityManager getEntityManager() {
<span class="nc" id="L205">        return entityManager;</span>
    }

    public void setEntityManager(EntityManager entityManager) {
<span class="nc" id="L209">        this.entityManager = entityManager;</span>
<span class="nc" id="L210">    }</span>

    public UUIDService getUuidManager() {
<span class="nc" id="L213">        return uuidManager;</span>
    }

    public void setUuidManager(UUIDService uuidManager) {
<span class="fc" id="L217">        this.uuidManager = uuidManager;</span>
<span class="fc" id="L218">    }</span>

    public VatOperatorBalanceDao getVatOperatorBalanceDao() {
<span class="nc" id="L221">        return vatOperatorBalanceDao;</span>
    }

    public void setVatOperatorBalanceDao(VatOperatorBalanceDao vatOperatorBalanceDao) {
<span class="fc" id="L225">        this.vatOperatorBalanceDao = vatOperatorBalanceDao;</span>
<span class="fc" id="L226">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>