<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DownloadOfflineTicketServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.valueaddservice.vat.service.impl</a> &gt; <span class="el_source">DownloadOfflineTicketServiceImpl.java</span></div><h1>DownloadOfflineTicketServiceImpl.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.valueaddservice.vat.service.impl;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;

import com.mpos.lottery.te.common.util.Barcoder;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.magic100.game.Magic100GameInstance;
import com.mpos.lottery.te.gameimpl.magic100.sale.LuckyNumber;
import com.mpos.lottery.te.gameimpl.magic100.sale.OffLuckyNumberSequence;
import com.mpos.lottery.te.gameimpl.magic100.sale.OfflineCancellation;
import com.mpos.lottery.te.gameimpl.magic100.sale.dao.LuckyNumberDao;
import com.mpos.lottery.te.gameimpl.magic100.sale.dao.OffLuckyNumberSequenceDao;
import com.mpos.lottery.te.gameimpl.magic100.sale.dao.OfflinecancellationDao;
import com.mpos.lottery.te.gamespec.game.Game;
import com.mpos.lottery.te.gamespec.game.dao.BaseGameInstanceDao;
import com.mpos.lottery.te.gamespec.game.dao.GameDao;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.merchant.dao.MerchantDao;
import com.mpos.lottery.te.merchant.domain.Merchant;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.port.domain.router.RoutineKey;
import com.mpos.lottery.te.sequence.domain.TicketSerialSpec;
import com.mpos.lottery.te.sequence.service.UUIDService;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.trans.domain.TransactionMessage;
import com.mpos.lottery.te.trans.domain.TransactionType;
import com.mpos.lottery.te.trans.domain.logic.AbstractReversalOrCancelStrategy;
import com.mpos.lottery.te.valueaddservice.vat.OperatorBizType;
import com.mpos.lottery.te.valueaddservice.vat.VAT;
import com.mpos.lottery.te.valueaddservice.vat.Vat2Game;
import com.mpos.lottery.te.valueaddservice.vat.Vat2Merchant;
import com.mpos.lottery.te.valueaddservice.vat.dao.OperatorBizTypeDao;
import com.mpos.lottery.te.valueaddservice.vat.dao.Vat2GameDao;
import com.mpos.lottery.te.valueaddservice.vat.dao.Vat2MerchantDao;
import com.mpos.lottery.te.valueaddservice.vat.dao.VatDao;
import com.mpos.lottery.te.valueaddservice.vat.service.DownloadOfflineTicketService;
import com.mpos.lottery.te.valueaddservice.vat.web.NumberDto;
import com.mpos.lottery.te.valueaddservice.vat.web.OfflineTicketDto;
import com.mpos.lottery.te.valueaddservice.vat.web.OfflineTicketPackDto;
import com.mpos.lottery.te.valueaddservice.vat.web.SelectedNumberPackDto;
import com.mpos.lottery.te.valueaddservice.vat.web.TicketPackDto;
import com.mpos.lottery.te.valueaddservice.vat.web.VatRefNoDto;
import com.mpos.lottery.te.valueaddservice.vat.web.VatRefNoPackDto;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import javax.annotation.Resource;
import javax.persistence.EntityManager;
import javax.persistence.LockModeType;
import javax.persistence.PersistenceContext;

/**
 * @author terry
 * @version [3.3.1, 2014-7-25]
 */
<span class="fc" id="L64">public class DownloadOfflineTicketServiceImpl extends AbstractReversalOrCancelStrategy</span>
        implements
            DownloadOfflineTicketService {
<span class="fc" id="L67">    private static Log logger = LogFactory.getLog(DownloadOfflineTicketServiceImpl.class);</span>
    @Resource(name = &quot;vatDao&quot;)
    private VatDao vatDao;

    @Resource(name = &quot;vat2MerchantDao&quot;)
    private Vat2MerchantDao vat2MerchantDao;

    @Resource(name = &quot;vat2GameDao&quot;)
    private Vat2GameDao vat2GameDao;

    @Resource(name = &quot;operatorBizTypeDao&quot;)
    private OperatorBizTypeDao operatorBizTypeDao;

    @Resource(name = &quot;offlinecancellationDao&quot;)
    private OfflinecancellationDao offlinecancellationDao;

    @Resource(name = &quot;offLuckyNumberSequenceDao&quot;)
    private OffLuckyNumberSequenceDao offLuckyNumberSequenceDao;

    @Resource(name = &quot;luckyNumberDao&quot;)
    private LuckyNumberDao luckyNumberDao;

    @Resource(name = &quot;baseGameInstanceDao&quot;)
    private BaseGameInstanceDao gameInstanceDao;

    @Resource(name = &quot;merchantDao&quot;)
    private MerchantDao merchantDao;

    @Resource(name = &quot;gameDao&quot;)
    private GameDao gameDao;

    private UUIDService uuidService;
    @PersistenceContext(unitName = &quot;lottery_te&quot;)
    private EntityManager entityManager;

    @Override
    public OfflineTicketPackDto downloadOfflineTicket(Context respCtx, OfflineTicketPackDto offlineTicketPackDto)
            throws ApplicationException {
<span class="fc" id="L105">        OfflineTicketPackDto respOfflineTicketPackDto = new OfflineTicketPackDto();</span>
<span class="fc" id="L106">        VAT vat = this.getVatDao().findByCode(offlineTicketPackDto.getVat().getCode());</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (vat == null) {</span>
<span class="nc" id="L108">            throw new ApplicationException(SystemException.CODE_VAT_NOFOUND, &quot;No valid VAT found by code(&quot;</span>
                    + offlineTicketPackDto.getVat().getCode() + &quot;)&quot;);
        }

<span class="fc" id="L112">        respOfflineTicketPackDto.setVat(vat);</span>

        // verify whether VAT has been allocated to merchant
<span class="fc" id="L115">        Vat2Merchant vat2Merchant = this.getVat2MerchantDao().findByVatAndMerchant(vat.getId(),</span>
                respCtx.getTransaction().getMerchantId());
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (vat2Merchant == null) {</span>
<span class="nc" id="L118">            throw new ApplicationException(SystemException.CODE_VAT_NOT_ALLOCATED_TO_MERCHANT, &quot;VAT(id=&quot; + vat.getId()</span>
                    + &quot;) hasn't been allocated to merchant(id=&quot; + respCtx.getTransaction().getMerchantId() + &quot;) yet.&quot;);
        }

        // determine the business type of device first
<span class="fc" id="L123">        OperatorBizType deviceBizType = this.getOperatorBizTypeDao().findByOperator(</span>
                respCtx.getTransaction().getOperatorId());
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (deviceBizType == null) {</span>
<span class="nc" id="L126">            throw new SystemException(&quot;No operator BizType definition found by operatorId=&quot;</span>
                    + respCtx.getTransaction().getOperatorId());
        }
        // lookup Game allocated to given VAT
<span class="fc" id="L130">        Vat2Game vat2Game = this.getVat2GameDao().findByVatAndBizType(vat.getId(), deviceBizType.getBusinessType());</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (vat2Game == null) {</span>
<span class="nc" id="L132">            throw new ApplicationException(SystemException.CODE_VAT_NOT_GAME_ALLOCATED,</span>
                    &quot;No Game has been allocated to Vat(id=&quot; + vat.getId() + &quot;) yet.&quot;);
        }
<span class="fc" id="L135">        Game game = gameDao.findByGamdId(vat2Game.getGameId());</span>
<span class="fc" id="L136">        Merchant distributeMerchant = merchantDao.findDistributeMerchantByMerchantId(respCtx.getTransaction()</span>
                .getMerchantId());

<span class="fc" id="L139">        logger.info(&quot;Game Type is [&quot; + game.getType() + &quot;]&quot;);</span>
        // set SelectedNumberPack
<span class="pc bpc" id="L141" title="3 of 6 branches missed.">        if (game.getType() == Game.TYPE_LUCKYNUMBER &amp;&amp; offlineTicketPackDto.getSelectedNumberPackDto() != null</span>
                &amp;&amp; offlineTicketPackDto.getSelectedNumberPackDto().getRequestCount() &gt; 0) {
<span class="fc" id="L143">            List&lt;Magic100GameInstance&gt; list = gameInstanceDao.lookupActiveByGame(respCtx.getTransaction()</span>
                    .getMerchantId(), Magic100GameInstance.class, vat2Game.getGameId());
<span class="pc bpc" id="L145" title="2 of 4 branches missed.">            if (null == list || list.size() == 0) {</span>
<span class="nc" id="L146">                throw new ApplicationException(SystemException.CODE_NOT_ACTIVE_DRAW, &quot;No active draw( merchantId=&quot;</span>
                        + respCtx.getTransaction().getMerchantId() + &quot;,gameId=&quot; + vat2Game.getGameId() + &quot;) yet.&quot;);

            }
<span class="fc" id="L150">            Magic100GameInstance magic100GameInstance = list.get(0);</span>
<span class="fc" id="L151">            int maxNumberSeq = luckyNumberDao.getMaxNumberSeq(magic100GameInstance.getId());</span>

<span class="pc bpc" id="L153" title="2 of 4 branches missed.">            if (offlineTicketPackDto.getSelectedNumberPackDto().getRequestCount() &gt; maxNumberSeq</span>
                    || offlineTicketPackDto.getSelectedNumberPackDto().getRequestCount() &gt; distributeMerchant
                            .getMaxOfflineTickets()) {
<span class="nc" id="L156">                throw new ApplicationException(SystemException.CODE_NO_LARGE_FOR_NUMBERS, &quot;Number[&quot;</span>
                        + offlineTicketPackDto.getSelectedNumberPackDto().getRequestCount()
                        + &quot;] requests can not be greater than MaxOfflineTickets[&quot;
                        + distributeMerchant.getMaxOfflineTickets() + &quot;] or maxNumberSeq[&quot; + maxNumberSeq + &quot;]&quot;);
            }
<span class="fc" id="L161">            SelectedNumberPackDto selectedNumberPackDto = this.getReservedNumbers(respCtx,</span>
                    magic100GameInstance.getId(), vat2Game.getGameId(), maxNumberSeq,
                    offlineTicketPackDto.getSelectedNumberPackDto());
<span class="fc" id="L164">            respOfflineTicketPackDto.setSelectedNumberPackDto(selectedNumberPackDto);</span>
        }

        // set VatRefNoPack 鎵归噺鐢熸垚serialNo锛宐arcode锛寁alidationCode
<span class="pc bpc" id="L168" title="2 of 4 branches missed.">        if (offlineTicketPackDto.getTicketPackDto() != null</span>
                &amp;&amp; offlineTicketPackDto.getTicketPackDto().getRequestCount() &gt; 0) {
<span class="fc" id="L170">            long requestCount = offlineTicketPackDto.getTicketPackDto().getRequestCount();</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">            if (requestCount &gt; distributeMerchant.getMaxOfflineTickets()) {</span>
<span class="nc" id="L172">                throw new ApplicationException(SystemException.CODE_NO_LARGE_FOR_NUMBERS, &quot;Ticket[&quot; + requestCount</span>
                        + &quot;] requests can not be greater than MaxOfflineTickets[&quot;
                        + distributeMerchant.getMaxOfflineTickets() + &quot;] &quot;);
            }

<span class="fc" id="L177">            TicketPackDto ticketPackDto = new TicketPackDto();</span>
<span class="fc" id="L178">            List&lt;OfflineTicketDto&gt; tickets = new ArrayList();</span>
<span class="fc" id="L179">            ticketPackDto.setRequestCount(requestCount);</span>
<span class="fc" id="L180">            ticketPackDto.setTickets(tickets);</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">            for (long i = 0; i &lt; requestCount; i++) {</span>
<span class="fc" id="L182">                OfflineTicketDto clientTicket = new OfflineTicketDto();</span>
<span class="fc" id="L183">                clientTicket.setRawSerialNo(this.getUuidService().getTicketSerialNo(TicketSerialSpec.OFFLINE_MODE,</span>
                        game.getType()));
<span class="fc" id="L185">                clientTicket.setBarcode(new Barcoder(game.getType(), clientTicket.getRawSerialNo()).getBarcode());</span>
<span class="fc" id="L186">                clientTicket.setValidationCode(BaseTicket.generateValidationCode());</span>

<span class="fc" id="L188">                tickets.add(clientTicket);</span>
            }

<span class="fc" id="L191">            respOfflineTicketPackDto.setTicketPackDto(ticketPackDto);</span>
        }

        // set TicketPack 鎵归噺鐢熸垚refNo
<span class="pc bpc" id="L195" title="2 of 4 branches missed.">        if (offlineTicketPackDto.getVatRefNoPackDto() != null</span>
                &amp;&amp; offlineTicketPackDto.getVatRefNoPackDto().getRequestCount() &gt; 0) {
<span class="fc" id="L197">            long requestCount = offlineTicketPackDto.getVatRefNoPackDto().getRequestCount();</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">            if (requestCount &gt; distributeMerchant.getMaxOfflineTickets()) {</span>
<span class="nc" id="L199">                throw new ApplicationException(SystemException.CODE_NO_LARGE_FOR_NUMBERS, &quot;RefNo[&quot; + requestCount</span>
                        + &quot;] requests can not be greater than MaxOfflineTickets[&quot;
                        + distributeMerchant.getMaxOfflineTickets() + &quot;] &quot;);
            }
<span class="fc" id="L203">            VatRefNoPackDto vatRefNoPackDto = new VatRefNoPackDto();</span>
<span class="fc" id="L204">            vatRefNoPackDto.setRequestCount(requestCount);</span>
<span class="fc" id="L205">            List&lt;VatRefNoDto&gt; vatRefNoDtos = new ArrayList();</span>
<span class="fc" id="L206">            vatRefNoPackDto.setVatRefNoDtos(vatRefNoDtos);</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">            for (long i = 0; i &lt; requestCount; i++) {</span>
<span class="fc" id="L208">                VatRefNoDto vatRefNoDto = new VatRefNoDto();</span>
<span class="fc" id="L209">                vatRefNoDto.setRefNo(this.getUuidService().getReferenceNo(TicketSerialSpec.OFFLINE_MODE));</span>

<span class="fc" id="L211">                vatRefNoDtos.add(vatRefNoDto);</span>
            }
<span class="fc" id="L213">            respOfflineTicketPackDto.setVatRefNoPackDto(vatRefNoPackDto);</span>
        }

<span class="fc" id="L216">        return respOfflineTicketPackDto;</span>
    }

    /**
     * @param respCtx
     *            The context represents the response.
     * @param dto
     *            Get the number of numbers reserved
     * @return SelectedNumberPackDto
     * @throws ApplicationException
     */
    @Override
    public SelectedNumberPackDto getReservedNumbers(Context respCtx, String magic100GameInstanceId, String gameId,
            long maxNumberSeq, SelectedNumberPackDto dto) throws ApplicationException {
        // 灏佽Offlinere quest Numbers
<span class="fc" id="L231">        List&lt;NumberDto&gt; numberDtos = doOfflineRequestNumbers(respCtx, gameId, dto.getRequestCount(), maxNumberSeq,</span>
                respCtx.getTransactionID());

        // 璁剧疆姣忎釜鍙风爜鐨勪腑濂栭噾棰�
<span class="fc" id="L235">        assemblePrizeNumber(numberDtos, magic100GameInstanceId);</span>

<span class="fc" id="L237">        SelectedNumberPackDto selectedNumberPackDto = new SelectedNumberPackDto();</span>
<span class="fc" id="L238">        selectedNumberPackDto.setRequestCount(dto.getRequestCount());</span>
<span class="fc" id="L239">        selectedNumberPackDto.setNumberDtos(numberDtos);</span>
<span class="fc" id="L240">        return selectedNumberPackDto;</span>
    }

    /*
     * 绗竴:鍏堝湪浠嶰fflineCancellation琛ㄤ笅杞藉彿鐮�绗簩锛氬鏋淥fflineCancellation琛ㄦ病鏈夋垨涓嶅鐢ㄦ埛璇锋眰鐨勫彿鐮佹暟锛屽氨浠庢寮弌ffline pirze琛ㄤ腑涓嬭浇
     */
    private List&lt;NumberDto&gt; doOfflineRequestNumbers(Context respCtx, String gameId, long requestNumbers,
            long maxNumberSeq, String teTransactionId) throws ApplicationException {
<span class="fc" id="L248">        List&lt;NumberDto&gt; list = new ArrayList();</span>
<span class="fc" id="L249">        List&lt;OfflineCancellation&gt; offlineRerverseMsgList = new ArrayList();</span>
<span class="fc" id="L250">        OffLuckyNumberSequence offLuckyNumberSequence = offLuckyNumberSequenceDao.findByGameId(gameId);</span>
<span class="fc" id="L251">        this.getEntityManager().refresh(offLuckyNumberSequence, LockModeType.PESSIMISTIC_READ);</span>

<span class="fc" id="L253">        List&lt;OfflineCancellation&gt; offlineCancellationList = offlinecancellationDao.findByGameId(gameId);</span>
<span class="fc" id="L254">        long remainingRequestNumbers = requestNumbers;</span>
        // 绗竴鍏堝湪浠嶰fflineCancellation琛ㄤ笅杞藉彿鐮�
<span class="pc bpc" id="L256" title="1 of 4 branches missed.">        if (offlineCancellationList != null &amp;&amp; offlineCancellationList.size() != 0) {</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">            for (OfflineCancellation offlineCancellation : offlineCancellationList) {</span>
<span class="fc" id="L258">                remainingRequestNumbers = requestNumbers - list.size();</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                if (remainingRequestNumbers &lt;= 0) {</span>
<span class="nc" id="L260">                    break;</span>
                }
<span class="fc" id="L262">                OfflineCancellation offlineRerverseMsg = calculateRemainingNumberPerOfflineCancellation(list,</span>
                        offlineCancellation, maxNumberSeq, remainingRequestNumbers);
<span class="fc" id="L264">                offlineRerverseMsg.setTeTransactionId(teTransactionId);</span>
<span class="fc" id="L265">                offlineRerverseMsg.setGameId(gameId);</span>
<span class="fc" id="L266">                offlineRerverseMsgList.add(offlineRerverseMsg);</span>
<span class="fc" id="L267">                remainingRequestNumbers = requestNumbers - list.size();</span>

<span class="fc" id="L269">            }</span>
        }

        // 绗簩锛氬鏋淥fflineCancellation琛ㄦ病鏈夋垨涓嶅鐢ㄦ埛璇锋眰鐨勫彿鐮佹暟锛屽氨浠庢寮弌ffline pirze琛ㄤ腑涓嬭浇

<span class="fc" id="L274">        long nextSeq = offLuckyNumberSequence.getNextSequence();</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (remainingRequestNumbers &gt; 0) {</span>
<span class="fc" id="L276">            long numbers = 0;</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">            if ((nextSeq + remainingRequestNumbers) &gt; maxNumberSeq) {</span>
<span class="fc" id="L278">                numbers = remainingRequestNumbers + nextSeq - maxNumberSeq - 1;</span>
<span class="fc" id="L279">                addNumberDto(list, nextSeq - 1, maxNumberSeq);</span>
<span class="fc" id="L280">                addNumberDto(list, 0, numbers);</span>
            } else {
<span class="fc" id="L282">                numbers = nextSeq + remainingRequestNumbers - 1;</span>
<span class="fc" id="L283">                addNumberDto(list, nextSeq - 1, numbers);</span>
            }
<span class="fc" id="L285">            offLuckyNumberSequence.setNextSequence(numbers + 1);</span>
<span class="fc" id="L286">            offLuckyNumberSequenceDao.update(offLuckyNumberSequence);</span>

<span class="fc" id="L288">            OfflineCancellation offlineRerverseMsg = new OfflineCancellation();</span>
<span class="fc" id="L289">            offlineRerverseMsg.setStartNumber(nextSeq);</span>
<span class="fc" id="L290">            offlineRerverseMsg.setEndNumber(numbers);</span>
<span class="fc" id="L291">            offlineRerverseMsg.setCurrentNumber(nextSeq - 1);</span>
<span class="fc" id="L292">            offlineRerverseMsg.setIsHandled(OfflineCancellation.STATE_PROCESSING);</span>
<span class="fc" id="L293">            offlineRerverseMsg.setTeTransactionId(teTransactionId);</span>
<span class="fc" id="L294">            offlineRerverseMsg.setGameId(gameId);</span>
<span class="fc" id="L295">            offlineRerverseMsgList.add(offlineRerverseMsg);</span>
        }
<span class="fc" id="L297">        offlinecancellationDao.update(offlineCancellationList);</span>

        // write transaction message for reversal.
<span class="fc" id="L300">        TransactionMessage transMsg = new TransactionMessage();</span>
<span class="fc" id="L301">        transMsg.setTransactionId(respCtx.getTransaction().getId());</span>
<span class="fc" id="L302">        transMsg.setRequestMsg(new Gson().toJson(offlineRerverseMsgList));</span>
<span class="fc" id="L303">        respCtx.getTransaction().setTransMessage(transMsg);</span>

<span class="fc" id="L305">        return list;</span>
    }

    /**
     * 浠嶰fflineCancellation琛ㄥ彇鍙风爜锛屽苟灏佽鎵�渶浠ュ悗reserve鏁版嵁, 濡傛灉鑾峰彇鍙风爜鍚庢洿鏂癱urrentNumber鍜宨sHandled currentNumber宸茬稉琚娇鐢�
     * 
     * @param list
     * @param offlineCancellation
     *            鎵�鍙朞fflineCancellation鏁版嵁
     * @param maxNumberSeq
     *            娓告垙鎵�兘鍙栫殑鏈�ぇ鍙风爜鏁�
     * @param requestNumbers
     *            瑕佸彇鐨勫彿鐮佹暟閲�
     * @return OfflineCancellation 浠ュ悗reserve鏁版嵁
     */
    OfflineCancellation calculateRemainingNumberPerOfflineCancellation(List&lt;NumberDto&gt; list,
            OfflineCancellation offlineCancellation, long maxNumberSeq, long requestNumbers) {
<span class="fc" id="L322">        long endNumber = offlineCancellation.getEndNumber();</span>
<span class="fc" id="L323">        long currentNumber = offlineCancellation.getCurrentNumber();</span>
<span class="fc" id="L324">        long startNumber = offlineCancellation.getStartNumber();</span>
        // Check this offlineCancellation how many numbers you can use
<span class="fc" id="L326">        long numbers = 0;</span>
<span class="fc" id="L327">        long remainingNumbers = 0;</span>
        // 杩欎釜鍊煎垽鏂彇鍊兼槸鍚﹁疆鍥炰簡
<span class="fc" id="L329">        long endTransmigrationNumber = 0;</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">        if (startNumber &lt; endNumber) {</span>
<span class="fc" id="L331">            remainingNumbers = endNumber - currentNumber;</span>
<span class="fc" id="L332">            numbers = requestNumbers + currentNumber;</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">            if (remainingNumbers &lt;= requestNumbers) {</span>
<span class="fc" id="L334">                numbers = endNumber;</span>
<span class="fc" id="L335">                offlineCancellation.setIsHandled(OfflineCancellation.STATE_DONE);</span>
            }
<span class="fc" id="L337">            offlineCancellation.setCurrentNumber(numbers);</span>

        }
<span class="fc bfc" id="L340" title="All 2 branches covered.">        if (startNumber &gt; endNumber) {</span>
            // 濡傛灉maxNumberSeq,start,end,current鏈変袱绉嶆儏鍐佃绠楀墿浣欏彿鐮侊紝
            // 绀轰緥锛歮axNumberSeq=50,start=40,end=10,current=5,閭ｄ箞鍓╀綑鍙风爜璁＄畻锛歳emainingNumbers=
            // endNumber-currentNumber=10-5=5;
            // :
            // maxNumberSeq=50,start=40,end=10,current=45,閭ｄ箞鍓╀綑鍙风爜璁＄畻锛歳emainingNumbers
            // = maxNumberSeq-currentNumber+endNumber=50-45+10=15;

<span class="fc bfc" id="L348" title="All 2 branches covered.">            remainingNumbers = (currentNumber &lt; startNumber) ? (endNumber - currentNumber) : (maxNumberSeq</span>
                    - currentNumber + endNumber);

            // 灏佽offlineCancellation
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">            if (remainingNumbers &lt;= requestNumbers) {</span>
<span class="fc" id="L353">                offlineCancellation.setIsHandled(OfflineCancellation.STATE_DONE);</span>
<span class="fc" id="L354">                offlineCancellation.setCurrentNumber(endNumber);</span>
            } else {
<span class="nc" id="L356">                offlineCancellation.setCurrentNumber(currentNumber + requestNumbers);</span>
                // 濡傛灉offlineCancellation.getCurrentNumber()&gt;maxNumberSeq,璇存槑宸茬粡瓒呰繃涓�釜杞洖浜嗭紝绀轰緥锛�
                // maxNumberSeq=50,start=40,end=10,current=45,requestNumbers=10
                // 宸茬粡瓒呰繃maxNumberSeq=50锛屽氨瑕侀噸鏂拌绠�currentNumber+requestNumbers-currentNumber
<span class="nc bnc" id="L360" title="All 2 branches missed.">                if (offlineCancellation.getCurrentNumber() &gt; maxNumberSeq) {</span>
<span class="nc" id="L361">                    offlineCancellation.setCurrentNumber(currentNumber + requestNumbers - maxNumberSeq);</span>
                }
            }

            // 瑷疆NumberDto,numbers灏辨槸瑕佹坊鍔犺櫉纰肩祩榛�
<span class="fc bfc" id="L366" title="All 2 branches covered.">            if (startNumber &lt;= currentNumber) {</span>
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">                if ((maxNumberSeq - currentNumber) &gt;= requestNumbers) {</span>
<span class="nc" id="L368">                    numbers = currentNumber + requestNumbers;</span>
                } else {
<span class="pc bpc" id="L370" title="1 of 2 branches missed.">                    numbers = (remainingNumbers &lt;= requestNumbers)</span>
                            ? endNumber
                            : (requestNumbers + currentNumber - maxNumberSeq);
<span class="fc" id="L373">                    addNumberDto(list, 0, numbers);</span>
<span class="fc" id="L374">                    endTransmigrationNumber = numbers;</span>

<span class="fc" id="L376">                    numbers = maxNumberSeq;</span>
                }
            } else {
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">                numbers = (endNumber - currentNumber) &lt;= remainingNumbers</span>
                        ? endNumber
                        : (currentNumber + requestNumbers);
            }
        }
<span class="fc" id="L384">        offlineCancellation.setUpdateTime(new Date());</span>
<span class="fc" id="L385">        addNumberDto(list, currentNumber, numbers);</span>

<span class="fc" id="L387">        OfflineCancellation offlineRerverseMsg = new OfflineCancellation();</span>
<span class="fc" id="L388">        offlineRerverseMsg.setStartNumber(currentNumber + 1);</span>
<span class="fc bfc" id="L389" title="All 2 branches covered.">        offlineRerverseMsg.setEndNumber(endTransmigrationNumber == 0 ? numbers : endTransmigrationNumber);</span>
<span class="fc" id="L390">        offlineRerverseMsg.setCurrentNumber(currentNumber);</span>
<span class="fc" id="L391">        offlineRerverseMsg.setIsHandled(OfflineCancellation.STATE_PROCESSING);</span>
<span class="fc" id="L392">        return offlineRerverseMsg;</span>

    }

    private void assemblePrizeNumber(List&lt;NumberDto&gt; list, String gameInstanceId) {
<span class="fc" id="L397">        List&lt;LuckyNumber&gt; luckyNumbers = luckyNumberDao.findByGameInstanceId(gameInstanceId);</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">        for (NumberDto numberDto : list) {</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">            for (LuckyNumber luckyNumber : luckyNumbers) {</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">                if (numberDto.getNumber() == luckyNumber.getSequenceOfNumber()) {</span>
<span class="fc" id="L401">                    numberDto.setPrizeAmount(luckyNumber.getPrizeAmount());</span>
<span class="fc" id="L402">                    numberDto.setLuckyNumber(luckyNumber.getLuckyNumber());</span>
<span class="fc" id="L403">                    break;</span>
                }
<span class="fc" id="L405">            }</span>
<span class="fc" id="L406">        }</span>
<span class="fc" id="L407">    }</span>

    private void addNumberDto(List&lt;NumberDto&gt; list, long currentNumber, long endNumber) {
<span class="fc" id="L410">        int count = list.size();</span>
<span class="fc bfc" id="L411" title="All 2 branches covered.">        for (long i = currentNumber + 1; i &lt;= endNumber; i++) {</span>
<span class="fc" id="L412">            NumberDto numberDto = new NumberDto();</span>
<span class="fc" id="L413">            numberDto.setNumber(i);</span>
<span class="fc" id="L414">            numberDto.setSequence(++count);</span>
<span class="fc" id="L415">            list.add(numberDto);</span>
        }
<span class="fc" id="L417">    }</span>

    @Override
    public boolean cancelOrReverse(Context&lt;?&gt; respCtx, Transaction targetTrans) throws ApplicationException {
<span class="nc" id="L421">        boolean isCancelDecline = false;</span>
<span class="nc" id="L422">        List&lt;OfflineCancellation&gt; list = offlinecancellationDao.findByTransactionId(targetTrans.getId());</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">        if (list != null &amp;&amp; list.size() &gt; 0) {</span>
<span class="nc" id="L424">            isCancelDecline = true;</span>
        }
<span class="nc" id="L426">        Type type = new TypeToken&lt;List&lt;OfflineCancellation&gt;&gt;() {</span>
        }.getType();

<span class="nc" id="L429">        List&lt;OfflineCancellation&gt; clientlist = new Gson().fromJson(targetTrans.getTransMessage().getRequestMsg(), type);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        for (OfflineCancellation offlineCancellation : clientlist) {</span>
<span class="nc" id="L431">            offlineCancellation.setId(this.getUuidService().getGeneralID());</span>
<span class="nc" id="L432">            offlineCancellation.setIsHandled(OfflineCancellation.STATE_PROCESSING);</span>
<span class="nc" id="L433">            offlineCancellation.setCreateTime(new Date());</span>
<span class="nc" id="L434">            offlineCancellation.setUpdateTime(new Date());</span>
<span class="nc" id="L435">        }</span>
<span class="nc" id="L436">        offlinecancellationDao.insert(clientlist);</span>
<span class="nc" id="L437">        return isCancelDecline;</span>
    }

    @Override
    public RoutineKey supportedReversalRoutineKey() {
<span class="fc" id="L442">        return new RoutineKey(TransactionType.RESERVED_NUMBERS.getRequestType());</span>
    }

    public VatDao getVatDao() {
<span class="fc" id="L446">        return vatDao;</span>
    }

    public void setVatDao(VatDao vatDao) {
<span class="nc" id="L450">        this.vatDao = vatDao;</span>
<span class="nc" id="L451">    }</span>

    public Vat2MerchantDao getVat2MerchantDao() {
<span class="fc" id="L454">        return vat2MerchantDao;</span>
    }

    public void setVat2MerchantDao(Vat2MerchantDao vat2MerchantDao) {
<span class="nc" id="L458">        this.vat2MerchantDao = vat2MerchantDao;</span>
<span class="nc" id="L459">    }</span>

    public Vat2GameDao getVat2GameDao() {
<span class="fc" id="L462">        return vat2GameDao;</span>
    }

    public void setVat2GameDao(Vat2GameDao vat2GameDao) {
<span class="nc" id="L466">        this.vat2GameDao = vat2GameDao;</span>
<span class="nc" id="L467">    }</span>

    public OperatorBizTypeDao getOperatorBizTypeDao() {
<span class="fc" id="L470">        return operatorBizTypeDao;</span>
    }

    public void setOperatorBizTypeDao(OperatorBizTypeDao operatorBizTypeDao) {
<span class="nc" id="L474">        this.operatorBizTypeDao = operatorBizTypeDao;</span>
<span class="nc" id="L475">    }</span>

    public OfflinecancellationDao getOfflinecancellationDao() {
<span class="nc" id="L478">        return offlinecancellationDao;</span>
    }

    public void setOfflinecancellationDao(OfflinecancellationDao offlinecancellationDao) {
<span class="nc" id="L482">        this.offlinecancellationDao = offlinecancellationDao;</span>
<span class="nc" id="L483">    }</span>

    public OffLuckyNumberSequenceDao getOffLuckyNumberSequenceDao() {
<span class="nc" id="L486">        return offLuckyNumberSequenceDao;</span>
    }

    public void setOffLuckyNumberSequenceDao(OffLuckyNumberSequenceDao offLuckyNumberSequenceDao) {
<span class="nc" id="L490">        this.offLuckyNumberSequenceDao = offLuckyNumberSequenceDao;</span>
<span class="nc" id="L491">    }</span>

    public LuckyNumberDao getLuckyNumberDao() {
<span class="nc" id="L494">        return luckyNumberDao;</span>
    }

    public void setLuckyNumberDao(LuckyNumberDao luckyNumberDao) {
<span class="nc" id="L498">        this.luckyNumberDao = luckyNumberDao;</span>
<span class="nc" id="L499">    }</span>

    public BaseGameInstanceDao getGameInstanceDao() {
<span class="nc" id="L502">        return gameInstanceDao;</span>
    }

    public void setGameInstanceDao(BaseGameInstanceDao gameInstanceDao) {
<span class="nc" id="L506">        this.gameInstanceDao = gameInstanceDao;</span>
<span class="nc" id="L507">    }</span>

    public UUIDService getUuidService() {
<span class="fc" id="L510">        return uuidService;</span>
    }

    public void setUuidService(UUIDService uuidService) {
<span class="fc" id="L514">        this.uuidService = uuidService;</span>
<span class="fc" id="L515">    }</span>

    public MerchantDao getMerchantDao() {
<span class="nc" id="L518">        return merchantDao;</span>
    }

    public void setMerchantDao(MerchantDao merchantDao) {
<span class="nc" id="L522">        this.merchantDao = merchantDao;</span>
<span class="nc" id="L523">    }</span>

    public EntityManager getEntityManager() {
<span class="fc" id="L526">        return entityManager;</span>
    }

    public void setEntityManager(EntityManager entityManager) {
<span class="nc" id="L530">        this.entityManager = entityManager;</span>
<span class="nc" id="L531">    }</span>

    public GameDao getGameDao() {
<span class="nc" id="L534">        return gameDao;</span>
    }

    public void setGameDao(GameDao gameDao) {
<span class="nc" id="L538">        this.gameDao = gameDao;</span>
<span class="nc" id="L539">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>