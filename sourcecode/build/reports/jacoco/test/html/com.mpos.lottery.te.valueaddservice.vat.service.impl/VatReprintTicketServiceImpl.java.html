<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>VatReprintTicketServiceImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.valueaddservice.vat.service.impl</a> &gt; <span class="el_source">VatReprintTicketServiceImpl.java</span></div><h1>VatReprintTicketServiceImpl.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.valueaddservice.vat.service.impl;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.magic100.sale.Magic100Entry;
import com.mpos.lottery.te.gameimpl.magic100.sale.Magic100Ticket;
import com.mpos.lottery.te.gameimpl.raffle.sale.RaffleTicket;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.gamespec.prize.NewPrintTicket;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.gamespec.sale.service.CompositeTicketService;
import com.mpos.lottery.te.merchant.dao.MerchantDao;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.sequence.service.UUIDService;
import com.mpos.lottery.te.valueaddservice.vat.VAT;
import com.mpos.lottery.te.valueaddservice.vat.VatSaleTransaction;
import com.mpos.lottery.te.valueaddservice.vat.dao.Vat2GameDao;
import com.mpos.lottery.te.valueaddservice.vat.dao.Vat2MerchantDao;
import com.mpos.lottery.te.valueaddservice.vat.dao.VatDao;
import com.mpos.lottery.te.valueaddservice.vat.dao.VatReprintTicketDao;
import com.mpos.lottery.te.valueaddservice.vat.dao.VatSaleTransactionDao;
import com.mpos.lottery.te.valueaddservice.vat.service.VatReprintTicketService;
import com.mpos.lottery.te.valueaddservice.vat.web.VatReprintTicketReqDto;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.util.ArrayList;
import java.util.List;

import javax.annotation.Resource;

<span class="fc" id="L33">public class VatReprintTicketServiceImpl implements VatReprintTicketService {</span>
<span class="fc" id="L34">    private static Log logger = LogFactory.getLog(VatReprintTicketServiceImpl.class);</span>

    @Resource(name = &quot;raffleTicketService&quot;)
    private CompositeTicketService raffleTicketService;
    @Resource(name = &quot;magic100SaleService&quot;)
    private CompositeTicketService magic100TicketService;
    @Resource(name = &quot;uuidManager&quot;)
    private UUIDService uUIDService;
    @Resource(name = &quot;vatReprintTicketDao&quot;)
    private VatReprintTicketDao vatReprintTicketDao;
    @Resource(name = &quot;vatDao&quot;)
    private VatDao vatDao;
    @Resource(name = &quot;vat2MerchantDao&quot;)
    private Vat2MerchantDao vat2MerchantDao;
    @Resource(name = &quot;vat2GameDao&quot;)
    private Vat2GameDao vat2GameDao;
    @Resource(name = &quot;merchantDao&quot;)
    private MerchantDao merchantDao;
    @Resource(name = &quot;vatSaleTransactionDao&quot;)
    private VatSaleTransactionDao vatSaleTransactionDao;

    @Override
    public VatSaleTransaction raffleReprintTicket(Context reqCtx, Context respCtx, VatReprintTicketReqDto dto)
            throws ApplicationException {
<span class="nc" id="L58">        String serialnonew = uUIDService.getTicketSerialNo(GameType.RAFFLE.getType());</span>
<span class="nc" id="L59">        String encryptSerialnoold = BaseTicket.encryptSerialNo(dto.getSerialNo());</span>
<span class="nc" id="L60">        String encryptSerialnonew = BaseTicket.encryptSerialNo(serialnonew);</span>

        // step 0 [lookup whether exist the printed ticket ,if had then response directly]
<span class="nc" id="L63">        NewPrintTicket printicket = vatReprintTicketDao.findNewPrintedTicketByOldSerialNo(encryptSerialnoold);</span>
<span class="nc" id="L64">        String currentEncryptSerialno = new String(encryptSerialnonew); // set the new serial no</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (printicket != null) {</span>
<span class="nc" id="L66">            currentEncryptSerialno = new String(printicket.getNewTicketSerialNo());</span>
        }

<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (printicket == null) {</span>
            // step 1 [find the ticket]
<span class="nc" id="L71">            List&lt;RaffleTicket&gt; raffleTicketlist = vatReprintTicketDao.findRaffleTicketBySerialNo(encryptSerialnoold);</span>
<span class="nc bnc" id="L72" title="All 4 branches missed.">            if (raffleTicketlist == null || raffleTicketlist.size() &lt;= 0) {</span>
<span class="nc" id="L73">                throw new ApplicationException(SystemException.CODE_NO_TICKET, &quot;can NOT find ticket with serialNO=&quot;</span>
                        + dto.getSerialNo());
            }
            // step 2 [insert new serial no ticket into ticket table]
<span class="nc" id="L77">            List&lt;String&gt; ticketidlist = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            for (int i = 0; i &lt; raffleTicketlist.size(); i++) {</span>
<span class="nc" id="L79">                ticketidlist.add(uUIDService.getGeneralID());</span>
            }
<span class="nc" id="L81">            vatReprintTicketDao.insertRaffleTicketByNewSerialNo(raffleTicketlist, serialnonew, encryptSerialnonew,</span>
                    ticketidlist);

            // step 3 [update the old ticket status to invalid]
<span class="nc" id="L85">            vatReprintTicketDao.updateRaffleOldStatusBySerialNo(encryptSerialnoold);</span>

            // step 4 [insert relationship into new_ticket table]
<span class="nc" id="L88">            vatReprintTicketDao</span>
                    .insertNewPrintTicket(encryptSerialnoold, encryptSerialnonew, uUIDService.getGeneralID());
        }
        // step 5 [inquiry the record for new ticket record]
        // BaseTicket returnTicket =
        // vatReprintTicketDao.findRaffleTicketBySerialNo(currentEncryptSerialno);
<span class="nc" id="L94">        RaffleTicket requestraffleticket = new RaffleTicket();</span>
<span class="nc" id="L95">        requestraffleticket.setSerialNo(currentEncryptSerialno);</span>
<span class="nc" id="L96">        RaffleTicket raffleTicket = (RaffleTicket) this.getRaffleTicketService().enquiry(respCtx, requestraffleticket,</span>
                true);
        // GameDraw related
        // VAT related
        // lookup VAT
<span class="nc" id="L101">        VatSaleTransaction vatsaletransaction = vatSaleTransactionDao.findBySerialnoAndOperatorid(encryptSerialnoold,</span>
                reqCtx.getOperatorId());
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (vatsaletransaction == null) {</span>
<span class="nc" id="L104">            throw new ApplicationException(SystemException.CODE_VAT_NOFOUND, &quot;No valid VAT found by serialno(&quot;</span>
                    + encryptSerialnoold + &quot;)&quot;);
        }

<span class="nc" id="L108">        VatSaleTransaction vat = new VatSaleTransaction();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (raffleTicket != null) {</span>
            //set game type
<span class="nc" id="L111">            raffleTicket.getGameInstance().setGameType(GameType.RAFFLE.getType());</span>
<span class="nc" id="L112">            vat.setTicket(raffleTicket);</span>
        }
<span class="nc" id="L114">        vat.setVatTotalAmount(vatsaletransaction.getVatTotalAmount());</span>
<span class="nc" id="L115">        vat.setVatRate(vatsaletransaction.getVatRateTotalAmount());</span>
        
<span class="nc bnc" id="L117" title="All 4 branches missed.">        if (vatsaletransaction.getVatRefNo() != null </span>
            &amp;&amp; !vatsaletransaction.getVatRefNo().equals(&quot;&quot;)) {
<span class="nc" id="L119">            vat.setVatRefNo(vatsaletransaction.getVatRefNo());</span>
        }
        
<span class="nc bnc" id="L122" title="All 4 branches missed.">        if (vatsaletransaction.getBuyerCompanyId() != null </span>
            &amp;&amp; !vatsaletransaction.getBuyerCompanyId().equals(&quot;&quot;)) {
<span class="nc" id="L124">            vat.setBuyerTaxNo(vatsaletransaction.getBuyerCompanyId());</span>
        }
         // lookup VAT code
<span class="nc" id="L127">        VAT vatobj = this.getVatDao().findById(VAT.class, vatsaletransaction.getVatId());</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (vatobj == null) {</span>
<span class="nc" id="L129">            throw new ApplicationException(SystemException.CODE_VAT_NOFOUND, &quot;No valid VAT found by id(&quot;</span>
                            + vatsaletransaction.getVatId() + &quot;)&quot;);
        }
<span class="nc" id="L132">        vat.setVatCode(vatobj.getCode());</span>

         //
        // raffleTicket.setVat(vat);
<span class="nc" id="L136">        return vat;</span>
    }

    @Override
    public VatSaleTransaction MagicReprintTicket(Context reqCtx, Context respCtx, VatReprintTicketReqDto dto)
            throws ApplicationException {
<span class="nc" id="L142">        String serialnonew = uUIDService.getTicketSerialNo(GameType.LUCKYNUMBER.getType());</span>
<span class="nc" id="L143">        String encryptSerialnoold = BaseTicket.encryptSerialNo(dto.getSerialNo());</span>
<span class="nc" id="L144">        String encryptSerialnonew = BaseTicket.encryptSerialNo(serialnonew);</span>

        // step 0 [lookup whether exist the printed ticket ,if had then response directly]
<span class="nc" id="L147">        NewPrintTicket printicket = vatReprintTicketDao.findNewPrintedTicketByOldSerialNo(encryptSerialnoold);</span>
<span class="nc" id="L148">        String currentEncryptSerialno = new String(encryptSerialnonew); // set the new serial no</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (printicket != null) {</span>
<span class="nc" id="L150">            currentEncryptSerialno = new String(printicket.getNewTicketSerialNo());</span>
        }

<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (printicket == null) {</span>
            // step 1 [find the ticket]
<span class="nc" id="L155">            List&lt;Magic100Ticket&gt; magicTicketlist = vatReprintTicketDao.findMagicTicketBySerialNo(encryptSerialnoold);</span>
<span class="nc bnc" id="L156" title="All 4 branches missed.">            if (magicTicketlist == null || magicTicketlist.size() &lt;= 0) {</span>
<span class="nc" id="L157">                throw new ApplicationException(SystemException.CODE_NO_TICKET, &quot;can NOT find ticket with serialNO=&quot;</span>
                        + dto.getSerialNo());
            }
            // step 2 [insert new serial no ticket into ticket table]
<span class="nc" id="L161">            List&lt;String&gt; ticketidlist = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            for (int i = 0; i &lt; magicTicketlist.size(); i++) {</span>
<span class="nc" id="L163">                ticketidlist.add(uUIDService.getGeneralID());</span>
            }
<span class="nc" id="L165">            vatReprintTicketDao.insertMagicTicketByNewSerialNo(magicTicketlist, serialnonew, encryptSerialnonew,</span>
                    ticketidlist);

            // step 3 [update the old ticket status to invalid]
<span class="nc" id="L169">            vatReprintTicketDao.updateMagicOldStatusBySerialNo(encryptSerialnoold);</span>

            // step 4 [find entries]
<span class="nc" id="L172">            List&lt;Magic100Entry&gt; magicEntrylist = vatReprintTicketDao.findMagicEntryBySerialNo(encryptSerialnoold);</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">            if (magicEntrylist == null || magicEntrylist.size() &lt;= 0) {</span>
<span class="nc" id="L174">                throw new ApplicationException(SystemException.CODE_NO_ENTRIES, &quot;can NOT find entries with serialNO=&quot;</span>
                        + dto.getSerialNo());
            }

            // step 5 [insert new entry]
<span class="nc" id="L179">            List&lt;String&gt; entryidlist = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">            for (int i = 0; i &lt; magicEntrylist.size(); i++) {</span>
<span class="nc" id="L181">                entryidlist.add(uUIDService.getGeneralID());</span>
            }
<span class="nc" id="L183">            vatReprintTicketDao.insertMagicEntryByNewSerialNo(magicEntrylist, serialnonew, encryptSerialnonew,</span>
                    entryidlist);

            // step 6 [insert relationship into new_ticket table]
<span class="nc" id="L187">            vatReprintTicketDao</span>
                    .insertNewPrintTicket(encryptSerialnoold, encryptSerialnonew, uUIDService.getGeneralID());
        }
        // step 5 [inquiry the record for new ticket record]
<span class="nc" id="L191">        Magic100Ticket requestmagicticket = new Magic100Ticket();</span>
<span class="nc" id="L192">        requestmagicticket.setSerialNo(currentEncryptSerialno);</span>
<span class="nc" id="L193">        Magic100Ticket magicTicket = (Magic100Ticket) this.getMagic100TicketService().enquiry(respCtx,</span>
                requestmagicticket, true);
        // GameDraw(Entry) related

        // VAT related
        // lookup VAT
<span class="nc" id="L199">        VatSaleTransaction vatsaletransaction = vatSaleTransactionDao.findBySerialnoAndOperatorid(encryptSerialnoold,</span>
                reqCtx.getOperatorId());
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (vatsaletransaction == null) {</span>
<span class="nc" id="L202">            throw new ApplicationException(SystemException.CODE_VAT_NOFOUND, &quot;No valid VAT found by serialno(&quot;</span>
                    + encryptSerialnoold + &quot;)&quot;);
        }

<span class="nc" id="L206">        VatSaleTransaction vat = new VatSaleTransaction();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (magicTicket != null) {</span>
            //set game type
<span class="nc" id="L209">            magicTicket.getGameInstance().setGameType(GameType.LUCKYNUMBER.getType());</span>
<span class="nc" id="L210">            vat.setTicket(magicTicket);</span>
        }
<span class="nc" id="L212">        vat.setVatTotalAmount(vatsaletransaction.getVatTotalAmount());</span>
<span class="nc" id="L213">        vat.setVatRate(vatsaletransaction.getVatRateTotalAmount());</span>
        
<span class="nc bnc" id="L215" title="All 4 branches missed.">        if (vatsaletransaction.getVatRefNo() != null</span>
            &amp;&amp; !vatsaletransaction.getVatRefNo().equals(&quot;&quot;)) {
<span class="nc" id="L217">            vat.setVatRefNo(vatsaletransaction.getVatRefNo());</span>
        }
         
<span class="nc bnc" id="L220" title="All 4 branches missed.">        if (vatsaletransaction.getBuyerCompanyId() != null </span>
            &amp;&amp; !vatsaletransaction.getBuyerCompanyId().equals(&quot;&quot;)) {
<span class="nc" id="L222">            vat.setBuyerTaxNo(vatsaletransaction.getBuyerCompanyId());</span>
        }
        // lookup VAT code
<span class="nc" id="L225">        VAT vatobj = this.getVatDao().findById(VAT.class, vatsaletransaction.getVatId());</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (vatobj == null) {</span>
<span class="nc" id="L227">            throw new ApplicationException(SystemException.CODE_VAT_NOFOUND, &quot;No valid VAT found by id(&quot;</span>
            + vatsaletransaction.getVatId() + &quot;)&quot;);
        }
<span class="nc" id="L230">        vat.setVatCode(vatobj.getCode());</span>
        //
        // magicTicket.setVat(vat);
<span class="nc" id="L233">        return vat;</span>
    }

    // --------------------------------------------------------------------
    // HELPER METHODS
    // --------------------------------------------------------------------

    public VatReprintTicketDao getVatReprintTicketDao() {
<span class="nc" id="L241">        return vatReprintTicketDao;</span>
    }

    public CompositeTicketService getRaffleTicketService() {
<span class="nc" id="L245">        return raffleTicketService;</span>
    }

    public void setRaffleTicketService(CompositeTicketService raffleTicketService) {
<span class="nc" id="L249">        this.raffleTicketService = raffleTicketService;</span>
<span class="nc" id="L250">    }</span>

    public CompositeTicketService getMagic100TicketService() {
<span class="nc" id="L253">        return magic100TicketService;</span>
    }

    public void setMagic100TicketService(CompositeTicketService magic100TicketService) {
<span class="nc" id="L257">        this.magic100TicketService = magic100TicketService;</span>
<span class="nc" id="L258">    }</span>

    public void setVatReprintTicketDao(VatReprintTicketDao vatReprintTicketDao) {
<span class="nc" id="L261">        this.vatReprintTicketDao = vatReprintTicketDao;</span>
<span class="nc" id="L262">    }</span>

    public UUIDService getUUIDService() {
<span class="nc" id="L265">        return uUIDService;</span>
    }

    public void setUUIDService(UUIDService service) {
<span class="nc" id="L269">        uUIDService = service;</span>
<span class="nc" id="L270">    }</span>

    public VatDao getVatDao() {
<span class="nc" id="L273">        return vatDao;</span>
    }

    public void setVatDao(VatDao vatDao) {
<span class="nc" id="L277">        this.vatDao = vatDao;</span>
<span class="nc" id="L278">    }</span>

    public Vat2MerchantDao getVat2MerchantDao() {
<span class="nc" id="L281">        return vat2MerchantDao;</span>
    }

    public void setVat2MerchantDao(Vat2MerchantDao vat2MerchantDao) {
<span class="nc" id="L285">        this.vat2MerchantDao = vat2MerchantDao;</span>
<span class="nc" id="L286">    }</span>

    public Vat2GameDao getVat2GameDao() {
<span class="nc" id="L289">        return vat2GameDao;</span>
    }

    public void setVat2GameDao(Vat2GameDao vat2GameDao) {
<span class="nc" id="L293">        this.vat2GameDao = vat2GameDao;</span>
<span class="nc" id="L294">    }</span>

    public MerchantDao getMerchantDao() {
<span class="nc" id="L297">        return merchantDao;</span>
    }

    public void setMerchantDao(MerchantDao merchantDao) {
<span class="nc" id="L301">        this.merchantDao = merchantDao;</span>
<span class="nc" id="L302">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>