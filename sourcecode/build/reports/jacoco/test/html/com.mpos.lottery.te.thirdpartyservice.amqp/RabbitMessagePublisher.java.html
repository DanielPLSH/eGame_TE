<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RabbitMessagePublisher.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.thirdpartyservice.amqp</a> &gt; <span class="el_source">RabbitMessagePublisher.java</span></div><h1>RabbitMessagePublisher.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.thirdpartyservice.amqp;

import com.mpos.lottery.te.config.exception.SystemException;
import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.MessageProperties;
import com.rabbitmq.client.ShutdownSignalException;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.commons.pool.ObjectPool;

import java.io.IOException;

public class RabbitMessagePublisher implements MessagePublisher {
<span class="nc" id="L16">    private Log logger = LogFactory.getLog(RabbitMessagePublisher.class);</span>
    private ObjectPool connectionPool;

<span class="nc" id="L19">    public RabbitMessagePublisher(ObjectPool connPool) {</span>
<span class="nc" id="L20">        this.connectionPool = connPool;</span>
<span class="nc" id="L21">    }</span>

    @Override
    public void publish(final byte[] message, final String exchangeName, final String routingKey) throws IOException {
<span class="nc" id="L25">        this.exchange(new MessageCallback() {</span>

            @Override
            public void doExchange(MessageContext context) throws ShutdownSignalException, IOException {
<span class="nc" id="L29">                Channel channel = context.getChannel();</span>
                // declare a 'topic' type of exchange
<span class="nc" id="L31">                channel.exchangeDeclare(exchangeName, &quot;topic&quot;);</span>
                // Content-type &quot;application/octet-stream&quot;, deliveryMode 2
                // (persistent), priority zero
<span class="nc" id="L34">                channel.basicPublish(exchangeName, routingKey, MessageProperties.PERSISTENT_BASIC, message);</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L36">                    logger.debug(&quot;Publish message[&quot; + message + &quot;] successfully.&quot;);</span>
                }
<span class="nc" id="L38">            }</span>
        });
<span class="nc" id="L40">    }</span>

    /**
     * This method will manage the connection pool, and re-connect is remote server is down. The real publishing or
     * consuming is delegated to &lt;code&gt;MessageCallback&lt;/code&gt;.
     * 
     * @param callback
     *            THe &lt;code&gt;MessageCallback&lt;/code&gt; which will publish or consume message.
     */
    protected void exchange(MessageCallback callback) throws IOException {
<span class="nc" id="L50">        boolean rebuildPool = false;</span>
        try {
<span class="nc" id="L52">            Connection conn = null;</span>
<span class="nc" id="L53">            Channel channel = null;</span>

<span class="nc" id="L55">            conn = (Connection) connectionPool.borrowObject();</span>
            try {
<span class="nc" id="L57">                channel = conn.createChannel();</span>
                // assemble message context
<span class="nc" id="L59">                MessageContext msgContext = new MessageContext();</span>
<span class="nc" id="L60">                msgContext.setChannel(channel);</span>
<span class="nc" id="L61">                callback.doExchange(msgContext);</span>
<span class="nc" id="L62">            } catch (Exception e) {</span>
                // can catch only IOException, for example, if AMQP server is
                // closed, a 'com.rabbitmq.client.AlreadyClosedException' will be
                // thrown out.
<span class="nc" id="L66">                logger.warn(e);</span>
                // if a IOException caught, it basically means the underlying
                // connection is closed, and should be rebuild the connection
                // pool
<span class="nc" id="L70">                rebuildPool = true;</span>

                // If one connection failed, it commonly means all connections
                // in the pool are failed(due to closure of AMQP server). In
                // this case, it is better to clear idle pool, and let
                // subsequent request new a connection
<span class="nc" id="L76">                this.connectionPool.clear();</span>

                // invalidate the connection instance...it will close the
                // connection
<span class="nc" id="L80">                this.connectionPool.invalidateObject(conn);</span>
            } finally {
<span class="nc bnc" id="L82" title="All 6 branches missed.">                if (channel != null) {</span>
<span class="nc" id="L83">                    channel.close();</span>
                }
<span class="nc bnc" id="L85" title="All 12 branches missed.">                if (conn != null &amp;&amp; !rebuildPool) {</span>
                    /**
                     * make sure return the object back to pool. However if &lt;code&gt;rebuildPool&lt;/code&gt; is true, in which
                     * case current connection is damaged, the connection should be invalidate(essentially closed).
                     */
<span class="nc" id="L90">                    this.connectionPool.returnObject(conn);</span>
                }
<span class="nc bnc" id="L92" title="All 6 branches missed.">                if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L93">                    logger.debug(&quot;Stat of connection pool: &quot; + this.connectionPool.getNumActive() + &quot; active, &quot;</span>
                            + this.connectionPool.getNumIdle() + &quot; idle&quot;);
                }
            }
<span class="nc" id="L97">        } catch (Exception e) {</span>
<span class="nc" id="L98">            throw new SystemException(e);</span>
<span class="nc" id="L99">        }</span>
<span class="nc" id="L100">    }</span>

    public ObjectPool getConnectionPool() {
<span class="nc" id="L103">        return connectionPool;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>