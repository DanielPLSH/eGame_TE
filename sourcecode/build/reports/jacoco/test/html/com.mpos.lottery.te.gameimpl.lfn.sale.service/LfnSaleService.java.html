<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LfnSaleService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gameimpl.lfn.sale.service</a> &gt; <span class="el_source">LfnSaleService.java</span></div><h1>LfnSaleService.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gameimpl.lfn.sale.service;

import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gameimpl.lfn.game.LfnFunType;
import com.mpos.lottery.te.gameimpl.lfn.sale.LfnEntry;
import com.mpos.lottery.te.gameimpl.lfn.sale.dao.LfnStatOfSelectedNumberDao;
import com.mpos.lottery.te.gamespec.game.BaseGameInstance;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.gamespec.sale.BaseEntry;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.gamespec.sale.StatOfSelectedNumber;
import com.mpos.lottery.te.gamespec.sale.service.AbstractTicketService;
import com.mpos.lottery.te.gamespec.sale.support.validator.SelectedNumber;
import com.mpos.lottery.te.port.Context;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.perf4j.StopWatch;
import org.perf4j.log4j.Log4JStopWatch;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;

<span class="fc" id="L26">public class LfnSaleService extends AbstractTicketService {</span>
<span class="fc" id="L27">    private Log logger = LogFactory.getLog(LfnSaleService.class);</span>
    private LfnStatOfSelectedNumberDao statOfSelectedNumberDao;

    @Override
    protected void customizeAssembleTicket(BaseTicket generatedTicket, BaseTicket clientTicket) {
<span class="fc" id="L32">        super.customizeAssembleTicket(generatedTicket, clientTicket);</span>
<span class="fc" id="L33">    }</span>

    @Override
    public GameType supportedGameType() {
<span class="fc" id="L37">        return GameType.LFN;</span>
    }

    @Override
    protected void generateQPWhenSale(Context&lt;?&gt; respCtx, BaseTicket clientTicket) throws ApplicationException {
<span class="fc bfc" id="L42" title="All 2 branches covered.">        for (BaseEntry entry : clientTicket.getEntries()) {</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">            if (entry.isQP()) {</span>
                // generate QP selected numbers.
<span class="fc" id="L45">                int countOfQPNumber = this.determineCountOfQPNumber((LfnEntry) entry);</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">                if (countOfQPNumber &gt; 0) {</span>
<span class="fc" id="L47">                    StopWatch sw = new Log4JStopWatch();</span>
<span class="fc" id="L48">                    entry.setSelectNumber(doGeneratingQP(respCtx, clientTicket.getGameInstance(), countOfQPNumber));</span>
<span class="fc" id="L49">                    sw.stop(&quot;Generate_QP&quot;, &quot;Generate QP number for ticket(&quot; + clientTicket.getSerialNo() + &quot;)&quot;);</span>
                }
            }
<span class="fc" id="L52">        }</span>
<span class="fc" id="L53">    }</span>

    @Override
    protected String doGeneratingQP(Context&lt;?&gt; respCtx, BaseGameInstance gameInstance, int countOfQPNumber)
            throws ApplicationException {
<span class="fc" id="L58">        LfnFunType funType = this.getBaseJpaDao().findById(LfnFunType.class, gameInstance.getGame().getFunTypeId());</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (countOfQPNumber &gt; funType.getN()) {</span>
<span class="nc" id="L60">            throw new ApplicationException(SystemException.CODE_WRONG_MESSAGEBODY, &quot;The required count of QP number(&quot;</span>
                    + countOfQPNumber + &quot;) has exceeded max allowed count:&quot; + funType.getN());
        }
        // pick range of latest sold numbers, and then pick some to
        // form a QP number
<span class="fc" id="L65">        int countOfSample = countOfQPNumber + (funType.getN() - countOfQPNumber) / 3;</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L67">            logger.debug(&quot;Ready to pick &quot; + countOfQPNumber + &quot; from total &quot; + countOfSample</span>
                    + &quot; same numbers to form QP&quot;);
        }
<span class="fc" id="L70">        List&lt;StatOfSelectedNumber&gt; stats = this.getStatOfSelectedNumberDao().findByGameInstance(gameInstance.getId(),</span>
                countOfSample);
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        if (stats.size() &lt; countOfQPNumber) {</span>
<span class="nc" id="L73">            throw new SystemException(&quot;No enough stat of selected number found:&quot; + stats.size() + &quot;, at least &quot;</span>
                    + countOfQPNumber);
        }
        // shuffle the sample, and pick from the head
<span class="fc" id="L77">        Collections.shuffle(stats);</span>
<span class="fc" id="L78">        int[] numbers = new int[countOfQPNumber];</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        for (int i = 0; i &lt; countOfQPNumber; i++) {</span>
<span class="fc" id="L80">            numbers[i] = Integer.parseInt(stats.get(i).getSelecteNumber().trim());</span>
        }
<span class="fc" id="L82">        Arrays.sort(numbers);</span>
<span class="fc" id="L83">        StringBuffer qp = new StringBuffer();</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        for (int i = 0; i &lt; countOfQPNumber; i++) {</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">            if (i != 0) {</span>
<span class="fc" id="L86">                qp.append(SelectedNumber.DELEMETER_NUMBER);</span>
            }
<span class="fc" id="L88">            qp.append(numbers[i]);</span>
        }
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L91">            logger.debug(&quot;Generate QP number:&quot; + qp.toString() + &quot; of game instance(id=&quot; + gameInstance.getId() + &quot;).&quot;);</span>
        }
<span class="fc" id="L93">        return qp.toString();</span>
    }

    protected int determineCountOfQPNumber(LfnEntry entry) throws ApplicationException {
<span class="pc bpc" id="L97" title="3 of 4 branches missed.">        if (entry.getSelectNumber() != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(entry.getSelectNumber())) {</span>
            // no need to generate QP, as client has provided the numbers.
<span class="nc" id="L99">            return 0;</span>
        } else {
<span class="fc bfc" id="L101" title="All 2 branches covered.">            if (!entry.isP()) {</span>
<span class="fc" id="L102">                return entry.getBetOption();</span>
            } else {
<span class="fc" id="L104">                int count = entry.getCountOfQPNumber();</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">                if (count &lt; entry.getBetOption() - LfnEntry.BETOPTION_INTERVAL) {</span>
<span class="nc" id="L106">                    throw new ApplicationException(SystemException.CODE_WRONG_MESSAGEBODY,</span>
                            &quot;The count of QP number must be greater than or equal with &quot;
                                    + (entry.getBetOption() - LfnEntry.BETOPTION_INTERVAL));
                }
<span class="fc" id="L110">                return count;</span>
            }
        }
    }

    public LfnStatOfSelectedNumberDao getStatOfSelectedNumberDao() {
<span class="fc" id="L116">        return statOfSelectedNumberDao;</span>
    }

    public void setStatOfSelectedNumberDao(LfnStatOfSelectedNumberDao statOfSelectedNumberDao) {
<span class="fc" id="L120">        this.statOfSelectedNumberDao = statOfSelectedNumberDao;</span>
<span class="fc" id="L121">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>