<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DefaultTicketValidator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.gamespec.sale.support.validator</a> &gt; <span class="el_source">DefaultTicketValidator.java</span></div><h1>DefaultTicketValidator.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.gamespec.sale.support.validator;

import com.mpos.lottery.te.common.dao.BaseJpaDao;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.gamespec.game.BaseFunType;
import com.mpos.lottery.te.gamespec.game.BaseOperationParameter;
import com.mpos.lottery.te.gamespec.game.Game;
import com.mpos.lottery.te.gamespec.game.GameType;
import com.mpos.lottery.te.gamespec.sale.BaseEntry;
import com.mpos.lottery.te.gamespec.sale.BaseTicket;
import com.mpos.lottery.te.merchant.domain.Merchant;
import com.mpos.lottery.te.port.Context;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.math.BigDecimal;

<span class="fc" id="L20">public class DefaultTicketValidator implements TicketValidator {</span>
<span class="fc" id="L21">    private Log logger = LogFactory.getLog(DefaultTicketValidator.class);</span>
    // Spring dependencies
<span class="fc" id="L23">    private SelectedNumberValidatorFactory selectedNumberValidatorFactory = new DefaultSelectedNumberValidatorFactory();</span>
    private BaseJpaDao baseJpaDao;

    @Override
    public final void validate(Context respCtx, BaseTicket clientTicket, Game game) throws ApplicationException {
<span class="fc" id="L28">        BaseFunType funType = this.lookupFunType(respCtx, game);</span>
<span class="fc" id="L29">        BaseOperationParameter operationParam = this.lookupOperationParameter(respCtx, game);</span>

<span class="fc" id="L31">        this.customizeValidateTicketBefore(respCtx, clientTicket, game, funType, operationParam);</span>
<span class="fc" id="L32">        this.validateMaxAllowedMultipleDraw(respCtx, clientTicket, game, funType, operationParam);</span>
        // validate entries one by one
<span class="fc bfc" id="L34" title="All 2 branches covered.">        for (BaseEntry entry : clientTicket.getEntries()) {</span>
<span class="fc" id="L35">            entry.setTicketSerialNo(clientTicket.getSerialNo());</span>
<span class="fc" id="L36">            AbstractSelectedNumberValidator selectedNumberValidator = this.selectedNumberValidatorFactory</span>
                    .newSelectedNumberValidator(game, entry.getBetOption());
            // configure validator
<span class="fc" id="L39">            selectedNumberValidator.setFunType(funType);</span>
<span class="fc" id="L40">            selectedNumberValidator.setOperationParam(operationParam);</span>
            // perform validation
<span class="fc" id="L42">            selectedNumberValidator.validate(respCtx, clientTicket, game, entry);</span>

            // calculate total bets first
<span class="fc" id="L45">            long totalBets = selectedNumberValidator.calTotalBets(entry);</span>
<span class="fc" id="L46">            entry.setTotalBets(totalBets);</span>
<span class="fc" id="L47">            this.calculateEntryAmount(respCtx, entry, selectedNumberValidator);</span>
<span class="fc" id="L48">            this.validateMaxAllowedEntryBets(respCtx, clientTicket, game, entry);</span>
<span class="fc" id="L49">            this.customizeValidateTicketEntry(respCtx, clientTicket, game, entry);</span>
<span class="fc" id="L50">        }</span>

<span class="fc" id="L52">        this.validateAmount(respCtx, clientTicket, game);</span>
<span class="fc" id="L53">        this.customizeValidateTicketAfter(respCtx, clientTicket, game, funType, operationParam);</span>
<span class="fc" id="L54">    }</span>

    protected void calculateEntryAmount(Context respCtx, BaseEntry entry,
            AbstractSelectedNumberValidator selectedNumberValidator) throws ApplicationException {
<span class="fc" id="L58">        BigDecimal entryAmount = selectedNumberValidator.calEntryAmount(entry);</span>
<span class="fc" id="L59">        entry.setEntryAmount(entryAmount);</span>
<span class="fc" id="L60">    }</span>

    protected void validateMaxAllowedMultipleDraw(Context respCtx, BaseTicket clientTicket, Game game,
            BaseFunType funType, BaseOperationParameter operationParam) throws ApplicationException {
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (operationParam == null) {</span>
<span class="nc" id="L65">            return;</span>
        }
        // check whether this sale exceeds the allowed multi-draw
<span class="fc" id="L68">        Merchant merchant = respCtx.getMerchant();</span>
        // use the smaller one
<span class="fc bfc" id="L70" title="All 2 branches covered.">        int maxAllowedMultiDraw = (merchant.getAllowedMultiDraw() &gt; operationParam.getMaxAllowedMultiDraw())</span>
                ? operationParam.getMaxAllowedMultiDraw()
                : merchant.getAllowedMultiDraw();
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L74">            logger.debug(&quot;THe max allowed multi-draw of operation parameter is &quot;</span>
                    + operationParam.getMaxAllowedMultiDraw() + &quot;, merchant limit to &quot; + merchant.getAllowedMultiDraw()
                    + &quot;, the smaller &quot; + maxAllowedMultiDraw + &quot; will be used.&quot;);
        }
<span class="pc bpc" id="L78" title="1 of 4 branches missed.">        if (clientTicket.getMultipleDraws() &lt; operationParam.getMinAllowedMultiDraw()</span>
                || clientTicket.getMultipleDraws() &gt; maxAllowedMultiDraw) {
<span class="fc" id="L80">            throw new ApplicationException(SystemException.CODE_EXCEED_ALLOWD_MULTI_DRAW, &quot;THe multiple draw[&quot;</span>
                    + clientTicket.getMultipleDraws() + &quot;] is not in range of allowed multiple-draws[&quot;
                    + operationParam.getMinAllowedMultiDraw() + &quot;,&quot; + maxAllowedMultiDraw + &quot;] of game(id=&quot;
                    + game.getId() + &quot;)&quot;);
        }
<span class="fc" id="L85">    }</span>

    protected void customizeValidateTicketEntry(Context respCtx, BaseTicket clientTicket, Game game, BaseEntry entry)
            throws ApplicationException {
        // template method
<span class="fc" id="L90">    }</span>

    /**
     * verify the allowed bets of a entry.
     */
    protected void validateMaxAllowedEntryBets(Context respCtx, BaseTicket clientTicket, Game game, BaseEntry entry)
            throws ApplicationException {
<span class="fc" id="L97">        Merchant merchant = respCtx.getMerchant();</span>
        // 0 means no limit
<span class="pc bpc" id="L99" title="1 of 4 branches missed.">        if (merchant.getMaxMultipleBets() &gt; 0 &amp;&amp; entry.getTotalBets() &gt; merchant.getMaxMultipleBets()) {</span>
<span class="fc" id="L100">            throw new ApplicationException(SystemException.CODE_EXCEED_MAX_MULTIPLE,</span>
                    &quot;The total bets of selectd number:&quot; + entry.getSelectNumber() + &quot; is &quot; + entry.getTotalBets()
                            + &quot;, it exceeds the max allowed bets: &quot; + merchant.getMaxMultipleBets()
                            + &quot; of merchant(id=&quot; + merchant.getId() + &quot;).&quot;);
        }
<span class="fc" id="L105">    }</span>

    /**
     * Validate whether ticket's amount is correct.
     */
    protected void validateAmount(Context respCtx, BaseTicket clientTicket, Game game) throws ApplicationException {
<span class="fc" id="L111">        BigDecimal expectedTotalAmount = this.doCalculateExpectTotalAmount(respCtx, clientTicket, game);</span>

<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (clientTicket.getTotalAmount().compareTo(expectedTotalAmount) != 0) {</span>
<span class="fc" id="L114">            throw new ApplicationException(SystemException.CODE_UNMATCHED_SALEAMOUNT, &quot;The total amount(&quot;</span>
                    + clientTicket.getTotalAmount() + &quot;) of client ticket is &quot;
                    + &quot;unmatched with the server side(totalAmount=&quot; + expectedTotalAmount + &quot;,totalBets=&quot;
                    + clientTicket.getTotalBets() + &quot;)&quot;);
        }
<span class="fc" id="L119">    }</span>

    protected BigDecimal doCalculateExpectTotalAmount(Context respCtx, BaseTicket clientTicket, Game game) {
<span class="fc" id="L122">        BigDecimal expectedTotalAmount = new BigDecimal(&quot;0&quot;);</span>
<span class="fc" id="L123">        int totalBets = 0;</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">        for (BaseEntry entry : clientTicket.getEntries()) {</span>
<span class="fc" id="L125">            expectedTotalAmount = expectedTotalAmount.add(entry.getEntryAmount());</span>
<span class="fc" id="L126">            totalBets += entry.getTotalBets();</span>
<span class="fc" id="L127">        }</span>
<span class="fc" id="L128">        expectedTotalAmount = expectedTotalAmount.multiply(new BigDecimal(clientTicket.getMultipleDraws()));</span>
<span class="fc" id="L129">        clientTicket.setTotalBets(totalBets);</span>

<span class="fc" id="L131">        return expectedTotalAmount;</span>
    }

    /**
     * Template method for subclass to apply more checking before any validations.
     */
    protected void customizeValidateTicketBefore(Context respCtx, BaseTicket clientTicket, Game game,
            BaseFunType funType, BaseOperationParameter opParam) throws ApplicationException {
        // Template method for subclass
<span class="fc" id="L140">    }</span>

    /**
     * Template method for subclass to apply more checking.
     */
    protected void customizeValidateTicketAfter(Context respCtx, BaseTicket clientTicket, Game game,
            BaseFunType funType, BaseOperationParameter opParam) throws ApplicationException {
<span class="fc" id="L147">    }</span>

    protected BaseFunType lookupFunType(Context respCtx, Game game) {
<span class="fc" id="L150">        return this.getBaseJpaDao()</span>
                .findById(GameType.fromType(game.getType()).getFunType(), game.getFunTypeId(), false);
    }

    protected BaseOperationParameter lookupOperationParameter(Context respCtx, Game game) {
<span class="fc" id="L155">        return this.getBaseJpaDao().findById(GameType.fromType(game.getType()).getOperationParametersType(),</span>
                game.getOperatorParameterId(), false);
    }

    // ------------------------------------------------------
    // SPRING DEPENDENCIES INJECTION
    // ------------------------------------------------------

    public SelectedNumberValidatorFactory getSelectedNumberValidatorFactory() {
<span class="nc" id="L164">        return selectedNumberValidatorFactory;</span>
    }

    public void setSelectedNumberValidatorFactory(SelectedNumberValidatorFactory selectedNumberValidatorFactory) {
<span class="fc" id="L168">        this.selectedNumberValidatorFactory = selectedNumberValidatorFactory;</span>
<span class="fc" id="L169">    }</span>

    public BaseJpaDao getBaseJpaDao() {
<span class="fc" id="L172">        return baseJpaDao;</span>
    }

    public void setBaseJpaDao(BaseJpaDao baseJpaDao) {
<span class="fc" id="L176">        this.baseJpaDao = baseJpaDao;</span>
<span class="fc" id="L177">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>