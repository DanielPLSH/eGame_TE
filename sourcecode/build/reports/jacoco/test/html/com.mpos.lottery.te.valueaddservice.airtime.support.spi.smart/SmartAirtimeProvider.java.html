<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SmartAirtimeProvider.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sourcecode</a> &gt; <a href="index.html" class="el_package">com.mpos.lottery.te.valueaddservice.airtime.support.spi.smart</a> &gt; <span class="el_source">SmartAirtimeProvider.java</span></div><h1>SmartAirtimeProvider.java</h1><pre class="source lang-java linenums">package com.mpos.lottery.te.valueaddservice.airtime.support.spi.smart;

import com.mpos.lottery.te.common.http.HttpMethod;
import com.mpos.lottery.te.common.util.SimpleToolkit;
import com.mpos.lottery.te.config.MLotteryContext;
import com.mpos.lottery.te.config.exception.ApplicationException;
import com.mpos.lottery.te.config.exception.SystemException;
import com.mpos.lottery.te.port.Context;
import com.mpos.lottery.te.trans.domain.Transaction;
import com.mpos.lottery.te.valueaddservice.airtime.AirtimeTopup;
import com.mpos.lottery.te.valueaddservice.airtime.support.AbstractAirtimeProvider;

import org.apache.commons.lang.builder.ToStringBuilder;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.HttpEntityEnclosingRequestBase;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.entity.ByteArrayEntity;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.params.CoreConnectionPNames;
import org.apache.http.util.EntityUtils;
import org.dom4j.Document;
import org.dom4j.Node;
import org.dom4j.XPath;
import org.dom4j.io.SAXReader;
import org.springframework.stereotype.Component;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.math.BigDecimal;
import java.net.URI;

@Component(&quot;smartAirtimeProvider&quot;)
public class SmartAirtimeProvider extends AbstractAirtimeProvider {
<span class="fc" id="L39">    private Log logger = LogFactory.getLog(SmartAirtimeProvider.class);</span>
    private static final int SMART_PROVIDER_ID = 2;
    // all other value of COOBILL_QUERY_STATUS is failure
    public static final int SMART_TOPOUP_STATUS_OK = 0;
    private DefaultHttpClient httpClient;

    /**
     * General constructor.
     */
<span class="fc" id="L48">    public SmartAirtimeProvider() {</span>
<span class="fc" id="L49">        httpClient = new DefaultHttpClient();</span>
        // configure default connection parameters
        // timeout of waiting for data
<span class="fc" id="L52">        this.httpClient.getParams().setIntParameter(CoreConnectionPNames.SO_TIMEOUT,</span>
                MLotteryContext.getInstance().getInt(&quot;remoteservice.read.timeout&quot;, 30) * 1000);
        // timeout of establishing connection
<span class="fc" id="L55">        this.httpClient.getParams().setIntParameter(CoreConnectionPNames.CONNECTION_TIMEOUT,</span>
                MLotteryContext.getInstance().getInt(&quot;remoteservice.connection.timeout&quot;, 30) * 1000);
<span class="fc" id="L57">    }</span>

    @Override
    public int supportProvider() {
<span class="fc" id="L61">        return SMART_PROVIDER_ID;</span>
    }

    /**
     * Call topup service of Smart. As Smart doesn't provide any service for transaction enquiry or cancellation, TE
     * doesn't provide those services too.
     */
    @Override
    public AirtimeTopup topup(final Context respCtx, final AirtimeTopup topupReq) throws ApplicationException {
<span class="fc" id="L70">        topupReq.setSerialNo(this.generateRefNo());</span>
        // each provider may request a different refNo algorithm.
<span class="fc" id="L72">        MLotteryContext context = MLotteryContext.getInstance();</span>
        try {
<span class="fc" id="L74">            HttpUriRequest request = HttpMethod.POST.getRequest(new URI(context.get(&quot;smart.url&quot;)));</span>
<span class="fc" id="L75">            request.setHeader(&quot;SOAPAction&quot;, &quot;http://sdf.cellc.net/process&quot;);</span>
            // convert the monetary unit from dollar to cent.
<span class="fc" id="L77">            BigDecimal amount = SimpleToolkit.mathMultiple(topupReq.getAmount(), new BigDecimal(&quot;100.0&quot;));</span>
<span class="fc" id="L78">            HttpEntity entity = new ByteArrayEntity(this.assembleXmlRequest(topupReq.getSerialNo(),</span>
                    context.get(&quot;smart.sourceid&quot;), context.get(&quot;smart.username&quot;), context.get(&quot;smart.password&quot;),
                    topupReq.getMobileNo(), amount.intValue()).getBytes());
<span class="fc" id="L81">            ((HttpEntityEnclosingRequestBase) request).setEntity(entity);</span>

<span class="fc" id="L83">            AirtimeTopup result = this.httpClient.execute(request, new ResponseHandler&lt;AirtimeTopup&gt;() {</span>

                @Override
                public AirtimeTopup handleResponse(HttpResponse httpResponse) throws ClientProtocolException,
                        IOException {
<span class="fc" id="L88">                    byte[] entityByte = EntityUtils.toByteArray(httpResponse.getEntity());</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">                    if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L90">                        logger.debug(&quot;[Smart Response] &quot; + new String(entityByte));</span>
                    }
<span class="fc" id="L92">                    SmartResponse respDto = assembleResponse(entityByte);</span>
                    // assemble response
<span class="fc bfc" id="L94" title="All 2 branches covered.">                    topupReq.setStatus(SMART_TOPOUP_STATUS_OK == respDto.getStatusCode()</span>
                            ? AirtimeTopup.STATUS_SUCCESS
                            : AirtimeTopup.STATUS_FAIL);
<span class="fc" id="L97">                    topupReq.setRespMessageOfRemoteService(respDto.getErrorDesc());</span>
<span class="fc" id="L98">                    topupReq.setTelcCommTransId(respDto.getRefId());</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">                    if (respDto.getStatusCode() != SMART_TOPOUP_STATUS_OK) {</span>
<span class="fc" id="L100">                        logger.warn(&quot;Failed result of transaction(&quot; + respCtx.getTransaction().getId()</span>
                                + &quot;) from SMART:&quot; + respDto.getErrorDesc());
                    }
<span class="fc" id="L103">                    return topupReq;</span>
                }
            }, null);
<span class="fc" id="L106">            return result;</span>
<span class="nc" id="L107">        } catch (Exception e) {</span>
<span class="nc" id="L108">            throw new SystemException(e);</span>
        }
    }

    protected SmartResponse assembleResponse(byte[] respXml) {
<span class="fc" id="L113">        SmartResponse respDto = new SmartResponse();</span>
        try {
<span class="fc" id="L115">            SAXReader reader = new SAXReader();</span>
<span class="fc" id="L116">            Document doc = reader.read(new ByteArrayInputStream(respXml));</span>
            // XPath xpath = doc.createXPath(&quot;//soapenv:Envelope/soapenv:Body/com:SDF_Data/com:result/com:statusCode&quot;);
            // Node node = xpath.selectSingleNode(doc);
            // System.out.println(node.getText());
<span class="fc" id="L120">            String smartPrefix = doc.getRootElement().getNamespaceForURI(&quot;http://sdf.cellc.net/commonDataModel&quot;)</span>
                    .getPrefix();
<span class="fc" id="L122">            String soapPrefix = doc.getRootElement().getNamespaceForURI(&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;)</span>
                    .getPrefix();

<span class="fc" id="L125">            String xpath = String.format(&quot;//%s:Envelope/%s:Body/%s:SDF_Data/%s:result/%s:statusCode&quot;, soapPrefix,</span>
                    soapPrefix, smartPrefix, smartPrefix, smartPrefix);
<span class="fc" id="L127">            Node node = doc.createXPath(xpath).selectSingleNode(doc);</span>
<span class="fc" id="L128">            respDto.setStatusCode(Integer.parseInt(node.getText()));</span>

<span class="fc" id="L130">            xpath = String.format(&quot;//%s:Envelope/%s:Body/%s:SDF_Data/%s:result/%s:errorCode&quot;, soapPrefix, soapPrefix,</span>
                    smartPrefix, smartPrefix, smartPrefix);
<span class="fc" id="L132">            node = doc.createXPath(xpath).selectSingleNode(doc);</span>
<span class="fc" id="L133">            respDto.setErrorCode(Integer.parseInt(node.getText()));</span>

<span class="fc" id="L135">            xpath = String.format(&quot;//%s:Envelope/%s:Body/%s:SDF_Data/%s:result/%s:errorDescription&quot;, soapPrefix,</span>
                    soapPrefix, smartPrefix, smartPrefix, smartPrefix);
<span class="fc" id="L137">            node = doc.createXPath(xpath).selectSingleNode(doc);</span>
<span class="fc" id="L138">            respDto.setErrorDesc(node.getText());</span>

<span class="fc" id="L140">            xpath = String.format(&quot;//%s:Envelope/%s:Body/%s:SDF_Data/%s:result/%s:instanceId&quot;, soapPrefix, soapPrefix,</span>
                    smartPrefix, smartPrefix, smartPrefix);
<span class="fc" id="L142">            node = doc.createXPath(xpath).selectSingleNode(doc);</span>
<span class="fc" id="L143">            respDto.setRefId(node.getText());</span>
<span class="nc" id="L144">        } catch (Exception e) {</span>
<span class="nc" id="L145">            throw new SystemException(e);</span>
<span class="fc" id="L146">        }</span>
<span class="fc" id="L147">        return respDto;</span>
    }

    protected String assembleXmlRequest(String transId, String sourceId, String userName, String password,
            String mobileNo, int amount) {
<span class="fc" id="L152">        String xmlTemplate = &quot;&quot;;</span>
<span class="fc" id="L153">        xmlTemplate += &quot;&lt;soapenv:Envelope xmlns:soapenv=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot; xmlns:com=\&quot;http://sdf.cellc.net/commonDataModel\&quot;&gt;&quot;;</span>
<span class="fc" id="L154">        xmlTemplate += &quot;   &lt;soapenv:Header/&gt;&quot;;</span>
<span class="fc" id="L155">        xmlTemplate += &quot;   &lt;soapenv:Body&gt;&quot;;</span>
<span class="fc" id="L156">        xmlTemplate += &quot;      &lt;com:SDF_Data&gt;&quot;;</span>
<span class="fc" id="L157">        xmlTemplate += &quot;         &lt;com:header&gt;&quot;;</span>
<span class="fc" id="L158">        xmlTemplate += &quot;            &lt;com:processTypeID&gt;8798&lt;/com:processTypeID&gt;&quot;;</span>
<span class="fc" id="L159">        xmlTemplate += &quot;            &lt;com:externalReference&gt;%s&lt;/com:externalReference&gt;&quot;;</span>
<span class="fc" id="L160">        xmlTemplate += &quot;            &lt;com:sourceID&gt;%s&lt;/com:sourceID&gt;&quot;;</span>
<span class="fc" id="L161">        xmlTemplate += &quot;            &lt;com:username&gt;%s&lt;/com:username&gt;&quot;;</span>
<span class="fc" id="L162">        xmlTemplate += &quot;            &lt;com:password&gt;%s&lt;/com:password&gt;&quot;;</span>
<span class="fc" id="L163">        xmlTemplate += &quot;            &lt;com:processFlag&gt;1&lt;/com:processFlag&gt;&quot;;</span>
<span class="fc" id="L164">        xmlTemplate += &quot;         &lt;/com:header&gt;&quot;;</span>
<span class="fc" id="L165">        xmlTemplate += &quot;         &lt;com:parameters name=\&quot;\&quot;&gt;&quot;;</span>
<span class="fc" id="L166">        xmlTemplate += &quot;            &lt;com:parameter name=\&quot;RechargeType\&quot;&gt;1010&lt;/com:parameter&gt;&quot;;</span>
<span class="fc" id="L167">        xmlTemplate += &quot;            &lt;com:parameter name=\&quot;MSISDN\&quot;&gt;%s&lt;/com:parameter&gt;&quot;;</span>
<span class="fc" id="L168">        xmlTemplate += &quot;            &lt;com:parameter name=\&quot;Amount\&quot;&gt;%s&lt;/com:parameter&gt;&quot;;</span>
<span class="fc" id="L169">        xmlTemplate += &quot;            &lt;com:parameter name=\&quot;Channel_ID\&quot;&gt;35&lt;/com:parameter&gt;&quot;;</span>
<span class="fc" id="L170">        xmlTemplate += &quot;         &lt;/com:parameters&gt;&quot;;</span>
<span class="fc" id="L171">        xmlTemplate += &quot;      &lt;/com:SDF_Data&gt;&quot;;</span>
<span class="fc" id="L172">        xmlTemplate += &quot;   &lt;/soapenv:Body&gt;&quot;;</span>
<span class="fc" id="L173">        xmlTemplate += &quot;&lt;/soapenv:Envelope&gt;&quot;;</span>
<span class="fc" id="L174">        String reqXml = String.format(xmlTemplate, transId, sourceId, userName, password, mobileNo, amount);</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L176">            logger.debug(&quot;[SMART Request] &quot; + reqXml);</span>
        }
<span class="fc" id="L178">        return reqXml;</span>
    }

    private class SmartResponse {
        private int statusCode;
        private int errorCode;
        private String errorDesc;
        private String refId;

<span class="fc" id="L187">        public SmartResponse() {</span>
<span class="fc" id="L188">        }</span>

        public int getStatusCode() {
<span class="fc" id="L191">            return statusCode;</span>
        }

        public void setStatusCode(int statusCode) {
<span class="fc" id="L195">            this.statusCode = statusCode;</span>
<span class="fc" id="L196">        }</span>

        public int getErrorCode() {
<span class="nc" id="L199">            return errorCode;</span>
        }

        public void setErrorCode(int errorCode) {
<span class="fc" id="L203">            this.errorCode = errorCode;</span>
<span class="fc" id="L204">        }</span>

        public String getErrorDesc() {
<span class="fc" id="L207">            return errorDesc;</span>
        }

        public void setErrorDesc(String errorDesc) {
<span class="fc" id="L211">            this.errorDesc = errorDesc;</span>
<span class="fc" id="L212">        }</span>

        public String getRefId() {
<span class="fc" id="L215">            return refId;</span>
        }

        public void setRefId(String refId) {
<span class="fc" id="L219">            this.refId = refId;</span>
<span class="fc" id="L220">        }</span>

    }

    public static void main(String[] args) throws Exception {
<span class="nc" id="L225">        System.out.println(new SmartAirtimeProvider().assembleXmlRequest(&quot;23423523623423423&quot;, &quot;33613195&quot;,</span>
                &quot;CM6 Lottery&quot;, &quot;Y202U01AcA==&quot;, &quot;70204008&quot;, 1));

<span class="nc" id="L228">        String soapResp = &quot;&quot;;</span>
<span class="nc" id="L229">        soapResp += &quot;&lt;soapenv:Envelope xmlns:com=\&quot;http://sdf.cellc.net/commonDataModel\&quot; xmlns:soapenv=\&quot;http://schemas.xmlsoap.org/soap/envelope/\&quot;&gt;&quot;;</span>
<span class="nc" id="L230">        soapResp += &quot;   &lt;soapenv:Header/&gt;&quot;;</span>
<span class="nc" id="L231">        soapResp += &quot;   &lt;soapenv:Body&gt;&quot;;</span>
<span class="nc" id="L232">        soapResp += &quot;      &lt;com:SDF_Data processID=\&quot;\&quot;&gt;&quot;;</span>
<span class="nc" id="L233">        soapResp += &quot;         &lt;com:header&gt;&quot;;</span>
<span class="nc" id="L234">        soapResp += &quot;            &lt;com:processTypeID&gt;8798&lt;/com:processTypeID&gt;&quot;;</span>
<span class="nc" id="L235">        soapResp += &quot;            &lt;com:externalReference&gt;911411110000012400035&lt;/com:externalReference&gt;&quot;;</span>
<span class="nc" id="L236">        soapResp += &quot;            &lt;com:sourceID&gt;33613195&lt;/com:sourceID&gt;&quot;;</span>
<span class="nc" id="L237">        soapResp += &quot;            &lt;com:username&gt;CM6 Lottery&lt;/com:username&gt;&quot;;</span>
<span class="nc" id="L238">        soapResp += &quot;            &lt;com:password&gt;Y202U01AcA==&lt;/com:password&gt;&quot;;</span>
<span class="nc" id="L239">        soapResp += &quot;            &lt;com:processFlag&gt;1&lt;/com:processFlag&gt;&quot;;</span>
<span class="nc" id="L240">        soapResp += &quot;         &lt;/com:header&gt;&quot;;</span>
<span class="nc" id="L241">        soapResp += &quot;         &lt;com:parameters name=\&quot;\&quot;&gt;&quot;;</span>
<span class="nc" id="L242">        soapResp += &quot;            &lt;com:parameter name=\&quot;RechargeType\&quot;&gt;101&lt;/com:parameter&gt;&quot;;</span>
<span class="nc" id="L243">        soapResp += &quot;            &lt;com:parameter name=\&quot;MSISDN\&quot;&gt;70204008&lt;/com:parameter&gt;&quot;;</span>
<span class="nc" id="L244">        soapResp += &quot;            &lt;com:parameter name=\&quot;Amount\&quot;&gt;1&lt;/com:parameter&gt;&quot;;</span>
<span class="nc" id="L245">        soapResp += &quot;            &lt;com:parameter name=\&quot;Channel_ID\&quot;&gt;35&lt;/com:parameter&gt;&quot;;</span>
<span class="nc" id="L246">        soapResp += &quot;         &lt;/com:parameters&gt;&quot;;</span>
<span class="nc" id="L247">        soapResp += &quot;         &lt;com:result&gt;&quot;;</span>
<span class="nc" id="L248">        soapResp += &quot;            &lt;com:statusCode&gt;0&lt;/com:statusCode&gt;&quot;;</span>
<span class="nc" id="L249">        soapResp += &quot;            &lt;com:errorCode&gt;0&lt;/com:errorCode&gt;&quot;;</span>
<span class="nc" id="L250">        soapResp += &quot;            &lt;com:errorDescription&gt;Successful Transaction 0508155235053561&lt;/com:errorDescription&gt;&quot;;</span>
<span class="nc" id="L251">        soapResp += &quot;            &lt;com:instanceId&gt;0508155235053561&lt;/com:instanceId&gt;&quot;;</span>
<span class="nc" id="L252">        soapResp += &quot;         &lt;/com:result&gt;&quot;;</span>
<span class="nc" id="L253">        soapResp += &quot;      &lt;/com:SDF_Data&gt;&quot;;</span>
<span class="nc" id="L254">        soapResp += &quot;   &lt;/soapenv:Body&gt;&quot;;</span>
<span class="nc" id="L255">        soapResp += &quot;&lt;/soapenv:Envelope&gt;&quot;;</span>
<span class="nc" id="L256">        SAXReader reader = new SAXReader();</span>
<span class="nc" id="L257">        Document doc = reader.read(new ByteArrayInputStream(soapResp.getBytes()));</span>
        // ((DefaultElement) doc.getRootElement()).setNamespace(Namespace.NO_NAMESPACE);
        // doc.getRootElement().additionalNamespaces().clear();
<span class="nc" id="L260">        XPath xpath = doc.createXPath(&quot;//soapenv:Envelope/soapenv:Body/com:SDF_Data/com:result/com:statusCode&quot;);</span>
<span class="nc" id="L261">        Node node = xpath.selectSingleNode(doc);</span>
<span class="nc" id="L262">        System.out.println(node.getText());</span>
<span class="nc" id="L263">        System.out.println(doc.getRootElement().getNamespaceForURI(&quot;http://sdf.cellc.net/commonDataModel&quot;).getPrefix());</span>
<span class="nc" id="L264">        System.out.println(doc.getRootElement().getNamespaceForURI(&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;)</span>
                .getPrefix());
<span class="nc" id="L266">        System.out.println(doc.getRootElement().getNamespaceForPrefix(&quot;com&quot;));</span>

<span class="nc" id="L268">        SmartAirtimeProvider provider = new SmartAirtimeProvider();</span>
<span class="nc" id="L269">        Context respCtx = new Context();</span>
<span class="nc" id="L270">        Transaction trans = new Transaction();</span>
<span class="nc" id="L271">        trans.setId(&quot;9000002&quot;);</span>
<span class="nc" id="L272">        respCtx.setTransaction(trans);</span>
<span class="nc" id="L273">        AirtimeTopup topupReq = new AirtimeTopup();</span>
<span class="nc" id="L274">        topupReq.setMobileNo(&quot;70204008&quot;);</span>
<span class="nc" id="L275">        topupReq.setAmount(new BigDecimal(&quot;1&quot;));</span>
<span class="nc" id="L276">        AirtimeTopup respDto = provider.topup(respCtx, topupReq);</span>
<span class="nc" id="L277">        System.out.println(ToStringBuilder.reflectionToString(respDto));</span>
<span class="nc" id="L278">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.2.201302030002</span></div></body></html>